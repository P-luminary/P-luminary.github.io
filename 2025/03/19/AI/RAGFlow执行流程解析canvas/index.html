
<!DOCTYPE html>
<html lang="zh_CH ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-luminary || RAGFlowæ‰§è¡Œæµç¨‹è§£æcanvas</title>
    <meta name="author" content="Asuna">
    <meta name="description" content=" ">
    <meta name="keywords" content=" ">
    <link rel="icon" href="/https://raw.githubusercontent.com/P-luminary/images/master/data/asuna.jpg">
    <link rel="stylesheet" href="/css/antd.min.css">
    
    <link rel="stylesheet" href="/css/maiden-theme.css">
    
    <script src="/js/vue.js"></script>
    <script src="/js/antd.min.js"></script>
<meta name="generator" content="Hexo 6.1.0"></head>

<body>

    <div id="loading"
        style="height: 100vh; width: 100%; position: fixed;display: flex;z-index: 200; justify-content: space-between;">
        <div id="loadleft" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div id="loadright" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div
            style="position: fixed; height: 100vh; width: 100%;display: flex;justify-content: center;align-items: center;">
            <div id="loadcontent"
                style="width:400px;height:400px;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px#a3ddfb; text-align:center;opacity:1;transition:opacity 0.3s ease-out;">
                <div>
                    <h2>LOADING...</h2>
                    <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜(æµè§ˆå™¨é»˜è®¤å¼€å¯)</p>
                    <div>
                        <img src="/dancingkitty.gif" alt="loading">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="layout">
        <transition name="into">
            <div v-show="show_page" style="display: none;">
                <div id="menu_show">
                     
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">P-luminary</span>
        </a>
        
        <a href="/">
            <span>
                <a-icon type="home" theme="filled" />
            </span>
            <span>home</span>
        </a>
        
        <a href="/tags/è¯­æ³•">
            <span>
                <a-icon type="tags" theme="filled" />
            </span>
            <span>tags</span>
        </a>
        
    </div>

    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div :class="'title'" @click="menu_show=!menu_show">
            <span style="margin-right: 10px;">
                <a-icon type="appstore" theme="filled" />
            </span>
            <span>P-luminary</span>
        </div>
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="home" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">home</div>
                </div>
            </a>
            
            <a href="/tags/è¯­æ³•">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="tags" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">tags</div>
                </div>
            </a>
            
        </div>
        <div class="curtain" v-show="menu_show"></div>
    </div>

</nav>
                </div>

                <div id="main">
                     
<link rel="stylesheet" href="/css/post-body.css">
<div class="article">
    <div>
        <h1>RAGFlowæ‰§è¡Œæµç¨‹è§£æcanvas </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <a-icon type="calendar" theme="filled" />
            </span>
            2025/3/19
        </span>

        

        

        <span class="tags">
            <span class="icon">
                <a-icon type="tags" theme="filled" />
            </span>
            
            <span class="tag">
                
                <a href="/tags/AI" style=color:#00bcd4>
                    AI
                </a>
            </span>
            
        </span>
        
    </div>

    <div class="content" v-pre>
        <h4 id="Canvas-py"><a href="#Canvas-py" class="headerlink" title="Canvas.py"></a>Canvas.py</h4><pre><code class="python">import logging
import json
from copy import deepcopy
from functools import partial

import pandas as pd

from agent.component import component_class
from agent.component.base import ComponentBase


class Canvas:
    &quot;&quot;&quot;
    dsl = &#123;
        &quot;components&quot;: &#123;
            &quot;begin&quot;: &#123;
                &quot;obj&quot;:&#123;
                    &quot;component_name&quot;: &quot;Begin&quot;,
                    &quot;params&quot;: &#123;&#125;,
                &#125;,
                &quot;downstream&quot;: [&quot;answer_0&quot;],
                &quot;upstream&quot;: [],
            &#125;,
            &quot;answer_0&quot;: &#123;
                &quot;obj&quot;: &#123;
                    &quot;component_name&quot;: &quot;Answer&quot;,
                    &quot;params&quot;: &#123;&#125;
                &#125;,
                &quot;downstream&quot;: [&quot;retrieval_0&quot;],
                &quot;upstream&quot;: [&quot;begin&quot;, &quot;generate_0&quot;],
            &#125;,
            &quot;retrieval_0&quot;: &#123;
                &quot;obj&quot;: &#123;
                    &quot;component_name&quot;: &quot;Retrieval&quot;,
                    &quot;params&quot;: &#123;&#125;
                &#125;,
                &quot;downstream&quot;: [&quot;generate_0&quot;],
                &quot;upstream&quot;: [&quot;answer_0&quot;],
            &#125;,
            &quot;generate_0&quot;: &#123;
                &quot;obj&quot;: &#123;
                    &quot;component_name&quot;: &quot;Generate&quot;,
                    &quot;params&quot;: &#123;&#125;
                &#125;,
                &quot;downstream&quot;: [&quot;answer_0&quot;],
                &quot;upstream&quot;: [&quot;retrieval_0&quot;],
            &#125;
        &#125;,
        &quot;history&quot;: [],
        &quot;messages&quot;: [],
        &quot;reference&quot;: [],
        &quot;path&quot;: [[&quot;begin&quot;]],
        &quot;answer&quot;: []
    &#125;
    &quot;&quot;&quot;
    # dslæ˜¯ç»„ä»¶æµçš„JSONæ ¼å¼å­—ç¬¦ä¸² å®šä¹‰äº†ç»„ä»¶çš„è¿æ¥å…³ç³»
    # tenant_idå¤šç§Ÿæˆ·ç®¡ç†
    # componentå­˜å‚¨æ‰€æœ‰ç»„ä»¶å®ä¾‹
    def __init__(self, dsl: str, tenant_id=None):
        self.path = []
        self.history = []
        self.messages = []
        self.answer = []
        self.components = &#123;&#125;
        # å¦‚æœæä¾›äº†dslåˆ™è§£æJSON å¦åˆ™ä½¿ç”¨é»˜è®¤çš„DSLç»“æ„ï¼ˆåŒ…å« Begin ç»„ä»¶ï¼‰
        self.dsl = json.loads(dsl) if dsl else &#123;
            &quot;components&quot;: &#123;
                &quot;begin&quot;: &#123;
                    &quot;obj&quot;: &#123;
                        &quot;component_name&quot;: &quot;Begin&quot;,
                        &quot;params&quot;: &#123;
                            &quot;prologue&quot;: &quot;Hi there!&quot;
                        &#125;
                    &#125;,
                    &quot;downstream&quot;: [],
                    &quot;upstream&quot;: [],
                    &quot;parent_id&quot;: &quot;&quot;
                &#125;
            &#125;,
            &quot;history&quot;: [],
            &quot;messages&quot;: [],
            &quot;reference&quot;: [],
            &quot;path&quot;: [],
            &quot;answer&quot;: []
        &#125;
        self._tenant_id = tenant_id
        self._embed_id = &quot;&quot;
        self.load()

    # åŠ è½½dsl
    def load(self):
      # è§£ædsl[&quot;components&quot;]å­˜å‚¨ç»„ä»¶å®ä¾‹ å¹¶æ£€æŸ¥å¿…è¦ç»„ä»¶æ˜¯å¦å­˜åœ¨
        # ç»„ä»¶å­—å…¸å­˜å…¥self.components
        self.components = self.dsl[&quot;components&quot;]
        # cpn_nmsè®°å½•ç»„ä»¶åç§°é›†åˆ
        cpn_nms = set([])

        # éå†ç»„ä»¶ æå–åç§°
        for k, cpn in self.components.items():
            cpn_nms.add(cpn[&quot;obj&quot;][&quot;component_name&quot;])
        # ç¡®ä¿Beginå’ŒAnswerç»„ä»¶å­˜åœ¨ å¦åˆ™æŠ›å‡ºé”™è¯¯
        assert &quot;Begin&quot; in cpn_nms, &quot;There have to be an &#39;Begin&#39; component.&quot;
        assert &quot;Answer&quot; in cpn_nms, &quot;There have to be an &#39;Answer&#39; component.&quot;

        # forå¾ªç¯ä¾¿åˆ©self.componentsè¿™ä¸ªå­—å…¸
        # å…¶ä¸­é”®kæ˜¯ç»„ä»¶æ ‡è¯†ç¬¦ cpnæ˜¯ä¸€ä¸ªåŒ…å«ç»„ä»¶è¯¦ç»†ä¿¡æ¯çš„å­—å…¸
        for k, cpn in self.components.items():
            # å°†ç»„ä»¶åç§°æ·»åŠ åˆ°cpn_nmsé›†åˆä¸­
            cpn_nms.add(cpn[&quot;obj&quot;][&quot;component_name&quot;])
            # é€šè¿‡component_classåŠ¨æ€åˆ›å»º æ‹¼æ¥param
            param = component_class(cpn[&quot;obj&quot;][&quot;component_name&quot;] + &quot;Param&quot;)()
            # æ›´æ–°paramå®ä¾‹çš„å±æ€§ å°†cpn[&quot;obj&quot;][&quot;params&quot;]å­—å…¸ä¸­çš„é”®å€¼å¯¹åº”ç”¨åˆ°paramå®ä¾‹ä¸Š
            param.update(cpn[&quot;obj&quot;][&quot;params&quot;])
            param.check()
          # ä½¿ç”¨component_classåŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç»„ä»¶å®ä¾‹ å¹¶å°†å…¶èµ‹å€¼ç»™cpn[&quot;obj&quot;]
            # æ–°å®ä¾‹çš„åˆ›å»ºä½¿ç”¨äº†å½“å‰ç±»å®ä¾‹selfã€ç»„ä»¶æ ‡è¯†ç¬¦kå’Œå‚æ•°å®ä¾‹param
            cpn[&quot;obj&quot;] = component_class(cpn[&quot;obj&quot;][&quot;component_name&quot;])(self, k, param)
            # æ£€æŸ¥å½“å‰ç»„ä»¶çš„åç§°æ˜¯å¦ä¸º&quot;Categorize&quot;
            if cpn[&quot;obj&quot;].component_name == &quot;Categorize&quot;:
                # ç»„ä»¶æ˜¯&quot;Categorize&quot; åˆ™éå†param.category_descriptionå­—å…¸ è¿™ä¸ªå­—å…¸åŒ…å«äº†åˆ†ç±»æè¿°
                for _, desc in param.category_description.items():
                    # è¿™ä¸¤è¡Œä»£ç æ£€æŸ¥desc[&quot;to&quot;]ï¼ˆå¯èƒ½æ˜¯ä¸‹æ¸¸ç»„ä»¶çš„æ ‡è¯†ç¬¦ï¼‰æ˜¯å¦å·²ç»åœ¨cpn[&quot;downstream&quot;]åˆ—è¡¨ä¸­
                    if desc[&quot;to&quot;] not in cpn[&quot;downstream&quot;]:
                        # å¦‚æœä¸åœ¨ï¼Œå°±å°†å…¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­
                        cpn[&quot;downstream&quot;].append(desc[&quot;to&quot;])
        # å°†self.dsl[&quot;path&quot;]çš„å€¼èµ‹ç»™self.pathå±æ€§
        self.path = self.dsl[&quot;path&quot;]
        self.history = self.dsl[&quot;history&quot;]
        self.messages = self.dsl[&quot;messages&quot;]
        self.answer = self.dsl[&quot;answer&quot;]
        self.reference = self.dsl[&quot;reference&quot;]
        self._embed_id = self.dsl.get(&quot;embed_id&quot;, &quot;&quot;)

    # å®šä¹‰äº†ç±»çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ é€šå¸¸ç”¨äºæ‰“å°å¯¹è±¡æ—¶æ˜¾ç¤ºçš„ä¿¡æ¯
    # è¿™å‡ è¡Œä»£ç å°†ç±»çš„å±æ€§å€¼èµ‹ç»™self.dslå­—å…¸ä¸­çš„ç›¸åº”é”®
    def __str__(self):
        self.dsl[&quot;path&quot;] = self.path
        self.dsl[&quot;history&quot;] = self.history
        self.dsl[&quot;messages&quot;] = self.messages
        self.dsl[&quot;answer&quot;] = self.answer
        self.dsl[&quot;reference&quot;] = self.reference
        self.dsl[&quot;embed_id&quot;] = self._embed_id
        # åˆ›å»ºä¸€ä¸ªæ–°çš„å­—å…¸dsl å…¶ä¸­åŒ…å«ä¸€ä¸ªé”®components å…¶å€¼ä¸ºä¸€ä¸ªç©ºå­—å…¸
        dsl = &#123;
            &quot;components&quot;: &#123;&#125;
        &#125;
        # éå†self.dslå­—å…¸çš„é”® å¦‚æœé”®ä¸æ˜¯components åˆ™å°†å…¶å€¼æ·±æ‹·è´åˆ°æ–°çš„dslå­—å…¸ä¸­
        for k in self.dsl.keys():
            if k in [&quot;components&quot;]:
                continue
            dsl[k] = deepcopy(self.dsl[k])

        # éå†self.componentså­—å…¸ å°†æ¯ä¸ªç»„ä»¶çš„ä¿¡æ¯æ·±æ‹·è´åˆ°dslå­—å…¸çš„componentsé”®ä¸‹
        # å¯¹äºobjé”® å°†å…¶å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²åå†è§£æä¸ºJSON
        for k, cpn in self.components.items():
            if k not in dsl[&quot;components&quot;]:
                dsl[&quot;components&quot;][k] = &#123;&#125;
            for c in cpn.keys():
                if c == &quot;obj&quot;:
                    dsl[&quot;components&quot;][k][c] = json.loads(str(cpn[&quot;obj&quot;]))
                    continue
                dsl[&quot;components&quot;][k][c] = deepcopy(cpn[c])
        # è¿”å›dslå­—å…¸çš„JSONå­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ ensure_ascii=Falseç¡®ä¿éASCIIå­—ç¬¦å¯ä»¥æ­£ç¡®æ˜¾ç¤º
        return json.dumps(dsl, ensure_ascii=False)

    # å°†ç±»çš„å±æ€§é‡ç½®ä¸ºç©ºåˆ—è¡¨
    def reset(self):
        self.path = []
        self.history = []
        self.messages = []
        self.answer = []
        self.reference = []
        # éå†self.componentså­—å…¸ å¹¶è°ƒç”¨æ¯ä¸ªç»„ä»¶çš„resetæ–¹æ³•
        for k, cpn in self.components.items():
            self.components[k][&quot;obj&quot;].reset()
        # å°†_embed_idå±æ€§é‡ç½®ä¸ºç©ºå­—ç¬¦ä¸²
        self._embed_id = &quot;&quot;

    # è¿™ä¸ªæ–¹æ³•ç”¨äºæ ¹æ®ç»„ä»¶IDè·å–ç»„ä»¶åç§°
    def get_component_name(self, cid):
        # éå†self.dslå­—å…¸ä¸­çš„graphé”®ä¸‹çš„nodesåˆ—è¡¨
        # å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ID åˆ™è¿”å›ç›¸åº”çš„ç»„ä»¶åç§°
        for n in self.dsl[&quot;graph&quot;][&quot;nodes&quot;]:
            if cid == n[&quot;id&quot;]:
                return n[&quot;data&quot;][&quot;name&quot;]
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ID åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
        return &quot;&quot;

    def run(self, **kwargs):
        # å¦‚æœself.answeråˆ—è¡¨ä¸ä¸ºç©º
        if self.answer:
            # ç”¨äºå­˜å‚¨æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ç»„ä»¶ID
            cpn_id = self.answer[0]
            # å­˜å®Œå°±ä»åˆ—è¡¨ä¸­ç§»é™¤
            self.answer.pop(0)
            try:
                # å°è¯•æ‰§è¡Œ self.components å­—å…¸ä¸­å¯¹åº” cpn_id çš„ç»„ä»¶å¯¹è±¡çš„ run æ–¹æ³•
                # å¹¶ä¼ å…¥ self.history å’Œ **kwargs ä½œä¸ºå‚æ•°
                ans = self.components[cpn_id][&quot;obj&quot;].run(self.history, **kwargs)
                # å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸
            except Exception as e:
                # æ•è·è¯¥å¼‚å¸¸å¹¶ä½¿ç”¨ ComponentBase.be_output æ–¹æ³•å¤„ç†å¼‚å¸¸ä¿¡æ¯
                ans = ComponentBase.be_output(str(e))
            # å°†æ‰§è¡Œè¿‡çš„ç»„ä»¶IDæ·»åŠ åˆ° self.path åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸­
            # self.path ä¼¼ä¹ç”¨äºè®°å½•æ‰§è¡Œè·¯å¾„
            self.path[-1].append(cpn_id)
            # å¦‚æœ kwargs ä¸­åŒ…å«å…³é”®å­— â€œstreamâ€
            # åˆ™å‡è®¾ ans æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ éå†å®ƒå¹¶é€ä¸ª yield å‡ºæ¥
            # å¦‚æœä¸æ˜¯ åˆ™ç›´æ¥ yield ans
            if kwargs.get(&quot;stream&quot;):
                for an in ans():
                    yield an
            else:
                yield ans
            return
        # å¦‚æœ self.path ä¸ºç©º åˆ™æ‰§è¡Œåä¸º â€œbeginâ€ çš„ç»„ä»¶çš„ run æ–¹æ³• å¹¶å°† â€œbeginâ€ æ·»åŠ åˆ° self.path ä¸­
        if not self.path:
            self.components[&quot;begin&quot;][&quot;obj&quot;].run(self.history, **kwargs)
            self.path.append([&quot;begin&quot;])
        # å‘ self.path æ·»åŠ ä¸€ä¸ªç©ºåˆ—è¡¨ ä¸ºæ¥ä¸‹æ¥çš„ç»„ä»¶æ‰§è¡Œåšå‡†å¤‡
        self.path.append([])

        ran = -1
        waiting = []
        without_dependent_checking = []

        # å½“æœ‰ä¸‹æ¸¸ç»„ä»¶downstreamæ—¶
        # å®ƒæ¥å—ä¸€ä¸ªç»„ä»¶åˆ—è¡¨ cpns ä½œä¸ºå‚æ•°
        def prepare2run(cpns):
            # è¿™äº›å˜é‡åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰ ä½†åœ¨å‡½æ•°å†…éƒ¨å¯ä»¥è¢«ä¿®æ”¹
            nonlocal ran, ans
            # éå† cpns åˆ—è¡¨ä¸­çš„æ¯ä¸ªç»„ä»¶ID c
            # å¦‚æœ c å·²ç»æ˜¯ self.path ä¸­æœ€åä¸€ä¸ªåˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´  åˆ™è·³è¿‡å½“å‰å¾ªç¯
            for c in cpns:
                if self.path[-1] and c == self.path[-1][-1]:
                    continue
                # ä» self.components å­—å…¸ä¸­è·å–ç»„ä»¶ID c å¯¹åº”çš„ç»„ä»¶å¯¹è±¡
                cpn = self.components[c][&quot;obj&quot;]
                # å¦‚æœç»„ä»¶çš„åç§°æ˜¯ â€œAnswerâ€ åˆ™å°†ç»„ä»¶ID c æ·»åŠ åˆ° self.answer åˆ—è¡¨ä¸­
                if cpn.component_name == &quot;Answer&quot;:
                    self.answer.append(c)
                else:
                    # å¦‚æœç»„ä»¶ä¸æ˜¯ â€œAnswerâ€ åˆ™è®°å½•è°ƒè¯•ä¿¡æ¯ æ£€æŸ¥ç»„ä»¶æ˜¯å¦æœ‰æœªæ‰§è¡Œçš„ä¾èµ–ç»„ä»¶
                    # å¦‚æœæœ‰ å°†ç»„ä»¶IDæ·»åŠ åˆ° waiting åˆ—è¡¨ å¹¶è·³è¿‡å½“å‰å¾ªç¯
                    logging.debug(f&quot;Canvas.prepare2run: &#123;c&#125;&quot;)
                    if c not in without_dependent_checking:
                        cpids = cpn.get_dependent_components()
                        if any([cc not in self.path[-1] for cc in cpids]):
                            if c not in waiting:
                                waiting.append(c)
                            continue
                    yield &quot;*&#39;&#123;&#125;&#39;* is running...ğŸ•&quot;.format(self.get_component_name(c))
                    # å¦‚æœç»„ä»¶æ˜¯ â€œIterationâ€ åˆ™è·å–å…¶å¼€å§‹ç»„ä»¶ å¹¶æ£€æŸ¥æ˜¯å¦å·²ç»ç»“æŸ å¦‚æœæ²¡æœ‰ç»“æŸ åˆ™æ›´æ–° cpn å’Œ c ä¸ºå¼€å§‹ç»„ä»¶
                    if cpn.component_name.lower() == &quot;iteration&quot;:
                        st_cpn = cpn.get_start()
                        assert st_cpn, &quot;Start component not found for Iteration.&quot;
                        if not st_cpn[&quot;obj&quot;].end():
                            cpn = st_cpn[&quot;obj&quot;]
                            c = cpn._id
                    # å°è¯•è¿è¡Œç»„ä»¶
                    try:
                        ans = cpn.run(self.history, **kwargs)
                    # å¹¶æ•è·ä»»ä½•å¼‚å¸¸ å¦‚æœå‘ç”Ÿå¼‚å¸¸ è®°å½•é”™è¯¯å¹¶æ›´æ–° ran ç„¶åé‡æ–°æŠ›å‡ºå¼‚å¸¸
                    except Exception as e:
                        logging.exception(f&quot;Canvas.run got exception: &#123;e&#125;&quot;)
                        self.path[-1].append(c)
                        ran += 1
                        raise e
                    # å°†ç»„ä»¶ID c æ·»åŠ åˆ° self.path çš„æœ€åä¸€ä¸ªåˆ—è¡¨ä¸­
                    self.path[-1].append(c)
            # å¢åŠ  ran è®¡æ•°å™¨çš„å€¼
            ran += 1
        &quot;&quot;&quot;
        æ¥ä¸‹æ¥çš„ä»£ç å—å¤„ç†ä¸‹æ¸¸ç»„ä»¶çš„è¿è¡Œ å¾ªç¯æ£€æµ‹ ä»¥åŠç»„ä»¶è¾“å‡ºçš„åˆå¹¶
        è¿™éƒ¨åˆ†ä»£ç æ¶‰åŠåˆ°æ›´å¤æ‚çš„é€»è¾‘ï¼Œå¦‚å¤„ç†å¾ªç¯ã€æ¡ä»¶åˆ†æ”¯ã€ç»„ä»¶è¾“å‡ºç­‰
        &quot;&quot;&quot;
        # è·å–ä¸Šä¸€ä¸ªç»„ä»¶çš„ä¸‹æ¸¸ç»„ä»¶åˆ—è¡¨
        downstream = self.components[self.path[-2][-1]][&quot;downstream&quot;]
        # å¦‚æœæ²¡æœ‰ä¸‹æ¸¸ç»„ä»¶ ä½†å­˜åœ¨çˆ¶ç»„ä»¶ID åˆ™åˆå¹¶çˆ¶ç»„ä»¶å’Œå½“å‰ç»„ä»¶çš„è¾“å‡º
        if not downstream and self.components[self.path[-2][-1]].get(&quot;parent_id&quot;):
            cid = self.path[-2][-1]
            pid = self.components[cid][&quot;parent_id&quot;]
            o, _ = self.components[cid][&quot;obj&quot;].output(allow_partial=False)
            oo, _ = self.components[pid][&quot;obj&quot;].output(allow_partial=False)
            self.components[pid][&quot;obj&quot;].set_output(pd.concat([oo, o], ignore_index=True).dropna())
            downstream = [pid]
        # é€’å½’è°ƒç”¨ prepare2run å‡½æ•°å¤„ç†ä¸‹æ¸¸ç»„ä»¶ å¹¶ç”Ÿæˆè¿è¡ŒçŠ¶æ€ä¿¡æ¯
        for m in prepare2run(downstream):
            yield &#123;&quot;content&quot;: m, &quot;running_status&quot;: True&#125;

        # åœ¨ ran çš„å€¼æœ‰æ•ˆæ—¶ å¤„ç†å¾ªç¯å’Œç»„ä»¶è¿è¡Œ
        # ran çš„å€¼åœ¨ 0 å’Œ self.path[-1] çš„é•¿åº¦ä¹‹é—´æ—¶ç»§ç»­æ‰§è¡Œ
        while 0 &lt;= ran &lt; len(self.path[-1]):
            logging.debug(f&quot;Canvas.run: &#123;ran&#125; &#123;self.path&#125;&quot;)
            # ä» self.path ä¸­è·å–å½“å‰è¦å¤„ç†çš„ç»„ä»¶ID cpn_id
            # å¹¶é€šè¿‡ get_component æ–¹æ³•è·å–ç»„ä»¶å¯¹è±¡
            cpn_id = self.path[-1][ran]
            cpn = self.get_component(cpn_id)
            # å¦‚æœå½“å‰ç»„ä»¶æ²¡æœ‰ä¸‹æ¸¸ç»„ä»¶ã€æ²¡æœ‰çˆ¶ç»„ä»¶ID å¹¶ä¸”æ²¡æœ‰ç­‰å¾…å¤„ç†çš„ç»„ä»¶ åˆ™é€€å‡ºå¾ªç¯
            if not any([cpn[&quot;downstream&quot;], cpn.get(&quot;parent_id&quot;), waiting]):
                break

            # è°ƒç”¨ _find_loop æ–¹æ³•æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾ªç¯ å¦‚æœå­˜åœ¨åˆ™æŠ›å‡º OverflowError å¼‚å¸¸
            loop = self._find_loop()
            if loop:
                raise OverflowError(f&quot;Too much loops: &#123;loop&#125;&quot;)
            # å¦‚æœç»„ä»¶çš„åç§°æ˜¯ â€œswitchâ€ã€â€œcategorizeâ€ æˆ– â€œrelevantâ€ åˆ™å¤„ç†è¿™äº›ç‰¹å®šç±»å‹çš„ç»„ä»¶
            if cpn[&quot;obj&quot;].component_name.lower() in [&quot;switch&quot;, &quot;categorize&quot;, &quot;relevant&quot;]:
                switch_out = cpn[&quot;obj&quot;].output()[1].iloc[0, 0]
                assert switch_out in self.components, \
                    &quot;&#123;&#125;&#39;s output: &#123;&#125; not valid.&quot;.format(cpn_id, switch_out)
                # é€’å½’è°ƒç”¨ prepare2run å‡½æ•°å¤„ç†ç‰¹å®šç»„ä»¶çš„è¾“å‡º å¹¶ç”Ÿæˆè¿è¡ŒçŠ¶æ€ä¿¡æ¯ ç„¶åç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯
                for m in prepare2run([switch_out]):
                    yield &#123;&quot;content&quot;: m, &quot;running_status&quot;: True&#125;
                continue

            # å¤„ç†çˆ¶ç»„ä»¶è¾“å‡ºåˆå¹¶
            downstream = cpn[&quot;downstream&quot;]
            # å¦‚æœæ²¡æœ‰ä¸‹æ¸¸ç»„ä»¶ä½†æœ‰çˆ¶ç»„ä»¶ID åˆ™åˆå¹¶çˆ¶ç»„ä»¶å’Œå½“å‰ç»„ä»¶çš„è¾“å‡º
            if not downstream and cpn.get(&quot;parent_id&quot;):
                pid = cpn[&quot;parent_id&quot;]
                _, o = cpn[&quot;obj&quot;].output(allow_partial=False)
                _, oo = self.components[pid][&quot;obj&quot;].output(allow_partial=False)
                self.components[pid][&quot;obj&quot;].set_output(pd.concat([oo.dropna(axis=1), o.dropna(axis=1)], ignore_index=True))
                downstream = [pid]
            # é€’å½’è°ƒç”¨ prepare2run å‡½æ•°å¤„ç†ä¸‹æ¸¸ç»„ä»¶ å¹¶ç”Ÿæˆè¿è¡ŒçŠ¶æ€ä¿¡æ¯
            for m in prepare2run(downstream):
                yield &#123;&quot;content&quot;: m, &quot;running_status&quot;: True&#125;

            # å¦‚æœ ran çš„å€¼ç­‰äºæˆ–è¶…è¿‡ self.path[-1] çš„é•¿åº¦
            # å¹¶ä¸”æœ‰ç­‰å¾…å¤„ç†çš„ç»„ä»¶ åˆ™å¤„ç†è¿™äº›ç»„ä»¶ å¹¶æ›´æ–° ran çš„å€¼
            if ran &gt;= len(self.path[-1]) and waiting:
                without_dependent_checking = waiting
                waiting = []
                for m in prepare2run(without_dependent_checking):
                    yield &#123;&quot;content&quot;: m, &quot;running_status&quot;: True&#125;
                without_dependent_checking = []
                ran -= 1
        # å¦‚æœ self.answer åˆ—è¡¨éç©º å¤„ç†ç­”æ¡ˆç»„ä»¶
        if self.answer:
            cpn_id = self.answer[0]
            self.answer.pop(0)
            ans = self.components[cpn_id][&quot;obj&quot;].run(self.history, **kwargs)
            self.path[-1].append(cpn_id)
            # å¦‚æœ self.answer åˆ—è¡¨ä¸ºç©º æŠ›å‡ºå¼‚å¸¸ æç¤ºéœ€è¦åœ¨æµç¨‹æœ«å°¾æ·»åŠ äº¤äº’ç»„ä»¶
            if kwargs.get(&quot;stream&quot;):
                assert isinstance(ans, partial)
                for an in ans():
                    yield an
            else:
                yield ans

        else:
            raise Exception(&quot;The dialog flow has no way to interact with you. Please add an &#39;Interact&#39; component to the end of the flow.&quot;)

    def get_component(self, cpn_id):
        return self.components[cpn_id]

    def get_tenant_id(self):
        return self._tenant_id
    # å®šä¹‰ä¸€ä¸ªåä¸º get_history çš„æ–¹æ³• å®ƒæ¥å—ä¸€ä¸ªå‚æ•° window_size è¿™ä¸ªå‚æ•°ç”¨äºç¡®å®šéœ€è¦è¿”å›å¤šå°‘æ¡å†å²è®°å½•
    def get_history(self, window_size):
        # åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨convs  ç”¨äºå­˜å‚¨æ ¼å¼åŒ–åçš„å¯¹è¯è®°å½•
        convs = []
        # ä½¿ç”¨ä¸€ä¸ª for å¾ªç¯éå† self.history çš„æœ€å window_size æ¡è®°å½•
        # self.history åº”è¯¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ å…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªåŒ…å«è§’è‰²å’Œå¯¹è±¡ï¼ˆå¯¹è¯å†…å®¹ï¼‰çš„å…ƒç»„
        &quot;&quot;&quot;
            role æ˜¯å¯¹è¯ä¸­çš„è§’è‰²ï¼Œä¾‹å¦‚ â€œuserâ€ æˆ– â€œassistantâ€ã€‚
            obj æ˜¯ä¸è¯¥è§’è‰²ç›¸å…³çš„å¯¹è¯å†…å®¹ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªåˆ—è¡¨æˆ–å•ä¸ªå¯¹è±¡
        &quot;&quot;&quot;
        for role, obj in self.history[window_size * -1:]:
            if isinstance(obj, list) and obj and all([isinstance(o, dict) for o in obj]):
                convs.append(&#123;&quot;role&quot;: role, &quot;content&quot;: &#39;\n&#39;.join([str(s.get(&quot;content&quot;, &quot;&quot;)) for s in obj])&#125;)
            else:
                convs.append(&#123;&quot;role&quot;: role, &quot;content&quot;: str(obj)&#125;)
        return convs

    def add_user_input(self, question):
        self.history.append((&quot;user&quot;, question))

    def set_embedding_model(self, embed_id):
        self._embed_id = embed_id

    def get_embedding_model(self):
        return self._embed_id
 # å®šä¹‰ä¸€ä¸ªåä¸º _find_loop çš„æ–¹æ³• å®ƒæ¥å—ä¸€ä¸ªå¯é€‰å‚æ•° max_loopsé»˜è®¤å€¼ä¸º6 è¿™ä¸ªå‚æ•°ç”¨äºé™åˆ¶å¾ªç¯æ£€æµ‹çš„æ¬¡æ•°
    def _find_loop(self, max_loops=6):
        # è·å– self.path åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆå³å½“å‰è·¯å¾„ï¼‰å¹¶å°†å…¶åè½¬ ä»¥ä¾¿ä»åå¾€å‰æ£€æŸ¥
        path = self.path[-1][::-1]
        # å¦‚æœè·¯å¾„çš„é•¿åº¦å°äº2 åˆ™æ²¡æœ‰è¶³å¤Ÿçš„å…ƒç´ å½¢æˆå¾ªç¯ å› æ­¤ç›´æ¥è¿”å› False
        if len(path) &lt; 2:
            return False
        # éå†è·¯å¾„ï¼Œå¦‚æœæ‰¾åˆ°ä»¥ â€œanswerâ€ æˆ– â€œiterationitemâ€ å¼€å¤´çš„å…ƒç´ 
        # åˆ™ä»è·¯å¾„ä¸­ç§»é™¤è¯¥å…ƒç´ åŠå…¶åé¢çš„æ‰€æœ‰å…ƒç´ 
        # å› ä¸ºè¿™äº›å…ƒç´ å¯èƒ½è¡¨ç¤ºå¾ªç¯çš„ç»“æŸ
        for i in range(len(path)):
            if path[i].lower().find(&quot;answer&quot;) == 0 or path[i].lower().find(&quot;iterationitem&quot;) == 0:
                path = path[:i]
                break
        # å†æ¬¡æ£€æŸ¥è·¯å¾„é•¿åº¦ å¦‚æœç§»é™¤ç‰¹å®šå…ƒç´ åé•¿åº¦å°äº2 åˆ™è¿”å› False
        if len(path) &lt; 2:
            return False
        # ä½¿ç”¨ä¸€ä¸ªå¾ªç¯æ¥æ£€æŸ¥è·¯å¾„çš„ä¸åŒå­åºåˆ— loc æ˜¯å­åºåˆ—çš„é•¿åº¦
        # ä» 2 å¼€å§‹ ç›´åˆ°è·¯å¾„é•¿åº¦çš„ä¸€åŠ
        for loc in range(2, len(path) // 2):
            # åˆ›å»ºä¸€ä¸ªå­åºåˆ—pat å®ƒæ˜¯è·¯å¾„çš„å‰locä¸ªå…ƒç´  ç”¨é€—å·è¿æ¥
            pat = &quot;,&quot;.join(path[0:loc])
            # åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² path_str å®ƒæ˜¯æ•´ä¸ªè·¯å¾„ ç”¨é€—å·è¿æ¥
            path_str = &quot;,&quot;.join(path)
            # å¦‚æœå­åºåˆ—patçš„é•¿åº¦å¤§äºæˆ–ç­‰äºæ•´ä¸ªè·¯å¾„å­—ç¬¦ä¸² ath_strçš„é•¿åº¦ åˆ™ä¸å¯èƒ½å½¢æˆå¾ªç¯ å› æ­¤è¿”å› False
            if len(pat) &gt;= len(path_str):
                return False
            &quot;&quot;&quot;
            ä½¿ç”¨ä¸€ä¸ª while å¾ªç¯æ¥æ£€æŸ¥ path_str æ˜¯å¦ä»¥ pat å¼€å¤´ 
            å¦‚æœæ˜¯ åˆ™å‡å°‘ loop è®¡æ•° å¹¶ä» path_str ä¸­ç§»é™¤ pat å’Œéšåçš„é€—å·
            å¦‚æœ loop è®¡æ•°é™åˆ° 0 ä»¥ä¸‹ è¯´æ˜æ‰¾åˆ°äº†å¾ªç¯
            &quot;&quot;&quot;
            loop = max_loops
            while path_str.find(pat) == 0 and loop &gt;= 0:
                loop -= 1
                if len(pat)+1 &gt;= len(path_str):
                    return False
                path_str = path_str[len(pat)+1:]
                # å¦‚æœæ‰¾åˆ°äº†å¾ªç¯ åˆ™åˆ›å»ºä¸€ä¸ªå¾ªç¯æ¨¡å¼çš„å­—ç¬¦ä¸² ä½¿ç”¨ &quot; =&gt; &quot; ä½œä¸ºåˆ†éš”ç¬¦
                # å¹¶å°†è·¯å¾„ä¸­çš„æ¯ä¸ªå…ƒç´ çš„å‰åŠéƒ¨åˆ†ï¼ˆåœ¨å†’å·ä¹‹å‰çš„éƒ¨åˆ†ï¼‰è¿æ¥èµ·æ¥
                # æœ€å è¿”å›ä¸€ä¸ªè¡¨ç¤ºå¾ªç¯çš„æ¨¡å¼å­—ç¬¦ä¸²
            if loop &lt; 0:
                pat = &quot; =&gt; &quot;.join([p.split(&quot;:&quot;)[0] for p in path[0:loc]])
                return pat + &quot; =&gt; &quot; + pat

        return False

    def get_prologue(self):
        return self.components[&quot;begin&quot;][&quot;obj&quot;]._param.prologue

    def set_global_param(self, **kwargs):
        for k, v in kwargs.items():
            for q in self.components[&quot;begin&quot;][&quot;obj&quot;]._param.query:
                if k != q[&quot;key&quot;]:
                    continue
                q[&quot;value&quot;] = v

    def get_preset_param(self):
        return self.components[&quot;begin&quot;][&quot;obj&quot;]._param.query

    def get_component_input_elements(self, cpnnm):
        return self.components[cpnnm][&quot;obj&quot;].get_input_elements()
</code></pre>

    </div>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <div id="comment">
        <div id="gitalk-container">
        </div>
    </div>
    
</div>
                     
<footer id="footer">
    <div class="footer-wrap">
        <div>
            Â© 2018 - 2025 P-luminary
            <span class="footer-icon">
                <a-icon type="flag" theme="filled" /></span>
            @Asuna
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a>
<!--         & <a target="_blank" rel="noopener" href="https://github.com/korilin/hexo-theme-particle">Particle Theme</a></div> -->
        
    </div>

</footer>

<script src="/js/highlight.min.js"></script>
<script src="/js/particle.js"></script>
                </div>
            </div>
        </transition>
    </div>

    <script>
    new Vue({
        el: "#layout",
        data: {
            show_page: false,
            onload_menu: false,
            menu_show: false,
            card_top: 100
        },
        created: function () {
            var that = this
            window.onload = function () {
                that.show_page = true
                document.getElementById("loadcontent").style.opacity = 0
                setTimeout(function () {
                    document.getElementById("loadleft").style.width = 0
                    document.getElementById("loadright").style.width = 0
                }, 300)
                setTimeout(function () {
                    document.getElementById("loading").style = "display:none"
                }, 600)
            }
        },
        mounted: function () {
            var that = this
            window.addEventListener('scroll', function (e) {
                that.menu_show = false
            })
        },
        methods: {
            home_click: function () {
                window.scrollTo({
                    top: window.innerHeight - 80,
                    behavior: "smooth",
                });
            }
        }
    })
</script>

<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'hexo-theme-particle',      // The repository of store comments,
        owner: 'P-luminary',
        admin: ['P-luminary'],
        language: 'en',
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: true  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>

</body>

</html>