
<!DOCTYPE html>
<html lang="zh_CH ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-luminary || Cloud分布式微服务打造大型自媒体3大业务平台</title>
    <meta name="author" content="Asuna">
    <meta name="description" content=" ">
    <meta name="keywords" content=" ">
    <link rel="icon" href="/https://raw.githubusercontent.com/P-luminary/images/master/data/asuna.jpg">
    <link rel="stylesheet" href="/css/antd.min.css">
    
    <link rel="stylesheet" href="/css/maiden-theme.css">
    
    <script src="/js/vue.js"></script>
    <script src="/js/antd.min.js"></script>
<meta name="generator" content="Hexo 6.1.0"></head>

<body>

    <div id="loading"
        style="height: 100vh; width: 100%; position: fixed;display: flex;z-index: 200; justify-content: space-between;">
        <div id="loadleft" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div id="loadright" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div
            style="position: fixed; height: 100vh; width: 100%;display: flex;justify-content: center;align-items: center;">
            <div id="loadcontent"
                style="width:400px;height:400px;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px#a3ddfb; text-align:center;opacity:1;transition:opacity 0.3s ease-out;">
                <div>
                    <h2>LOADING...</h2>
                    <p>加载过慢请开启缓存(浏览器默认开启)</p>
                    <div>
                        <img src="/dancingkitty.gif" alt="loading">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="layout">
        <transition name="into">
            <div v-show="show_page" style="display: none;">
                <div id="menu_show">
                     
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">P-luminary</span>
        </a>
        
        <a href="/">
            <span>
                <a-icon type="home" theme="filled" />
            </span>
            <span>home</span>
        </a>
        
        <a href="/tags/语法">
            <span>
                <a-icon type="tags" theme="filled" />
            </span>
            <span>tags</span>
        </a>
        
    </div>

    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div :class="'title'" @click="menu_show=!menu_show">
            <span style="margin-right: 10px;">
                <a-icon type="appstore" theme="filled" />
            </span>
            <span>P-luminary</span>
        </div>
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="home" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">home</div>
                </div>
            </a>
            
            <a href="/tags/语法">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="tags" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">tags</div>
                </div>
            </a>
            
        </div>
        <div class="curtain" v-show="menu_show"></div>
    </div>

</nav>
                </div>

                <div id="main">
                     
<link rel="stylesheet" href="/css/post-body.css">
<div class="article">
    <div>
        <h1>Cloud分布式微服务打造大型自媒体3大业务平台 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <a-icon type="calendar" theme="filled" />
            </span>
            2024/5/12
        </span>

        

        

        <span class="tags">
            <span class="icon">
                <a-icon type="tags" theme="filled" />
            </span>
            
            <span class="tag">
                
                <a href="/tags/后端" style=color:#ff7d73>
                    后端
                </a>
            </span>
            
        </span>
        
    </div>

    <div class="content" v-pre>
        <h1 id="自媒体项目"><a href="#自媒体项目" class="headerlink" title="自媒体项目"></a>自媒体项目</h1><h6 id="VM-CentOS7：数据库密码→Panchunyao123"><a href="#VM-CentOS7：数据库密码→Panchunyao123" class="headerlink" title="VM CentOS7：数据库密码→Panchunyao123!"></a>VM CentOS7：数据库密码→Panchunyao123!</h6><h5 id="开发思维与企业一致"><a href="#开发思维与企业一致" class="headerlink" title="开发思维与企业一致"></a>开发思维与企业一致</h5><ul>
<li>三端融合：门户+媒体+运营</li>
<li>4g自媒体辉煌时代</li>
<li>5g科技互联网风口</li>
<li>前后端分离式开发、代码动静分离、保证职</li>
<li>能解耦、功能模块互相协调</li>
</ul>
<h5 id="如何整合分布式中间件到项目中"><a href="#如何整合分布式中间件到项目中" class="headerlink" title="如何整合分布式中间件到项目中"></a>如何整合分布式中间件到项目中</h5><ul>
<li>整个流程会做到细致入微</li>
<li>帮助<span style = "color:red"><strong>迅速提升至少2年</strong></span>以上的项目经验</li>
</ul>
<h5 id="重点功能技术分析"><a href="#重点功能技术分析" class="headerlink" title="重点功能技术分析"></a>重点功能技术分析</h5><ul>
<li><strong>Redis</strong>：分布式会话、session共享、单点登录、防刷、计数</li>
<li><strong>Fastdfs+Nginx&#x2F;OSS&#x2F;GridFS</strong>：搭建分布式文件系统、单文件&#x2F;批量上传、人脸隐私保护拦截</li>
<li><strong>Maven</strong>：项目构建、聚合、分层、架构设计、面向对象</li>
<li><strong>阿里AI</strong>：人脸对比、文本&#x2F;图片自动审核、短信</li>
<li><strong>SpringCloud</strong>：业务分而治之、可伸缩、可扩展、接口服务化</li>
<li><strong>Freemarker</strong>：构建模块页，实现页面静态化</li>
</ul>
<h5 id="前置技能必备"><a href="#前置技能必备" class="headerlink" title="前置技能必备"></a>前置技能必备</h5><ul>
<li>Java基础</li>
<li>熟悉MySQL&#x2F;MariaDB</li>
<li>掌握Linux的基本命令</li>
</ul>
<h5 id="课程安排"><a href="#课程安排" class="headerlink" title="课程安排"></a>课程安排</h5><ul>
<li>前端构建与运行</li>
<li>后端手把手从0到1</li>
<li>中间件手把手部署</li>
</ul>
<img src="https://raw.githubusercontent.com/P-luminary/images/42c012bc7c8346dbe4070f43c67bfed16904e4a8/data/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%84%E6%9E%B6%E5%9B%BE.jpg" style="zoom: 80%;" />



<h3 id="前后端分离开发模式"><a href="#前后端分离开发模式" class="headerlink" title="前后端分离开发模式"></a>前后端分离开发模式</h3><h5 id="传统JavaWeb开发-与-前后端页面交互"><a href="#传统JavaWeb开发-与-前后端页面交互" class="headerlink" title="传统JavaWeb开发 与 前后端页面交互"></a>传统JavaWeb开发 与 前后端页面交互</h5><p><img src="https://raw.githubusercontent.com/P-luminary/images/1e5f4e27bd9ca7bf4ab7d4afebe373a9f06dc735/data/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F.png"></p>
<h3 id="运行前端项目"><a href="#运行前端项目" class="headerlink" title="运行前端项目"></a>运行前端项目</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/bugu_hhh/article/details/130625482?ops_request_misc=%7B%22request_id%22:%22171930111016800178595350%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=171930111016800178595350&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-2-130625482-null-null.142%5Ev100%5Epc_search_result_base9&utm_term=linux%E4%B8%8B%E5%AE%89%E8%A3%85mysql&spm=1018.2226.3001.4187">Linux 安装 MySQL【CentOS】_linux 安装mysql-CSDN博客</a></p>
<pre><code class="java">前端代码在压缩包中 启动D:\apache-tomcat-8.5.93\bin\startup.bat
将里面的imooc-news放到D:\apache-tomcat-8.5.93\webapps中
去浏览器中启动 http://localhost:9090/imooc-news/portal/index.html
</code></pre>
<h5 id="SwitchHosts"><a href="#SwitchHosts" class="headerlink" title="SwitchHosts"></a>SwitchHosts</h5><blockquote>
<p><a target="_blank" rel="noopener" href="https://oldj.github.io/SwitchHosts/">https://oldj.github.io/SwitchHosts/</a><br>在本地把域名和对应的IP給联系绑定起来 [相当于在云服务买了域名后绑定]</p>
<p> #imooc-news 127.0.0.1<br>[这东西需要关闭代理才可以用]</p>
<p>127.0.0.1 <a target="_blank" rel="noopener" href="http://www.imoocnews.com/">www.imoocnews.com</a><br>127.0.0.1 writer.imoocnews.com<br>127.0.0.1 admin.imoocnews.com</p>
<p>127.0.0.1 article.imoocnews.com<br>127.0.0.1 user.imoocnews.com<br>127.0.0.1 files.imoocnews.com</p>
</blockquote>
<h6 id="D-apache-tomcat-8-5-93-webapps-imooc-news-portal-js-app-js"><a href="#D-apache-tomcat-8-5-93-webapps-imooc-news-portal-js-app-js" class="headerlink" title="D:\apache-tomcat-8.5.93\webapps\imooc-news\portal\js\app.js"></a>D:\apache-tomcat-8.5.93\webapps\imooc-news\portal\js\app.js</h6><pre><code class="java">window.app = &#123;
    /* 
    portalIndexUrl: &quot;http://localhost:8080/imooc-news/portal/index.html&quot;,           // 门户首页地址
    writerIndexUrl: &quot;http://localhost:8080/imooc-news/writer/contentMng.html&quot;,      // 作家中心首页
    writerInfoUrl: &quot;http://localhost:8080/imooc-news/writer/accountInfo.html&quot;,     // 用户信息完善页面
    userServerUrl: &quot;http://192.168.1.5:8003&quot;,   // 用户服务后端接口地址
    */

    portalIndexUrl: &quot;http://www.imoocnews.com:9090/imooc-news/portal/index.html&quot;,           // 门户首页地址
    writerLoginUrl: &quot;http://writer.imoocnews.com:9090/imooc-news/writer/passport.html&quot;,      // 登录页面
    writerIndexUrl: &quot;http://writer.imoocnews.com:9090/imooc-news/writer/contentMng.html&quot;,      // 作家中心首页
    writerInfoUrl: &quot;http://writer.imoocnews.com:9090/imooc-news/writer/accountInfo.html&quot;,     // 用户信息完善页面
    adminCenterUrl: &quot;http://admin.imoocnews.com:9090/imooc-news/admin/contentReview.html&quot;,     // 运营管理平台主页

    userServerUrl: &quot;http://user.imoocnews.com:8003&quot;,        // 用户服务后端接口地址
    fsServerUrl: &quot;http://files.imoocnews.com:8004&quot;,         // 文件服务后端接口地址
    adminServerUrl: &quot;http://admin.imoocnews.com:8005&quot;,      // 运营管理服务后端接口地址
    articleServerUrl: &quot;http://article.imoocnews.com:8001&quot;,      // 文章服务后端接口地址

    /**
     * 如果本地使用localhost测试可以不使用，如果是ip或者域名测试，cookieDomain改为对应的ip或者域名
     * 例：
     *    ip：  192.168.1.111
     *    域名：   .imooc.com
     */
    cookieDomain: &quot;.imoocnews.com&quot;,  
    ......
&#125;
</code></pre>
<h3 id="数据库选型与数据导入"><a href="#数据库选型与数据导入" class="headerlink" title="数据库选型与数据导入"></a>数据库选型与数据导入</h3><ul>
<li>MySql 5.6&#x2F;5.7</li>
<li><strong>MariaDB</strong></li>
<li>Mysql 8.0</li>
</ul>
<pre><code class="java">表名                             注释
admin_user                      运营管理平台的admin级别用户    
app_user                      网站用户
article                          文章资讯表
category                      新闻资讯文章的分类(或称之为领域)
comments                      评论表
fans                          粉丝表，用户与粉丝的关联关系，粉丝本质也是用户
</code></pre>
<h3 id="构建Maven聚合工程"><a href="#构建Maven聚合工程" class="headerlink" title="构建Maven聚合工程"></a>构建Maven聚合工程</h3><blockquote>
<p>创建一个 imooc-news-dev 的Maven项目作为一个顶级工程项目</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/5fa77f452f8588a132ccd5a461663d1f8cc8b353/data/%E6%9E%84%E5%BB%BAmaven%E8%81%9A%E5%90%88%E5%B7%A5%E7%A8%8B.png"></p>
<pre><code class="xml">pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.imooc&lt;/groupId&gt;
    &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;pom&lt;/packaging&gt;
&lt;!--
    1.聚合工程可以分为顶级项目(顶级工程,父工程) 与子工程(子modele模块)
      这两者的关系其实就是父子继承关系, 子工程在maven中可以称为module,
      模块与模块之间是平级的,是可以相互依赖的
    2.子模块可以使用顶级工程中所有的资源(依赖), 子模块之间如果有要使用资源的话
      必须构建依赖(构建关系)
    3.一个顶级工程是可以由多个不同的子工程共同组合而成
--&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;
        &lt;relativePath /&gt; &lt;!--SpringBoot是和后续的SpringCLoud版本联系的--&gt;
    &lt;/parent&gt;

    &lt;properties&gt; &lt;!--属性文件参数 如果mysql是8以上 需要修改mysql的版本号--&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;

        &lt;mysql-connector-java.version&gt;8.0.33&lt;/mysql-connector-java.version&gt;
        &lt;mybatis-spring-boot-starter.version&gt;2.1.0&lt;/mybatis-spring-boot-starter.version&gt;
        &lt;mapper-spring-boot-starter.version&gt;2.1.5&lt;/mapper-spring-boot-starter.version&gt;
        &lt;pagehelper-spring-boot-starter.version&gt;1.2.12&lt;/pagehelper-spring-boot-starter.version&gt;

        &lt;okhttp.version&gt;4.2.2&lt;/okhttp.version&gt;
        &lt;jackson.version&gt;2.10.2&lt;/jackson.version&gt;

        &lt;commons-codec.version&gt;1.11&lt;/commons-codec.version&gt;
        &lt;commons-lang3.version&gt;3.4&lt;/commons-lang3.version&gt;
        &lt;commons-fileupload.version&gt;1.4&lt;/commons-fileupload.version&gt;
        &lt;google-guava.version&gt;28.2-jre&lt;/google-guava.version&gt;

        &lt;springfox-swagger2.version&gt;2.4.0&lt;/springfox-swagger2.version&gt;
        &lt;swagger-bootstrap-ui.version&gt;1.6&lt;/swagger-bootstrap-ui.version&gt;
        &lt;fastdfs.version&gt;1.27.2&lt;/fastdfs.version&gt;

        &lt;slf4j.version&gt;1.7.21&lt;/slf4j.version&gt;
        &lt;joda-time.version&gt;2.10.6&lt;/joda-time.version&gt;
    &lt;/properties&gt;

    &lt;!--
        使用dependencyManagement的目的是为了保证父工程的干净，
        也就是说父工程他只负责管理依赖，以及依赖的版本，而不会导入额外的jar依赖。
        如此一来父工程的职责就很单一了，而且也符合了面向对象开发的父子继承关系，
        依赖的导入只有在各自的子工程中才会进行导入。
    --&gt;
&lt;!--  ↓ 管理依赖 不会从外网下载具体jar包 只有在后续子模块配置的时候才会去配置
      为了保证父工程的干净,父工程中只负责管理依赖,以及依赖的版本,而不会导入额外的jar依赖
      如此一来父工程的职责就很单一了,而且也符合了面向对象开发的父子继承关系
      依赖的导入只有在各自的子工程中才会导入
 --&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;!-- SpringCloud 依赖 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;Hoxton.SR3&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;

            &lt;!-- 引入 mongodb 依赖 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
                &lt;artifactId&gt;mongodb-driver&lt;/artifactId&gt;
                &lt;!--mongodb-driver.version--&gt;
                &lt;version&gt;3.11.1&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- mysql 驱动  这样引用方便以后jar包依赖的升级--&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;mysql&lt;/groupId&gt;
                &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mysql-connector-java.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- mybatis --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
                &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mybatis-spring-boot-starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- 通用mapper逆向工具 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
                &lt;artifactId&gt;mapper-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mapper-spring-boot-starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!--pagehelper --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
                &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;pagehelper-spring-boot-starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!--服务和服务之间的请求--&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
                &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
                &lt;version&gt;$&#123;okhttp.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- jackson --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
                &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;
                &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
                &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- apache 工具类 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;commons-codec&lt;/groupId&gt;
                &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;
                &lt;version&gt;$&#123;commons-codec.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
                &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
                &lt;version&gt;$&#123;commons-lang3.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;
                &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;
                &lt;version&gt;$&#123;commons-fileupload.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- google 工具类 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
                &lt;artifactId&gt;guava&lt;/artifactId&gt;
                &lt;version&gt;$&#123;google-guava.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- swagger2 配置 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;io.springfox&lt;/groupId&gt;
                &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;
                &lt;version&gt;$&#123;springfox-swagger2.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;io.springfox&lt;/groupId&gt;
                &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;
                &lt;version&gt;$&#123;springfox-swagger2.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;
                &lt;artifactId&gt;swagger-bootstrap-ui&lt;/artifactId&gt;
                &lt;version&gt;$&#123;swagger-bootstrap-ui.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- 文件上传fdfs工具 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.tobato&lt;/groupId&gt;
                &lt;artifactId&gt;fastdfs-client&lt;/artifactId&gt;
                &lt;version&gt;$&#123;fastdfs.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- joda-time 时间工具 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;joda-time&lt;/groupId&gt;
                &lt;artifactId&gt;joda-time&lt;/artifactId&gt;
                &lt;version&gt;$&#123;joda-time.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;finalName&gt;$&#123;project.artifactId&#125;&lt;/finalName&gt;
        &lt;plugins&gt;
            &lt;!-- Java 编译 --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>
<h6 id="imooc-news-dev-common"><a href="#imooc-news-dev-common" class="headerlink" title="imooc-news-dev-common"></a>imooc-news-dev-common</h6><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
&lt;!--
    imooc-news-dev-common:
    通用工程
    包含了一些工具类,枚举类,封装的一些公共方法以及一些第三方组件等
--&gt;
    &lt;artifactId&gt;imooc-news-dev-common&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;

&lt;/project&gt;
</code></pre>
<h6 id="imooc-news-dev-model"><a href="#imooc-news-dev-model" class="headerlink" title="imooc-news-dev-model"></a>imooc-news-dev-model</h6><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
&lt;!--
    imooc-news-dev-model
    模型工程, 所有的子工程以及微服务中所涉及到的模型实体类都在此管理
    可以包含一些 *pojo,*Bean,*Entity,vo,bo,dto等
--&gt;

    &lt;artifactId&gt;imooc-news-dev-model&lt;/artifactId&gt;
    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
&lt;!--  子工程依赖common --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-common&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<h6 id="imooc-news-dev-service-api"><a href="#imooc-news-dev-service-api" class="headerlink" title="imooc-news-dev-service-api"></a>imooc-news-dev-service-api</h6><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;!--    imooc-news-dev-service-api
            接口工程,集中管理所有的controller中的接口,为了更好的统一管理微服务
    --&gt;
    &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-common&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<h6 id="imooc-news-dev-service-user"><a href="#imooc-news-dev-service-user" class="headerlink" title="imooc-news-dev-service-user"></a>imooc-news-dev-service-user</h6><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;artifactId&gt;imooc-news-dev-service-user&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;!--    引入SpringBoot依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<h6 id="imooc-news-dev-父"><a href="#imooc-news-dev-父" class="headerlink" title="imooc-news-dev [父]"></a>imooc-news-dev [父]</h6><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.imooc&lt;/groupId&gt;
    &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;pom&lt;/packaging&gt;
    &lt;modules&gt;
    &lt;!-- 这里是子模块[自动创建] 如果物理删除了子工程 这个不会自动删除的要手动删除--&gt;
        &lt;module&gt;imooc-news-dev-common&lt;/module&gt;
        &lt;module&gt;imooc-news-dev-model&lt;/module&gt;
        &lt;module&gt;imooc-news-dev-service-api&lt;/module&gt;
        &lt;module&gt;imooc-news-dev-service-user&lt;/module&gt;
        &lt;module&gt;imooc-news-dev-service-user&lt;/module&gt;
    &lt;/modules&gt;
    &lt;!--
        1.聚合工程可以分为顶级项目(顶级工程,父工程) 与子工程(子modele模块)
          这两者的关系其实就是父子继承关系, 子工程在maven中可以称为module,
          模块与模块之间是平级的,是可以相互依赖的
        2.子模块可以使用顶级工程中所有的资源(依赖), 子模块之间如果有要使用资源的话
          必须构建依赖(构建关系)
        3.一个顶级工程是可以由多个不同的子工程共同组合而成
    --&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;
        &lt;relativePath /&gt; &lt;!--SpringBoot是和后续的SpringCLoud版本联系的--&gt;
    &lt;/parent&gt;

    &lt;properties&gt; &lt;!--属性文件参数 如果mysql是8以上 需要修改mysql的版本号--&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;

        &lt;mysql-connector-java.version&gt;8.0.33&lt;/mysql-connector-java.version&gt;
        &lt;mybatis-spring-boot-starter.version&gt;2.1.0&lt;/mybatis-spring-boot-starter.version&gt;
        &lt;mapper-spring-boot-starter.version&gt;2.1.5&lt;/mapper-spring-boot-starter.version&gt;
        &lt;pagehelper-spring-boot-starter.version&gt;1.2.12&lt;/pagehelper-spring-boot-starter.version&gt;

        &lt;okhttp.version&gt;4.2.2&lt;/okhttp.version&gt;
        &lt;jackson.version&gt;2.10.2&lt;/jackson.version&gt;

        &lt;commons-codec.version&gt;1.11&lt;/commons-codec.version&gt;
        &lt;commons-lang3.version&gt;3.4&lt;/commons-lang3.version&gt;
        &lt;commons-fileupload.version&gt;1.4&lt;/commons-fileupload.version&gt;
        &lt;google-guava.version&gt;28.2-jre&lt;/google-guava.version&gt;

        &lt;springfox-swagger2.version&gt;2.4.0&lt;/springfox-swagger2.version&gt;
        &lt;swagger-bootstrap-ui.version&gt;1.6&lt;/swagger-bootstrap-ui.version&gt;
        &lt;fastdfs.version&gt;1.27.2&lt;/fastdfs.version&gt;

        &lt;slf4j.version&gt;1.7.21&lt;/slf4j.version&gt;
        &lt;joda-time.version&gt;2.10.6&lt;/joda-time.version&gt;
    &lt;/properties&gt;

    &lt;!--
        使用dependencyManagement的目的是为了保证父工程的干净，
        也就是说父工程他只负责管理依赖，以及依赖的版本，而不会导入额外的jar依赖。
        如此一来父工程的职责就很单一了，而且也符合了面向对象开发的父子继承关系，
        依赖的导入只有在各自的子工程中才会进行导入。
    --&gt;
&lt;!--  ↓ 管理依赖 不会从外网下载具体jar包 只有在后续子模块配置的时候才会去配置
      为了保证父工程的干净,夫工程中只负责管理依赖,以及依赖的版本,而不会导入额外的jar依赖
      如此一来父工程的职责就很单一了,而且也符合了面向对象开发的父子继承关系
      依赖的导入只有在各自的子工程中才会导入
 --&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;!-- SpringCloud 依赖 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;Hoxton.SR3&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;

            &lt;!-- 引入 mongodb 依赖 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
                &lt;artifactId&gt;mongodb-driver&lt;/artifactId&gt;
                &lt;!--mongodb-driver.version--&gt;
                &lt;version&gt;3.11.1&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- mysql 驱动  这样引用方便以后jar包依赖的升级--&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;mysql&lt;/groupId&gt;
                &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mysql-connector-java.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- mybatis --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
                &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mybatis-spring-boot-starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!-- 通用mapper逆向工具 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
                &lt;artifactId&gt;mapper-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;mapper-spring-boot-starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!--pagehelper --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
                &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;$&#123;pagehelper-spring-boot-starter.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;!--服务和服务之间的请求--&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
                &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
                &lt;version&gt;$&#123;okhttp.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- jackson --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
                &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;
                &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
                &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
                &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- apache 工具类 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;commons-codec&lt;/groupId&gt;
                &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;
                &lt;version&gt;$&#123;commons-codec.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
                &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
                &lt;version&gt;$&#123;commons-lang3.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;
                &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;
                &lt;version&gt;$&#123;commons-fileupload.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- google 工具类 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
                &lt;artifactId&gt;guava&lt;/artifactId&gt;
                &lt;version&gt;$&#123;google-guava.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- swagger2 配置 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;io.springfox&lt;/groupId&gt;
                &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;
                &lt;version&gt;$&#123;springfox-swagger2.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;io.springfox&lt;/groupId&gt;
                &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;
                &lt;version&gt;$&#123;springfox-swagger2.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;
                &lt;artifactId&gt;swagger-bootstrap-ui&lt;/artifactId&gt;
                &lt;version&gt;$&#123;swagger-bootstrap-ui.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- 文件上传fdfs工具 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.github.tobato&lt;/groupId&gt;
                &lt;artifactId&gt;fastdfs-client&lt;/artifactId&gt;
                &lt;version&gt;$&#123;fastdfs.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- joda-time 时间工具 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;joda-time&lt;/groupId&gt;
                &lt;artifactId&gt;joda-time&lt;/artifactId&gt;
                &lt;version&gt;$&#123;joda-time.version&#125;&lt;/version&gt;
            &lt;/dependency&gt;

        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;finalName&gt;$&#123;project.artifactId&#125;&lt;/finalName&gt;
        &lt;plugins&gt;
            &lt;!-- Java 编译 --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>
<pre><code class="java">com/imooc/user/controller/HelloController.java
package com.imooc.user.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController &#123;
    @GetMapping(&quot;/hello&quot;)
    public Object hello()&#123;
        return &quot;hello&quot;;
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/user/Application.java
package com.imooc.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="yaml">application.yml
############################################################
#
# 用户微服务
# web访问端口号  约定：8003
#
############################################################
server:
  port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: service-user
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
</code></pre>
<pre><code class="java">SwitchHosts【一定要先关闭代理 因为它会固定静态ip】
127.0.0.1 user.imoocnews.com

http://user.imoocnews.com:8003/hello
</code></pre>
<h3 id="api接口暴露"><a href="#api接口暴露" class="headerlink" title="api接口暴露"></a>api接口暴露</h3><h6 id="所有业务下不同的controller都要交给api统一接口去处理，把实现所对应的接口写进API内"><a href="#所有业务下不同的controller都要交给api统一接口去处理，把实现所对应的接口写进API内" class="headerlink" title="所有业务下不同的controller都要交给api统一接口去处理，把实现所对应的接口写进API内"></a>所有业务下不同的controller都要交给api统一接口去处理，把实现所对应的接口写进API内</h6><pre><code class="xml">把imooc-news-dev-service-user中的pom.xml中的关于SpringBoot的依赖
全部放入imooc-news-dev-service-api中
并且在imooc-news-dev-service-user中写入引用依赖
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
<pre><code class="java">【服务层依赖api层】
更改把user项目的HelloController 复制到dev-service-api 创建一个接口

...api
com/imooc/api/controller/user/HelloControllerApi.java
package com.imooc.api.controller.user;
import org.springframework.web.bind.annotation.GetMapping;

public interface HelloControllerApi &#123;
    /**
     * api的作用：
     * api就相当于企业的领导,老板,部门经理
     * 其他的服务层都是实现,他们就相当于员工,只做事情
     * 老板(开发人员)来看一下每个人(服务)的进度,做什么事
     * 老板不会去问员工,他只会对接部门经理
     * 这里所有的api接口就是统一在这里管理和调度的,微服务也如此
     */

    /**
     * 运作：
     * 现在的所有接口都在此暴露,实现都是在各自的微服务中
     * 本项目只写项目,不写实现,实现在各自的微服务工程中,因为以业务来划分的微服务有很多
     * Controller也会分散在各个微服务工程中,一旦多了就很难统一管理和查看
     *
     * 其次,微服务之间的调用都是基于接口的
     * 如果不这样做,微服务之间的调用就需要互相依赖了
     * 耦合对也就很高,接口的目的是为了能够提供解耦
     *
     * 此外,本项目的接口其实就是一套规范.实现都是由各自的工程去做的处理
     * 目前我们使用springboot作为接口的实现的
     * 如果未来以后出现新的java web框架,那么我们不需要修改接口
     * 只需要去修改对应的实现就可以了,这其实也是解耦的一个体现
     *
     * Swagger2, 基于接口的自动文档生成
     * 所有的配置文件只需要一份,就能再当前项目中去构建了
     * 管理起来很方便
     * 
     * 综上所述,这样做法可以提高多服务的项目可扩展性
     */
    @GetMapping(&quot;/hello&quot;)
    public Object hello();
&#125;


...user
com/imooc/user/controller/HelloController.java
package com.imooc.user.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    public Object hello()&#123;
        return &quot;hello&quot;;
    &#125;
&#125;
</code></pre>
<h3 id="配置logback日志与多环境profile"><a href="#配置logback日志与多环境profile" class="headerlink" title="配置logback日志与多环境profile"></a>配置logback日志与多环境profile</h3><h6 id="imooc-news-dev-service-user-1"><a href="#imooc-news-dev-service-user-1" class="headerlink" title="imooc-news-dev-service-user"></a>imooc-news-dev-service-user</h6><blockquote>
<p>先添加一个logback-spring.xml</p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration&gt;
    &lt;!-- 指定日志文件的存储地址，使用绝对路径 --&gt;
&lt;!--    &lt;property name=&quot;LOG_HOME&quot; value=&quot;/workspaces/logs/imooc-news-dev/service-admin&quot;/&gt;--&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;C:/Users/Pluminary/Desktop/imooc-news-dev&quot;/&gt;

    &lt;!-- Console 输出设置 --&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;
            &lt;pattern&gt;%white(%d&#123;mm:ss.SSS&#125;) %green([%thread]) %cyan(%-5level) %yellow(%logger&#123;36&#125;) %magenta(-) %black(%msg%n)&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 按照每天生成日志文件 --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- 日志文件输出的文件名 --&gt;
            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/service-user.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!--&lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;--&gt;
        &lt;!--&lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;--&gt;
    &lt;!--&lt;/logger&gt;--&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<pre><code class="java">com/imooc/user/controller/HelloController.java
package com.imooc.user.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);
    public Object hello()&#123;
        logger.debug(&quot;debug: hello~&quot;);
        logger.info(&quot;info: hello~&quot;);
        logger.warn(&quot;warn: hello~&quot;);
        logger.error(&quot;error: hello~&quot;);

        return &quot;hello&quot;;
    &#125;
&#125;
//重新启动后去页面刷新一下
......
29:22.373 [main] INFO  com.imooc.user.Application - Started Application in 1.061 seconds (JVM running for 1.543)
29:40.693 [http-nio-8003-exec-1] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring DispatcherServlet &#39;dispatcherServlet&#39;
29:40.694 [http-nio-8003-exec-1] INFO  o.s.web.servlet.DispatcherServlet - Initializing Servlet &#39;dispatcherServlet&#39;
29:40.696 [http-nio-8003-exec-1] INFO  o.s.web.servlet.DispatcherServlet - Completed initialization in 2 ms
29:40.707 [http-nio-8003-exec-1] INFO  c.i.user.controller.HelloController - info: hello~
29:40.707 [http-nio-8003-exec-1] WARN  c.i.user.controller.HelloController - warn: hello~
29:40.707 [http-nio-8003-exec-1] ERROR c.i.user.controller.HelloController - error: hello~
</code></pre>
<pre><code class="yaml">application.yml
############################################################
#
# 用户微服务
# web访问端口号  约定：8003
#
############################################################
server:
# port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-user
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
</code></pre>
<pre><code class="java">application-dev.yml
server:
  port: 8003


application-prod.yml
server:
  port: 8130
</code></pre>
<h3 id="优雅的返回封装结果"><a href="#优雅的返回封装结果" class="headerlink" title="优雅的返回封装结果"></a>优雅的返回封装结果</h3><pre><code class="java">com/imooc/user/controller/HelloController.java
package com.imooc.user.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.IMOOCJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);
    public Object hello()&#123;
        logger.debug(&quot;debug: hello~&quot;);
        logger.info(&quot;info: hello~&quot;);
        logger.warn(&quot;warn: hello~&quot;);
        logger.error(&quot;error: hello~&quot;);

//        return &quot;hello&quot;;
//        return IMOOCJSONResult.ok();
//        return IMOOCJSONResult.ok(&quot;hello!&quot;);
        return IMOOCJSONResult.errorMsg(&quot;您的信息有误&quot;);
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/grace/result/IMOOCJSONResult.java
package com.imooc.grace.result;

/**
 * 
 * @Title: IMOOCJSONResult.java
 * @Package com.imooc.utils
 * @Description: 自定义响应数据结构
 *                 本类可提供给 H5/ios/安卓/公众号/小程序 使用
 *                 前端接受此类数据（json object)后，可自行根据业务去实现相关功能
 * 
 *                 200：表示成功
 *                 500：表示错误，错误信息在msg字段中
 *                 501：bean验证错误，不管多少个错误都以map形式返回
 *                 502：拦截器拦截到用户token出错
 *                 555：异常抛出信息
 *                 556: 用户qq校验异常
 *                 557: 校验用户是否在CAS登录，用户门票的校验
 * @Copyright: Copyright (c) 2020
 * @Company: www.imooc.com
 * @author 慕课网 - 风间影月
 * @version V1.0
 * 这样太麻烦了 直接用枚举类
 */
public class IMOOCJSONResult &#123;

    // 响应业务状态
    private Integer status;

    // 响应消息
    private String msg;

    // 响应中的数据
    private Object data;
    
    private String ok;    // 不使用

    public static IMOOCJSONResult build(Integer status, String msg, Object data) &#123;
        return new IMOOCJSONResult(status, msg, data);
    &#125;

    public static IMOOCJSONResult build(Integer status, String msg, Object data, String ok) &#123;
        return new IMOOCJSONResult(status, msg, data, ok);
    &#125;
    
    public static IMOOCJSONResult ok(Object data) &#123;
        return new IMOOCJSONResult(data);
    &#125;

    public static IMOOCJSONResult ok() &#123;
        return new IMOOCJSONResult(null);
    &#125;
    
    public static IMOOCJSONResult errorMsg(String msg) &#123;
        return new IMOOCJSONResult(500, msg, null);
    &#125;

    public static IMOOCJSONResult errorUserTicket(String msg) &#123;
        return new IMOOCJSONResult(557, msg, null);
    &#125;
    
    public static IMOOCJSONResult errorMap(Object data) &#123;
        return new IMOOCJSONResult(501, &quot;error&quot;, data);
    &#125;
    
    public static IMOOCJSONResult errorTokenMsg(String msg) &#123;
        return new IMOOCJSONResult(502, msg, null);
    &#125;
    
    public static IMOOCJSONResult errorException(String msg) &#123;
        return new IMOOCJSONResult(555, msg, null);
    &#125;
    
    public static IMOOCJSONResult errorUserQQ(String msg) &#123;
        return new IMOOCJSONResult(556, msg, null);
    &#125;

    public IMOOCJSONResult() &#123;

    &#125;

    public IMOOCJSONResult(Integer status, String msg, Object data) &#123;
        this.status = status;
        this.msg = msg;
        this.data = data;
    &#125;
    
    public IMOOCJSONResult(Integer status, String msg, Object data, String ok) &#123;
        this.status = status;
        this.msg = msg;
        this.data = data;
        this.ok = ok;
    &#125;

    public IMOOCJSONResult(Object data) &#123;
        this.status = 200;
        this.msg = &quot;OK&quot;;
        this.data = data;
    &#125; Getter+Setter
</code></pre>
<h6 id="这样太麻烦而且观察起来不方便-升级一下变成枚举类-更加优雅！"><a href="#这样太麻烦而且观察起来不方便-升级一下变成枚举类-更加优雅！" class="headerlink" title="这样太麻烦而且观察起来不方便 升级一下变成枚举类 更加优雅！"></a>这样太麻烦而且观察起来不方便 升级一下变成枚举类 更加优雅！</h6><pre><code class="java">com/imooc/user/controller/HelloController.java
package com.imooc.user.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.IMOOCJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);
    public Object hello()&#123;
        logger.debug(&quot;debug: hello~&quot;);
        logger.info(&quot;info: hello~&quot;);
        logger.warn(&quot;warn: hello~&quot;);
        logger.error(&quot;error: hello~&quot;);

//        return &quot;hello&quot;;
//        return IMOOCJSONResult.ok();
//        return IMOOCJSONResult.ok(&quot;hello!&quot;);
//        return IMOOCJSONResult.errorMsg(&quot;您的信息有误&quot;);
        return GraceJSONResult.errorCustom(ResponseStatusEnum.NO_AUTH);
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/grace/result/GraceJSONResult.java
package com.imooc.grace.result;

import java.util.Map;

/**
 * 自定义响应数据类型枚举升级版本
 *
 * @Title: IMOOCJSONResult.java
 * @Package com.imooc.utils
 * @Description: 自定义响应数据结构
 *                 本类可提供给 H5/ios/安卓/公众号/小程序 使用
 *                 前端接受此类数据（json object)后，可自行根据业务去实现相关功能
 *
 * @Copyright: Copyright (c) 2020
 * @Company: www.imooc.com
 * @author 慕课网 - 风间影月
 * @version V2.0
 */
public class GraceJSONResult &#123;

    // 响应业务状态码
    private Integer status;

    // 响应消息
    private String msg;

    // 是否成功
    private Boolean success;

    // 响应数据，可以是Object，也可以是List或Map等
    private Object data;

    /**
     * 成功返回，带有数据的，直接往OK方法丢data数据即可
     * @param data
     * @return
     */
    public static GraceJSONResult ok(Object data) &#123;
        return new GraceJSONResult(data);
    &#125;
    /**
     * 成功返回，不带有数据的，直接调用ok方法，data无须传入（其实就是null）
     * @return
     */
    public static GraceJSONResult ok() &#123;
        return new GraceJSONResult(ResponseStatusEnum.SUCCESS);
    &#125;
    public GraceJSONResult(Object data) &#123;
        this.status = ResponseStatusEnum.SUCCESS.status();
        this.msg = ResponseStatusEnum.SUCCESS.msg();
        this.success = ResponseStatusEnum.SUCCESS.success();
        this.data = data;
    &#125;


    /**
     * 错误返回，直接调用error方法即可，当然也可以在ResponseStatusEnum中自定义错误后再返回也都可以
     * @return
     */
    public static GraceJSONResult error() &#123;
        return new GraceJSONResult(ResponseStatusEnum.FAILED);
    &#125;

    /**
     * 错误返回，map中包含了多条错误信息，可以用于表单验证，把错误统一的全部返回出去
     * @param map
     * @return
     */
    public static GraceJSONResult errorMap(Map map) &#123;
        return new GraceJSONResult(ResponseStatusEnum.FAILED, map);
    &#125;

    /**
     * 错误返回，直接返回错误的消息
     * @param msg
     * @return
     */
    public static GraceJSONResult errorMsg(String msg) &#123;
        return new GraceJSONResult(ResponseStatusEnum.FAILED, msg);
    &#125;

    /**
     * 错误返回，token异常，一些通用的可以在这里统一定义
     * @return
     */
    public static GraceJSONResult errorTicket() &#123;
        return new GraceJSONResult(ResponseStatusEnum.TICKET_INVALID);
    &#125;

    /**
     * 自定义错误范围，需要传入一个自定义的枚举，可以到[ResponseStatusEnum.java[中自定义后再传入
     * @param responseStatus
     * @return
     */
    public static GraceJSONResult errorCustom(ResponseStatusEnum responseStatus) &#123;
        return new GraceJSONResult(responseStatus);
    &#125;
    public static GraceJSONResult exception(ResponseStatusEnum responseStatus) &#123;
        return new GraceJSONResult(responseStatus);
    &#125;

    public GraceJSONResult(ResponseStatusEnum responseStatus) &#123;
        this.status = responseStatus.status();
        this.msg = responseStatus.msg();
        this.success = responseStatus.success();
    &#125;
    public GraceJSONResult(ResponseStatusEnum responseStatus, Object data) &#123;
        this.status = responseStatus.status();
        this.msg = responseStatus.msg();
        this.success = responseStatus.success();
        this.data = data;
    &#125;
    public GraceJSONResult(ResponseStatusEnum responseStatus, String msg) &#123;
        this.status = responseStatus.status();
        this.msg = msg;
        this.success = responseStatus.success();
    &#125;Getter+Setter
&#125;
</code></pre>
<pre><code class="java">com/imooc/grace/result/ResponseStatusEnum.java
package com.imooc.grace.result;

/**
 * 响应结果枚举，用于提供给GraceJSONResult返回给前端的
 * 本枚举类中包含了很多的不同的状态码供使用，可以自定义
 * 便于更优雅的对状态码进行管理，一目了然
 */
public enum ResponseStatusEnum &#123;

    SUCCESS(200, true, &quot;操作成功！&quot;),
    FAILED(500, false, &quot;操作失败！&quot;),

    // 50x
    UN_LOGIN(501,false,&quot;请登录后再继续操作！&quot;),
    TICKET_INVALID(502,false,&quot;会话失效，请重新登录！&quot;),
    NO_AUTH(503,false,&quot;您的权限不足，无法继续操作！&quot;),
    MOBILE_ERROR(504,false,&quot;短信发送失败，请稍后重试！&quot;),
    SMS_NEED_WAIT_ERROR(505,false,&quot;短信发送太快啦~请稍后再试！&quot;),
    SMS_CODE_ERROR(506,false,&quot;验证码过期或不匹配，请稍后再试！&quot;),
    USER_FROZEN(507,false,&quot;用户已被冻结，请联系管理员！&quot;),
    USER_UPDATE_ERROR(508,false,&quot;用户信息更新失败，请联系管理员！&quot;),
    USER_INACTIVE_ERROR(509,false,&quot;请前往[账号设置]修改信息激活后再进行后续操作！&quot;),
    FILE_UPLOAD_NULL_ERROR(510,false,&quot;文件不能为空，请选择一个文件再上传！&quot;),
    FILE_UPLOAD_FAILD(511,false,&quot;文件上传失败！&quot;),
    FILE_FORMATTER_FAILD(512,false,&quot;文件图片格式不支持！&quot;),
    FILE_MAX_SIZE_ERROR(513,false,&quot;仅支持500kb大小以下的图片上传！&quot;),
    FILE_NOT_EXIST_ERROR(514,false,&quot;你所查看的文件不存在！&quot;),
    USER_STATUS_ERROR(515,false,&quot;用户状态参数出错！&quot;),
    USER_NOT_EXIST_ERROR(516,false,&quot;用户不存在！&quot;),

    // 自定义系统级别异常 54x
    SYSTEM_INDEX_OUT_OF_BOUNDS(541, false, &quot;系统错误，数组越界！&quot;),
    SYSTEM_ARITHMETIC_BY_ZERO(542, false, &quot;系统错误，无法除零！&quot;),
    SYSTEM_NULL_POINTER(543, false, &quot;系统错误，空指针！&quot;),
    SYSTEM_NUMBER_FORMAT(544, false, &quot;系统错误，数字转换异常！&quot;),
    SYSTEM_PARSE(545, false, &quot;系统错误，解析异常！&quot;),
    SYSTEM_IO(546, false, &quot;系统错误，IO输入输出异常！&quot;),
    SYSTEM_FILE_NOT_FOUND(547, false, &quot;系统错误，文件未找到！&quot;),
    SYSTEM_CLASS_CAST(548, false, &quot;系统错误，类型强制转换错误！&quot;),
    SYSTEM_PARSER_ERROR(549, false, &quot;系统错误，解析出错！&quot;),
    SYSTEM_DATE_PARSER_ERROR(550, false, &quot;系统错误，日期解析出错！&quot;),

    // admin 管理系统 56x
    ADMIN_USERNAME_NULL_ERROR(561, false, &quot;管理员登录名不能为空！&quot;),
    ADMIN_USERNAME_EXIST_ERROR(562, false, &quot;管理员登录名已存在！&quot;),
    ADMIN_NAME_NULL_ERROR(563, false, &quot;管理员负责人不能为空！&quot;),
    ADMIN_PASSWORD_ERROR(564, false, &quot;密码不能为空后者两次输入不一致！&quot;),
    ADMIN_CREATE_ERROR(565, false, &quot;添加管理员失败！&quot;),
    ADMIN_PASSWORD_NULL_ERROR(566, false, &quot;密码不能为空！&quot;),
    ADMIN_NOT_EXIT_ERROR(567, false, &quot;管理员不存在或密码错误！&quot;),
    ADMIN_FACE_NULL_ERROR(568, false, &quot;人脸信息不能为空！&quot;),
    ADMIN_FACE_LOGIN_ERROR(569, false, &quot;人脸识别失败，请重试！&quot;),
    CATEGORY_EXIST_ERROR(570, false, &quot;文章分类已存在，请换一个分类名！&quot;),

    // 媒体中心 相关错误 58x
    ARTICLE_COVER_NOT_EXIST_ERROR(580, false, &quot;文章封面不存在，请选择一个！&quot;),
    ARTICLE_CATEGORY_NOT_EXIST_ERROR(581, false, &quot;请选择正确的文章领域！&quot;),
    ARTICLE_CREATE_ERROR(582, false, &quot;创建文章失败，请重试或联系管理员！&quot;),
    ARTICLE_QUERY_PARAMS_ERROR(583, false, &quot;文章列表查询参数错误！&quot;),
    ARTICLE_DELETE_ERROR(584, false, &quot;文章删除失败！&quot;),
    ARTICLE_WITHDRAW_ERROR(585, false, &quot;文章撤回失败！&quot;),
    ARTICLE_REVIEW_ERROR(585, false, &quot;文章审核出错！&quot;),
    ARTICLE_ALREADY_READ_ERROR(586, false, &quot;文章重复阅读！&quot;),

    // 人脸识别错误代码
    FACE_VERIFY_TYPE_ERROR(600, false, &quot;人脸比对验证类型不正确！&quot;),
    FACE_VERIFY_LOGIN_ERROR(601, false, &quot;人脸登录失败！&quot;),

    // 系统错误，未预期的错误 555
    SYSTEM_ERROR(555, false, &quot;系统繁忙，请稍后再试！&quot;),
    SYSTEM_OPERATION_ERROR(556, false, &quot;操作失败，请重试或联系管理员&quot;),
    SYSTEM_RESPONSE_NO_INFO(557, false, &quot;&quot;);


    // 响应业务状态
    private Integer status;
    // 调用是否成功
    private Boolean success;
    // 响应消息，可以为成功或者失败的消息
    private String msg;

    ResponseStatusEnum(Integer status, Boolean success, String msg) &#123;
        this.status = status;
        this.success = success;
        this.msg = msg;
    &#125;

    public Integer status() &#123;
        return status;
    &#125;
    public Boolean success() &#123;
        return success;
    &#125;
    public String msg() &#123;
        return msg;
    &#125;
&#125;
</code></pre>
<pre><code class="java">&#123;
    &quot;status&quot;: 200,
    &quot;msg&quot;: &quot;操作成功！&quot;,
    &quot;success&quot;: true,
    &quot;data&quot;: null
&#125;
</code></pre>
<h3 id="配置数据库逆向生成实体类"><a href="#配置数据库逆向生成实体类" class="headerlink" title="配置数据库逆向生成实体类"></a>配置数据库逆向生成实体类</h3><h6 id="引入mybatis-generator-database-新建工程项目"><a href="#引入mybatis-generator-database-新建工程项目" class="headerlink" title="引入mybatis-generator-database[新建工程项目]"></a>引入mybatis-generator-database[新建工程项目]</h6><pre><code class="xml">pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.imooc&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-generator-database&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;


    &lt;dependencies&gt;

        &lt;!-- 引入log4j日志依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-log4j&lt;/artifactId&gt;
            &lt;version&gt;1.3.8.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 阿里开源数据源 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.1.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;5.1.41&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!--mybatis--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.3.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--mapper--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
            &lt;artifactId&gt;mapper-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.2.4&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--pagehelper--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
            &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.2.3&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- mybatis 逆向生成工具  --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt;
            &lt;version&gt;1.3.2&lt;/version&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<h3 id="整合Mybatis"><a href="#整合Mybatis" class="headerlink" title="整合Mybatis"></a>整合Mybatis</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaoheihai666/article/details/125936493">dependencymanagement 无法引入包依赖-CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/stKAnic/article/details/121380871?spm=1001.2101.3001.6650.4&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-4-121380871-blog-121295199.235%5Ev43%5Epc_blog_bottom_relevance_base6&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-4-121380871-blog-121295199.235%5Ev43%5Epc_blog_bottom_relevance_base6">关于Maven依赖dependency无法引入的问题_<dependencymanagement> 无法引入包-CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46411355/article/details/131312807">Maven配置仓库、阿里云镜像、环境变量（史上最全最详细）_maven配置阿里云镜像-CSDN博客</a></p>
<pre><code class="java">将mybatis-generator-database中的pojo[AppUser+Fans]复制转移到imooc-news-dev-model com/imooc/pojo中
将mybatis-generator-database中的com/imooc/user/mapper[AppUserMapper、FansMapper]复制转移到imooc-news-service-user com/imooc/user/mapper中
所有的服务都是要实现API的
将mybatis-generator-database中的com/imooc/my/mapper[MyMapper]复制转移到imooc-news-dev-service-api com/imooc/my/mapper中
将..database中的resources的mapper[AppUserMapper.xml、FansMapper.xml]转移到...service-user的resources的mapper中
</code></pre>
<pre><code class="yaml">imooc-news-dev-service-user中的resources的application.yml
############################################################
#
# 用户微服务
# web访问端口号  约定：8003
#
############################################################
server:
# port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-user
  datasource: # 数据源的相关配置
    type: com.zaxxer.hikari.HikariDataSource          # 数据源类型：HikariCP
    driver-class-name: com.mysql.jdbc.Driver          # mysql驱动
    url: jdbc:mysql://localhost:3306/imooc-news-dev?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true
    username: root
    password: root
    hikari:
      connection-timeout: 30000       # 等待连接池分配连接的最大时长（毫秒），超过这个时长还没可用的连接则发生SQLException， 默认:30秒
      minimum-idle: 5                 # 最小连接数
      maximum-pool-size: 20           # 最大连接数
      auto-commit: true               # 自动提交
      idle-timeout: 600000            # 连接超时的最大时长（毫秒），超时则被释放（retired），默认:10分钟
      pool-name: DateSourceHikariCP     # 连接池名字
      max-lifetime: 1800000           # 连接的生命时长（毫秒），超时而且没被使用则被释放（retired），默认:30分钟 1800000ms
      connection-test-query: SELECT 1
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
############################################################
#
# mybatis 配置
#
############################################################
mybatis:
  type-aliases-package: com.imooc.pojo          # 所有POJO类所在包路径
  mapper-locations: classpath:mapper/*.xml      # mapper映射文件

############################################################
#
# mybatis mapper 配置
#
############################################################
# 通用 Mapper 配置
mapper:
  mappers: com.imooc.my.mapper.MyMapper
  not-empty: false    # 在进行数据库操作的的时候，判断表达式 username != null, 是否追加 username != &#39;&#39;
  identity: MYSQL
# 分页插件配置
pagehelper:
  helperDialect: mysql
  supportMethodsArguments: true
</code></pre>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hkdhkdhkd/article/details/113869035">【解决】SLF4J: Class path contains multiple SLF4J bindings._启动metastore时slf4j: class path contains multiple sl-CSDN博客</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huifeidezhuzai/p/16352608.html">整合MongoDB踩坑记录及解决方法 - 会飞的猪仔 - 博客园 (cnblogs.com)</a></p>
<pre><code class="java">com/imooc/user/Application.java
package com.imooc.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.user.mapper&quot;)
@ComponentScan(&quot;com.imooc&quot;)
public class Application &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<h3 id="Swagger2接口文檔工具的使用"><a href="#Swagger2接口文檔工具的使用" class="headerlink" title="Swagger2接口文檔工具的使用"></a>Swagger2接口文檔工具的使用</h3><h6 id="imooc-news-dev-service-api-1"><a href="#imooc-news-dev-service-api-1" class="headerlink" title="imooc-news-dev-service-api"></a>imooc-news-dev-service-api</h6><pre><code class="xml">&lt;!-- swagger2 配置 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.springfox&lt;/groupId&gt;
            &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;
            &lt;version&gt;$&#123;springfox-swagger2.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.springfox&lt;/groupId&gt;
            &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;
            &lt;version&gt;$&#123;springfox-swagger2.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;
            &lt;artifactId&gt;swagger-bootstrap-ui&lt;/artifactId&gt;
            &lt;version&gt;$&#123;swagger-bootstrap-ui.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">com/imooc/api/config/Swagger2.java
package com.imooc.api.config;

import com.google.common.base.Predicate;
import com.google.common.base.Predicates;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.RequestHandler;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

@Configuration //Springboot啓動的時候會被掃描到并且加載
@EnableSwagger2
public class Swagger2 &#123;

    //    http://localhost:8088/swagger-ui.html     原路径
//http://user.imoocnews.com:8003/swagger-ui.htm
    //    http://localhost:8088/doc.html            新路径
//http://user.imoocnews.com:8003/doc.html

    // 配置swagger2核心配置 docket
    @Bean
    public Docket createRestApi() &#123;
        Predicate&lt;RequestHandler&gt; adminPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.admin.controller&quot;);
//        Predicate&lt;RequestHandler&gt; articlePredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.article.controller&quot;);
        Predicate&lt;RequestHandler&gt; userPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.user.controller&quot;);
        Predicate&lt;RequestHandler&gt; filesPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.files.controller&quot;);

        return new Docket(DocumentationType.SWAGGER_2)  // 指定api类型为swagger2
                .apiInfo(apiInfo())                 // 用于定义api文档汇总信息
                .select()
                .apis(Predicates.or(userPredicate, adminPredicate, filesPredicate))
//                .apis(Predicates.or(adminPredicate, articlePredicate, userPredicate, filesPredicate))
                .paths(PathSelectors.any())         // 所有controller
                .build();
    &#125;

    private ApiInfo apiInfo() &#123;
        return new ApiInfoBuilder()
                .title(&quot;慕课新闻·自媒体接口api&quot;)                       // 文档页标题
                .contact(new Contact(&quot;imooc&quot;,
                        &quot;https://www.imooc.com&quot;,
                        &quot;abc@imooc.com&quot;))                   // 联系人信息
                .description(&quot;专为慕课新闻·自媒体平台提供的api文档&quot;)      // 详细信息
                .version(&quot;1.0.1&quot;)                               // 文档版本号
                .termsOfServiceUrl(&quot;https://www.imooc.com&quot;)     // 网站地址
                .build();
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/api/controller/user/HelloControllerApi.java
package com.imooc.api.controller.user;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

@Api(value = &quot;controller的標題&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
public interface HelloControllerApi &#123;
    @ApiOperation(value = &quot;hello方法的接口&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/hello&quot;)
    public Object hello();
&#125;
</code></pre>
<p>[maven-之Lifecycle详解_maven lifecycle-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39505065/article/details/102915403#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86">https://blog.csdn.net/qq_39505065/article/details/102915403#第三部分</a> PS)</p>
<blockquote>
<p>Maven中的Lifecycle的install是什麽 ？<br>将包安装到本地存储库中，作为本地其他项目的依赖项</p>
</blockquote>
<h3 id="梳理短信登錄注冊流程"><a href="#梳理短信登錄注冊流程" class="headerlink" title="梳理短信登錄注冊流程"></a>梳理短信登錄注冊流程</h3><ul>
<li>短信登录注册</li>
<li>短信验证码发送与限制</li>
<li>分布式会话</li>
<li>用户信息完善，OSS&#x2F;FastDFS文件上传</li>
<li>AOP日志监控</li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/87e42b65e3e64f84efebcf347d7bd0180b448627/data/%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B.png"></p>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/e4dcd13c468e5883cfd3187c6c2800cf2bc4168f/data/%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C2.png"></p>
<pre><code class="xml">aliyun.properties
#这里需要去阿里云上购买短信验证 [电脑aliyun_Key.txt有]
aliyun.accessKeyID=
aliyun.accessKeySecret=
</code></pre>
<p><a target="_blank" rel="noopener" href="https://next.api.aliyun.com/api/Dysmsapi/2017-05-25/SendSms?params=%7B%22SignName%22:%22%E5%B0%8F%E6%BD%98%E7%A7%91%E6%8A%80%22,%22TemplateCode%22:%22SMS_467115116%22,%22PhoneNumbers%22:%2215027597319%22,%22TemplateParam%22:%22%7B%22code%22:%221234%22%7D%22%7D">SendSms_短信服务_API调试-阿里云OpenAPI开发者门户 (aliyun.com)</a><br><a target="_blank" rel="noopener" href="https://next.api.aliyun.com/api-tools/demo/Dysmsapi/db7e1211-14e0-4b7b-9011-037dfb85d42e">短信发送并查询示例_短信服务_示例中心-阿里云OpenAPI开发者门户 (aliyun.com)</a><br><a target="_blank" rel="noopener" href="https://ram.console.aliyun.com/manage/ak">RAM 访问控制 (aliyun.com)</a><br><a target="_blank" rel="noopener" href="https://dysms.console.aliyun.com/overview">短信服务 (aliyun.com)</a><br><a target="_blank" rel="noopener" href="https://ecs.console.aliyun.com/server/i-bp1dssknxftmjczbtpnd/detail?regionId=cn-hangzhou">云服务器管理控制台 (aliyun.com)</a></p>
<pre><code class="xml">【imooc-news-dev-common】
pom.xml
加入springboot依赖包
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
&lt;!--
    imooc-news-dev-common:
    通用工程
    包含了一些工具类,枚举类,封装的一些公共方法以及一些第三方组件等
--&gt;
    &lt;artifactId&gt;imooc-news-dev-common&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;!--    引入SpringBoot依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--  第三方云厂商相关依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-java-sdk-core&lt;/artifactId&gt;
            &lt;version&gt;4.5.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<pre><code class="java">com/imooc/utils/extend/AliyunResource.java
package com.imooc.utils.extend;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.PropertySource;
import org.springframework.stereotype.Component;

@Component
@PropertySource(&quot;classpath:aliyun.properties&quot;)
@ConfigurationProperties(prefix = &quot;aliyun&quot;) //这里是前缀
public class AliyunResource &#123;
    private String accessKeyID;
    private String accessKeySecret;

    public String getAccessKeyID() &#123;
        return accessKeyID;
    &#125;

    public void setAccessKeyID(String accessKeyID) &#123;
        this.accessKeyID = accessKeyID;
    &#125;

    public String getAccessKeySecret() &#123;
        return accessKeySecret;
    &#125;

    public void setAccessKeySecret(String accessKeySecret) &#123;
        this.accessKeySecret = accessKeySecret;
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/utils/SMSUtils.java
package com.imooc.utils;

import com.aliyuncs.CommonRequest;
import com.aliyuncs.CommonResponse;
import com.aliyuncs.DefaultAcsClient;
import com.aliyuncs.IAcsClient;
import com.aliyuncs.exceptions.ClientException;
import com.aliyuncs.exceptions.ServerException;
import com.aliyuncs.http.MethodType;
import com.aliyuncs.profile.DefaultProfile;
import com.imooc.utils.extend.AliyunResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component //工具类 可以作为组件
public class SMSUtils &#123;
    @Autowired
    public AliyunResource aliyunResource;
    final static Logger logger = LoggerFactory.getLogger(SMSUtils.class);
    public void sendSMS(String mobile, String code) &#123;
        DefaultProfile profile = DefaultProfile.getProfile(&quot;cn-hangzhou&quot;,
                aliyunResource.getAccessKeyID(),
                aliyunResource.getAccessKeySecret());
        IAcsClient client = new DefaultAcsClient(profile);

        CommonRequest request = new CommonRequest();
        request.setSysMethod(MethodType.POST);
        request.setSysDomain(&quot;dysmsapi.aliyuncs.com&quot;);
        request.setSysVersion(&quot;2017-05-25&quot;);
        request.setSysAction(&quot;SendSms&quot;);
        request.putQueryParameter(&quot;RegionId&quot;, &quot;cn-hangzhou&quot;);
        //给对方发送的手机号
        request.putQueryParameter(&quot;PhoneNumbers&quot;, mobile);
        request.putQueryParameter(&quot;SignName&quot;, &quot;小潘科技&quot;);//控制台可以添加签名
        request.putQueryParameter(&quot;TemplateCode&quot;, &quot;SMS_467115116&quot;);
        request.putQueryParameter(&quot;TemplateParam&quot;, &quot;&#123;\&quot;code\&quot;:\&quot;&quot; + code + &quot;\&quot;&#125;&quot;);//JSON对象字符串
        try &#123;
            CommonResponse response = client.getCommonResponse(request);
            System.out.println(response.getData());
            // 打印阿里云API的响应结果
            logger.info(&quot;Aliyun SMS API response: &quot; + response.getData());
        &#125; catch (ServerException e) &#123;
            e.printStackTrace();
            logger.error(&quot;ServerException: &quot; + e.getMessage());
        &#125; catch (ClientException e) &#123;
            e.printStackTrace();
            logger.error(&quot;ClientException: &quot; + e.getMessage());
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/api/controller/user/PassportControllerApi.java[接口]
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode();
&#125;
</code></pre>
<pre><code class="java">com/imooc/user/controller/PassportController.java
package com.imooc.user.controller;

import com.imooc.api.controller.user.PassportControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.utils.SMSUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(&quot;passport&quot;)
public class PassportController implements PassportControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(PassportController.class);

    @Autowired
    private SMSUtils smsUtils;
    // 这里去除的原因是因为新建了一个BaseController 在里面有信息 且在这加个extends
    //    @Autowired
    //    private RedisOperator redis;

    @Override
    public GraceJSONResult getSMSCode()&#123;
        // 生成6位随机验证码
        String random = String.valueOf((int)((Math.random() * 9 + 1) * 100000));
        // 打印生成的验证码以便调试
        logger.info(&quot;Generated SMS code: &quot; + random);
//        String random = ((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
        smsUtils.sendSMS(&quot;15027597319&quot;,random);//可以用MyInfo.getMobile代替
        // 记录发送短信的结果（添加日志）
        logger.info(&quot;SMS sent to 15027597000 with code: &quot; + random);

        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/grace/result/GraceJSONResult.java
package com.imooc.grace.result;

import java.util.Map;

/**
 * 自定义响应数据类型枚举升级版本
 *
 * @Title: IMOOCJSONResult.java
 * @Package com.imooc.utils
 * @Description: 自定义响应数据结构
 *                 本类可提供给 H5/ios/安卓/公众号/小程序 使用
 *                 前端接受此类数据（json object)后，可自行根据业务去实现相关功能
 *
 * @Copyright: Copyright (c) 2020
 * @Company: www.imooc.com
 * @author 慕课网 - 风间影月
 * @version V2.0
 */
public class GraceJSONResult &#123;

    // 响应业务状态码
    private Integer status;

    // 响应消息
    private String msg;

    // 是否成功
    private Boolean success;

    // 响应数据，可以是Object，也可以是List或Map等
    private Object data;

    /**
     * 成功返回，带有数据的，直接往OK方法丢data数据即可
     * @param data
     * @return
     */
    public static GraceJSONResult ok(Object data) &#123;
        return new GraceJSONResult(data);
    &#125;
    /**
     * 成功返回，不带有数据的，直接调用ok方法，data无须传入（其实就是null）
     * @return
     */
    public static GraceJSONResult ok() &#123;
        return new GraceJSONResult(ResponseStatusEnum.SUCCESS);
    &#125;
    public GraceJSONResult(Object data) &#123;
        this.status = ResponseStatusEnum.SUCCESS.status();
        this.msg = ResponseStatusEnum.SUCCESS.msg();
        this.success = ResponseStatusEnum.SUCCESS.success();
        this.data = data;
    &#125;


    /**
     * 错误返回，直接调用error方法即可，当然也可以在ResponseStatusEnum中自定义错误后再返回也都可以
     * @return
     */
    public static GraceJSONResult error() &#123;
        return new GraceJSONResult(ResponseStatusEnum.FAILED);
    &#125;

    /**
     * 错误返回，map中包含了多条错误信息，可以用于表单验证，把错误统一的全部返回出去
     * @param map
     * @return
     */
    public static GraceJSONResult errorMap(Map map) &#123;
        return new GraceJSONResult(ResponseStatusEnum.FAILED, map);
    &#125;

    /**
     * 错误返回，直接返回错误的消息
     * @param msg
     * @return
     */
    public static GraceJSONResult errorMsg(String msg) &#123;
        return new GraceJSONResult(ResponseStatusEnum.FAILED, msg);
    &#125;

    /**
     * 错误返回，token异常，一些通用的可以在这里统一定义
     * @return
     */
    public static GraceJSONResult errorTicket() &#123;
        return new GraceJSONResult(ResponseStatusEnum.TICKET_INVALID);
    &#125;

    /**
     * 自定义错误范围，需要传入一个自定义的枚举，可以到[ResponseStatusEnum.java[中自定义后再传入
     * @param responseStatus
     * @return
     */
    public static GraceJSONResult errorCustom(ResponseStatusEnum responseStatus) &#123;
        return new GraceJSONResult(responseStatus);
    &#125;
    public static GraceJSONResult exception(ResponseStatusEnum responseStatus) &#123;
        return new GraceJSONResult(responseStatus);
    &#125;

    public GraceJSONResult(ResponseStatusEnum responseStatus) &#123;
        this.status = responseStatus.status();
        this.msg = responseStatus.msg();
        this.success = responseStatus.success();
    &#125;
    public GraceJSONResult(ResponseStatusEnum responseStatus, Object data) &#123;
        this.status = responseStatus.status();
        this.msg = responseStatus.msg();
        this.success = responseStatus.success();
        this.data = data;
    &#125;
    public GraceJSONResult(ResponseStatusEnum responseStatus, String msg) &#123;
        this.status = responseStatus.status();
        this.msg = msg;
        this.success = responseStatus.success();
    &#125;

    public GraceJSONResult() &#123;
    &#125;

    public Integer getStatus() &#123;
        return status;
    &#125;

    public void setStatus(Integer status) &#123;
        this.status = status;
    &#125;

    public String getMsg() &#123;
        return msg;
    &#125;

    public void setMsg(String msg) &#123;
        this.msg = msg;
    &#125;

    public Object getData() &#123;
        return data;
    &#125;

    public void setData(Object data) &#123;
        this.data = data;
    &#125;

    public Boolean getSuccess() &#123;
        return success;
    &#125;

    public void setSuccess(Boolean success) &#123;
        this.success = success;
    &#125;
&#125;
</code></pre>
<h3 id="安装配置整合Redis"><a href="#安装配置整合Redis" class="headerlink" title="安装配置整合Redis"></a>安装配置整合Redis</h3><pre><code class="mysql">通过Xftp7把redis-5.0.7.tar.gz传入到服务器
[root@iZbp1dssknxftmjczbtpndZ ~]# tar -zxvf redis-5.0.7.tar.gz 
[root@iZbp1dssknxftmjczbtpndZ ~]# ls
apache-zookeeper-3.6.0-bin         rabbitmq-server-3.8.2-1.el7.noarch.rpm
apache-zookeeper-3.6.0-bin.tar.gz  redis-5.0.7
erlang-22.3-1.el7.x86_64.rpm       redis-5.0.7.tar.gz
[root@iZbp1dssknxftmjczbtpndZ ~]# cd redis-5.0.7
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# ll
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# yum install gcc-c++
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# make
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# cd /usr/local/ ★
[root@iZbp1dssknxftmjczbtpndZ local]# ll
[root@iZbp1dssknxftmjczbtpndZ local]# pwd
/usr/local
[root@iZbp1dssknxftmjczbtpndZ local]# cd redis/ ★
[root@iZbp1dssknxftmjczbtpndZ redis]# ll
total 4
drwxr-xr-x 2 root root 4096 May 15 11:19 bin
[root@iZbp1dssknxftmjczbtpndZ redis]# cd bin ★
[root@iZbp1dssknxftmjczbtpndZ bin]# ll
total 32772
-rwxr-xr-x 1 root root 4366880 May 15 11:04 redis-benchmark
-rwxr-xr-x 1 root root 8125288 May 15 11:04 redis-check-aof
-rwxr-xr-x 1 root root 8125288 May 15 11:04 redis-check-rdb
-rwxr-xr-x 1 root root 4807952 May 15 11:04 redis-cli
-rw-r--r-- 1 root root       0 May 15 11:19 redis.conf
lrwxrwxrwx 1 root root      12 May 15 11:04 redis-sentinel -&gt; redis-server
-rwxr-xr-x 1 root root 8125288 May 15 11:04 redis-server
[root@iZbp1dssknxftmjczbtpndZ redis]# cd
[root@iZbp1dssknxftmjczbtpndZ ~]# cd redis-5.0.7
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# ls
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# cp redis.conf /usr/local/redis/bin/
cp: overwrite ‘/usr/local/redis/bin/redis.conf’? y
[root@iZbp1dssknxftmjczbtpndZ redis-5.0.7]# cd /usr/local/redis/bin/
[root@iZbp1dssknxftmjczbtpndZ bin]# ll
total 32836
-rwxr-xr-x 1 root root 4366880 May 15 11:04 redis-benchmark
-rwxr-xr-x 1 root root 8125288 May 15 11:04 redis-check-aof
-rwxr-xr-x 1 root root 8125288 May 15 11:04 redis-check-rdb
-rwxr-xr-x 1 root root 4807952 May 15 11:04 redis-cli
-rw-r--r-- 1 root root   61797 May 15 11:28 redis.conf
lrwxrwxrwx 1 root root      12 May 15 11:04 redis-sentinel -&gt; redis-server
-rwxr-xr-x 1 root root 8125288 May 15 11:04 redis-server
[root@iZbp1dssknxftmjczbtpndZ bin]# vim redis.conf
在里面 /bind 直接搜索
把bind 127.0.0.1修改成 0.0.0.0在任何地方都可以进行操作修改
在里面 /dae
把daemonize no 改成 daemonize yes[后台启动]
在里面 /require
把requirepass foobared 这里是设置密码 requirepass XXXX
[root@iZbp1dssknxftmjczbtpndZ bin]# ./redis-server redis.conf ★
32421:C 15 May 2024 11:35:36.687 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
32421:C 15 May 2024 11:35:36.687 # Redis version=5.0.7, bits=64, commit=00000000, modified=0, pid=32421, just started
32421:C 15 May 2024 11:35:36.687 # Configuration loaded
[root@iZbp1dssknxftmjczbtpndZ bin]# ps -ef|grep redis
root     32422     1  0 11:35 ?        00:00:00 ./redis-server 0.0.0.0:6379
root     32456 25226  0 11:35 pts/0    00:00:00 grep --color=auto redis
【此时说明已经成功启动Redis】
[root@iZbp1dssknxftmjczbtpndZ bin]# ./redis-cli ★
127.0.0.1:6379&gt; ping
PONG
127.0.0.1:6379&gt; keys *
(empty list or set)
127.0.0.1:6379&gt; set name imooc
OK
127.0.0.1:6379&gt; get name
&quot;imooc&quot;
[root@iZbp1dssknxftmjczbtpndZ bin]# ./redis-cli -p 6379 shutdown

★直接进入redis文件内★
[root@iZbp1dssknxftmjczbtpndZ ~]# cd /usr/local/redis/bin       //进入文件内
[root@iZbp1dssknxftmjczbtpndZ bin]# ./redis-server redis.conf   //启动
[root@iZbp1dssknxftmjczbtpndZ bin]# ./redis-cli                 //测试
★★
</code></pre>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hu4545/article/details/126174419">Linux下Redis服务启动与关闭_linux 关闭redis-CSDN博客</a></p>
<h3 id="安装配置整合Redis-2"><a href="#安装配置整合Redis-2" class="headerlink" title="安装配置整合Redis-2"></a>安装配置整合Redis-2</h3><blockquote>
<p>下载并安装好 Redis Desktop Manager<br>新连接设置<br>名字：redis-imooc-news 47.98.225.105<br>地址：47.98.225.105：6379</p>
</blockquote>
<pre><code class="xml">加一下redis的依赖
imooc-news-dev-common
pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
&lt;!--
    imooc-news-dev-common:
    通用工程
    包含了一些工具类,枚举类,封装的一些公共方法以及一些第三方组件等
--&gt;
    &lt;artifactId&gt;imooc-news-dev-common&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;!--    引入SpringBoot依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- 引入 redis 依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
            &lt;version&gt;2.0.4.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
            &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- jackson --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- apache 工具类 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;commons-codec&lt;/groupId&gt;
            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;
            &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- google 工具类 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
            &lt;artifactId&gt;guava&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- joda-time 时间工具 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;joda-time&lt;/groupId&gt;
            &lt;artifactId&gt;joda-time&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--  第三方云厂商相关依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-java-sdk-core&lt;/artifactId&gt;
            &lt;version&gt;4.5.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<pre><code class="java">com/imooc/utils/RedisOperator.java
package com.imooc.utils;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataAccessException;
import org.springframework.data.redis.connection.RedisConnection;
import org.springframework.data.redis.connection.StringRedisConnection;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;

/**
 * @Title: Redis 工具类
 * @author 风间影月
 */
@Component
public class RedisOperator &#123;
    
    @Resource
    private StringRedisTemplate redisTemplate;

    // Key（键），简单的key-value操作

    /**
     * 判断key是否存在
     * @param key
     * @return
     */
    public boolean keyIsExist(String key) &#123;
        return redisTemplate.hasKey(key);
    &#125;

    /**
     * 实现命令：TTL key，以秒为单位，返回给定 key的剩余生存时间(TTL, time to live)。
     * 
     * @param key
     * @return
     */
    public long ttl(String key) &#123;
        return redisTemplate.getExpire(key);
    &#125;
    
    /**
     * 实现命令：expire 设置过期时间，单位秒
     * 
     * @param key
     * @return
     */
    public void expire(String key, long timeout) &#123;
        redisTemplate.expire(key, timeout, TimeUnit.SECONDS);
    &#125;
    
    /**
     * 实现命令：increment key，增加key一次
     * 
     * @param key
     * @return
     */
    public long increment(String key, long delta) &#123;
        return redisTemplate.opsForValue().increment(key, delta);
    &#125;

    /**
     * 实现命令：decrement key，减少key一次
     *
     * @param key
     * @return
     */
    public long decrement(String key, long delta) &#123;
        return redisTemplate.opsForValue().decrement(key, delta);
    &#125;

    /**
     * 实现命令：KEYS pattern，查找所有符合给定模式 pattern的 key
     */
    public Set&lt;String&gt; keys(String pattern) &#123;
        return redisTemplate.keys(pattern);
    &#125;

    /**
     * 实现命令：DEL key，删除一个key
     * 
     * @param key
     */
    public void del(String key) &#123;
        redisTemplate.delete(key);
    &#125;

    // String（字符串）

    /**
     * 实现命令：SET key value，设置一个key-value（将字符串值 value关联到 key）
     * 
     * @param key
     * @param value
     */
    public void set(String key, String value) &#123;
        redisTemplate.opsForValue().set(key, value);
    &#125;

    /**
     * 实现命令：SET key value EX seconds，设置key-value和超时时间（秒）
     * 
     * @param key
     * @param value
     * @param timeout
     *            （以秒为单位）
     */
    public void set(String key, String value, long timeout) &#123;
        redisTemplate.opsForValue().set(key, value, timeout, TimeUnit.SECONDS);
    &#125;

    /**
     * 如果key不存在，则设置，如果存在，则报错
     * @param key
     * @param value
     */
    public void setnx60s(String key, String value) &#123;
        redisTemplate.opsForValue().setIfAbsent(key, value, 60, TimeUnit.SECONDS);
    &#125;

    /**
     * 如果key不存在，则设置，如果存在，则报错
     * @param key
     * @param value
     */
    public void setnx(String key, String value) &#123;
        redisTemplate.opsForValue().setIfAbsent(key, value);
    &#125;

    /**
     * 实现命令：GET key，返回 key所关联的字符串值。
     * 
     * @param key
     * @return value
     */
    public String get(String key) &#123;
        return (String)redisTemplate.opsForValue().get(key);
    &#125;

    /**
     * 批量查询，对应mget
     * @param keys
     * @return
     */
    public List&lt;String&gt; mget(List&lt;String&gt; keys) &#123;
        return redisTemplate.opsForValue().multiGet(keys);
    &#125;

    /**
     * 批量查询，管道pipeline
     * @param keys
     * @return
     */
    public List&lt;Object&gt; batchGet(List&lt;String&gt; keys) &#123;

//        nginx -&gt; keepalive
//        redis -&gt; pipeline

        List&lt;Object&gt; result = redisTemplate.executePipelined(new RedisCallback&lt;String&gt;() &#123;
            @Override
            public String doInRedis(RedisConnection connection) throws DataAccessException &#123;
                StringRedisConnection src = (StringRedisConnection)connection;

                for (String k : keys) &#123;
                    src.get(k);
                &#125;
                return null;
            &#125;
        &#125;);

        return result;
    &#125;


    // Hash（哈希表）

    /**
     * 实现命令：HSET key field value，将哈希表 key中的域 field的值设为 value
     * 
     * @param key
     * @param field
     * @param value
     */
    public void hset(String key, String field, Object value) &#123;
        redisTemplate.opsForHash().put(key, field, value);
    &#125;

    /**
     * 实现命令：HGET key field，返回哈希表 key中给定域 field的值
     * 
     * @param key
     * @param field
     * @return
     */
    public String hget(String key, String field) &#123;
        return (String) redisTemplate.opsForHash().get(key, field);
    &#125;

    /**
     * 实现命令：HDEL key field [field ...]，删除哈希表 key 中的一个或多个指定域，不存在的域将被忽略。
     * 
     * @param key
     * @param fields
     */
    public void hdel(String key, Object... fields) &#123;
        redisTemplate.opsForHash().delete(key, fields);
    &#125;

    /**
     * 实现命令：HGETALL key，返回哈希表 key中，所有的域和值。
     * 
     * @param key
     * @return
     */
    public Map&lt;Object, Object&gt; hgetall(String key) &#123;
        return redisTemplate.opsForHash().entries(key);
    &#125;

    // List（列表）

    /**
     * 实现命令：LPUSH key value，将一个值 value插入到列表 key的表头
     * 
     * @param key
     * @param value
     * @return 执行 LPUSH命令后，列表的长度。
     */
    public long lpush(String key, String value) &#123;
        return redisTemplate.opsForList().leftPush(key, value);
    &#125;

    /**
     * 实现命令：LPOP key，移除并返回列表 key的头元素。
     * 
     * @param key
     * @return 列表key的头元素。
     */
    public String lpop(String key) &#123;
        return (String)redisTemplate.opsForList().leftPop(key);
    &#125;

    /**
     * 实现命令：RPUSH key value，将一个值 value插入到列表 key的表尾(最右边)。
     * 
     * @param key
     * @param value
     * @return 执行 LPUSH命令后，列表的长度。
     */
    public long rpush(String key, String value) &#123;
        return redisTemplate.opsForList().rightPush(key, value);
    &#125;
&#125;
</code></pre>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/337066868">Spring Boot集成Redis的坑，踩了！ - 知乎 (zhihu.com)</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45590494/article/details/114444371">@Autowired和@Resource注解的区别和联系（十分详细，不看后悔）_为什么@resource和@autowired 注入的对象不一样-CSDN博客</a></p>
<blockquote>
<p>妈的有个超级大bug 整我一下午，<br>@Component public class RedisOperator {<br>@Autowired private StringRedisTemplate redisTemplate;}<br> 报错信息 Could not autowire. No beans of ‘StringRedisTemplate’ type found.</p>
<p>在这里不要本末倒置 回归最原始的报错 那就是pom.xml中的导包依赖问题<br>有的时候直接复制的项目中的成熟依赖 根据时代的不同可能会导致丢失无法下载依赖<br>这时要去百度Maven库手动下载 并且手动添加 然后手动导入Project Structure → Libraries 手动导入自己需要的包[记住包的版本 也要在依赖里面体现 &lt; version &gt;]，而且如果有红色波浪线的包可以删除 再重新导入即可</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/arjelarxfc/article/details/78806384">Spring里遇到的一个问题，autowired时报找不到bean定义_autowired找不到bean-CSDN博客</a></p>
<h3 id="完善发送短信接口"><a href="#完善发送短信接口" class="headerlink" title="完善发送短信接口"></a>完善发送短信接口</h3><pre><code class="java">com/imooc/api/controller/user/PassportControllerApi.java
package com.imooc.api.controller.user;


import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import javax.servlet.http.HttpServletRequest;

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode(String mobile, HttpServletRequest request);
&#125;
</code></pre>
<pre><code class="java">com/imooc/user/controller/PassportController.java
package com.imooc.user.controller;


import com.imooc.api.controller.user.BaseController;
import com.imooc.api.controller.user.PassportControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.utils.RedisOperator;
import com.imooc.utils.SMSUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.imooc.utils.IPUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;

@RestController
@RequestMapping(&quot;passport&quot;)
public class PassportController extends BaseController implements PassportControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(PassportController.class);

    @Autowired
    private SMSUtils smsUtils;
// 这里去除的原因是因为新建了一个BaseController 在里面有信息 且在这加个extends
//    @Autowired
//    private RedisOperator redis;

    @Override
    public GraceJSONResult getSMSCode(String mobile, HttpServletRequest request)&#123;
        String userIp = IPUtil.getRequestIp(request);
        //根据用户的ip进行限制,限制用户在60秒内只能获得一次验证码
//        redis.setnx60s(&quot;smscode&quot;+ip);
        redis.setnx60s(MOBILE_SMSCODE + &quot;:&quot;+userIp,userIp);

        //生成随机验证码并且发送短信
        String random = ((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
        smsUtils.sendSMS(&quot;15027597319&quot;,random);//可以用MyInfo.getMobile代替

        //把验证码存入redis,用于后续进行验证
        redis.set(MOBILE_SMSCODE+&quot;:&quot;+mobile, random, 30*60);
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/api/controller/user/BaseController.java
package com.imooc.api.controller.user;

import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;

public class BaseController &#123;
   @Autowired
    public RedisOperator redis;
    public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;

&#125;
</code></pre>
<pre><code class="java">com/imooc/utils/IPUtil.java
package com.imooc.utils;

import javax.servlet.http.HttpServletRequest;

/**
 * 用户获得用户ip的工具类
 */
public class IPUtil &#123;

    /**
     * 获取请求IP:
     * 用户的真实IP不能使用request.getRemoteAddr()
     * 这是因为可能会使用一些代理软件，这样ip获取就不准确了
     * 此外我们如果使用了多级（LVS/Nginx）反向代理的话，ip需要从X-Forwarded-For中获得第一个非unknown的IP才是用户的有效ip。
     * @param request
     * @return
     */
    public static String getRequestIp(HttpServletRequest request) &#123;
        String ip = request.getHeader(&quot;x-forwarded-for&quot;);
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;
            ip = request.getHeader(&quot;Proxy-Client-IP&quot;);
        &#125;
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;
            ip = request.getHeader(&quot;WL-Proxy-Client-IP&quot;);
        &#125;
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;
            ip = request.getHeader(&quot;HTTP_CLIENT_IP&quot;);
        &#125;
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;
            ip = request.getHeader(&quot;HTTP_X_FORWARDED_FOR&quot;);
        &#125;
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip)) &#123;
            ip = request.getRemoteAddr();
        &#125;
        return ip;
    &#125;
&#125;
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/sms/getting-started/use-sms-console-1?spm=a2c4g.11186623.0.0.70707f5cATZOcJ">快速使用 在控制台发送短信_短信服务(SMS)-阿里云帮助中心 (aliyun.com)</a></p>
</blockquote>
<h3 id="联调前端发送短信-解决跨域问题"><a href="#联调前端发送短信-解决跨域问题" class="headerlink" title="联调前端发送短信, 解决跨域问题"></a>联调前端发送短信, 解决跨域问题</h3><pre><code class="java">http://writer.imoocnews.com:9090/imooc-news/writer/passport.html
因为后台写死了手机号 所以在输入手机号可以随便 点击发送验证码后 会在浏览器控制台输出跨域问题 在后端要設置允許跨域請求
-----------------------------------------------------------------------------------
passport.html:1  Access to XMLHttpRequest at &#39;http://user.imoocnews.com:8003/passport/getSMSCode?mobile=123334323&#39; from origin &#39;http://writer.imoocnews.com:9090&#39; has been blocked by CORS policy: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource.

GET http://user.imoocnews.com:8003/passport/getSMSCode?mobile=123334323 net::ERR_FAILED 200 (OK)
axios.min.js:2  Uncaught (in promise) Error: Network Error
    at e.exports (axios.min.js:2:9633)
    at l.onerror (axios.min.js:2:8398)
</code></pre>
<pre><code class="java">...service-api  com/imooc/api/config/CorsConfig.java
package com.imooc.api.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration //SpringBoot可以加载该信息
public class CorsConfig &#123;

    public CorsConfig() &#123;
    &#125;

    @Bean
    public CorsFilter corsFilter() &#123;
        // 1. 添加cors配置信息
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin(&quot;*&quot;);
        // 设置是否发送cookie信息
        config.setAllowCredentials(true);
        // 设置允许请求的方式
        config.addAllowedMethod(&quot;*&quot;);
        // 设置允许的header
        config.addAllowedHeader(&quot;*&quot;);
        // 2. 为url添加映射路径
        UrlBasedCorsConfigurationSource corsSource = new UrlBasedCorsConfigurationSource();
        corsSource.registerCorsConfiguration(&quot;/**&quot;, config);
        // 3. 返回重新定义好的corsSource
        return new CorsFilter(corsSource);
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/user/controller/PassportController.java
package com.imooc.user.controller;


import com.imooc.api.BaseController;
import com.imooc.api.controller.user.PassportControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.IPUtil;
import com.imooc.utils.SMSUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;

@RestController
@RequestMapping(&quot;passport&quot;)
public class PassportController extends BaseController implements PassportControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(PassportController.class);

    @Autowired
    private SMSUtils smsUtils;
    // 这里去除的原因是因为新建了一个BaseController 在里面有信息 且在这加个extends
    //    @Autowired
    //    private RedisOperator redis;

    @Override
    public GraceJSONResult getSMSCode(String mobile, HttpServletRequest request)&#123;
        //获取用户ip
        String userIp = IPUtil.getRequestIp(request);
        logger.info(&quot;User ip:&quot;, userIp);
        //根据用户的ip进行限制,限制用户在60秒内只能获得一次验证码
        redis.setnx60s(MOBILE_SMSCODE + &quot;:&quot; + userIp, userIp);

        // 生成6位随机验证码
        String random = (int)((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
        // 打印生成的验证码以便调试
//        logger.info(&quot;Generated SMS code: &quot; + random);
//        String random = ((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
//        smsUtils.sendSMS(&quot;15027597319&quot;,random);//可以用MyInfo.getMobile代替
        // 记录发送短信的结果（添加日志）
//        logger.info(&quot;SMS sent to 15027597319 with code: &quot; + random);
        redis.set(MOBILE_SMSCODE + &quot;:&quot; + mobile, random, 30 * 60);
   //记得如果要发送到redis中 则需要先用application-dev.yml导入RedisDesktopManager正确的网络地址127.0.0.1 
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/api/controller/user/PassportControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.HttpServletRequest;

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
@RequestMapping(&quot;passport&quot;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode(@RequestParam String mobile, HttpServletRequest request);
&#125;
</code></pre>
<h3 id="拦截并限制60秒用户短信发送"><a href="#拦截并限制60秒用户短信发送" class="headerlink" title="拦截并限制60秒用户短信发送"></a>拦截并限制60秒用户短信发送</h3><pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
package com.imooc.api.config;

import com.imooc.api.interceptors.PassportInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;

    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/password/getSMSCode&quot;); //拦截PassportControllerApi里的信息
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/api/interceptors/PassportInterceptor.java
package com.imooc.api.interceptors;

import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.IPUtil;
import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

    public class PassportInterceptor implements HandlerInterceptor &#123;

        @Autowired
        public RedisOperator redis;

        public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;

        /**
         * 拦截请求，访问controller之前
         * @param request
         * @param response
         * @param handler
         * @return
         * @throws Exception
         */
        @Override
        public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;

            // 获得用户ip
            String userIp = IPUtil.getRequestIp(request);

            boolean keyIsExist = redis.keyIsExist(MOBILE_SMSCODE + &quot;:&quot; + userIp);

            if (keyIsExist) &#123;
                GraceException.display(ResponseStatusEnum.SMS_NEED_WAIT_ERROR);
//            System.out.println(&quot;短信发送频率太大！&quot;);
                return false;
            &#125;

            /**
             * false：请求被拦截
             * true：请求通过验证，放行
             */
            return true;
        &#125;


        /**
         * 请求访问到controller之后，渲染视图之前
         * @param request
         * @param response
         * @param handler
         * @param modelAndView
         * @throws Exception
         */
        @Override
        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;

        &#125;

        /**
         * 请求访问到controller之后，渲染视图之后
         * @param request
         * @param response
         * @param handler
         * @param ex
         * @throws Exception
         */
        @Override
        public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;

        &#125;
    &#125;
</code></pre>
<pre><code class="java">dev-common com/imooc/exception/GraceException.java
package com.imooc.exception;

import com.imooc.grace.result.ResponseStatusEnum;

/**
 * 优雅的处理异常，统一封装
 */
public class GraceException &#123;

    public static void display(ResponseStatusEnum responseStatusEnum) &#123;
        throw new MyCustomException(responseStatusEnum);
    &#125;

&#125;
</code></pre>
<pre><code class="java">com/imooc/exception/MyCustomException.java
package com.imooc.exception;

import com.imooc.grace.result.ResponseStatusEnum;

/**
 * 自定义异常
 * 目的：统一处理异常信息
 *      便于解耦，service与controller错误的解耦，不会被service返回的类型而限制
 */
public class MyCustomException extends RuntimeException &#123;

    private ResponseStatusEnum responseStatusEnum;

    public MyCustomException(ResponseStatusEnum responseStatusEnum) &#123;
        super(&quot;异常状态码为：&quot; + responseStatusEnum.status()
                + &quot;；具体异常信息为：&quot; + responseStatusEnum.msg());
        this.responseStatusEnum = responseStatusEnum;
    &#125;

    public ResponseStatusEnum getResponseStatusEnum() &#123;
        return responseStatusEnum;
    &#125;

    public void setResponseStatusEnum(ResponseStatusEnum responseStatusEnum) &#123;
        this.responseStatusEnum = responseStatusEnum;
    &#125;
&#125;
</code></pre>
<h3 id="自定义异常-返回错误信息"><a href="#自定义异常-返回错误信息" class="headerlink" title="自定义异常, 返回错误信息"></a>自定义异常, 返回错误信息</h3><h6 id="接上方GraceException、MyCustomException、PassportInterceptor"><a href="#接上方GraceException、MyCustomException、PassportInterceptor" class="headerlink" title="[接上方GraceException、MyCustomException、PassportInterceptor]"></a>[接上方GraceException、MyCustomException、PassportInterceptor]</h6><pre><code class="java">dev-common  com/imooc/grace/result/ResponseStatusEnum.java
package com.imooc.grace.result;

/**
 * 响应结果枚举，用于提供给GraceJSONResult返回给前端的
 * 本枚举类中包含了很多的不同的状态码供使用，可以自定义
 * 便于更优雅的对状态码进行管理，一目了然
 */
public enum ResponseStatusEnum &#123;

    SUCCESS(200, true, &quot;操作成功！&quot;),
    FAILED(500, false, &quot;操作失败！&quot;),

    // 50x
    UN_LOGIN(501,false,&quot;请登录后再继续操作！&quot;),
    TICKET_INVALID(502,false,&quot;会话失效，请重新登录！&quot;),
    NO_AUTH(503,false,&quot;您的权限不足，无法继续操作！&quot;),
    MOBILE_ERROR(504,false,&quot;短信发送失败，请稍后重试！&quot;),
    SMS_NEED_WAIT_ERROR(505,false,&quot;短信发送太快啦~请稍后再试！&quot;),
    SMS_CODE_ERROR(506,false,&quot;验证码过期或不匹配，请稍后再试！&quot;),
    USER_FROZEN(507,false,&quot;用户已被冻结，请联系管理员！&quot;),
    USER_UPDATE_ERROR(508,false,&quot;用户信息更新失败，请联系管理员！&quot;),
    USER_INACTIVE_ERROR(509,false,&quot;请前往[账号设置]修改信息激活后再进行后续操作！&quot;),
    FILE_UPLOAD_NULL_ERROR(510,false,&quot;文件不能为空，请选择一个文件再上传！&quot;),
    FILE_UPLOAD_FAILD(511,false,&quot;文件上传失败！&quot;),
    FILE_FORMATTER_FAILD(512,false,&quot;文件图片格式不支持！&quot;),
    FILE_MAX_SIZE_ERROR(513,false,&quot;仅支持500kb大小以下的图片上传！&quot;),
    FILE_NOT_EXIST_ERROR(514,false,&quot;你所查看的文件不存在！&quot;),
    USER_STATUS_ERROR(515,false,&quot;用户状态参数出错！&quot;),
    USER_NOT_EXIST_ERROR(516,false,&quot;用户不存在！&quot;),

    // 自定义系统级别异常 54x
    SYSTEM_INDEX_OUT_OF_BOUNDS(541, false, &quot;系统错误，数组越界！&quot;),
    SYSTEM_ARITHMETIC_BY_ZERO(542, false, &quot;系统错误，无法除零！&quot;),
    SYSTEM_NULL_POINTER(543, false, &quot;系统错误，空指针！&quot;),
    SYSTEM_NUMBER_FORMAT(544, false, &quot;系统错误，数字转换异常！&quot;),
    SYSTEM_PARSE(545, false, &quot;系统错误，解析异常！&quot;),
    SYSTEM_IO(546, false, &quot;系统错误，IO输入输出异常！&quot;),
    SYSTEM_FILE_NOT_FOUND(547, false, &quot;系统错误，文件未找到！&quot;),
    SYSTEM_CLASS_CAST(548, false, &quot;系统错误，类型强制转换错误！&quot;),
    SYSTEM_PARSER_ERROR(549, false, &quot;系统错误，解析出错！&quot;),
    SYSTEM_DATE_PARSER_ERROR(550, false, &quot;系统错误，日期解析出错！&quot;),

    // admin 管理系统 56x
    ADMIN_USERNAME_NULL_ERROR(561, false, &quot;管理员登录名不能为空！&quot;),
    ADMIN_USERNAME_EXIST_ERROR(562, false, &quot;管理员登录名已存在！&quot;),
    ADMIN_NAME_NULL_ERROR(563, false, &quot;管理员负责人不能为空！&quot;),
    ADMIN_PASSWORD_ERROR(564, false, &quot;密码不能为空后者两次输入不一致！&quot;),
    ADMIN_CREATE_ERROR(565, false, &quot;添加管理员失败！&quot;),
    ADMIN_PASSWORD_NULL_ERROR(566, false, &quot;密码不能为空！&quot;),
    ADMIN_NOT_EXIT_ERROR(567, false, &quot;管理员不存在或密码错误！&quot;),
    ADMIN_FACE_NULL_ERROR(568, false, &quot;人脸信息不能为空！&quot;),
    ADMIN_FACE_LOGIN_ERROR(569, false, &quot;人脸识别失败，请重试！&quot;),
    CATEGORY_EXIST_ERROR(570, false, &quot;文章分类已存在，请换一个分类名！&quot;),

    // 媒体中心 相关错误 58x
    ARTICLE_COVER_NOT_EXIST_ERROR(580, false, &quot;文章封面不存在，请选择一个！&quot;),
    ARTICLE_CATEGORY_NOT_EXIST_ERROR(581, false, &quot;请选择正确的文章领域！&quot;),
    ARTICLE_CREATE_ERROR(582, false, &quot;创建文章失败，请重试或联系管理员！&quot;),
    ARTICLE_QUERY_PARAMS_ERROR(583, false, &quot;文章列表查询参数错误！&quot;),
    ARTICLE_DELETE_ERROR(584, false, &quot;文章删除失败！&quot;),
    ARTICLE_WITHDRAW_ERROR(585, false, &quot;文章撤回失败！&quot;),
    ARTICLE_REVIEW_ERROR(585, false, &quot;文章审核出错！&quot;),
    ARTICLE_ALREADY_READ_ERROR(586, false, &quot;文章重复阅读！&quot;),

    // 人脸识别错误代码
    FACE_VERIFY_TYPE_ERROR(600, false, &quot;人脸比对验证类型不正确！&quot;),
    FACE_VERIFY_LOGIN_ERROR(601, false, &quot;人脸登录失败！&quot;),

    // 系统错误，未预期的错误 555
    SYSTEM_ERROR(555, false, &quot;系统繁忙，请稍后再试！&quot;),
    SYSTEM_OPERATION_ERROR(556, false, &quot;操作失败，请重试或联系管理员&quot;),
    SYSTEM_RESPONSE_NO_INFO(557, false, &quot;&quot;);


    // 响应业务状态
    private Integer status;
    // 调用是否成功
    private Boolean success;
    // 响应消息，可以为成功或者失败的消息
    private String msg;

    ResponseStatusEnum(Integer status, Boolean success, String msg) &#123;
        this.status = status;
        this.success = success;
        this.msg = msg;
    &#125;

    public Integer status() &#123;
        return status;
    &#125;
    public Boolean success() &#123;
        return success;
    &#125;
    public String msg() &#123;
        return msg;
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-common  com/imooc/exception/GraceExceptionHandler.java
package com.imooc.exception;

import com.imooc.grace.result.GraceJSONResult;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * 统一异常拦截处理
 * 可以针对异常的类型进行捕获 然后返回json信息到前端
 */
@ControllerAdvice //本质上是实现AOP的管理
public class GraceExceptionHandler &#123;
    @ExceptionHandler(MyCustomException.class)
    //只要是这个类的异常都会进入下面的方法
    @ResponseBody
    public GraceJSONResult returnMyException(MyCustomException e)&#123;
        e.printStackTrace(); //打印信息
        return GraceJSONResult.exception(e.getResponseStatusEnum());
    &#125;
&#125;
</code></pre>
<h3 id="验证BO信息-注册登录接口"><a href="#验证BO信息-注册登录接口" class="headerlink" title="验证BO信息(注册登录接口)"></a>验证BO信息(注册登录接口)</h3><pre><code class="java">service-api  com/imooc/api/controller/user/PassportControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid; //用户需求验证

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
@RequestMapping(&quot;passport&quot;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode(@RequestParam String mobile, HttpServletRequest request);

    @ApiOperation(value = &quot;一键注册登录接口&quot;,notes = &quot;一键注册登录接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/doLogin&quot;) //表单里面用post  RequestBody后面传过来的东西和json对象对应
    public GraceJSONResult doLogin(@RequestBody @Valid RegistLoginBO registLoginBO, BindingResult result);
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/bo/RegistLoginBO.java
package com.imooc.pojo.bo;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;

//加上@data 会自动生成getter+setter
public class RegistLoginBO &#123;
    //不为空 空的话可以返回 不用NOTNULL因为无法校验空字符串 用NotBlank
    @NotBlank(message = &quot;手机号不能为空&quot;) 
    private String mobile;
    @NotBlank(message = &quot;短信验证码不能为空&quot;)
    private String smsCode;

    @Override
    public String toString() &#123;
        return &quot;RegistLoginBO&#123;&quot; +
                &quot;mobile=&#39;&quot; + mobile + &#39;\&#39;&#39; +
                &quot;, smsCode=&#39;&quot; + smsCode + &#39;\&#39;&#39; +
                &#39;&#125;&#39;;
    &#125;

    public String getMobile() &#123;
        return mobile;
    &#125;

    public void setMobile(String mobile) &#123;
        this.mobile = mobile;
    &#125;

    public String getSmsCode() &#123;
        return smsCode;
    &#125;

    public void setSmsCode(String smsCode) &#123;
        this.smsCode = smsCode;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/PassportController.java
package com.imooc.user.controller;


import com.imooc.api.BaseController;
import com.imooc.api.controller.user.PassportControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.utils.IPUtil;
import com.imooc.utils.SMSUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(&quot;passport&quot;)
public class PassportController extends BaseController implements PassportControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(PassportController.class);

    @Autowired
    private SMSUtils smsUtils;
    // 这里去除的原因是因为新建了一个BaseController 在里面有信息 且在这加个extends
    //    @Autowired
    //    private RedisOperator redis;

    @Override
    public GraceJSONResult getSMSCode(String mobile, HttpServletRequest request)&#123;
        //获取用户ip
        String userIp = IPUtil.getRequestIp(request);
        logger.info(&quot;User ip:&quot;, userIp);
        //根据用户的ip进行限制,限制用户在60秒内只能获得一次验证码
        redis.setnx60s(MOBILE_SMSCODE + &quot;:&quot; + userIp, userIp);

        // 生成6位随机验证码
        String random = (int)((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
        // 打印生成的验证码以便调试
//        logger.info(&quot;Generated SMS code: &quot; + random);
//        String random = ((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
//        smsUtils.sendSMS(&quot;15027597319&quot;,random);//可以用MyInfo.getMobile代替
        // 记录发送短信的结果（添加日志）
//        logger.info(&quot;SMS sent to 15027597319 with code: &quot; + random);
        redis.set(MOBILE_SMSCODE + &quot;:&quot; + mobile, random, 30 * 60);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult doLogin(RegistLoginBO registLoginBO, BindingResult result) &#123;
        //0.判断BindingResult中是否保存了错误的验证信息 如果有则需要返回
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;
        String mobile = registLoginBO.getMobile();
        String smsCode = registLoginBO.getSmsCode();

        //1.校验验证码是否匹配[在redis中去获取]
        String redisSMSCode = redis.get(MOBILE_SMSCODE + &quot;:&quot; + mobile); //为空||不同值
        if (StringUtils.isBlank(redisSMSCode) || !redisSMSCode.equalsIgnoreCase(smsCode)) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.SMS_CODE_ERROR);
        &#125;
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java
package com.imooc.api;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public abstract class BaseController &#123;
   @Autowired
    public RedisOperator redis;
    public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;

    /**可以公用 就放到BaseController里面
     * 在任何controller中都可以调用和使用
     * 获取BO中的错误信息
     *
     * @param result
     * @return
     */
    public Map&lt;String, String&gt; getErrors(BindingResult result)&#123;
        //对应着RegistLoginBO的信息
        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
        List&lt;FieldError&gt; errorList = result.getFieldErrors();
        for (FieldError error : errorList)&#123;
            //发生验证错误所对应的某个属性
            String field = error.getField();
            //验证的错误信息
            String msg = error.getDefaultMessage();
            map.put(field, msg);
        &#125;
        return map;
    &#125;
&#125;
</code></pre>
<pre><code class="java">http://writer.imoocnews.com:8003/doc.html   打开校验
POST：/passport/doLogin

&#123;
    &quot;mobile&quot;:&quot;&quot;,
    &quot;smsCode&quot;:&quot;&quot;
&#125;

&#123;
&quot;status&quot;: 500,
&quot;msg&quot;: &quot;操作失败！&quot;,
&quot;success&quot;: false,
-&quot;data&quot;: &#123;
&quot;smsCode&quot;: &quot;短信验证码不能为空&quot;,
&quot;mobile&quot;: &quot;手机号不能为空&quot;
&#125;
&#125;
--------------------------------------------------------
 //不为空 空的话可以返回 不用NOTNULL因为无法校验空字符串 用NotBlank
    @NotBlank(message = &quot;手机号不能为空&quot;) 
    private String mobile;
    @NotBlank(message = &quot;短信验证码不能为空&quot;)
    private String smsCode;
// 要注意上面的为NotBlank 不然它验证的结果会跳过手机号判断 直接说验证码错误 
// 因为NotNull在处理&quot;mobile&quot;:&quot;&quot;, &quot;smsCode&quot;:&quot;&quot;的时候空字符串也算入不为空
//NotBlank兼顾NotNull
</code></pre>
<h3 id="通过数据库-查询老用户-老用户添加"><a href="#通过数据库-查询老用户-老用户添加" class="headerlink" title="通过数据库 查询老用户_老用户添加"></a>通过数据库 查询老用户_老用户添加</h3><pre><code class="java">service-api  com/imooc/api/controller/user/PassportControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid; //用户需求验证

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
@RequestMapping(&quot;passport&quot;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode(@RequestParam String mobile, HttpServletRequest request);

    @ApiOperation(value = &quot;一键注册登录接口&quot;,notes = &quot;一键注册登录接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/doLogin&quot;) //表单里面用post  RequestBody后面传过来的东西和json对象对应
    public GraceJSONResult doLogin(@RequestBody @Valid RegistLoginBO registLoginBO, BindingResult result);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/PassportController.java
package com.imooc.user.controller;


import com.imooc.api.BaseController;
import com.imooc.api.controller.user.PassportControllerApi;
import com.imooc.enums.UserStatus;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.user.service.impl.UserService;
import com.imooc.utils.IPUtil;
import com.imooc.utils.SMSUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(&quot;passport&quot;)
public class PassportController extends BaseController implements PassportControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(PassportController.class);

    @Autowired
    private SMSUtils smsUtils;

    @Autowired
    private UserService userService;
    // 这里去除的原因是因为新建了一个BaseController 在里面有信息 且在这加个extends
    //    @Autowired
    //    private RedisOperator redis;

    @Override
    public GraceJSONResult getSMSCode(String mobile, HttpServletRequest request)&#123;
        //获取用户ip
        String userIp = IPUtil.getRequestIp(request);
        logger.info(&quot;User ip:&quot;, userIp);
        //根据用户的ip进行限制,限制用户在60秒内只能获得一次验证码
        redis.setnx60s(MOBILE_SMSCODE + &quot;:&quot; + userIp, userIp);

        // 生成6位随机验证码
        String random = (int)((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
        // 打印生成的验证码以便调试
//        logger.info(&quot;Generated SMS code: &quot; + random);
//        String random = ((Math.random() * 9 + 1) * 100000) + &quot;&quot;;
//        smsUtils.sendSMS(&quot;15027597319&quot;,random);//可以用MyInfo.getMobile代替
        // 记录发送短信的结果（添加日志）
//        logger.info(&quot;SMS sent to 15027597319 with code: &quot; + random);
        redis.set(MOBILE_SMSCODE + &quot;:&quot; + mobile, random, 30 * 60);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult doLogin(RegistLoginBO registLoginBO, BindingResult result) &#123;
        //0.判断BindingResult中是否保存了错误的验证信息 如果有则需要返回
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;
        String mobile = registLoginBO.getMobile();
        String smsCode = registLoginBO.getSmsCode();

        //1.校验验证码是否匹配[在redis中去获取]
        String redisSMSCode = redis.get(MOBILE_SMSCODE + &quot;:&quot; + mobile); //为空||不同值
        if (StringUtils.isBlank(redisSMSCode) || !redisSMSCode.equalsIgnoreCase(smsCode)) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.SMS_CODE_ERROR);
        &#125;

        //2.查询数据库,判断该用户注册
        AppUser user = userService.queryMobileIsExist(mobile);
        if (user != null &amp;&amp; user.getActiveStatus() == UserStatus.FROZEN.type)&#123;
            //如果用户不为空，并且状态为冻结，则直接抛出异常，禁止登录
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_FROZEN);
        &#125;else if (user == null)&#123;
            //如果用户没有注册过，则为null，需要注册信息入库
            user = userService.createUser(mobile);
        &#125;
        return GraceJSONResult.ok(user);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/UserService.java[接口]
package com.imooc.user.service.impl;

import com.imooc.pojo.AppUser;

public interface UserService &#123;
    /**
     * 判断用户是否存在，如果存在返回user信息
     */
    public AppUser queryMobileIsExist(String mobile);

    /**
     * 创建用户，新增用户记录到数据库
     */
    public AppUser createUser(String mobile);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/UserServiceimpl.java
package com.imooc.user.service;

import com.imooc.enums.Sex;
import com.imooc.enums.UserStatus;
import com.imooc.pojo.AppUser;
import com.imooc.user.mapper.AppUserMapper;
import com.imooc.user.service.impl.UserService;
import com.imooc.utils.DesensitizationUtil;
import org.n3r.idworker.Sid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;
import com.imooc.utils.DateUtil;

import java.util.Date;

@Service
public class UserServiceimpl implements UserService &#123;
    @Autowired
    public AppUserMapper appUserMapper; //基本的CRUD都可以

    @Autowired
    public Sid sid;

    private static final String USER_FACE0 = &quot;https://raw.githubusercontent.com/P-luminary/images/10d94134b65e13cc8ec9b8a9aeae4f958921cab7/data/Imooc_Cat.jpg&quot;;
    private static final String USER_FACE1 = &quot;https://raw.githubusercontent.com/P-luminary/images/875ad52658686e6cc3a8e0cd75d2a324a3d742a9/data/Imooc_Girl.jpg&quot;;
    @Override
    public AppUser queryMobileIsExist(String mobile) &#123;
        Example userExample = new Example(AppUser.class);
        Example.Criteria userCriteria = userExample.createCriteria();
        userCriteria.andEqualTo(&quot;mobile&quot;, mobile);
        AppUser user = appUserMapper.selectOneByExample(userExample);
        return null;
    &#125;

    @Transactional //对整个类的方法，事务起作用。无异常时正常提交，有异常时数据回滚
    @Override
    public AppUser createUser(String mobile) &#123;
        /**
         * 互联网项目都要考虑可扩展性
         * 如果未来的业务激增，那么就需要分表分库
         * 那么数据库表主键id必须保证全局(全库)唯一,不得重复
         */
        String userId = sid.nextShort();
        AppUser user = new AppUser();
        user.setId(userId);
        user.setMobile(mobile);
        user.setNickname(&quot;用户：&quot; + DesensitizationUtil.commonDisplay(mobile)); //給手机号加** 是脱敏操作
        user.setFace(USER_FACE1);
        user.setBirthday(DateUtil.stringToDate(&quot;2024-06-29&quot;)); //字符串转换Date类型
        user.setSex(Sex.secret.type);
        user.setActiveStatus(UserStatus.INACTIVE.type);//是否激活
        user.setTotalIncome(0);//收入
        user.setCreatedTime(new Date());
        user.setUpdatedTime(new Date());
        return user;
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/AppUser.java
package com.imooc.pojo;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Table(name = &quot;app_user&quot;)
public class AppUser &#123;
    @Id
    private String id;

    /**
     * 手机号
     */
    private String mobile;

    /**
     * 昵称，媒体号
     */
    private String nickname;

    /**
     * 头像
     */
    private String face;

    /**
     * 真实姓名
     */
    private String realname;

    /**
     * 邮箱地址
     */
    private String email;

    /**
     * 性别 1:男  0:女  2:保密
     */
    private Integer sex;

    /**
     * 生日
     */
    private Date birthday;

    /**
     * 省份
     */
    private String province;

    /**
     * 城市
     */
    private String city;

    /**
     * 区县
     */
    private String district;

    /**
     * 用户状态：0：未激活。 1：已激活：基本信息是否完善，真实姓名，邮箱地址，性别，生日，住址等，如果没有完善，则用户不能发表评论，不能点赞，不能关注。2：已冻结。
     */
    @Column(name = &quot;active_status&quot;)
    private Integer activeStatus;

    /**
     * 累计已结算的收入金额，也就是已经打款的金额，每次打款后再此累加
     */
    @Column(name = &quot;total_income&quot;)
    private Integer totalIncome;

    /**
     * 创建时间 创建时间
     */
    @Column(name = &quot;created_time&quot;)
    private Date createdTime;

    /**
     * 更新时间 更新时间
     */
    @Column(name = &quot;updated_time&quot;)
    private Date updatedTime;
&#125;Getter + Setter
</code></pre>
<pre><code class="java">service-user  com/imooc/user/Application.java
package com.imooc.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.user.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;com.imooc.utils&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="java">【来自Chatgpt】
java.sql.SQLException: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#39;READ&#39; at line 1
    at org.mariadb.jdbc.internal.protocol.AbstractQueryProtocol.readErrorPacket(AbstractQueryProtocol.java:1594)
    at org.mariadb.jdbc.internal.protocol.AbstractQueryProtocol.readPacket(AbstractQueryProtocol.java:1453)
    at org.mariadb.jdbc.internal.protocol.AbstractQueryProtocol.getResult(AbstractQueryProtocol.java:1415)

这个新的错误信息表明在设置 tx_isolation 时，语法存在问题。我们需要确保设置事务隔离级别的语法是正确的。以下是一些更具体的步骤来解决这个问题：

1. 确认MariaDB版本支持的语法
在MariaDB中，设置事务隔离级别的正确语法可能与MySQL略有不同。确保使用MariaDB支持的正确语法。

2. 确认正确的事务隔离级别语法
根据MariaDB的官方文档，设置事务隔离级别的正确方法是使用以下语法：

sql
复制代码
SET SESSION tx_isolation = &#39;READ-COMMITTED&#39;;
3. 修改连接URL
在连接URL中正确设置事务隔离级别：

yaml
复制代码
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/imooc-news-dev?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;sessionVariables=tx_isolation=&#39;READ-COMMITTED&#39;
4. 确认数据源属性配置
确保数据源属性配置正确：

yaml
复制代码
spring:
  datasource:
    hikari:
      connection-timeout: 30000
      minimum-idle: 5
      maximum-pool-size: 20
      auto-commit: true
      idle-timeout: 600000
      pool-name: DateSourceHikariCP
      max-lifetime: 1800000
      connection-test-query: SELECT 1
      data-source-properties:
        tx_isolation: &#39;READ-COMMITTED&#39;
5. 确认使用MariaDB JDBC驱动
确保使用MariaDB的JDBC驱动：

Maven
xml
复制代码
&lt;dependency&gt;
    &lt;groupId&gt;org.mariadb.jdbc&lt;/groupId&gt;
    &lt;artifactId&gt;mariadb-java-client&lt;/artifactId&gt;
    &lt;version&gt;2.7.2&lt;/version&gt;
&lt;/dependency&gt;
Gradle
groovy
复制代码
implementation &#39;org.mariadb.jdbc:mariadb-java-client:2.7.2&#39;
6. 测试事务隔离设置
在MariaDB中手动测试设置事务隔离级别，确保语法正确：

sql
复制代码
SET SESSION tx_isolation = &#39;READ-COMMITTED&#39;;
如果这条命令可以成功执行，那么它也应该能在你的连接URL中正确设置。

7. 确认Spring配置
确保Spring Boot配置正确，可以通过显式设置数据源属性来避免问题：

yaml
复制代码
spring:
  datasource:
    hikari:
      data-source-properties:
        tx_isolation: &#39;READ-COMMITTED&#39;
总结
通过上述步骤，你应该能够解决 tx_isolation 变量设置的问题，并确保连接到MariaDB数据库时没有语法错误。如果问题依然存在，请提供更多的错误日志和配置文件信息，以便进一步诊断。
</code></pre>
<pre><code class="java">http://writer.imoocnews.com:8003/doc.html 先接收验证码 通过redis获得 再测试登录接口
&#123;
    &quot;mobile&quot;:&quot;15027597319&quot;,
    &quot;smsCode&quot;:&quot;815850&quot;
&#125;

相应内容：
&#123;
    &quot;status&quot;: 200,
    &quot;msg&quot;: &quot;操作成功！&quot;,
    &quot;success&quot;: true,
    -&quot;data&quot;: &#123;
    &quot;id&quot;: &quot;240629F0PD4PZANC&quot;,
    &quot;mobile&quot;: &quot;15027597319&quot;,
    &quot;nickname&quot;: &quot;用户：15******319&quot;,
    &quot;face&quot;: &quot;https://raw.githubusercontent.com/P-luminary/images/875ad52658686e6cc3a8e0cd75d2a324a3d742a9/data/Imooc_Girl.jpg&quot;,
    &quot;realname&quot;: null,
    &quot;email&quot;: null,
    &quot;sex&quot;: 2,
    &quot;birthday&quot;: &quot;2024-06-29 00:00:00&quot;,
    &quot;province&quot;: null,
    &quot;city&quot;: null,
    &quot;district&quot;: null,
    &quot;activeStatus&quot;: 0,
    &quot;totalIncome&quot;: 0,
    &quot;createdTime&quot;: &quot;2024-06-29 19:39:10&quot;,
    &quot;updatedTime&quot;: &quot;2024-06-29 19:39:10&quot;
    &#125;
&#125;

此时去数据库imooc-news-dev的app_user中发现并未有数据新增进入
再UserServiceimpl.java中
appUserMapper.insert(user);

当如果把app_user数据库离的active_status 的0变成2 就会被冻结【UserStatus】
&#123;
&quot;status&quot;: 507,
&quot;msg&quot;: &quot;用户已被冻结，请联系管理员！&quot;,
&quot;success&quot;: false,
&quot;data&quot;: null
&#125;
</code></pre>
<h3 id="设置会话与cookie信息【注册登录】"><a href="#设置会话与cookie信息【注册登录】" class="headerlink" title="设置会话与cookie信息【注册登录】"></a>设置会话与cookie信息【注册登录】</h3><pre><code class="java">service-user  com/imooc/user/controller/PassportController.java
...
 // 3.保存用户分布式会话的相关操作
        int userActiveStatus = user.getActiveStatus();
        if (userActiveStatus != UserStatus.FROZEN.type)&#123;
            String uToken = UUID.randomUUID().toString();
            redis.set(REDIS_USER_TOKEN+&quot;:&quot;+user.getId(),uToken);//BaseController里面 保存token到redis
            //保存用户id和token到cookie中 设计一个request response 回到PassportControllerApi

        &#125;
        return GraceJSONResult.ok(user);
    &#125;
...
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java [增加一个setCookie]
package com.imooc.api;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public abstract class BaseController &#123;
   @Autowired
    public RedisOperator redis;
    public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;
    public static final String REDIS_USER_TOKEN = &quot;redis_user_token&quot;;//ctrl+shift+u直接大写
    public static final Integer COOKIE_MONTH = 30 * 24 * 60 * 60;

    /**可以公用 就放到BaseController里面
     * 在任何controller中都可以调用和使用
     * 获取BO中的错误信息
     *
     * @param result
     * @return
     */
    public Map&lt;String, String&gt; getErrors(BindingResult result)&#123;
        //对应着RegistLoginBO的信息
        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
        List&lt;FieldError&gt; errorList = result.getFieldErrors();
        for (FieldError error : errorList)&#123;
            //发生验证错误所对应的某个属性
            String field = error.getField();
            //验证的错误信息
            String msg = error.getDefaultMessage();
            map.put(field, msg);
        &#125;
        return map;
    &#125;

/*    public void setCookie(HttpServletRequest request,
                          HttpServletResponse response,
                          String cookieName,
                          String cookieValue,
                          Integer maxAge)&#123;
        try &#123;
            cookieValue = URLEncoder.encode(cookieValue, &quot;utf-8&quot;);
            Cookie cookie = new Cookie(cookieName,cookieValue);
            cookie.setMaxAge(maxAge);
            cookie.setDomain(&quot;imoocnews.com&quot;);
            cookie.setPath(&quot;/&quot;);//都用cookie
        &#125; catch (UnsupportedEncodingException e) &#123;
            throw new RuntimeException(e);
        &#125;
    &#125; */

   public void setCookie(HttpServletRequest request,
                          HttpServletResponse response,
                          String cookieName,
                          String cookieValue,
                          Integer maxAge)&#123;
        try &#123;
            cookieValue = URLEncoder.encode(cookieValue, &quot;utf-8&quot;);
//            Cookie cookie = new Cookie(cookieName,cookieValue);
//            cookie.setMaxAge(maxAge);
//            cookie.setDomain(&quot;imoocnews.com&quot;);
//            cookie.setPath(&quot;/&quot;);//都用cookie
            setCookieValue(request, response, cookieName, cookieValue, maxAge);
        &#125; catch (UnsupportedEncodingException e) &#123;
            throw new RuntimeException(e);
        &#125;
    &#125;

    public void setCookieValue(HttpServletRequest request,
                          HttpServletResponse response,
                          String cookieName,
                          String cookieValue,
                          Integer maxAge)&#123;
            Cookie cookie = new Cookie(cookieName,cookieValue);
            cookie.setMaxAge(maxAge);
            cookie.setDomain(&quot;imoocnews.com&quot;);
            cookie.setPath(&quot;/&quot;);//都用cookie
            response.addCookie(cookie);//把cookie传入
        &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/user/PassportControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid; //用户需求验证

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
@RequestMapping(&quot;passport&quot;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode(@RequestParam String mobile, HttpServletRequest request);

    @ApiOperation(value = &quot;一键注册登录接口&quot;,notes = &quot;一键注册登录接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/doLogin&quot;) //表单里面用post  RequestBody后面传过来的东西和json对象对应
    public GraceJSONResult doLogin(@RequestBody @Valid RegistLoginBO registLoginBO
            , BindingResult result, HttpServletRequest request, HttpServletResponse response);
    //完成之后 去BaseController里面写一个setCookie()方便都可以用
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/PassportController.java
    @Override
    public GraceJSONResult doLogin(RegistLoginBO registLoginBO, BindingResult result, HttpServletRequest request, HttpServletResponse response) &#123;
        //0.判断BindingResult中是否保存了错误的验证信息 如果有则需要返回
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;
        String mobile = registLoginBO.getMobile();
        String smsCode = registLoginBO.getSmsCode();

        //1.校验验证码是否匹配[在redis中去获取]
        String redisSMSCode = redis.get(MOBILE_SMSCODE + &quot;:&quot; + mobile); //为空||不同值
        if (StringUtils.isBlank(redisSMSCode) || !redisSMSCode.equalsIgnoreCase(smsCode)) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.SMS_CODE_ERROR);
        &#125;

        //2.查询数据库,判断该用户注册
        AppUser user = userService.queryMobileIsExist(mobile);
        if (user != null &amp;&amp; user.getActiveStatus() == UserStatus.FROZEN.type)&#123;
            //如果用户不为空，并且状态为冻结，则直接抛出异常，禁止登录
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_FROZEN);
        &#125;else if (user == null)&#123;
            //如果用户没有注册过，则为null，需要注册信息入库
            user = userService.createUser(mobile);
        &#125;

        // 3.保存用户分布式会话的相关操作
        int userActiveStatus = user.getActiveStatus();
        if (userActiveStatus != UserStatus.FROZEN.type)&#123;
            String uToken = UUID.randomUUID().toString();
            redis.set(REDIS_USER_TOKEN+&quot;:&quot;+user.getId(),uToken);//BaseController里面 保存token到redis

            //保存用户id和token到cookie中 设计一个request response 回到PassportControllerApi
            setCookie(request, response,&quot;uToken&quot;,uToken,COOKIE_MONTH);
            setCookie(request, response,&quot;uid&quot;,user.getId(),COOKIE_MONTH);
        &#125;
        // 4.用户登录或注册成功以后，需要删除redis中的短信验证码，验证码只能使用一次，用过则作废
        redis.del(MOBILE_SMSCODE + &quot;:&quot; + mobile);
        // 5.返回用户状态 返回前端看
        return GraceJSONResult.ok(userActiveStatus);
    &#125;
</code></pre>
<h3 id="资源属性与常量绑定-优雅"><a href="#资源属性与常量绑定-优雅" class="headerlink" title="资源属性与常量绑定 [优雅]"></a>资源属性与常量绑定 [优雅]</h3><pre><code class="java">把这种属性放到常量文件里进行绑定  cookie.setDomain(&quot;imoocnews.com&quot;);
service-api  com/imooc/api/BaseController.java
public abstract class BaseController &#123;
    @Autowired
    public RedisOperator redis;
    public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;
    public static final String REDIS_USER_TOKEN = &quot;redis_user_token&quot;;//ctrl+shift+u直接大写
    public static final Integer COOKIE_MONTH = 30 * 24 * 60 * 60;
 ★ @Value(&quot;$&#123;website.domain-name&#125;&quot;) ★★
 ★ public String DOMAIN_NAME; ★★
...
 public void setCookie(HttpServletRequest request,
                          HttpServletResponse response,
                          String cookieName,
                          String cookieValue,
                          Integer maxAge) &#123;
        try &#123;
            cookieValue = URLEncoder.encode(cookieValue, &quot;utf-8&quot;);
//            Cookie cookie = new Cookie(cookieName,cookieValue);
//            cookie.setMaxAge(maxAge);
//            cookie.setDomain(&quot;imoocnews.com&quot;);
//            cookie.setPath(&quot;/&quot;);//都用cookie
            setCookieValue(request, response, cookieName, cookieValue, maxAge);
        &#125; catch (UnsupportedEncodingException e) &#123;
            throw new RuntimeException(e);
        &#125;
    &#125;

    public void setCookieValue(HttpServletRequest request,
                               HttpServletResponse response,
                               String cookieName,
                               String cookieValue,
                               Integer maxAge) &#123;
        Cookie cookie = new Cookie(cookieName, cookieValue);
        cookie.setMaxAge(maxAge);
//        cookie.setDomain(&quot;imoocnews.com&quot;);
        cookie.setDomain(DOMAIN_NAME);
        cookie.setPath(&quot;/&quot;);//都用cookie
        response.addCookie(cookie);//把cookie传入
    &#125;
...
================================================================================
application-dev.yml
server:
  port: 8003

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379

# setup CN from java, This is resource
website:
  domain-name: imoocnews.com
</code></pre>
<h3 id="查询用户账户信息"><a href="#查询用户账户信息" class="headerlink" title="查询用户账户信息"></a>查询用户账户信息</h3><pre><code class="java">service-api  com/imooc/api/controller/user/UserControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

@Api(value = &quot;用户信息相关Controller&quot;,tags = &#123;&quot;用户信息相关Controller&quot;&#125;)
@RequestMapping(&quot;user&quot;)
public interface UserControllerApi &#123;
    @ApiOperation(value = &quot;获得用户账户信息&quot;,notes = &quot;获得用户账户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAccountInfo&quot;)
    public GraceJSONResult getAccountInfo(@RequestParam String userId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
package com.imooc.user.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.api.controller.user.UserControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.vo.UserAccountInfoVO;
import com.imooc.user.service.impl.UserService;
import com.imooc.utils.RedisOperator;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@RestController
public class UserController implements UserControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(UserController.class);

    @Autowired
    private UserService userService;

    @Override
    public GraceJSONResult getAccountInfo(String userId) &#123;
        // 0. 判断参数不为空
        if (StringUtils.isBlank(userId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.UN_LOGIN);
        &#125;

        // 1. 根据userId查询用户的信息 UserService+impl
        AppUser user = getUser(userId);
        // 2. 返回用户信息
        UserAccountInfoVO accountInfoVO = new UserAccountInfoVO();
        BeanUtils.copyProperties(user, accountInfoVO); //拷贝信息
        return GraceJSONResult.ok(accountInfoVO);
    &#125;
    private AppUser getUser(String userId)&#123;
        // TODO 本方法后续公用，并且扩展
        AppUser user = userService.getUser(userId);
        return user;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/UserService.java
package com.imooc.user.service.impl;

import com.imooc.pojo.AppUser;

public interface UserService &#123;
    /**
     * 判断用户是否存在，如果存在返回user信息
     */
    public AppUser queryMobileIsExist(String mobile);

    /**
     * 创建用户，新增用户记录到数据库
     */
    public AppUser createUser(String mobile);

    /**
     * 根据用户主键id查询用户信息
     * @param userId
     * @return
     */
    public AppUser getUser(String userId);
&#125;
====================================================================
service-user  com/imooc/user/service/UserServiceimpl.java
     @Override
    public AppUser getUser(String userId) &#123;
        return appUserMapper.selectByPrimaryKey(userId);
    &#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/UserAccountInfoVO.java
public class UserAccountInfoVO &#123;
    private String id;
    private String mobile;
    private String nickname;
    private String face;
    private String realname;
    private String email;
    private Integer sex;
    private Date birthday;
    private String province;
    private String city;
    private String district;
&#125;Getter + Setter
</code></pre>
<h3 id="信息校验"><a href="#信息校验" class="headerlink" title="信息校验"></a>信息校验</h3><pre><code class="java">service-user  com/imooc/user/controller/UserController.java
package com.imooc.user.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.api.controller.user.UserControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import com.imooc.pojo.vo.UserAccountInfoVO;
import com.imooc.user.service.impl.UserService;
import com.imooc.utils.RedisOperator;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.Map;

@RestController
public class UserController extends BaseController implements UserControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(UserController.class);

    @Autowired
    private UserService userService;

    @Override
    public GraceJSONResult getAccountInfo(String userId) &#123;
        // 0. 判断参数不为空
        if (StringUtils.isBlank(userId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.UN_LOGIN);
        &#125;

        // 1. 根据userId查询用户的信息 UserService+impl
        AppUser user = getUser(userId);
        // 2. 返回用户信息
        UserAccountInfoVO accountInfoVO = new UserAccountInfoVO();
        BeanUtils.copyProperties(user, accountInfoVO); //拷贝信息
        return GraceJSONResult.ok(accountInfoVO);
    &#125;

    private AppUser getUser(String userId)&#123;
        // TODO 本方法后续公用，并且扩展
        AppUser user = userService.getUser(userId);
        return user;
    &#125;

    @Override
    public GraceJSONResult updateUserInfo(UpdateUserInfoBO updateUserInfoBO, BindingResult result) &#123;
        // 0.校验BO
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;
        // 1.执行更新操作
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/user/UserControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

@Api(value = &quot;用户信息相关Controller&quot;,tags = &#123;&quot;用户信息相关Controller&quot;&#125;)
@RequestMapping(&quot;user&quot;)
public interface UserControllerApi &#123;
    @ApiOperation(value = &quot;获得用户账户信息&quot;,notes = &quot;获得用户账户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAccountInfo&quot;)
    public GraceJSONResult getAccountInfo(@RequestParam String userId);

    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/updateUserInfo&quot;)
    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO,
                                          BindingResult result);
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/bo/UpdateUserInfoBO.java
public class UpdateUserInfoBO &#123;

    @NotBlank(message = &quot;用户ID不能为空&quot;)
    private String id;

    @NotBlank(message = &quot;用户昵称不能为空&quot;)
    @Length(max = 12, message = &quot;用户昵称不能超过12位&quot;)
    private String nickname;

    @NotBlank(message = &quot;用户头像不能为空&quot;)
    private String face;

    @NotBlank(message = &quot;真实姓名不能为空&quot;)
    private String realname;

    @Email
    @NotBlank(message = &quot;邮件不能为空&quot;)
    private String email;

    @NotNull(message = &quot;请选择一个性别&quot;)
    @Min(value = 0, message = &quot;性别选择不正确&quot;)
    @Max(value = 1, message = &quot;性别选择不正确&quot;)
    private Integer sex;

    @NotNull(message = &quot;请选择生日日期&quot;)
    @JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd&quot;) // 解决前端日期字符串传到后端后，转换为Date类型
    private Date birthday;

    @NotBlank(message = &quot;请选择所在城市&quot;)
    private String province;

    @NotBlank(message = &quot;请选择所在城市&quot;)
    private String city;

    @NotBlank(message = &quot;请选择所在城市&quot;)
    private String district;
&#125;
</code></pre>
<h3 id="激活用户信息入库"><a href="#激活用户信息入库" class="headerlink" title="激活用户信息入库"></a>激活用户信息入库</h3><pre><code class="java">service-user  com/imooc/user/controller/UserController.java
@Override
    public GraceJSONResult updateUserInfo(UpdateUserInfoBO updateUserInfoBO, BindingResult result) &#123;
        // 0.校验BO
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;
        // 1.执行更新操作
        userService.updateUserInfo(updateUserInfoBO);
        return GraceJSONResult.ok();
        //调用UserService把独有信息传入
    &#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/UserService.java
package com.imooc.user.service.impl;

import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.UpdateUserInfoBO;

public interface UserService &#123;
    /**
     * 判断用户是否存在，如果存在返回user信息
     */
    public AppUser queryMobileIsExist(String mobile);

    /**
     * 创建用户，新增用户记录到数据库
     */
    public AppUser createUser(String mobile);

    /**
     * 根据用户主键id查询用户信息
     * @param userId
     * @return
     */
    public AppUser getUser(String userId);

    /**
     * 用户修改信息，完善资料，并且激活
     * @param updateUserInfoBO
     */
    public void updateUserInfo(UpdateUserInfoBO updateUserInfoBO);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/UserServiceimpl.java
@Override
    public void updateUserInfo(UpdateUserInfoBO updateUserInfoBO)&#123;
        String userId = updateUserInfoBO.getId();
        AppUser userInfo = new AppUser();
        BeanUtils.copyProperties(updateUserInfoBO, userInfo);
        userInfo.setUpdatedTime(new Date());
        userInfo.setActiveStatus(UserStatus.ACTIVE.type);
        //appUserMapper.updateByPrimaryKey()//数据中现有的数据覆盖为空的
        int result = appUserMapper.updateByPrimaryKeySelective(userInfo);
        if (result != 1)&#123;
            //更新操作有问题
            GraceException.display(ResponseStatusEnum.USER_UPDATE_ERROR);
        &#125;
    &#125;
</code></pre>
<h3 id="查询并展示用户基本信息"><a href="#查询并展示用户基本信息" class="headerlink" title="查询并展示用户基本信息"></a>查询并展示用户基本信息</h3><pre><code class="java">service-api  com/imooc/api/controller/user/UserControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

@Api(value = &quot;用户信息相关Controller&quot;,tags = &#123;&quot;用户信息相关Controller&quot;&#125;)
@RequestMapping(&quot;user&quot;)
public interface UserControllerApi &#123;

    @ApiOperation(value = &quot;获得用户基本信息&quot;,notes = &quot;获得用户基本信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getUserInfo&quot;)
    public GraceJSONResult getUserInfo(@RequestParam String userId);
    @ApiOperation(value = &quot;获得用户账户信息&quot;,notes = &quot;获得用户账户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAccountInfo&quot;)
    public GraceJSONResult getAccountInfo(@RequestParam String userId);

    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/updateUserInfo&quot;)
    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO,BindingResult result);
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/AppUserVO.java
public class AppUserVO &#123;
    private String id;
    private String nickname;
    private String face;
    private Integer activeStatus;
&#125;Getter+Setter
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
@RestController
public class UserController extends BaseController implements UserControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(UserController.class);

    @Autowired
    private UserService userService;

    @Override
    public GraceJSONResult getUserInfo(String userId) &#123;
        //重写接口进行解耦!!
        // 0. 判断参数不为空
        if (StringUtils.isBlank(userId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.UN_LOGIN);
        &#125;
        // 1. 根据userId查询用户的信息 UserService+impl
        AppUser user = getUser(userId);
        // 2. 返回用户信息
        AppUserVO userVO = new AppUserVO();
        BeanUtils.copyProperties(user, userVO); //拷贝信息
        return GraceJSONResult.ok(userVO);
    &#125;
&#125;
</code></pre>
<h3 id="浏览器存储介质"><a href="#浏览器存储介质" class="headerlink" title="浏览器存储介质"></a>浏览器存储介质</h3><ul>
<li><h6 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h6></li>
<li><h6 id="SessionStorage"><a href="#SessionStorage" class="headerlink" title="SessionStorage"></a><span style = "color:red">SessionStorage</span></h6></li>
<li><h6 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h6></li>
</ul>
<h3 id="缓存用户信息-用Redis减轻数据库压力"><a href="#缓存用户信息-用Redis减轻数据库压力" class="headerlink" title="缓存用户信息 [用Redis减轻数据库压力]"></a>缓存用户信息 [用Redis减轻数据库压力]</h3><pre><code class="java">service-api  com/imooc/api/BaseController.java
//REDIS_USER_INFO添加进来
public abstract class BaseController &#123;
    @Autowired
    public RedisOperator redis;
    public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;
    public static final String REDIS_USER_TOKEN = &quot;redis_user_token&quot;;//ctrl+shift+u直接大写
    public static final String REDIS_USER_INFO = &quot;redis_user_info&quot;;//ctrl+shift+u直接大写
    public static final Integer COOKIE_MONTH = 30 * 24 * 60 * 60;
    @Value(&quot;$&#123;website.domain-name&#125;&quot;)
    public String DOMAIN_NAME;

    /**
     * 可以公用 就放到BaseController里面
     * 在任何controller中都可以调用和使用
     * 获取BO中的错误信息
     *
     * @param result
     * @return
     */
    public Map&lt;String, String&gt; getErrors(BindingResult result) &#123;
        //对应着RegistLoginBO的信息
        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
        List&lt;FieldError&gt; errorList = result.getFieldErrors();
        for (FieldError error : errorList) &#123;
            //发生验证错误所对应的某个属性
            String field = error.getField();
            //验证的错误信息
            String msg = error.getDefaultMessage();
            map.put(field, msg);
        &#125;
        return map;
    &#125;

    public void setCookie(HttpServletRequest request,
                          HttpServletResponse response,
                          String cookieName,
                          String cookieValue,
                          Integer maxAge) &#123;
        try &#123;
            cookieValue = URLEncoder.encode(cookieValue, &quot;utf-8&quot;);
//            Cookie cookie = new Cookie(cookieName,cookieValue);
//            cookie.setMaxAge(maxAge);
//            cookie.setDomain(&quot;imoocnews.com&quot;);
//            cookie.setPath(&quot;/&quot;);//都用cookie
            setCookieValue(request, response, cookieName, cookieValue, maxAge);
        &#125; catch (UnsupportedEncodingException e) &#123;
            throw new RuntimeException(e);
        &#125;
    &#125;

    public void setCookieValue(HttpServletRequest request,
                               HttpServletResponse response,
                               String cookieName,
                               String cookieValue,
                               Integer maxAge) &#123;
        Cookie cookie = new Cookie(cookieName, cookieValue);
        cookie.setMaxAge(maxAge);
//        cookie.setDomain(&quot;imoocnews.com&quot;);
        cookie.setDomain(DOMAIN_NAME);
        cookie.setPath(&quot;/&quot;);//都用cookie
        response.addCookie(cookie);//把cookie传入
    &#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
 private AppUser getUser(String userId)&#123;
        //查询判断redis中是否包含用户信息 若有则直接返回就不去查询数据库了
        String userJson = redis.get(REDIS_USER_INFO + &quot;:&quot; + userId);
        AppUser user = null;
        if (StringUtils.isNotBlank(userJson))&#123;
            //字符串转换成json对象  要提取user 所以要一开始赋值null
            user = JsonUtils.jsonToPojo(userJson, AppUser.class);
        &#125; else &#123;
            // TODO 本方法后续公用，并且扩展
            user = userService.getUser(userId);
            // 由于用户信息不怎么会变动,对于一些千万级别网站来说,这类信息不会直接去查询数据库
            // 可以完全依靠Redis,直接把查询后的数据存入到Redis中
            // set里面设置一个key去BaseController里设置  ↓user变成jason转换类
            redis.set(REDIS_USER_INFO + &quot;:&quot; + userId, JsonUtils.objectToJson(user));
        &#125;

        return user;
    &#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/UserServiceimpl.java
package com.imooc.user.service;

import com.imooc.enums.Sex;
import com.imooc.enums.UserStatus;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import com.imooc.user.mapper.AppUserMapper;
import com.imooc.user.service.impl.UserService;
import com.imooc.utils.DesensitizationUtil;
import com.imooc.utils.JsonUtils;
import com.imooc.utils.RedisOperator;
import org.n3r.idworker.Sid;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;
import com.imooc.utils.DateUtil;

import java.util.Date;

@Service
public class UserServiceimpl implements UserService &#123;
    @Autowired
    public AppUserMapper appUserMapper; //基本的CRUD都可以

    @Autowired
    public Sid sid;
    public static final String REDIS_USER_INFO = &quot;redis_user_info&quot;;//ctrl+shift+u直接大写


    @Autowired
    public RedisOperator redis;

    private static final String USER_FACE0 = &quot;https://raw.githubusercontent.com/P-luminary/images/10d94134b65e13cc8ec9b8a9aeae4f958921cab7/data/Imooc_Cat.jpg&quot;;
    private static final String USER_FACE1 = &quot;https://raw.githubusercontent.com/P-luminary/images/875ad52658686e6cc3a8e0cd75d2a324a3d742a9/data/Imooc_Girl.jpg&quot;;
    @Override
    public AppUser queryMobileIsExist(String mobile) &#123;
        Example userExample = new Example(AppUser.class);
        Example.Criteria userCriteria = userExample.createCriteria();
        userCriteria.andEqualTo(&quot;mobile&quot;, mobile);
        AppUser user = appUserMapper.selectOneByExample(userExample);
        return user;
    &#125;

    @Transactional //对整个类的方法，事务起作用。无异常时正常提交，有异常时数据回滚
    @Override
    public AppUser createUser(String mobile) &#123;
        /**
         * 互联网项目都要考虑可扩展性
         * 如果未来的业务激增，那么就需要分表分库
         * 那么数据库表主键id必须保证全局(全库)唯一,不得重复
         */
        String userId = sid.nextShort();
        AppUser user = new AppUser();
        user.setId(userId);
        user.setMobile(mobile);
        user.setNickname(&quot;用户：&quot; + DesensitizationUtil.commonDisplay(mobile)); //給手机号加** 是脱敏操作
        user.setFace(USER_FACE1);
        user.setBirthday(DateUtil.stringToDate(&quot;2024-06-29&quot;)); //字符串转换Date类型
        user.setSex(Sex.secret.type);
        user.setActiveStatus(UserStatus.INACTIVE.type);//是否激活
        user.setTotalIncome(0);//收入
        user.setCreatedTime(new Date());
        user.setUpdatedTime(new Date());
        appUserMapper.insert(user);
        return user;
    &#125;

    @Override
    public AppUser getUser(String userId) &#123;
        return appUserMapper.selectByPrimaryKey(userId);
    &#125;

    @Override
    public void updateUserInfo(UpdateUserInfoBO updateUserInfoBO)&#123;
        String userId = updateUserInfoBO.getId();
        AppUser userInfo = new AppUser();
        BeanUtils.copyProperties(updateUserInfoBO, userInfo);

        userInfo.setUpdatedTime(new Date());
        userInfo.setActiveStatus(UserStatus.ACTIVE.type);
        //appUserMapper.updateByPrimaryKey()//数据中现有的数据覆盖为空的
        int result = appUserMapper.updateByPrimaryKeySelective(userInfo);
        if (result != 1)&#123;
            //更新操作有问题
            GraceException.display(ResponseStatusEnum.USER_UPDATE_ERROR);
        &#125;
        // 再次查询用户的最新信息,放入redis中
        AppUser user = getUser(userId);
        redis.set(REDIS_USER_INFO + &quot;:&quot; + userId, JsonUtils.objectToJson(user));

    &#125;
&#125;
</code></pre>
<pre><code class="java">Redis里面 redis_user_info
&#123;&quot;id&quot;:&quot;240629F21AK1BHX4&quot;,&quot;mobile&quot;:&quot;15027597319&quot;,&quot;nickname&quot;:&quot;15027597319&quot;,&quot;face&quot;:&quot;https://raw.githubusercontent.com/P-luminary/images/875ad52658686e6cc3a8e0cd75d2a324a3d742a9/data/Imooc_Girl.jpg&quot;,&quot;realname&quot;:&quot;小宝宝的小潘潘2&quot;,&quot;email&quot;:&quot;390415030@qq.com&quot;,&quot;sex&quot;:1,&quot;birthday&quot;:1720195200000,&quot;province&quot;:&quot;河北&quot;,&quot;city&quot;:&quot;唐山市&quot;,&quot;district&quot;:&quot;丰润区&quot;,&quot;activeStatus&quot;:1,&quot;totalIncome&quot;:0,&quot;createdTime&quot;:1719661387000,&quot;updatedTime&quot;:1720281759000&#125;
</code></pre>
<h3 id="双写数据不一致的情况-redis故障没有写入新数据"><a href="#双写数据不一致的情况-redis故障没有写入新数据" class="headerlink" title="双写数据不一致的情况 [redis故障没有写入新数据]"></a>双写数据不一致的情况 [redis故障没有写入新数据]</h3><h6 id="如何双写一致-缓存双删"><a href="#如何双写一致-缓存双删" class="headerlink" title="如何双写一致 缓存双删"></a>如何双写一致 缓存双删</h6><blockquote>
<p>用户先把老Redis中的数据删除 然后再把修改值放入数据库 然后数据库再导入redis 就可以保证双写一致<br>但是要保证数据库放入Redis之前 后期用户请求要再其之后 [进行休眠] &#x3D;&gt;缓存双删</p>
</blockquote>
<pre><code class="java">service-user  com/imooc/user/service/UserServiceimpl.java  @Override
    public void updateUserInfo(UpdateUserInfoBO updateUserInfoBO)&#123;
        String userId = updateUserInfoBO.getId();
        // 保证双写一致,先删除redis中的数据,后更新数据库
//        redis.del(REDIS_USER_INFO + &quot;:&quot; + userId);

        AppUser userInfo = new AppUser();
        BeanUtils.copyProperties(updateUserInfoBO, userInfo);

        userInfo.setUpdatedTime(new Date());
        userInfo.setActiveStatus(UserStatus.ACTIVE.type);
        //appUserMapper.updateByPrimaryKey()//数据中现有的数据覆盖为空的
        int result = appUserMapper.updateByPrimaryKeySelective(userInfo);
        if (result != 1)&#123;
            //更新操作有问题
            GraceException.display(ResponseStatusEnum.USER_UPDATE_ERROR);
        &#125;
        // 再次查询用户的最新信息,放入redis中
        AppUser user = getUser(userId);
        redis.set(REDIS_USER_INFO + &quot;:&quot; + userId, JsonUtils.objectToJson(user));

        // 缓存双删策略 [不处理可能会缓存击穿]
        try &#123;
            Thread.sleep(100);
            redis.del(REDIS_USER_INFO + &quot;:&quot; + userId);
        &#125; catch (InterruptedException e) &#123;
            throw new RuntimeException(e);
        &#125;
</code></pre>
<h3 id="CAP理论-只能满足其中一、二"><a href="#CAP理论-只能满足其中一、二" class="headerlink" title="CAP理论 [只能满足其中一、二]"></a>CAP理论 [只能满足其中一、二]</h3><h5 id="分布式系统都存在CAP情况"><a href="#分布式系统都存在CAP情况" class="headerlink" title="分布式系统都存在CAP情况"></a>分布式系统都存在CAP情况</h5><h4 id="定理"><a href="#定理" class="headerlink" title="定理"></a>定理</h4><h5 id="CAP的重要性"><a href="#CAP的重要性" class="headerlink" title="CAP的重要性"></a>CAP的重要性</h5><p>分布式不可能同时满足三个条件 【先满足P再去考虑A或C】</p>
<h5 id="CAP理论是什么？"><a href="#CAP理论是什么？" class="headerlink" title="CAP理论是什么？"></a>CAP理论是什么？</h5><ul>
<li><span style = "color:red"><strong>C</strong>(Consistency, 一致性)</span>：读操作是否总能读到前一个写操作的结果 [某节点获得的数据都是一样的] 在本项目中一致性位于Session Storage</li>
<li><span style = "color:red"><strong>A</strong>(Availability, 可用性)</span>：非故障节点应该在合理的时间内作出合理的响应(不是错误或超时的响应),但是可能<strong>不是最新的数据</strong>。 [某个挂掉了 其他还可以用]</li>
<li><span style = "color:red"><strong>P</strong>(Partition tolerance, 分区容错)</span>：当出现网络分区现象后，系统能够继续运行。分区容错性</li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/793eb4ab3003af82869b186bcc016fcb8c2c2f5b/data/CAP%E5%AE%9A%E7%90%86.jpg"></p>
<h5 id="CAP如何选择？"><a href="#CAP如何选择？" class="headerlink" title="CAP如何选择？"></a>CAP如何选择？</h5><ul>
<li><strong>CP</strong>[支付宝]或者<strong>AP</strong>[超级跑跑系统维护]</li>
<li>在什么场合，可用性高于一致性？<ul>
<li>网页必须要保障<strong>可用性</strong>(一定能看到最重要 是不是最新的不重要)和<strong>分区容错</strong></li>
<li>支付的时候一定要保障<strong>一致性</strong>(我可以保证不可用 但我不允许余额不一致)和<strong>分区容错</strong></li>
</ul>
</li>
<li>合适的才是最好的</li>
<li><strong>CP</strong>：Redis【保证数据一致性 一定要满足C】</li>
<li><strong>AP</strong>：会采用弱一致性 淘宝下单只需要知道下单就好 数量一致性商家可以慢慢调整</li>
<li><strong>CA</strong>：单体存在架构、关系型架构</li>
</ul>
<p>在本项目中如果采用弱一致性：可以不把用户存到session Storage 直接显示</p>
<h3 id="集群、分布式、微服务的区别"><a href="#集群、分布式、微服务的区别" class="headerlink" title="集群、分布式、微服务的区别"></a>集群、分布式、微服务的区别</h3><h5 id="集群和分布式的区别"><a href="#集群和分布式的区别" class="headerlink" title="集群和分布式的区别"></a>集群和分布式的区别</h5><ul>
<li>分布式：一个业务分拆<strong>多个子业务</strong>，部署在不同的服务器上 [服务器之间要通信]</li>
<li>集群：<strong>同一个</strong>业务，部署在多个服务器上 [五台机器可以不通信]</li>
</ul>
<h5 id="集群和微服务的区别"><a href="#集群和微服务的区别" class="headerlink" title="集群和微服务的区别"></a>集群和微服务的区别</h5><ul>
<li>集群：分散<strong>压力</strong></li>
<li>微服务：分散<strong>压力</strong></li>
</ul>
<h5 id="微服务和分布式的区别"><a href="#微服务和分布式的区别" class="headerlink" title="微服务和分布式的区别"></a>微服务和分布式的区别</h5><ul>
<li><p>微服务是<strong>架构设计</strong>方式 [逻辑架构]</p>
</li>
<li><p>分布式是<strong>系统部署</strong>方式 [物理架构]</p>
</li>
<li><p>微服务：是一种架构方式 [大的服务拆成小的服务 每个服务独立开发测试]</p>
</li>
<li><p>分布式：主要强调部署的方式</p>
</li>
</ul>
<h3 id="用户会话拦截器-必须用户登陆后才可以用其他界面"><a href="#用户会话拦截器-必须用户登陆后才可以用其他界面" class="headerlink" title="用户会话拦截器 [必须用户登陆后才可以用其他界面]"></a>用户会话拦截器 [必须用户登陆后才可以用其他界面]</h3><pre><code class="java">service-api  com/imooc/api/interceptors/UserTokenInterceptor.java
package com.imooc.api.interceptors;

import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.IPUtil;
import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class UserTokenInterceptor extends BaseInterceptor implements HandlerInterceptor &#123;

    /**
     * 拦截请求，访问controller之前
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        // 有些接口同时会給安卓 H5等 所以不去cookie拿
        String userId = request.getHeader(&quot;headerUserId&quot;);
        String userToken = request.getHeader(&quot;headerUserToken&quot;);

        // 判断是否放行
        boolean run = verifyUserIdToken(userId, userToken, REDIS_USER_TOKEN);

        /**
         * false：请求被拦截
         * true：请求通过验证，放行
         */
        return true;
    &#125;


    /**
     * 请求访问到controller之后，渲染视图之前
     * @param request
     * @param response
     * @param handler
     * @param modelAndView
     * @throws Exception
     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;

    &#125;

    /**
     * 请求访问到controller之后，渲染视图之后
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;

    &#125;
&#125;
</code></pre>
<pre><code class="java">package com.imooc.api.interceptors;

import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.RedisOperator;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;

public class BaseInterceptor &#123;
    @Autowired
    private RedisOperator redis;
    public static final String REDIS_USER_TOKEN = &quot;redis_user_token&quot;;//ctrl+shift+u直接大写

    public boolean verifyUserIdToken(String id,
                                     String token,
                                     String redisKeyPrefix)&#123; //redis..前缀
        if (StringUtils.isNotBlank(id) &amp;&amp; StringUtils.isNotBlank(token))&#123;
            String redisToken = redis.get(redisKeyPrefix + &quot;:&quot; + id);
            if (StringUtils.isBlank(id))&#123;
                GraceException.display(ResponseStatusEnum.UN_LOGIN);
                return false;
            &#125; else &#123;
                if (!redisToken.equalsIgnoreCase(token))&#123;//是否和传入token一致
                    GraceException.display(ResponseStatusEnum.TICKET_INVALID);
                    return false;
                &#125;
            &#125;
        &#125;else &#123;
            GraceException.display(ResponseStatusEnum.UN_LOGIN);
            return false;
        &#125;
        return true;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
package com.imooc.api.config;

import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;

    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;);
    &#125;
&#125;
/*
在你的 Spring 应用程序中，InterceptorConfig 类中的 @Bean 注解用于定义 PassportInterceptor 和 UserTokenInterceptor 的 bean。这使这些拦截器对象在 Spring 上下文中可用，以便进行依赖注入。

删除 @Bean 注解后会出现错误 Autowired members must be defined in valid Spring bean (@Component|@Service|...)，这是因为 BaseInterceptor 类中有一个需要由 Spring 注入的依赖 (RedisOperator redis)。要让 Spring 执行依赖注入，包含 @Autowired 注解的类必须是一个由 Spring 管理的 bean，可以通过 @Component、@Service、@Controller 等注解或在配置类中通过 @Bean 来定义。

这里是对 @Bean 的作用以及为什么删除它会导致错误的详细解释：

使用 @Bean 定义 Bean：
在 InterceptorConfig 类中，@Bean 注解定义了 PassportInterceptor 和 UserTokenInterceptor 作为 Spring 的 bean。这使得它们在整个应用程序中可用于依赖注入。

依赖注入的要求：
BaseInterceptor 类中使用了 @Autowired 注解来注入 RedisOperator。要使这个注入有效，BaseInterceptor 必须是一个 Spring 管理的 bean。而 @Bean 注解在配置类中定义了这些拦截器，使得 Spring 可以管理它们，并在需要时进行依赖注入。

如果删除了 @Bean 注解，PassportInterceptor 和 UserTokenInterceptor 将不再是 Spring 管理的 bean，从而导致在它们内部或相关联的类（如 BaseInterceptor）中的依赖无法被注入。这就是为什么删除 @Bean 注解后会出现 Autowired members must be defined in valid Spring bean (@Component|@Service|...) 错误的原因。
*/
</code></pre>
<h3 id="用户状态激活拦截器"><a href="#用户状态激活拦截器" class="headerlink" title="用户状态激活拦截器"></a>用户状态激活拦截器</h3><pre><code class="java">service-api  com/imooc/api/interceptors/UseActiveInterceptor.java
package com.imooc.api.interceptors;

import com.imooc.enums.UserStatus;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AppUser;
import com.imooc.utils.JsonUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * 用户激活状态检测拦截器
 * 发文章，修改文章，删除文章，发表评论，查看评论等
 * 这些接口都是要在用户激活后才能进行操作
 * 否则需要提示用户前往[账号设置]去修改信息
 */
    public class UseActiveInterceptor extends BaseInterceptor implements HandlerInterceptor &#123;

    /**
     * 拦截请求，访问controller之前
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        // 有些接口同时会給安卓 H5等 所以不去cookie拿
        String userId = request.getHeader(&quot;headerUserId&quot;);
        String userJson = redis.get(REDIS_USER_INFO + &quot;:&quot; + userId);
        AppUser user = null;
        if (StringUtils.isNotBlank(userJson))&#123;
            user = JsonUtils.jsonToPojo(userJson, AppUser.class);
        &#125; else &#123;
            GraceException.display(ResponseStatusEnum.UN_LOGIN);
        &#125;
        if (user.getActiveStatus() == null || user.getActiveStatus() != UserStatus.ACTIVE.type)&#123;
            GraceException.display(ResponseStatusEnum.USER_INACTIVE_ERROR);
            return false;
            //随后去拦截器里进行@Bean注册 [下下个代码就是]
        &#125;

        /**
         * false：请求被拦截
         * true：请求通过验证，放行
         */
        return true;
    &#125;

    /**
     * 请求访问到controller之后，渲染视图之前
     * @param request
     * @param response
     * @param handler
     * @param modelAndView
     * @throws Exception
     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;
    &#125;
    /**
     * 请求访问到controller之后，渲染视图之后
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;

    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/PassportController.java
//[加一行redis.set(REDIS_USER_INFO+&quot;:&quot;+user.getId(), JsonUtils.objectToJson(user));]
@Override
    public GraceJSONResult doLogin(RegistLoginBO registLoginBO, BindingResult result, HttpServletRequest request, HttpServletResponse response) &#123;
        //0.判断BindingResult中是否保存了错误的验证信息 如果有则需要返回
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;
        String mobile = registLoginBO.getMobile();
        String smsCode = registLoginBO.getSmsCode();

        //1.校验验证码是否匹配[在redis中去获取]
        String redisSMSCode = redis.get(MOBILE_SMSCODE + &quot;:&quot; + mobile); //为空||不同值
        if (StringUtils.isBlank(redisSMSCode) || !redisSMSCode.equalsIgnoreCase(smsCode)) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.SMS_CODE_ERROR);
        &#125;

        //2.查询数据库,判断该用户注册
        AppUser user = userService.queryMobileIsExist(mobile);
        if (user != null &amp;&amp; user.getActiveStatus() == UserStatus.FROZEN.type)&#123;
            //如果用户不为空，并且状态为冻结，则直接抛出异常，禁止登录
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_FROZEN);
        &#125;else if (user == null)&#123;
            //如果用户没有注册过，则为null，需要注册信息入库
            user = userService.createUser(mobile);
        &#125;

        // 3.保存用户分布式会话的相关操作
        int userActiveStatus = user.getActiveStatus();
        if (userActiveStatus != UserStatus.FROZEN.type)&#123;
            String uToken = UUID.randomUUID().toString();
            redis.set(REDIS_USER_TOKEN+&quot;:&quot;+user.getId(),uToken);//BaseController里面 保存token到redis
            redis.set(REDIS_USER_INFO+&quot;:&quot;+user.getId(), JsonUtils.objectToJson(user));

            //保存用户id和token到cookie中 设计一个request response 回到PassportControllerApi
            setCookie(request, response,&quot;utoken&quot;,uToken,COOKIE_MONTH);
            setCookie(request, response,&quot;uid&quot;,user.getId(),COOKIE_MONTH);
        &#125;
        // 4.用户登录或注册成功以后，需要删除redis中的短信验证码，验证码只能使用一次，用过则作废
//        redis.del(MOBILE_SMSCODE + &quot;:&quot; + mobile);
        // 5.返回用户状态 返回前端看
        return GraceJSONResult.ok(userActiveStatus);
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
package com.imooc.api.config;

import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UseActiveInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UseActiveInterceptor useActiveInterceptor()&#123;
        return new UseActiveInterceptor();
    &#125;

    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;);
//        registry.addInterceptor(userTokenInterceptor())
//                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
    &#125;
&#125;
</code></pre>
<h3 id="AOP警告日志监控与sql打印-切面AOP通知编程"><a href="#AOP警告日志监控与sql打印-切面AOP通知编程" class="headerlink" title="AOP警告日志监控与sql打印 [切面AOP通知编程]"></a>AOP警告日志监控与sql打印 [切面AOP通知编程]</h3><pre><code class="xml">dev-common 引入aop依赖
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/aspect/ServiceLogAspect.java
package com.imooc.api.aspect;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class ServiceLogAspect &#123;
    final static Logger logger = LoggerFactory.getLogger(ServiceLogAspect.class);
    /**
     * AOP通知：
     * 1.前置通知
     * 2.后置通知
     * 3.环绕通知 ★★
     * 4.异常通知
     * 5.最终通知
     */
    //*是返回所有类型 匹配包的位置 *.* = 任意文件.任意后缀  (..)是任意类和任意方法
    @Around(&quot;execution(* com.imooc.*.service.impl..*.*(..))&quot;)
    public Object recordTimeOfService(ProceedingJoinPoint joinPoint) throws Throwable &#123;
        logger.info(&quot;==== 开始执行 &#123;&#125;.&#123;&#125; ====&quot;,
                joinPoint.getTarget().getClass(),
                joinPoint.getSignature().getName());
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed();
        long end = System.currentTimeMillis();
        long takeTime = end - start;
        if (takeTime &gt; 3000)&#123;
            logger.error(&quot;当前执行耗时：&#123;&#125;&quot;,takeTime);
        &#125;else if (takeTime &gt; 2000)&#123;
            logger.warn(&quot;当前执行耗时：&#123;&#125;&quot;,takeTime);
        &#125;else &#123;
            logger.info(&quot;当前执行耗时：&#123;&#125;&quot;,takeTime);
        &#125;
        return result;
    &#125;
&#125;
====================================================================
http://writer.imoocnews.com:9090/imooc-news/writer/accountInfo.html
提交信息 看后台Terminal
</code></pre>
<pre><code class="yml">service-user  application-dev.yml #增加一个open mybatis log in dev
  server:
  port: 8003

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
# open mybatis log in dev
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
# setup CN from java, This is resource
website:
  domain-name: imoocnews.com

===================================================================
如果在未来发生sql错误可以通过sql输出来找到sql语句从而放入运行检查错误 (21 28行)
JDBC Connection [HikariProxyConnection@2054571226 wrapping org.mariadb.jdbc.MariaDbConnection@4b4b68f8] will not be managed by Spring
==&gt;  Preparing: UPDATE app_user SET nickname = ?,face = ?,realname = ?,email = ?,sex = ?,birthday = ?,province = ?,city = ?,district = ?,active_status = ?,updated_time = ? WHERE id = ? 
==&gt; Parameters: 15027597319(String), https://raw.githubusercontent.com/P-luminary/images/875ad52658686e6cc3a8e0cd75d2a324a3d742a9/data/Imooc_Girl.jpg(String), 小宝宝的小潘潘(String), 390415030@qq.com(String), 1(Integer), 2024-07-06 00:00:00.0(Timestamp), 河北(String), 唐山市(String), 丰润区(String), 1(Integer), 2024-07-07 22:41:09.862(Timestamp), 240629F21AK1BHX4(String)
&lt;==    Updates: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@9176eb0]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@65bd9477] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1798162927 wrapping org.mariadb.jdbc.MariaDbConnection@4b4b68f8] will not be managed by Spring
==&gt;  Preparing: SELECT id,mobile,nickname,face,realname,email,sex,birthday,province,city,district,active_status,total_income,created_time,updated_time FROM app_user WHERE id = ? 
==&gt; Parameters: 240629F21AK1BHX4(String)
&lt;==    Columns: id, mobile, nickname, face, realname, email, sex, birthday, province, city, district, active_status, total_income, created_time, updated_time
&lt;==        Row: 240629F21AK1BHX4, 15027597319, 15027597319, https://raw.githubusercontent.com/P-luminary/images/875ad52658686e6cc3a8e0cd75d2a324a3d742a9/data/Imooc_Girl.jpg, 小宝宝的小潘潘, 390415030@qq.com, 1, 2024-07-06, 河北, 唐山市, 丰润区, 1, 0, 2024-06-29 19:43:07.0, 2024-07-07 22:41:09.0
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@65bd9477]
41:10.009 [http-nio-8003-exec-3] INFO  io.lettuce.core.EpollProvider - Starting without optional epoll library
41:10.010 [http-nio-8003-exec-3] INFO  io.lettuce.core.KqueueProvider - Starting without optional kqueue library
41:10.460 [http-nio-8003-exec-3] INFO  c.imooc.api.aspect.ServiceLogAspect - 当前执行耗时：601
</code></pre>
<h3 id="退出登录、注销会话"><a href="#退出登录、注销会话" class="headerlink" title="退出登录、注销会话"></a>退出登录、注销会话</h3><pre><code class="java">service-api  com/imooc/api/controller/user/PassportControllerApi.java
//用户登录信息的redis和cookies清除
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid; //用户需求验证

@Api(value = &quot;用户注册登录&quot;,tags = &#123;&quot;用户注册登录的Controller&quot;&#125;)
@RequestMapping(&quot;passport&quot;)
public interface PassportControllerApi &#123;
    @ApiOperation(value = &quot;获得短信验证码&quot;,notes = &quot;获得短信验证码&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/getSMSCode&quot;)
    public GraceJSONResult getSMSCode(@RequestParam String mobile, HttpServletRequest request);

    @ApiOperation(value = &quot;一键注册登录接口&quot;,notes = &quot;一键注册登录接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/doLogin&quot;) //表单里面用post  RequestBody后面传过来的东西和json对象对应
    public GraceJSONResult doLogin(@RequestBody @Valid RegistLoginBO registLoginBO
            , BindingResult result, HttpServletRequest request, HttpServletResponse response);
    //完成之后 去BaseController里面写一个setCookie()方便都可以用

    @ApiOperation(value = &quot;用户退出登录&quot;,notes = &quot;用户退出登录&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/logout&quot;)
    public GraceJSONResult logout(@RequestParam String userId,
                                  HttpServletRequest request,
                                  HttpServletResponse response);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/PassportController.java
@Override
    public GraceJSONResult logout(String userId,
                                  HttpServletRequest request,
                                  HttpServletResponse response)&#123;
        redis.del(REDIS_USER_TOKEN + &quot;:&quot; + userId);
        //USER_INFO可以不用删 可能后面会查询 没有清除cookie只有重新设置时间为0
        setCookie(request, response, &quot;utoken&quot;,&quot;&quot;,COOKIE_DELETE);
        setCookie(request, response, &quot;uid&quot;,&quot;&quot;,COOKIE_DELETE);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<h3 id="FastDFS架构原理与上传下载流程解析"><a href="#FastDFS架构原理与上传下载流程解析" class="headerlink" title="FastDFS架构原理与上传下载流程解析"></a>FastDFS架构原理与上传下载流程解析</h3><h5 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h5><ul>
<li><p>传统服务器存储</p>
</li>
<li><h5 id="FastDFS"><a href="#FastDFS" class="headerlink" title="FastDFS"></a>FastDFS</h5></li>
<li><p>OSS</p>
</li>
<li><p>GridFS</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/584d8cb5b41ffa10cb9b5303c13b5782e1130889/data/FastDFS%E6%9E%B6%E6%9E%84.png"></p>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/f4d7477aa2b6843ddfb11af2cbbe2424a25e4b39/data/FastDFS%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E8%BF%87%E7%A8%8B.png"></p>
<h3 id="配置FastDFS环境准备工作"><a href="#配置FastDFS环境准备工作" class="headerlink" title="配置FastDFS环境准备工作"></a>配置FastDFS环境准备工作</h3><h6 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h6><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Centos</td>
<td>7.x</td>
</tr>
<tr>
<td>libfastcommon-1.0.42.tar.gz</td>
<td>FastDFS分离出的一些公用函数包</td>
</tr>
<tr>
<td>FastDFS</td>
<td>FastDFS本体</td>
</tr>
<tr>
<td>fastdfs-nginx-module-1.22.tar.gz</td>
<td>FastDFS和nginx的关联模块</td>
</tr>
<tr>
<td>nginx</td>
<td>nginx1.15.4</td>
</tr>
</tbody></table>
<h6 id="它跟我说要准备两个虚拟机-tracker-和-storage-版本都是CentOS-7-x"><a href="#它跟我说要准备两个虚拟机-tracker-和-storage-版本都是CentOS-7-x" class="headerlink" title="它跟我说要准备两个虚拟机[tracker 和 storage 版本都是CentOS 7.x]"></a>它跟我说要准备两个虚拟机[tracker 和 storage 版本都是CentOS 7.x]</h6><pre><code class="java">//创建一个FastDFS文件夹
[imooc@imooc FastDFS]$ ll
总用量 1980
-rw-rw-r--. 1 imooc imooc  800157 7月   9 15:53 fastdfs-6.04.tar.gz
-rw-rw-r--. 1 imooc imooc   19952 7月   9 15:53 fastdfs-nginx-module-1.22.tar.gz
-rw-rw-r--. 1 imooc imooc  164704 7月   9 15:53 libfastcommon-1.0.42.tar.gz
-rw-rw-r--. 1 imooc imooc 1032630 7月   9 15:53 nginx-1.16.1.tar.gz
[imooc@imooc FastDFS]$ tar -zxvf libfastcommon-1.0.42.tar.gz 
[imooc@imooc FastDFS]$ cd libfastcommon-1.0.42/
[imooc@imooc libfastcommon-1.0.42]$ ll
总用量 32
drwxrwxr-x. 2 imooc imooc   114 12月  5 2019 doc
-rw-rw-r--. 1 imooc imooc 10054 12月  5 2019 HISTORY
-rw-rw-r--. 1 imooc imooc   674 12月  5 2019 INSTALL
-rw-rw-r--. 1 imooc imooc  1607 12月  5 2019 libfastcommon.spec
-rwxrwxr-x. 1 imooc imooc  3253 12月  5 2019 make.sh
drwxrwxr-x. 2 imooc imooc   191 12月  5 2019 php-fastcommon
-rw-rw-r--. 1 imooc imooc  2776 12月  5 2019 README
drwxrwxr-x. 3 imooc imooc  4096 12月  5 2019 src
[imooc@imooc libfastcommon-1.0.42]$ ./make.sh
[imooc@imooc libfastcommon-1.0.42]$ sudo ./make.sh install
//安装解压包的本体
[imooc@imooc FastDFS]$ tar -zxvf fastdfs-6.04.tar.gz 
[imooc@imooc FastDFS]$ cd fastdfs-6.04/
[imooc@imooc fastdfs-6.04]$ ./make.sh
[imooc@imooc fastdfs-6.04]$ sudo ./make.sh install
[imooc@imooc fastdfs-6.04]$ cd /usr/bin
[imooc@imooc bin]$ ls fdfs_*
fdfs_appender_test   fdfs_download_file        fdfs_test
fdfs_appender_test1  fdfs_file_info            fdfs_test1
fdfs_append_file     fdfs_monitor              fdfs_trackerd
fdfs_crc32           fdfs_regenerate_filename  fdfs_upload_appender
fdfs_delete_file     fdfs_storaged             fdfs_upload_file
[imooc@imooc bin]$ cd /etc/fdfs/
[imooc@imooc fdfs]$ ll
总用量 28 //这些都是配置文件 如果要修改则需要拷贝一份新鲜的
-rw-r--r--. 1 root root  1834 7月   9 16:02 client.conf.sample
-rw-r--r--. 1 root root 10085 7月   9 16:02 storage.conf.sample
-rw-r--r--. 1 root root   527 7月   9 16:02 storage_ids.conf.sample
-rw-r--r--. 1 root root  8038 7月   9 16:02 tracker.conf.sample

[imooc@imooc FastDFS]$ cd fastdfs-6.04/
[imooc@imooc fastdfs-6.04]$ cd conf/
[imooc@imooc conf]$ ll
总用量 88
-rw-rw-r--. 1 imooc imooc 23981 12月  5 2019 anti-steal.jpg
-rw-rw-r--. 1 imooc imooc  1834 12月  5 2019 client.conf
-rw-rw-r--. 1 imooc imooc   955 12月  5 2019 http.conf
-rw-rw-r--. 1 imooc imooc 31172 12月  5 2019 mime.types
-rw-rw-r--. 1 imooc imooc 10085 12月  5 2019 storage.conf
-rw-rw-r--. 1 imooc imooc   527 12月  5 2019 storage_ids.conf
-rw-rw-r--. 1 imooc imooc  8038 12月  5 2019 tracker.conf
//拷贝到etc下  安装前的准备工作
[imooc@imooc conf]$ sudo cp * /etc/fdfs/
[imooc@imooc conf]$ cd /etc/fdfs
[imooc@imooc fdfs]$ ll
总用量 116
-rw-r--r--. 1 root root 23981 7月   9 16:06 anti-steal.jpg
-rw-r--r--. 1 root root  1834 7月   9 16:06 client.conf
-rw-r--r--. 1 root root  1834 7月   9 16:02 client.conf.sample
-rw-r--r--. 1 root root   955 7月   9 16:06 http.conf
-rw-r--r--. 1 root root 31172 7月   9 16:06 mime.types
-rw-r--r--. 1 root root 10085 7月   9 16:06 storage.conf
-rw-r--r--. 1 root root 10085 7月   9 16:02 storage.conf.sample
-rw-r--r--. 1 root root   527 7月   9 16:06 storage_ids.conf
-rw-r--r--. 1 root root   527 7月   9 16:02 storage_ids.conf.sample
-rw-r--r--. 1 root root  8038 7月   9 16:06 tracker.conf
-rw-r--r--. 1 root root  8038 7月   9 16:02 tracker.conf.sample
</code></pre>
<h3 id="配置tracker服务-一个虚拟机"><a href="#配置tracker服务-一个虚拟机" class="headerlink" title="配置tracker服务 [一个虚拟机]"></a>配置tracker服务 [一个虚拟机]</h3><pre><code class="java">//根据配置文件去区分是哪个服务
[imooc@imooc fdfs]$ cd /etc/fdfs
[imooc@imooc fdfs]$ ll
总用量 116
-rw-r--r--. 1 root root 23981 7月   9 16:06 anti-steal.jpg
-rw-r--r--. 1 root root  1834 7月   9 16:06 client.conf
-rw-r--r--. 1 root root  1834 7月   9 16:02 client.conf.sample
-rw-r--r--. 1 root root   955 7月   9 16:06 http.conf
-rw-r--r--. 1 root root 31172 7月   9 16:06 mime.types
-rw-r--r--. 1 root root 10085 7月   9 16:06 storage.conf
-rw-r--r--. 1 root root 10085 7月   9 16:02 storage.conf.sample
-rw-r--r--. 1 root root   527 7月   9 16:06 storage_ids.conf
-rw-r--r--. 1 root root   527 7月   9 16:02 storage_ids.conf.sample
-rw-r--r--. 1 root root  8038 7月   9 16:06 tracker.conf
-rw-r--r--. 1 root root  8038 7月   9 16:02 tracker.conf.sample
[imooc@imooc fdfs]$ sudo vim tracker.conf  
//里面的port=22122 bind_addr= 计算机节点 这些不动
//修改里面的base_path=/home/yuqing/fastdfs 
    //修改为→ /usr/local/fastdfs/tracker
[imooc@imooc fdfs]$ mkdir /usr/local/fastdfs/tracker -p //-p后面文件夹做递归创建
[imooc@imooc fdfs]$ sudo /usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf //当成配置文件加进去 ★★★★★★★★★★★★★★★★★★
[imooc@imooc fdfs]$ ps -ef|grep tracker
root       6254      1  0 18:31 ?        00:00:00 /usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf
imooc      6268   3011  0 18:31 pts/0    00:00:00 grep --color=auto tracker
</code></pre>
<h3 id="配置storage服务-另一个虚拟机"><a href="#配置storage服务-另一个虚拟机" class="headerlink" title="配置storage服务 [另一个虚拟机]"></a>配置storage服务 [另一个虚拟机]</h3><pre><code class="java">[storage@imooc fdfs]$ cd /etc/fdfs/
[storage@imooc fdfs]$ sudo vim storage.conf
//[修改后] group_name=imooc 
//[修改后] bath_path=/usr/local/fastdfs/storage
[storage@imooc fdfs]$ sudo mkdir /usr/local/fastdfs/storage -p
[storage@imooc fdfs]$ cd /usr/local/
[storage@imooc local]$ ll
[storage@imooc local]$ cd fastdfs/
[storage@imooc fastdfs]$ ll
[storage@localhost fastdfs]$ ll
总用量 0
drwxr-xr-x. 2 root root 6 7月   9 18:38 storage
[storage@localhost fastdfs]$ cd /etc/fdfs/  //接着修改storage
[storage@imooc fdfs]$ sudo vim storage.conf
//[修改后] store_path0=/usr/local/fastdfs/storage
//配置到tracker的ip地址[修改后] tracker_server=192.168.170.135:22122
/ ‘/8888’  http.server_port=8888 是web的相关端口号
[storage@localhost fdfs]$ sudo /usr/bin/fdfs_storaged /etc/fdfs/storage.conf //★★★★
★一定要先启动tracker 再去启动storage 不然service发不过去★
</code></pre>
<pre><code class="java">//配置客户端做上传动作
[imooc@imooc ~]$ cd /etc/fdfs
[storage@localhost fdfs]$ pwd
/etc/fdfs
[storage@localhost fdfs]$ sudo vim client.conf
//[修改后]base_path=/usr/local/fastdfs/client
[storage@localhost fdfs]$ sudo mkdir /usr/local/fastdfs/client
[storage@localhost fdfs]$ cd /usr/local/fastdfs
[storage@localhost fastdfs]$ ll
总用量 0
drwxr-xr-x. 2 root root  6 7月   9 19:26 client
drwxr-xr-x. 4 root root 30 7月   9 19:04 storage
[storage@localhost fastdfs]$ cd /etc/fdfs/
[storage@localhost fdfs]$ sudo vim client.conf
//[修改后]tracker_server=192.168.170.135:22122
[storage@localhost fdfs]$ cd /usr/bin
[storage@localhost bin]$ ls fdfs*
fdfs_appender_test   fdfs_download_file        fdfs_test
fdfs_appender_test1  fdfs_file_info            fdfs_test1
fdfs_append_file     fdfs_monitor              fdfs_trackerd
fdfs_crc32           fdfs_regenerate_filename  fdfs_upload_appender
fdfs_delete_file     fdfs_storaged             fdfs_upload_file
//fdfs_test在命令行去测试
[storage@localhost bin]$ cd /home/
[storage@localhost home]$ cd /usr/local/fastdfs/storage/
[storage@localhost storage]$ cd data
[storage@localhost data]$ cd 00
[storage@localhost data]$ ll   【里面很多十六进制数据】
[storage@localhost data]$ cd 00 
[storage@localhost data]$ ll   //【里面没有数据 上传图片到这里查看是否成功】
///home/storage 这里有一张测试图片log.png [自行添加]
[storage@localhost 00]$ pwd
/usr/local/fastdfs/storage/data/00/00
[storage@localhost 00]$ cd /etc/fdfs
[storage@localhost ~]$ cd /etc/fdfs/
[storage@localhost fdfs]$ cd /usr/bin/
[storage@localhost bin]$ ls fdfs*
fdfs_appender_test   fdfs_download_file      //fdfs_test
fdfs_appender_test1  fdfs_file_info            fdfs_test1
fdfs_append_file     fdfs_monitor              fdfs_trackerd
fdfs_crc32           fdfs_regenerate_filename  fdfs_upload_appender
fdfs_delete_file     fdfs_storaged             fdfs_upload_file
[storage@localhost bin]$ ./fdfs_test /etc/fdfs/client.conf upload /home/storage/log.png 
/*
This is FastDFS client test program v6.04

Copyright (C) 2008, Happy Fish / YuQing

FastDFS may be copied only under the terms of the GNU General
Public License V3, which may be found in the FastDFS source kit.
Please visit the FastDFS Home Page http://www.fastken.com/ 
for more detail.

[2024-07-09 19:39:25] DEBUG - base_path=/usr/local/fastdfs/client, connect_timeout=10, network_timeout=60, tracker_server_count=1, anti_steal_token=0, anti_steal_secret_key length=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s, use_storage_id=0, storage server id count: 0

tracker_query_storage_store_list_without_group: 
    server 1. group_name=, ip_addr=192.168.170.136, port=23000

group_name=imooc【企业简写】, ip_addr=192.168.170.136, port=23000
storage_upload_by_filename
group_name=imooc, remote_filename=M00/00/00/wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png 
【remote_filename：重组路径】【因为还没有发布文件服务 所以无法直接查看文件】
source ip address: 192.168.170.136
file timestamp=2024-07-09 19:39:25
file size=12618
file crc32=630904148
example file url: http://192.168.170.136/imooc/M00/00/00/wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png
storage_upload_slave_by_filename
group_name=imooc, remote_filename=M00/00/00/wKiqiGaNIW2AMDeaAAAxSiWa1VQ457_big.png
source ip address: 192.168.170.136
file timestamp=2024-07-09 19:39:25
file size=12618
file crc32=630904148
example file url: http://192.168.170.136/imooc/M00/00/00/wKiqiGaNIW2AMDeaAAAxSiWa1VQ457_big.png
 */
[storage@localhost bin]$ cd /usr/local/fastdfs/storage/data/
[storage@localhost data]$ cd 00
[storage@localhost 00]$ cd 00
[storage@localhost 00]$ ll
总用量 40
-rw-r--r--. 1 root root 12618 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457_big.png
-rw-r--r--. 1 root root    49 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457_big.png-m
-rw-r--r--. 1 root root 12618 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png
-rw-r--r--. 1 root root    49 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png-m
</code></pre>
<h3 id="安装Nginx提供Web服务-通过浏览器访问到文件"><a href="#安装Nginx提供Web服务-通过浏览器访问到文件" class="headerlink" title="安装Nginx提供Web服务 [通过浏览器访问到文件]"></a>安装Nginx提供Web服务 [通过浏览器访问到文件]</h3><h6 id="Nginx是反向代理服务器可以做集群-也可以控制多个虚拟主机"><a href="#Nginx是反向代理服务器可以做集群-也可以控制多个虚拟主机" class="headerlink" title="Nginx是反向代理服务器可以做集群 也可以控制多个虚拟主机"></a>Nginx是反向代理服务器可以做集群 也可以控制多个虚拟主机</h6><pre><code class="java">-rw-rw-r--. 1 storage storage 142245547 7月  10 15:32 jdk-7u75-linux-x64.tar.gz
-rw-rw-r--. 1 storage storage   1032630 7月  10 15:33 nginx-1.16.1.tar.gz
//[storage@localhost ~]$ sudo yum install gcc-c++
已加载插件：fastestmirror, langpacks
Determining fastest mirrors
//[storage@localhost ~]$ sudo yum install -y pcre pcre-devel
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
//[storage@localhost ~]$ sudo yum install -y zlib zlib-devel
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
//[storage@localhost ~]$ sudo yum install -y openssl openssl-devel
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
//[storage@localhost ~]$ tar -zxvf nginx-1.16.1.tar.gz
nginx-1.16.1.tar.gz
//[storage@localhost ~]$ cd nginx-1.16.1.tar.gz
[storage@localhost nginx-1.16.1]$ sudo mkdir /var/temp/nginx -p
//创建所需的临时目录：
sudo mkdir -p /var/temp/nginx/client
sudo mkdir -p /var/temp/nginx/proxy
sudo mkdir -p /var/temp/nginx/fastcgi
sudo mkdir -p /var/temp/nginx/uwsgi
sudo mkdir -p /var/temp/nginx/scgi
[storage@localhost nginx-1.16.1]$ ./configure \  //【预配置】
&gt; --prefix=/usr/local/nginx \
&gt; --pid-path=/var/run/nginx/nginx.pid \
&gt; --lock-path=/var/lock/nginx.lock \
&gt; --error-log-path=/var/log/nginx/error.log \
&gt; --http-log-path=/var/log/nginx/access.log \
&gt; --with-http_gzip_static_module \
&gt; --http-client-body-temp-path=/var/temp/nginx/client \
&gt; --http-proxy-temp-path=/var/temp/nginx/proxy \
&gt; --http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
&gt; --http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
&gt; --http-scgi-temp-path=/var/temp/nginx/scgi
[storage@localhost nginx-1.16.1]$ make  //【编译】
/* linux中的网络不可达
如果镜像出了问题 一定要换一下镜像配置
1. 编辑 CentOS 的 YUM 配置文件：
编辑 /etc/yum.repos.d/CentOS-Base.repo 文件：

复制代码
sudo vi /etc/yum.repos.d/CentOS-Base.repo

2. 使用以下内容更新 CentOS-Base.repo 文件：
复制代码
[base]
name=CentOS-$releasever - Base
baseurl=http://vault.centos.org/7.9.2009/os/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7

[updates]
name=CentOS-$releasever - Updates
baseurl=http://vault.centos.org/7.9.2009/updates/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7

[extras]
name=CentOS-$releasever - Extras
baseurl=http://vault.centos.org/7.9.2009/extras/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
*/
[storage@localhost nginx-1.16.1]$ sudo make install
[storage@localhost nginx-1.16.1]$ cd /usr/local
[storage@localhost local]$ ll
总用量 0
drwxr-xr-x. 2 root root  6 4月  11 2018 bin
drwxr-xr-x. 2 root root  6 4月  11 2018 etc
drwxr-xr-x. 4 root root 35 7月   9 19:26 fastdfs
drwxr-xr-x. 2 root root  6 4月  11 2018 games
drwxr-xr-x. 2 root root  6 4月  11 2018 include
drwxr-xr-x. 2 root root  6 4月  11 2018 lib
drwxr-xr-x. 2 root root  6 4月  11 2018 lib64
drwxr-xr-x. 2 root root  6 4月  11 2018 libexec
drwxr-xr-x. 5 root root 42 7月  10 16:55 nginx
drwxr-xr-x. 2 root root  6 4月  11 2018 sbin
drwxr-xr-x. 5 root root 49 7月   9 17:16 share
drwxr-xr-x. 2 root root  6 4月  11 2018 src
[storage@localhost local]$ cd nginx/
[storage@localhost nginx]$ ll
总用量 4
drwxr-xr-x. 2 root root 4096 7月  10 16:55 conf
drwxr-xr-x. 2 root root   40 7月  10 16:55 html
drwxr-xr-x. 2 root root   19 7月  10 16:55 sbin
[storage@localhost nginx]$ cd sbin/
[storage@localhost sbin]$ ll
总用量 3768
-rwxr-xr-x. 1 root root 3857144 7月  10 16:55 nginx
[storage@localhost sbin]$ sudo ./nginx
[storage@localhost sbin]$ ps -ef|grep nginx
root       6642      1  0 16:58 ?        00:00:00 nginx: master process ./nginx
nobody     6643   6642  0 16:58 ?        00:00:00 nginx: worker process
storage    6651   2975  0 16:58 pts/0    00:00:00 grep --color=auto nginx

// 在浏览器输入：http://192.168.170.136/ 【如果没显示应该是虚拟机的防火墙拦截 可以禁止防火墙】
Welcome to nginx!
If you see this page, the nginx web server is successfully installed and working. Further configuration is required.

For online documentation and support please refer to nginx.org.
Commercial support is available at nginx.com.

Thank you for using nginx.

[storage@localhost nginx]$ cd html
[storage@localhost html]$ ll
总用量 8
-rw-r--r--. 1 root root 494 7月  10 16:55 50x.html
-rw-r--r--. 1 root root 612 7月  10 16:55 index.html

[storage@localhost html]$ sudo ../sbin/nginx -t //【测试刚刚的步骤是否正确】
nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
</code></pre>
<h3 id="整合Nginx实现文件服务器"><a href="#整合Nginx实现文件服务器" class="headerlink" title="整合Nginx实现文件服务器"></a>整合Nginx实现文件服务器</h3><pre><code class="java">[storage@localhost FastDFS]$ tar -zxvf fastdfs-nginx-module-1.22.tar.gz 
fastdfs-nginx-module-1.22/
fastdfs-nginx-module-1.22/HISTORY
fastdfs-nginx-module-1.22/INSTALL
fastdfs-nginx-module-1.22/src/
fastdfs-nginx-module-1.22/src/common.c
fastdfs-nginx-module-1.22/src/common.h
fastdfs-nginx-module-1.22/src/config
fastdfs-nginx-module-1.22/src/mod_fastdfs.conf
fastdfs-nginx-module-1.22/src/ngx_http_fastdfs_module.c
[storage@localhost FastDFS]$ cd fastdfs-nginx-module-1.22/
[storage@localhost fastdfs-nginx-module-1.22]$ ll
总用量 8
-rw-rw-r--. 1 storage storage 3036 11月 19 2019 HISTORY
-rw-rw-r--. 1 storage storage 2001 11月 19 2019 INSTALL
drwxrwxr-x. 2 storage storage  109 11月 19 2019 src
[storage@localhost fastdfs-nginx-module-1.22]$ cd src/
[storage@localhost src]$ sudo cp mod_fastdfs.conf /etc/fdfs/
[storage@localhost ~]$ cd /etc/fdfs/
[storage@localhost fdfs]$ sudo vim mod_fastdfs.conf 
//【布置存储路径】
/*
store_path0=/usr/local/fastdfs/storage
tracker_server=192.168.170.135:22122
group_name=imooc
url_have_group_name = true
base_path=/usr/local/fastdfs/tmp
*/
[storage@localhost FastDFS]$ cd fastdfs-nginx-module-1.22/
[storage@localhost fastdfs-nginx-module-1.22]$ cd src/
[storage@localhost src]$ vim config
/local 把带有local的都删掉
[storage@localhost ~]$ cd nginx-1.16.1/
 [storage@localhost nginx-1.16.1]$ 
./configure \
&gt; --prefix=/usr/local/nginx \
&gt; --pid-path=/var/run/nginx/nginx.pid \
&gt; --lock-path=/var/lock/nginx.lock \
&gt; --error-log-path=/var/log/nginx/error.log \
&gt; --http-log-path=/var/log/nginx/access.log \
&gt; --with-http_gzip_static_module \
&gt; --http-client-body-temp-path=/var/temp/nginx/client \
&gt; --http-proxy-temp-path=/var/temp/nginx/proxy \
&gt; --http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
&gt; --http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
&gt; --http-scgi-temp-path=/var/temp/nginx/scgi \
&gt; --add-module=/home/storage/FastDFS/fastdfs-nginx-module-1.22/src
[storage@localhost nginx-1.16.1]$ sudo make &amp;&amp; sudo make install
[storage@localhost nginx-1.16.1]$ cd /usr/local/nginx/
[storage@localhost nginx]$ cd conf/
[storage@localhost conf]$ sudo vim nginx.conf
/*
server &#123;
        listen       8888;
        server_name  localhost;
        location ~/group[0-9]/ &#123;
        ngx_fastdfs_module;
        &#125;
        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / &#123;
            root   html;
            index  index.html index.htm;
        &#125;

*/
[storage@localhost conf]$ vim /etc/fdfs/tracker.conf
/http.service_port:8080
[storage@localhost conf]$ sudo vim nginx.conf //★★★★★★
/*
server &#123;
        listen       8888;
        server_name  localhost;
        location /imooc/M00 &#123;
            ngx_fastdfs_module;
        &#125;
        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / &#123;
            root   html;
            index  index.html index.htm;
        &#125;
&#125;
*/
[storage@localhost conf]$ sudo ../sbin/nginx -t //测试一下有无问题
ngx_http_fastdfs_set pid=6143
nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
[storage@localhost conf]$ sudo ../sbin/nginx -s reload //重新加载
ngx_http_fastdfs_set pid=6436

[storage@localhost conf]$ cd /usr/local/fastdfs/storage/
[storage@localhost storage]$ cd data
[storage@localhost data]$ cd 00/00
总用量 40
-rw-r--r--. 1 root root 12618 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457_big.png
-rw-r--r--. 1 root root    49 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457_big.png-m
-rw-r--r--. 1 root root 12618 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png
-rw-r--r--. 1 root root    49 7月   9 19:39 wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png-m
http://192.168.170.136:8888/imooc/M00/00/00/wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png


//查看错误日志 ★★★【sudo tail -n 50 /var/log/nginx/error.log】★★★
/*
2. 重新加载 systemd 并启动 Nginx
重新加载 systemd：
复制代码
sudo systemctl daemon-reload
启动 Nginx：

sh
复制代码
sudo systemctl start nginx
设置开机自启动：

sh
复制代码
sudo systemctl enable nginx
检查 Nginx 服务状态：

sh
复制代码
sudo systemctl status nginx
*/
[storage@localhost conf]$ sudo vim /etc/fdfs/tracker.conf
[storage@localhost conf]$ sudo vim /etc/fdfs/storage.conf

[storage@localhost conf]$ cd /usr/local/nginx/conf/
[storage@localhost conf]$ sudo ../sbin/nginx -s stop
ngx_http_fastdfs_set pid=12586
[storage@localhost conf]$ sudo ../sbin/nginx
ngx_http_fastdfs_set pid=12605
[storage@localhost conf]$ sudo ../sbin/nginx -s reload

/*
FastDFS输出报告位置：
sudo tail -n 50 /usr/local/fastdfs/storage/logs/storaged.log


启动 Tracker 服务器：
sudo systemctl start fdfs_trackerd
检查 Tracker 服务器状态：
sudo systemctl status fdfs_trackerd
确认 Tracker 服务器监听端口：
sudo netstat -tuln | grep :22122
*/
//草！好几个小时的含泪史 一定要先开tracker端！！！
★★★★★一定要先启动tracker 再去启动storage 不然service发不过去★★★★★
★★★★★一定要先启动tracker 再去启动storage 不然service发不过去★★★★★
★★★★★一定要先启动tracker 再去启动storage 不然service发不过去★★★★★
★★★★★一定要先启动tracker 再去启动storage 不然service发不过去★★★★★
★★★★★一定要先启动tracker 再去启动storage 不然service发不过去★★★★★
★★★★★一定要先启动tracker 再去启动storage 不然service发不过去★★★★★

/*
首先，重新启动 FastDFS 的 tracker 和 storage 服务：

bash
复制代码
# 重启 tracker 服务
sudo systemctl restart fdfs_trackerd

# 重启 storage 服务
sudo systemctl restart fdfs_storaged
2. 重启 Nginx 服务
接下来，重新启动 Nginx 服务，确保它能够加载新的配置并生效：

bash
复制代码
sudo systemctl restart nginx
3. 验证服务状态
重新启动服务后，可以通过以下方式验证它们的运行状态：

检查 FastDFS 服务状态：

bash
复制代码
sudo systemctl status fdfs_trackerd
sudo systemctl status fdfs_storaged
检查 Nginx 服务状态：

bash
复制代码
sudo systemctl status nginx
*/

http://192.168.170.136:8888/imooc/M00/00/00/wKiqiGaNIW2AMDeaAAAxSiWa1VQ457.png
</code></pre>
<h3 id="创建文件服务module-文件上传"><a href="#创建文件服务module-文件上传" class="headerlink" title="创建文件服务module [文件上传]"></a>创建文件服务module [文件上传]</h3><pre><code class="xml">【新建一个module imooc-news-dev-service-files】
pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;artifactId&gt;imooc-news-dev-service-files&lt;/artifactId&gt;
&lt;!--
    imooc-news-dev-service-files
    文件服务，文件相关的操作都在此文件中进行
    文件上传   文件下载
    fastdfs  oss  gridfs
--&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 文件上传fdfs工具包 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.tobato&lt;/groupId&gt;
            &lt;artifactId&gt;fastdfs-client&lt;/artifactId&gt;
            &lt;version&gt;1.27.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;



    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;

&lt;/project&gt;
</code></pre>
<pre><code class="yaml">application.yuml
############################################################
#
# 用户微服务
# web访问端口号  约定：8003
#
############################################################
server:
# port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-file
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
  servlet:
    multipart:
      max-file-size: 512000 #请求文件大小限制为500kb
      max-request-size: 512000
</code></pre>
<pre><code class="yaml">application-dev.yuml
server:
  port: 8004

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
</code></pre>
<pre><code class="java">service-files  com/imooc/files/controller/HelloController.java
package com.imooc.files.controller;


import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);

    public Object hello()&#123;
        return GraceJSONResult.ok(&quot;Hello World!&quot;);
    &#125;
&#125;




service-files  com/imooc/files/Application.java
package com.imooc.files;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = DataSourceAutoConfiguration.class) //排除数据源
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
-----------------------------------------------------------------------
http://localhost:8004/hello
&#123;
    &quot;status&quot;: 200,
    &quot;msg&quot;: &quot;操作成功！&quot;,
    &quot;success&quot;: true,
    &quot;data&quot;: &quot;Hello World!&quot;
&#125;
</code></pre>
<h3 id="整合fdfs与service实现-文件上传"><a href="#整合fdfs与service实现-文件上传" class="headerlink" title="整合fdfs与service实现 [文件上传]"></a>整合fdfs与service实现 [文件上传]</h3><pre><code class="java">service-api  com/imooc/files/service/impl/UploaderServiceImpl.java
package com.imooc.files.service.impl;

import com.github.tobato.fastdfs.domain.fdfs.StorePath;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import com.imooc.files.service.UploaderService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

@Service
public class UploaderServiceImpl implements UploaderService &#123;
    //注入客户端
    @Autowired
    public FastFileStorageClient fastFileStorageClient;

    @Override
    public String uploadFdfs(MultipartFile file, String fileExtName) throws IOException &#123;
        StorePath storePath = fastFileStorageClient.uploadFile(file.getInputStream(), file.getSize(), fileExtName, null);
        return storePath.getFullPath();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/files/service/UploaderService.java
package com.imooc.files.service;

import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

public interface UploaderService &#123;
    public String uploadFdfs(MultipartFile file, String fileExtName) throws IOException;
&#125;
</code></pre>
<pre><code class="yaml">application.yml
############################################################
#
# 用户微服务
# web访问端口号  约定：8003
#
############################################################
server:
# port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-file
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
  servlet:
    multipart:
      max-file-size: 512000 #请求文件大小限制为500kb
      max-request-size: 512000

############################################################
#
# fdfs配置信息
#
############################################################
fdfs:
  connect-timeout: 30
  so-timeout: 30
  tracker-list: 192.168.170.135:22122
</code></pre>
<h3 id="实现fastdfs图片存储-文件上传"><a href="#实现fastdfs图片存储-文件上传" class="headerlink" title="实现fastdfs图片存储 [文件上传]"></a>实现fastdfs图片存储 [文件上传]</h3><pre><code class="java">service-api  com/imooc/api/controller/files/FileUploadControllerApi.java
package com.imooc.api.controller.files;


import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

@Api(value = &quot;文件上传的controller&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
@RequestMapping(&quot;fs&quot;)
public interface FileUploadControllerApi &#123;
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadFace&quot;)
    public GraceJSONResult uploadFace(@RequestParam String userId, MultipartFile file) throws Exception;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/controller/FileUploadController.java
package com.imooc.files.controller;


import com.imooc.api.controller.files.FileUploadControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.files.service.UploaderService;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

@RestController
public class FileUploadController implements FileUploadControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FileUploadController.class);

    @Autowired
    private UploaderService uploaderService;

    @Override
    public GraceJSONResult uploadFace(String userId,
                                      MultipartFile file) throws Exception &#123;
        String path = &quot;&quot;;
        if (file != null)&#123;
        // 获得文件上传的名称
            String fileName = file.getOriginalFilename();
            //判断文件名不能为空
            if (StringUtils.isNotBlank(fileName))&#123;
                String fileNameArr[] = fileName.split(&quot;\\.&quot;);
                //获得后缀名
                String suffix = fileNameArr[fileNameArr.length - 1];
                //防止黑客上传文件攻击服务器 判断后缀符合我们的预定义规范
                if (!suffix.equalsIgnoreCase(&quot;png&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpg&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpeg&quot;)
                )&#123;
                    return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_FORMATTER_FAILD);
                &#125;
                // 执行上传
                path = uploaderService.uploadFdfs(file, suffix);
            &#125;else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
            &#125;
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
        &#125;
        logger.info(&quot;path = &quot; + path);
        return GraceJSONResult.ok(path);
    &#125;
&#125;
//此时去上传图片会报错 报跨域异常错误
//需要在用户service-user里的Application 
//@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
//贴到com/imooc/files/Application.java

此时再次 http://writer.imoocnews.com:9090/imooc-news/writer/accountInfo.html
提交头像
Console：
06:09.827 [http-nio-8004-exec-1] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring DispatcherServlet &#39;dispatcherServlet&#39;
06:09.827 [http-nio-8004-exec-1] INFO  o.s.web.servlet.DispatcherServlet - Initializing Servlet &#39;dispatcherServlet&#39;
06:09.832 [http-nio-8004-exec-1] INFO  o.s.web.servlet.DispatcherServlet - Completed initialization in 5 ms
06:09.882 [http-nio-8004-exec-2] INFO  c.imooc.api.aspect.ServiceLogAspect - ==== 开始执行 class com.imooc.files.service.impl.UploaderServiceImpl.uploadFdfs ====
06:09.937 [http-nio-8004-exec-2] INFO  c.imooc.api.aspect.ServiceLogAspect - 当前执行耗时：55
06:09.937 [http-nio-8004-exec-2] INFO  c.i.f.c.FileUploadController - path = imooc/M00/00/00/wKiqiGaPrpKAEt22AAAeb3kUsrg507.png

http://192.168.170.136:8888/imooc/M00/00/00/wKiqiGaPrpKAEt22AAAeb3kUsrg507.png
此时就可以看到Cat的图片了！
</code></pre>
<h3 id="完善用户头像上传"><a href="#完善用户头像上传" class="headerlink" title="完善用户头像上传"></a>完善用户头像上传</h3><pre><code class="java">【在用户返回的时候写死路径+path】
return GraceJSONResult.ok(&quot;http://192.168.170.136:8888/&quot;path);

给它包装一下 FileResource写一下
service-files  com/imooc/files/controller/FileUploadController.java
package com.imooc.files.controller;


import com.imooc.api.controller.files.FileUploadControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.files.FileResource;
import com.imooc.files.service.UploaderService;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

@RestController
public class FileUploadController implements FileUploadControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FileUploadController.class);

    @Autowired
    private UploaderService uploaderService;

    @Autowired
    private FileResource fileResource;

    @Override
    public GraceJSONResult uploadFace(String userId,
                                      MultipartFile file) throws Exception &#123;
        String path = &quot;&quot;;
        if (file != null)&#123;
        // 获得文件上传的名称
            String fileName = file.getOriginalFilename();
            //判断文件名不能为空
            if (StringUtils.isNotBlank(fileName))&#123;
                String fileNameArr[] = fileName.split(&quot;\\.&quot;);
                //获得后缀名
                String suffix = fileNameArr[fileNameArr.length - 1];
                //防止黑客上传文件攻击服务器 判断后缀符合我们的预定义规范
                if (!suffix.equalsIgnoreCase(&quot;png&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpg&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpeg&quot;)
                )&#123;
                    return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_FORMATTER_FAILD);
                &#125;
                // 执行上传
                path = uploaderService.uploadFdfs(file, suffix);
            &#125;else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
            &#125;
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
        &#125;
        logger.info(&quot;path = &quot; + path);

        String finalPath = &quot;&quot;;
        if (StringUtils.isNotBlank(path))&#123;
            finalPath = fileResource.getHost() + path;
        &#125;  else&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_FAILD);
        &#125;
        return GraceJSONResult.ok(finalPath);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/FileResource.java
package com.imooc.files;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.PropertySource;
import org.springframework.stereotype.Component;

@Component
@PropertySource(&quot;classpath:file-$&#123;spring.profiles.active&#125;.properties &quot;) //这个是在application.yml里面的 自动匹配
@ConfigurationProperties(prefix = &quot;file&quot;)
public class FileResource &#123;
    private String host;

    public String getHost() &#123;
        return host;
    &#125;

    public void setHost(String host) &#123;
        this.host = host;
    &#125;
&#125;
</code></pre>
<pre><code class="mysql">file-dev.properties
# fastdfs storage 节点地址(nginx整合的web服务)
file.host=http://192.168.170.136:8888/


application.yml
############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-file
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
  servlet:
    multipart:
      max-file-size: 512000 #请求文件大小限制为500kb
      max-request-size: 512000
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
此时拦截器也要加一层
package com.imooc.api.config;

import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UseActiveInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UseActiveInterceptor useActiveInterceptor()&#123;
        return new UseActiveInterceptor();
    &#125;

    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;)
                .addPathPatterns(&quot;/fs/uploadFace&quot;);
//        registry.addInterceptor(userTokenInterceptor())
//                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
    &#125;
&#125;
</code></pre>
<h3 id="图片大小控制的统一异常处理"><a href="#图片大小控制的统一异常处理" class="headerlink" title="图片大小控制的统一异常处理"></a>图片大小控制的统一异常处理</h3><pre><code class="java">dev-common  com/imooc/exception/GraceExceptionHandler.java
package com.imooc.exception;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MaxUploadSizeExceededException;

/**
 * 统一异常拦截处理
 * 可以针对异常的类型进行捕获 然后返回json信息到前端
 */
@ControllerAdvice
public class GraceExceptionHandler &#123;
    @ExceptionHandler(MyCustomException.class)
    //只要是这个类的异常都会进入下面的方法
    @ResponseBody
    public GraceJSONResult returnMyException(MyCustomException e)&#123;
        e.printStackTrace(); //打印信息
        return GraceJSONResult.exception(e.getResponseStatusEnum());
    &#125;

    @ExceptionHandler(MaxUploadSizeExceededException.class)
    @ResponseBody
    public GraceJSONResult returnMaxUploadSizeExceededException(MaxUploadSizeExceededException e)&#123;
        e.printStackTrace(); //打印信息
        return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_MAX_SIZE_ERROR);
    &#125;
&#125;
</code></pre>
<h3 id="第三方云存储解决方案-【阿里OSS】"><a href="#第三方云存储解决方案-【阿里OSS】" class="headerlink" title="第三方云存储解决方案 【阿里OSS】"></a>第三方云存储解决方案 【阿里OSS】</h3><h5 id="FastDFS-中小型公司使用"><a href="#FastDFS-中小型公司使用" class="headerlink" title="FastDFS [中小型公司使用]"></a>FastDFS [中小型公司使用]</h5><ul>
<li>水平扩容</li>
<li>运维复杂</li>
<li>开发复杂【增加图片效果 &amp; 人脸识别等】</li>
</ul>
<h5 id="云存储阿里OSS"><a href="#云存储阿里OSS" class="headerlink" title="云存储阿里OSS"></a><span style = "color:red">云存储阿里OSS</span></h5><ul>
<li>SDK使用简单 [Java对接]</li>
<li>提供强大的文件处理功能</li>
<li>零运维成本</li>
<li>图形化管理控制台</li>
<li>CDN加速</li>
<li>降低风险管理成本</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://common-buy.aliyun.com/?commodityCode=ossbag&spm=5176.28061389.commonbuy2container.oss_rc_dp_cn_ZjqTabLinks_2.3949778b3uJsQM&regionId=cn-inland-common&accounttraceid=f8f4fe13a682404d8cab9b0254ae864ddivk">对象存储 OSS 资源包 (aliyun.com)</a>[购买 <strong><u>标准-本地冗余存储</u></strong> ＋ <u><strong>下行流量</strong></u> ]</p>
<h3 id="控制台的基本配置使用-【阿里OSS】"><a href="#控制台的基本配置使用-【阿里OSS】" class="headerlink" title="控制台的基本配置使用 【阿里OSS】"></a>控制台的基本配置使用 【阿里OSS】</h3><p><a target="_blank" rel="noopener" href="https://oss.console.aliyun.com/overview">OSS管理控制台 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://billing-cost.console.aliyun.com/home/myfreetier?spm=5176.29188366.free-tier.4.47553e4dvJ4jbs">费用与成本 (aliyun.com)我的试用</a></p>
<ul>
<li>对象存储OSS → Bucket列表 → 创建Bucket → 存储冗余类型:<u>本地冗余存储</u> → 读写权限:<u>公共读</u></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://oss.console.aliyun.com/bucket/oss-cn-shanghai/iimooc-news-dev/object">OSS管理控制台 (aliyun.com)</a></p>
<ul>
<li>创建成功后进入<u>iimooc-news-dev&#x2F;object</u> → 文件管理 → 文件列表 →<br><a target="_blank" rel="noopener" href="https://iimooc-news-dev.oss-cn-shanghai.aliyuncs.com/log.png">https://iimooc-news-dev.oss-cn-shanghai.aliyuncs.com/log.png</a></li>
</ul>
<pre><code class="xml">dev-common  pom.xml
&lt;dependency&gt;
  &lt;groupId&gt;com.aliyun.oss&lt;/groupId&gt;
  &lt;artifactId&gt;aliyun-sdk-oss&lt;/artifactId&gt;
  &lt;version&gt;3.10.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>对象存储OSS → SDK文档 → <strong>上传网络流</strong></li>
<li>对象存储OSS → iimooc-news-dev → 概览 → 访问端口: 外网访问 <u>oss-cn-shanghai.aliyuncs.com</u></li>
</ul>
<h3 id="SDK的使用与项目整合"><a href="#SDK的使用与项目整合" class="headerlink" title="SDK的使用与项目整合"></a>SDK的使用与项目整合</h3><pre><code class="java">service-file  com/imooc/files/service/UploaderService.java
package com.imooc.files.service;

import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

public interface UploaderService &#123;
    /**
     * 使用fastdfs 上传文件
     */
    public String uploadFdfs(MultipartFile file, String fileExtName) throws IOException;

    /**
     * 使用OSS 上传文件
     */
    public String uploadOSS(MultipartFile file,String userId, String fileExtName) throws IOException;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/service/impl/UploaderServiceImpl.java
package com.imooc.files.service.impl;

import com.aliyun.oss.OSS;
import com.aliyun.oss.OSSClientBuilder;
import com.github.tobato.fastdfs.domain.fdfs.StorePath;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import com.imooc.files.resource.FileResource;
import com.imooc.files.service.UploaderService;
import com.imooc.utils.extend.AliyunResource;
import org.n3r.idworker.Sid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;

@Service
public class UploaderServiceImpl implements UploaderService &#123;
    //注入客户端
    @Autowired
    public FastFileStorageClient fastFileStorageClient;
    @Autowired
    public FileResource fileResource;
    @Autowired
    public AliyunResource aliyunResource;
    @Autowired
    public Sid sid;

    @Override
    public String uploadFdfs(MultipartFile file, String fileExtName) throws IOException &#123;
        StorePath storePath = fastFileStorageClient.uploadFile(file.getInputStream(), file.getSize(), fileExtName, null);
        return storePath.getFullPath();
    &#125;

    @Override
    public String uploadOSS(MultipartFile file, String userId, String fileExtName) throws IOException &#123;
        // Endpoint以杭州为例，其它Region请按实际情况填写。
        // 外网访问：oss-cn-shanghai.aliyuncs.com
        String endpoint = fileResource.getEndpoint();
        // 阿里云主账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建RAM账号。
        String accessKeyId = aliyunResource.getAccessKeyID();
        String accessKeySecret = aliyunResource.getAccessKeySecret();

        // 创建OSSClient实例。
        OSS ossClient = new OSSClientBuilder().build(endpoint,
                accessKeyId,
                accessKeySecret);
        //  images/abc/10010/cat.png  路径不全 所以需要myObjectName拼接
        String fileName = sid.nextShort();
        String myObjectName = fileResource.getObjectName()
                + &quot;/&quot; + userId + &quot;/&quot; + fileName + &quot;.&quot; + fileExtName;

        // 上传网络流。
        InputStream inputStream = file.getInputStream();
        ossClient.putObject(fileResource.getBucketName(),
                myObjectName,
                inputStream);

        // 关闭OSSClient。
        ossClient.shutdown();
        return myObjectName;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/resource/FileResource.java
package com.imooc.files.resource;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.PropertySource;
import org.springframework.stereotype.Component;

@Component
@PropertySource(&quot;classpath:file-$&#123;spring.profiles.active&#125;.properties &quot;) //这个是在application.yml里面的 自动匹配
@ConfigurationProperties(prefix = &quot;file&quot;)
public class FileResource &#123;
    private String host;
    private String endpoint;
    private String BucketName;
    private String objectName;
&#125;Getter + Setter
</code></pre>
<pre><code class="mysql">file-dev.properties
# fastdfs storage ????(nginx???web??)
file.host=http://192.168.170.136:8888/

# aliyun OSS
file.endpoint=oss-cn-shanghai.aliyuncs.com

file.BucketName=iimooc-news-dev

# url name
file.objectName=images/abc
</code></pre>
<h3 id="OSS整合实现文件上传"><a href="#OSS整合实现文件上传" class="headerlink" title="OSS整合实现文件上传"></a>OSS整合实现文件上传</h3><pre><code class="java"> // OSS执行上传
//  path = uploaderService.uploadOSS(file, userId, suffix);

service-files  com/imooc/files/controller/FileUploadController.java
package com.imooc.files.controller;


import com.imooc.api.controller.files.FileUploadControllerApi;
import com.imooc.files.resource.FileResource;
import com.imooc.files.service.UploaderService;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

@RestController
public class FileUploadController implements FileUploadControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FileUploadController.class);

    @Autowired
    private UploaderService uploaderService;

    @Autowired
    private FileResource fileResource;

    @Override
    public GraceJSONResult uploadFace(String userId,
                                      MultipartFile file) throws Exception &#123;
        String path = &quot;&quot;;
        if (file != null)&#123;
        // 获得文件上传的名称
            String fileName = file.getOriginalFilename();
            //判断文件名不能为空
            if (StringUtils.isNotBlank(fileName))&#123;
                String fileNameArr[] = fileName.split(&quot;\\.&quot;);
                //获得后缀名
                String suffix = fileNameArr[fileNameArr.length - 1];
                //防止黑客上传文件攻击服务器 判断后缀符合我们的预定义规范
                if (!suffix.equalsIgnoreCase(&quot;png&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpg&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpeg&quot;)
                )&#123;
                    return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_FORMATTER_FAILD);
                &#125;
                // fdfs执行上传
//                path = uploaderService.uploadFdfs(file, suffix);
                // OSS执行上传
                path = uploaderService.uploadOSS(file, userId, suffix);
            &#125;else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
            &#125;
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
        &#125;
        logger.info(&quot;path = &quot; + path);

        String finalPath = &quot;&quot;;
        if (StringUtils.isNotBlank(path))&#123;
            finalPath = fileResource.getHost() + path;
        &#125;  else&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_FAILD);
        &#125;
        return GraceJSONResult.ok(finalPath);
    &#125;
&#125;

=================================================================================
http://writer.imoocnews.com:9090/imooc-news/writer/accountInfo.html
此时更改头像上传后 头像会在OSS服务器的文件里面显示
</code></pre>
<pre><code class="mysql">file-dev.properties / file-prod.properties
# fastdfs storage ????(nginx???web??)
file.host=http://192.168.170.136:8888/

# aliyun OSS
file.endpoint=oss-cn-shanghai.aliyuncs.com

file.BucketName=iimooc-news-dev

# url name
file.objectName=images/abc

file.ossHost=https://iimooc-news-dev.oss-cn-shanghai.aliyuncs.com/
</code></pre>
<pre><code class="java">service-files  com/imooc/files/resource/FileResource.java
@Component
@PropertySource(&quot;classpath:file-$&#123;spring.profiles.active&#125;.properties &quot;) //这个是在application.yml里面的 自动匹配
@ConfigurationProperties(prefix = &quot;file&quot;)
public class FileResource &#123;
    private String host;
    private String endpoint;
    private String BucketName;
    private String objectName;
    private String OssHost;
&#125;Getter + Setter
</code></pre>
<pre><code class="java">service-files  com/imooc/files/controller/FileUploadController.java
    //用OSS执行上传 而不是 fdfs执行上传
package com.imooc.files.controller;


import com.imooc.api.controller.files.FileUploadControllerApi;
import com.imooc.files.resource.FileResource;
import com.imooc.files.service.UploaderService;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

@RestController
public class FileUploadController implements FileUploadControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FileUploadController.class);

    @Autowired
    private UploaderService uploaderService;

    @Autowired
    private FileResource fileResource;

    @Override
    public GraceJSONResult uploadFace(String userId,
                                      MultipartFile file) throws Exception &#123;
        String path = &quot;&quot;;
        if (file != null)&#123;
        // 获得文件上传的名称
            String fileName = file.getOriginalFilename();
            //判断文件名不能为空
            if (StringUtils.isNotBlank(fileName))&#123;
                String fileNameArr[] = fileName.split(&quot;\\.&quot;);
                //获得后缀名
                String suffix = fileNameArr[fileNameArr.length - 1];
                //防止黑客上传文件攻击服务器 判断后缀符合我们的预定义规范
                if (!suffix.equalsIgnoreCase(&quot;png&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpg&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpeg&quot;)
                )&#123;
                    return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_FORMATTER_FAILD);
                &#125;
                // fdfs执行上传
//                path = uploaderService.uploadFdfs(file, suffix);
                // OSS执行上传
                path = uploaderService.uploadOSS(file, userId, suffix);
            &#125;else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
            &#125;
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
        &#125;
        logger.info(&quot;path = &quot; + path);

        String finalPath = &quot;&quot;;
        if (StringUtils.isNotBlank(path))&#123;
//            finalPath = fileResource.getHost() + path;
            finalPath = fileResource.getOssHost() + path;
        &#125;  else&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_FAILD);
        &#125;
        return GraceJSONResult.ok(finalPath);
    &#125;
&#125;
</code></pre>
<h3 id="图片自动审核-【阿里内容安全】"><a href="#图片自动审核-【阿里内容安全】" class="headerlink" title="图片自动审核 【阿里内容安全】"></a>图片自动审核 【阿里内容安全】</h3><h6 id="多媒体内容风险智能识别服务，降低色情、暴力、恐怖-由于太贵了就不买了-1000多呢"><a href="#多媒体内容风险智能识别服务，降低色情、暴力、恐怖-由于太贵了就不买了-1000多呢" class="headerlink" title="多媒体内容风险智能识别服务，降低色情、暴力、恐怖 (由于太贵了就不买了 1000多呢)"></a>多媒体内容风险智能识别服务，降低色情、暴力、恐怖 (<u>由于太贵了就不买了 1000多呢</u>)</h6><pre><code class="xml">dev-common  pom.xml
 &lt;!-- 第三方云厂商相关的依赖 --&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-java-sdk-core&lt;/artifactId&gt;
            &lt;version&gt;4.5.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun.oss&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-sdk-oss&lt;/artifactId&gt;
            &lt;version&gt;3.10.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-java-sdk-green&lt;/artifactId&gt;
            &lt;version&gt;3.5.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;1.2.51&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;commons-codec&lt;/groupId&gt;
            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;
            &lt;version&gt;1.10&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;commons-io&lt;/groupId&gt;
            &lt;artifactId&gt;commons-io&lt;/artifactId&gt;
            &lt;version&gt;2.4&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">dev-common  com/imooc/utils/extend/AliImageReviewUtils.java
package com.imooc.utils.extend;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.aliyuncs.DefaultAcsClient;
import com.aliyuncs.IAcsClient;
import com.aliyuncs.green.model.v20180509.ImageSyncScanRequest;
import com.aliyuncs.http.FormatType;
import com.aliyuncs.http.HttpResponse;
import com.aliyuncs.http.MethodType;
import com.aliyuncs.http.ProtocolType;
import com.aliyuncs.profile.DefaultProfile;
import com.aliyuncs.profile.IClientProfile;
import com.imooc.enums.ArticleReviewLevel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.Date;
import java.util.UUID;

@Component
public class AliImageReviewUtils &#123;

//    文档地址：https://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.2.49.6f9c75fdjaW30p#reference-fzy-ztm-v2b

    @Autowired
    private AliyunResource aliyunResource;

    public boolean reviewImage(String imgUrl) throws Exception &#123;
        IClientProfile profile = DefaultProfile
                .getProfile(&quot;cn-shanghai&quot;, &quot;&quot;, &quot;&quot;);
        DefaultProfile
                .addEndpoint(&quot;cn-shanghai&quot;, &quot;cn-shanghai&quot;, &quot;Green&quot;, &quot;green.cn-shanghai.aliyuncs.com&quot;);
        IAcsClient client = new DefaultAcsClient(profile);

        ImageSyncScanRequest imageSyncScanRequest = new ImageSyncScanRequest();
        // 指定api返回格式
        imageSyncScanRequest.setAcceptFormat(FormatType.JSON);
        // 指定请求方法
        imageSyncScanRequest.setMethod(MethodType.POST);
        imageSyncScanRequest.setEncoding(&quot;utf-8&quot;);
        //支持http和https
        imageSyncScanRequest.setProtocol(ProtocolType.HTTP);


        JSONObject httpBody = new JSONObject();
        /**
         * 设置要检测的场景, 计费是按照该处传递的场景进行
         * 一次请求中可以同时检测多张图片，每张图片可以同时检测多个风险场景，计费按照场景计算
         * 例如：检测2张图片，场景传递porn、terrorism，计费会按照2张图片鉴黄，2张图片暴恐检测计算
         * porn: porn表示色情场景检测
         * logo: 商标
         * 其他详见官方文档
         */
        httpBody.put(&quot;scenes&quot;, Arrays.asList(&quot;terrorism&quot;));

        /**
         * 设置待检测图片， 一张图片一个task
         * 多张图片同时检测时，处理的时间由最后一个处理完的图片决定
         * 通常情况下批量检测的平均rt比单张检测的要长, 一次批量提交的图片数越多，rt被拉长的概率越高
         * 这里以单张图片检测作为示例, 如果是批量图片检测，请自行构建多个task
         */
        JSONObject task = new JSONObject();
        task.put(&quot;dataId&quot;, UUID.randomUUID().toString());

        //设置图片链接
        task.put(&quot;url&quot;, imgUrl);
        task.put(&quot;time&quot;, new Date());
        httpBody.put(&quot;tasks&quot;, Arrays.asList(task));

        imageSyncScanRequest.setHttpContent(org.apache.commons.codec.binary.StringUtils.getBytesUtf8(httpBody.toJSONString()),
                &quot;UTF-8&quot;, FormatType.JSON);

        /**
         * 请设置超时时间, 服务端全链路处理超时时间为10秒，请做相应设置
         * 如果您设置的ReadTimeout小于服务端处理的时间，程序中会获得一个read timeout异常
         */
        imageSyncScanRequest.setConnectTimeout(3000);
        imageSyncScanRequest.setReadTimeout(10000);
        HttpResponse httpResponse = null;
        try &#123;
            httpResponse = client.doAction(imageSyncScanRequest);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;

        //服务端接收到请求，并完成处理返回的结果
        if (httpResponse != null &amp;&amp; httpResponse.isSuccess()) &#123;
            JSONObject scrResponse = JSON.parseObject(org.apache.commons.codec.binary.StringUtils.newStringUtf8(httpResponse.getHttpContent()));
            System.out.println(JSON.toJSONString(scrResponse, true));
            int requestCode = scrResponse.getIntValue(&quot;code&quot;);
            //每一张图片的检测结果
            JSONArray taskResults = scrResponse.getJSONArray(&quot;data&quot;);
            if (200 == requestCode) &#123;
                for (Object taskResult : taskResults) &#123;
                    //单张图片的处理结果
                    int taskCode = ((JSONObject) taskResult).getIntValue(&quot;code&quot;);
                    //图片要检测的场景的处理结果, 如果是多个场景，则会有每个场景的结果
                    JSONArray sceneResults = ((JSONObject) taskResult).getJSONArray(&quot;results&quot;);
                    if (200 == taskCode) &#123;
                        Object sceneResult = sceneResults.get(0);
//                        for (Object sceneResult : sceneResults) &#123;
                        String scene = ((JSONObject) sceneResult).getString(&quot;scene&quot;);
                        String suggestion = ((JSONObject) sceneResult).getString(&quot;suggestion&quot;);
                        //根据scene和suggetion做相关处理
                        //do something
                        System.out.println(&quot;scene = [&quot; + scene + &quot;]&quot;);
                        System.out.println(&quot;suggestion = [&quot; + suggestion + &quot;]&quot;);

                        return suggestion.equalsIgnoreCase(ArticleReviewLevel.PASS.type) ? true : false;
//                        &#125;
                    &#125; else &#123;
                        //单张图片处理失败, 原因视具体的情况详细分析
                        System.out.println(&quot;task process fail. task response:&quot; + JSON.toJSONString(taskResult));
                        return false;
                    &#125;
                &#125;
            &#125; else &#123;
                /**
                 * 表明请求整体处理失败，原因视具体的情况详细分析
                 */
                System.out.println(&quot;the whole image scan request failed. response:&quot; + JSON.toJSONString(scrResponse));
                return false;
            &#125;
        &#125;
        return false;
    &#125;
&#125;
</code></pre>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/crisschan/article/details/136866137">解决github Push rejected报错 remote: error: GH013: Repository rule violations found for refs&#x2F;heads&#x2F;maste_github push declined due to repository rule violat-CSDN博客</a></p>
<pre><code class="java">dev-common  com/imooc/enums/ArticleReviewLevel.java
package com.imooc.enums;

/**
 * @Desc: 文章自动审核结果 枚举
 */
public enum ArticleReviewLevel &#123;
    PASS(&quot;pass&quot;, &quot;自动审核通过&quot;),
    BLOCK(&quot;block&quot;, &quot;自动审核不通过&quot;),
    REVIEW(&quot;review&quot;, &quot;建议人工复审&quot;);

    public final String type;
    public final String value;

    ArticleReviewLevel(String type, String value) &#123;
        this.type = type;
        this.value = value;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/controller/FileUploadController.java
package com.imooc.files.controller;

import com.imooc.api.controller.files.FileUploadControllerApi;
import com.imooc.files.resource.FileResource;
import com.imooc.files.service.UploaderService;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.extend.AliImageReviewUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

@RestController
public class FileUploadController implements FileUploadControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FileUploadController.class);

    @Autowired
    private UploaderService uploaderService;

    @Autowired
    private FileResource fileResource;

    @Autowired
    private AliImageReviewUtils aliImageReviewUtils;

    @Override
    public GraceJSONResult uploadFace(String userId,
                                      MultipartFile file) throws Exception &#123;
        String path = &quot;&quot;;
        if (file != null)&#123;
        // 获得文件上传的名称
            String fileName = file.getOriginalFilename();
            //判断文件名不能为空
            if (StringUtils.isNotBlank(fileName))&#123;
                String fileNameArr[] = fileName.split(&quot;\\.&quot;);
                //获得后缀名
                String suffix = fileNameArr[fileNameArr.length - 1];
                //防止黑客上传文件攻击服务器 判断后缀符合我们的预定义规范
                if (!suffix.equalsIgnoreCase(&quot;png&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpg&quot;) &amp;&amp;
                        !suffix.equalsIgnoreCase(&quot;jpeg&quot;)
                )&#123;
                    return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_FORMATTER_FAILD);
                &#125;
                // fdfs执行上传     要让外面得以访问 ①需要把内网的环境发布到公网 [内网穿透]  ②路由器端口映射到外网  ③fastdfs安装到公网里
//                path = uploaderService.uploadFdfs(file, suffix);
                // OSS执行上传
                path = uploaderService.uploadOSS(file, userId, suffix);
            &#125;else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
            &#125;
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_NULL_ERROR);
        &#125;
        logger.info(&quot;path = &quot; + path);

        String finalPath = &quot;&quot;;
        if (StringUtils.isNotBlank(path))&#123;
//            finalPath = fileResource.getHost() + path;
            finalPath = fileResource.getOssHost() + path;
        &#125;  else&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_UPLOAD_FAILD);
        &#125;
           return GraceJSONResult.ok(finalPath);
       // return GraceJSONResult.ok(doAliImageReview(finalPath)); //这里加了图片审核咯
    &#125;

    /**
     * fastdfs 默认存在于内网，无法被阿里云内容管理服务检查到
     * 需要配置到公网才行：
     * 1. 内网穿透，natppp/花生壳/ngrok
     * 2. 路由配置端口映射
     * 3. fdfs 发布到云服务器
     */

   /* 功能实现不了图片识别 因为没有开通内容安全需要企业认证
     public static final String FAILED_IMAGE_URL = &quot;https://iimooc-news-dev.oss-cn-shanghai.aliyuncs.com/images/abc/240629F21AK1BHX4/Review_Failed.png&quot;; //这里保存审核失败的照片 提前上传到Oss里直接用
    private String doAliImageReview(String pendingImageUrl)&#123;
        boolean result = false;
        try &#123;
            result = aliImageReviewUtils.reviewImage(pendingImageUrl);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
        if (!result)&#123;
            return FAILED_IMAGE_URL;
        &#125;
        return pendingImageUrl;
    &#125;
&#125;
*/
</code></pre>
<h3 id="创建阿里云子账号-【阿里内容安全】"><a href="#创建阿里云子账号-【阿里内容安全】" class="headerlink" title="创建阿里云子账号 【阿里内容安全】"></a>创建阿里云子账号 【阿里内容安全】</h3><p><a target="_blank" rel="noopener" href="https://ram.console.aliyun.com/users">RAM访问控制 → 用户</a><br>[实在不行了 凑合着搞一下吧 功能实现不了图片识别 因为没有开通内容安全需要企业认证]</p>
<blockquote>
<p>登录名称：imooc-news-dev<br>显示名称：用于内容审核<br>√  OpenAPI访问调用<br>AccessKey ID：<br>AccessKeySeret：</p>
<p>点击左侧列表下方 授权 → 新增授权 【授权主体：用于内容审核      权限策略：搜：green   … 管理内容安全的权限】</p>
</blockquote>
<h3 id="构建admin服务"><a href="#构建admin服务" class="headerlink" title="构建admin服务"></a>构建admin服务</h3><ul>
<li>构建admin管理服务</li>
<li>文章分类管理</li>
<li>友情连接管理</li>
<li>用户账号管理</li>
<li>文章内容人工审核 [放在文章上传后的自动审核]</li>
<li>admin管理人员账号分配 [用户人脸]</li>
</ul>
<pre><code class="xml">service-admin  pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;artifactId&gt;imooc-news-dev-service-admin&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;


&lt;/project&gt;
</code></pre>
<pre><code class="xml">service-admin  logback-spring.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;configuration&gt;
    &lt;!-- 指定日志文件的存储地址，使用绝对路径 --&gt;
&lt;!--    &lt;property name=&quot;LOG_HOME&quot; value=&quot;/workspaces/logs/imooc-news-dev/service-admin&quot;/&gt;--&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;C:/Users/Pluminary/Desktop/imooc-news-admin&quot;/&gt;

    &lt;!-- Console 输出设置 --&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;
            &lt;pattern&gt;%white(%d&#123;mm:ss.SSS&#125;) %green([%thread]) %cyan(%-5level) %yellow(%logger&#123;36&#125;) %magenta(-) %black(%msg%n)&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 按照每天生成日志文件 --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- 日志文件输出的文件名 --&gt;
            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/service-admin.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!--&lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;--&gt;
        &lt;!--&lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;--&gt;
    &lt;!--&lt;/logger&gt;--&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<pre><code class="java">service-admin:8005
package com.imooc.admin;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.user.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/HelloController.java
package com.imooc.admin.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.RedisOperator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);

    public Object hello() &#123;
        return GraceJSONResult.ok();
    &#125;
&#125;
----------------------------------------------------------------------------
http://admin.imoocnews.com:8005/hello

application-dev.yml
server:
  port: 8005

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
</code></pre>
<h3 id="表设计与账号预分配-【admin账号】"><a href="#表设计与账号预分配-【admin账号】" class="headerlink" title="表设计与账号预分配 【admin账号】"></a>表设计与账号预分配 【admin账号】</h3><pre><code class="xml">service-admin  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
            &lt;version&gt;2.1.1.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/PWDTest.java
package com.imooc.admin.controller;

import org.springframework.security.crypto.bcrypt.BCrypt;

public class PWDTest &#123;
    public static void main(String[] args) &#123;
        String pwd = BCrypt.hashpw(&quot;admin&quot;, BCrypt.gensalt());//加盐
        System.out.println(pwd);
    &#125;
&#125;
</code></pre>
<h3 id="持久层查询管理员-【admin账号】"><a href="#持久层查询管理员-【admin账号】" class="headerlink" title="持久层查询管理员 【admin账号】"></a>持久层查询管理员 【admin账号】</h3><p><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/login.html">http://admin.imoocnews.com:9090/imooc-news/admin/login.html</a><br><a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/windows-finds-port-usage.html">Windows下如何查看某个端口被谁占用 | 菜鸟教程 (runoob.com)</a></p>
<pre><code class="java">//更改一下mybatis-generator-database里面的generatorConfig-admin.xml
数据库表为：admin_user
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE generatorConfiguration
        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;

&lt;generatorConfiguration&gt;
    &lt;context id=&quot;MysqlContext&quot; targetRuntime=&quot;MyBatis3Simple&quot; defaultModelType=&quot;flat&quot;&gt;
        &lt;property name=&quot;beginningDelimiter&quot; value=&quot;`&quot;/&gt;
        &lt;property name=&quot;endingDelimiter&quot; value=&quot;`&quot;/&gt;

        &lt;!-- 通用mapper所在目录 --&gt;
        &lt;plugin type=&quot;tk.mybatis.mapper.generator.MapperPlugin&quot;&gt;
            &lt;property name=&quot;mappers&quot; value=&quot;com.imooc.my.mapper.MyMapper&quot;/&gt;
        &lt;/plugin&gt;

        &lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot;
                        connectionURL=&quot;jdbc:mysql://localhost:3306/imooc-news-dev&quot;
                        userId=&quot;root&quot;
                        password=&quot;root&quot;&gt;
        &lt;/jdbcConnection&gt;

        &lt;!-- 对应生成的pojo所在包 --&gt;
        &lt;javaModelGenerator targetPackage=&quot;com.imooc.pojo&quot; targetProject=&quot;mybatis-generator-database/src/main/java&quot;/&gt;

        &lt;!-- 对应生成的mapper所在目录 --&gt;
        &lt;sqlMapGenerator targetPackage=&quot;mapper.admin&quot; targetProject=&quot;mybatis-generator-database/src/main/resources&quot;/&gt;

        &lt;!-- 配置mapper对应的java映射 --&gt;
        &lt;javaClientGenerator targetPackage=&quot;com.imooc.admin.mapper&quot; targetProject=&quot;mybatis-generator-database/src/main/java&quot; type=&quot;XMLMAPPER&quot;/&gt;

        &lt;!-- 数据库表 --&gt;
        &lt;table tableName=&quot;admin_user&quot;&gt;&lt;/table&gt;

    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
</code></pre>
<pre><code class="java">mybatis-generator-database的把AdminUser拷贝到dev-model的com/imooc/pojo下
mybatis-generator-database的把AdminUserMapper拷贝到service-admin的resources mapper/AdminUserMapper.xml
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/AdminUserService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;

public interface AdminUserService &#123;
    /**
     * 获得管理员的用户信息
     * @param username
     * @return
     */
    public AdminUser queryAdminByUsername(String username);
&#125;



service-admin  com/imooc/admin/service/impl/AdminUserServiceImpl.java
package com.imooc.admin.service.impl;

import com.imooc.admin.mapper.AdminUserMapper;
import com.imooc.admin.service.AdminUserService;
import com.imooc.pojo.AdminUser;
import org.springframework.beans.factory.annotation.Autowired;
import tk.mybatis.mapper.entity.Example;

public class AdminUserServiceImpl implements AdminUserService &#123;
    @Autowired
    public AdminUserMapper adminUserMapper;
    @Override
    public AdminUser queryAdminByUsername(String username) &#123;
        Example adminExample = new Example(AdminUser.class);
        Example.Criteria Criteria = adminExample.createCriteria();
        Criteria.andEqualTo(&quot;username&quot;,username);
        AdminUser admin = adminUserMapper.selectOneByExample(adminExample);
        return admin;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/mapper/AdminUserMapper.java
package com.imooc.admin.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.AdminUser;
import org.springframework.stereotype.Repository;

@Repository
public interface AdminUserMapper extends MyMapper&lt;AdminUser&gt; &#123;
&#125;
</code></pre>
<pre><code class="java">service-admin  mapper/AdminUserMapper.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.admin.mapper.AdminUserMapper&quot; &gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.AdminUser&quot; &gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;username&quot; property=&quot;username&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;password&quot; property=&quot;password&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;face_id&quot; property=&quot;faceId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;admin_name&quot; property=&quot;adminName&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;created_time&quot; property=&quot;createdTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
    &lt;result column=&quot;updated_time&quot; property=&quot;updatedTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<h3 id="用户名密码登录-【admin账号】"><a href="#用户名密码登录-【admin账号】" class="headerlink" title="用户名密码登录 【admin账号】"></a>用户名密码登录 【admin账号】</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/arjelarxfc/article/details/78806384">Spring里遇到的一个问题，autowired时报找不到bean定义_autowired找不到bean-CSDN博客</a></p>
<h6 id="其次上述问题一定要去找Controller-Service-ServiceImpl-和-启动类里面的有没有正确扫描包-MapperScan-basePackages-x3D-“com-imooc-admin-mapper”"><a href="#其次上述问题一定要去找Controller-Service-ServiceImpl-和-启动类里面的有没有正确扫描包-MapperScan-basePackages-x3D-“com-imooc-admin-mapper”" class="headerlink" title="其次上述问题一定要去找Controller Service ServiceImpl 和 启动类里面的有没有正确扫描包@MapperScan(basePackages &#x3D; “com.imooc.admin.mapper”)"></a>其次上述问题一定要去找Controller Service ServiceImpl 和 启动类里面的有没有正确扫描包@MapperScan(basePackages &#x3D; “com.imooc.admin.mapper”)</h6><pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
package com.imooc.admin.controller;

import com.imooc.admin.service.AdminUserService;
import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.AdminMngControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.utils.RedisOperator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.UUID;

@RestController
public class AdminMngController extends BaseController implements AdminMngControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(AdminMngController.class);

    @Autowired
    private AdminUserService adminUserService;

    @Autowired
    private RedisOperator redis;

    @Override
    public Object adminLogin(AdminLoginBO adminLoginBO, HttpServletRequest request, HttpServletResponse response) &#123;
        // 0. TODO 验证BO中的用户名和密码不为空

        // 1.查询admin用户的信息
        AdminUser admin = adminUserService.queryAdminByUsername(adminLoginBO.getUsername());
        // 2.判断admin不为空，如果为空则登录失败
        if (admin == null) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_NOT_EXIT_ERROR);
        &#125;
        // 3.判断密码是否匹配
        boolean isPwdMath = BCrypt.checkpw(adminLoginBO.getPassword(), admin.getPassword());
        if (isPwdMath)&#123;
            doLoginSettings(admin,request,response);
            return GraceJSONResult.ok();
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_NOT_EXIT_ERROR);
        &#125;
    &#125;

    /**
     * 用于admin用户登录过后的基本信息设置
     */
    private void doLoginSettings(AdminUser admin, HttpServletRequest request, HttpServletResponse response)&#123;
        // 保存token放入到redis中
        String token = UUID.randomUUID().toString();
        redis.set(REDIS_ADMIN_TOKEN + &quot;:&quot; + admin.getId(),token);

        // 保存admin登录基本token信息到cookie中
        setCookie(request, response, &quot;atoken&quot;, token, COOKIE_MONTH);
        setCookie(request, response, &quot;aid&quot;, admin.getId(), COOKIE_MONTH);
        setCookie(request, response, &quot;aname&quot;, admin.getAdminName(), COOKIE_MONTH);
    &#125;
&#125;
---------------------------------------------------------------------------------
http://admin.imoocnews.com:9090/imooc-news/admin/login.html
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/AdminUserService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;

public interface AdminUserService &#123;
    /**
     * 获得管理员的用户信息
     * @param username
     * @return
     */
    public AdminUser queryAdminByUsername(String username);
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/AdminUserServiceImpl.java
package com.imooc.admin.service.impl;

import com.imooc.admin.mapper.AdminUserMapper;
import com.imooc.admin.service.AdminUserService;
import com.imooc.pojo.AdminUser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import tk.mybatis.mapper.entity.Example;

@Service
public class AdminUserServiceImpl implements AdminUserService &#123;
    @Autowired
    public AdminUserMapper adminUserMapper;
    @Override
    public AdminUser queryAdminByUsername(String username) &#123;
        Example adminExample = new Example(AdminUser.class);
        Example.Criteria Criteria = adminExample.createCriteria();
        Criteria.andEqualTo(&quot;username&quot;,username);
        AdminUser admin = adminUserMapper.selectOneByExample(adminExample);
        return admin;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/mapper/AdminUserMapper.java
package com.imooc.admin.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.AdminUser;
import org.springframework.stereotype.Repository;

@Repository
public interface AdminUserMapper extends MyMapper&lt;AdminUser&gt; &#123;
&#125;


service-admin  resources/mapper/AdminUserMapper.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.admin.mapper.AdminUserMapper&quot; &gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.AdminUser&quot; &gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;username&quot; property=&quot;username&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;password&quot; property=&quot;password&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;face_id&quot; property=&quot;faceId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;admin_name&quot; property=&quot;adminName&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;created_time&quot; property=&quot;createdTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
    &lt;result column=&quot;updated_time&quot; property=&quot;updatedTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/Application.java
package com.imooc.admin;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.admin.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="mysql">service-admin  application-dev.yml
server:
  port: 8005

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
## setup CN from java, This is resource
website:
  domain-name: imoocnews.com

## open mybatis log in dev
#mybatis:
#  configuration:
#    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
#
</code></pre>
<h3 id="校验admin账号唯一-【admin账号】"><a href="#校验admin账号唯一-【admin账号】" class="headerlink" title="校验admin账号唯一 【admin账号】"></a>校验admin账号唯一 【admin账号】</h3><p><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html">http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html</a></p>
<pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java

  @Override
    public Object adminLogin(String username) &#123;
        checkAdminExist(username);
        return GraceJSONResult.ok();
    &#125;
    private void checkAdminExist(String username)&#123;
        AdminUser admin = adminUserService.queryAdminByUsername(username);
        if (admin != null)&#123;
            GraceException.display(ResponseStatusEnum.ADMIN_USERNAME_EXIST_ERROR);
        &#125;

    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/admin/AdminMngControllerApi.java
package com.imooc.api.controller.admin;

import com.imooc.pojo.bo.AdminLoginBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;管理员admin维护&quot;,tags = &#123;&quot;管理员admin维护的Controller&quot;&#125;)
@RequestMapping(&quot;adminMng&quot;)
public interface AdminMngControllerApi &#123;
    @ApiOperation(value = &quot;hello方法的接口&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminLogin&quot;)
    public Object adminLogin(@RequestBody AdminLoginBO adminLoginBO,
                             HttpServletRequest request,
                             HttpServletResponse response);

    @ApiOperation(value = &quot;查询admin用户名是否存在&quot;,notes = &quot;查询admin用户名是否存在&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminIsExist&quot;)
    public Object adminLogin(@RequestParam String username); //传回来
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
package com.imooc.api.config;

import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UseActiveInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UseActiveInterceptor useActiveInterceptor()&#123;
        return new UseActiveInterceptor();
    &#125;

    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;)
                .addPathPatterns(&quot;/fs/uploadFace&quot;);

        //        registry.addInterceptor(userTokenInterceptor())
//                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
    &#125;
&#125;
</code></pre>
<h3 id="创建admin账号-【admin账号】"><a href="#创建admin账号-【admin账号】" class="headerlink" title="创建admin账号 【admin账号】"></a>创建admin账号 【admin账号】</h3><p><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/userList.html">用户管理 | 运营管理平台 (imoocnews.com)</a><br><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html">http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html</a></p>
<pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
package com.imooc.admin.controller;

import com.imooc.admin.service.AdminUserService;
import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.AdminMngControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.utils.RedisOperator;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.UUID;

@RestController
public class AdminMngController extends BaseController implements AdminMngControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(AdminMngController.class);

    @Autowired
    private AdminUserService adminUserService;

    @Autowired
    private RedisOperator redis;

    @Override
    public GraceJSONResult adminLogin(AdminLoginBO adminLoginBO, HttpServletRequest request, HttpServletResponse response) &#123;
        // 0. TODO 验证BO中的用户名和密码不为空

        // 1.查询admin用户的信息
        AdminUser admin = adminUserService.queryAdminByUsername(adminLoginBO.getUsername());
        // 2.判断admin不为空，如果为空则登录失败
        if (admin == null) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_NOT_EXIT_ERROR);
        &#125;
        // 3.判断密码是否匹配
        boolean isPwdMath = BCrypt.checkpw(adminLoginBO.getPassword(), admin.getPassword());
        if (isPwdMath)&#123;
            doLoginSettings(admin,request,response);
            return GraceJSONResult.ok();
        &#125;else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_NOT_EXIT_ERROR);
        &#125;
    &#125;


    /**
     * 用于admin用户登录过后的基本信息设置
     */
    private void doLoginSettings(AdminUser admin, HttpServletRequest request, HttpServletResponse response)&#123;
        // 保存token放入到redis中
        String token = UUID.randomUUID().toString();
        redis.set(REDIS_ADMIN_TOKEN + &quot;:&quot; + admin.getId(),token);

        // 保存admin登录基本token信息到cookie中
        setCookie(request, response, &quot;atoken&quot;, token, COOKIE_MONTH);
        setCookie(request, response, &quot;aid&quot;, admin.getId(), COOKIE_MONTH);
        setCookie(request, response, &quot;aname&quot;, admin.getAdminName(), COOKIE_MONTH);
    &#125;


    @Override
    public GraceJSONResult adminLogin(String username) &#123;
        checkAdminExist(username);
        return GraceJSONResult.ok();
    &#125;

    private void checkAdminExist(String username)&#123;
        AdminUser admin = adminUserService.queryAdminByUsername(username);
        if (admin != null)&#123;
            GraceException.display(ResponseStatusEnum.ADMIN_USERNAME_EXIST_ERROR);
        &#125;

    &#125;

    @Override
    public GraceJSONResult addNewAdmin(NewAdminBO newAdminBO,HttpServletRequest request,HttpServletResponse response) &#123;
        // 0. TODO 验证BO中的用户名和密码不为空

        // 1. base64不为空，则代表人脸入库，否则需要用户输入密码和确认密码
        if (StringUtils.isBlank(newAdminBO.getImg64()))&#123;
            if (StringUtils.isBlank(newAdminBO.getPassword()) || StringUtils.isBlank(newAdminBO.getConfirmPassword()))&#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_PASSWORD_NULL_ERROR);
            &#125;
        &#125;
        // 2. 密码不为空，则必须判断两次输入一致
        if (StringUtils.isNotBlank(newAdminBO.getPassword())) &#123;
            if (!newAdminBO.getPassword().equalsIgnoreCase(newAdminBO.getConfirmPassword())) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_PASSWORD_ERROR);
            &#125;
        &#125;
        // 3. 校验用户名唯一
        checkAdminExist(newAdminBO.getUsername());

        // 4.调用service存入admin信息
        adminUserService.createAdminUser(newAdminBO);
        return GraceJSONResult.ok();
    &#125;

&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/admin/AdminMngControllerApi.java
package com.imooc.api.controller.admin;


import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;管理员admin维护&quot;,tags = &#123;&quot;管理员admin维护的Controller&quot;&#125;)
@RequestMapping(&quot;adminMng&quot;)
public interface AdminMngControllerApi &#123;
    @ApiOperation(value = &quot;hello方法的接口&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminLogin&quot;)
    public GraceJSONResult adminLogin(@RequestBody AdminLoginBO adminLoginBO,
                                      HttpServletRequest request,
                                      HttpServletResponse response);

    @ApiOperation(value = &quot;查询admin用户名是否存在&quot;,notes = &quot;查询admin用户名是否存在&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminIsExist&quot;)
    public GraceJSONResult adminLogin(@RequestParam String username); //传回来

    @ApiOperation(value = &quot;创建admin&quot;,notes = &quot;创建admin&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/addNewAdmin&quot;)
    public GraceJSONResult addNewAdmin(@RequestBody NewAdminBO newAdminBO,HttpServletRequest request,HttpServletResponse response); //传回来
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/AdminUserServiceImpl.java
package com.imooc.admin.service.impl;

import com.imooc.admin.mapper.AdminUserMapper;
import com.imooc.admin.service.AdminUserService;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;
import org.apache.commons.lang3.StringUtils;
import org.n3r.idworker.Sid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.stereotype.Service;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;

@Service
public class AdminUserServiceImpl implements AdminUserService &#123;
    @Autowired
    public AdminUserMapper adminUserMapper;
    @Autowired
    public Sid sid;
    @Override
    public AdminUser queryAdminByUsername(String username) &#123;
        Example adminExample = new Example(AdminUser.class);
        Example.Criteria Criteria = adminExample.createCriteria();
        Criteria.andEqualTo(&quot;username&quot;,username);
        AdminUser admin = adminUserMapper.selectOneByExample(adminExample);
        return admin;
    &#125;

    @Override
    public void createAdminUser(NewAdminBO newAdminBO) &#123;
        String adminId = sid.nextShort(); //获得主键
        AdminUser adminUser = new AdminUser();
        adminUser.setId(adminId);
        adminUser.setUsername(newAdminBO.getUsername());
        adminUser.setAdminName(newAdminBO.getAdminName());
        // 如果密码不为空 则密码需要加密 存入数据库
        if (StringUtils.isNotBlank(newAdminBO.getPassword()))&#123;
            String pwd = BCrypt.hashpw(newAdminBO.getPassword(), BCrypt.gensalt());
            adminUser.setPassword(pwd);
        &#125;

        // 如果人脸上传以后，则有faceId，需要和admin信息关联存储入库
        if (StringUtils.isNotBlank(newAdminBO.getFaceId()))&#123;
            adminUser.setFaceId(newAdminBO.getFaceId());
        &#125;
        adminUser.setCreatedTime(new Date());
        adminUser.setUpdatedTime(new Date());

        int insert = adminUserMapper.insert(adminUser);
        if (insert != 1)&#123;
            GraceException.display(ResponseStatusEnum.ADMIN_CREATE_ERROR);
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="java">com/imooc/admin/service/AdminUserService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;

public interface AdminUserService &#123;
    /**
     * 获得管理员的用户信息
     * @param username
     * @return
     */
    public AdminUser queryAdminByUsername(String username);

    /**
     * 新增管理员
     *
     * @param newAdminBO
     */
    public void createAdminUser(NewAdminBO newAdminBO);
&#125;
</code></pre>
<h3 id="查看admin列表-【admin账号】-分页查询"><a href="#查看admin列表-【admin账号】-分页查询" class="headerlink" title="查看admin列表 【admin账号】(分页查询)"></a>查看admin列表 【admin账号】(分页查询)</h3><pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
 @Override
    public GraceJSONResult getAdminList(Integer page, Integer pageSize) &#123;
        if (page == null)&#123;
            page = COMMON_START_PAGE;
        &#125;
        if (pageSize == null)&#123;//由于是固定数值 可以去basecontroller加一下
            pageSize = COMMON_PAGE_SIZE;
        &#125;
        adminUserService.queryAdminList(page, pageSize);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/AdminUserService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;

public interface AdminUserService &#123;
    /**
     * 获得管理员的用户信息
     * @param username
     * @return
     */
    public AdminUser queryAdminByUsername(String username);

    /**
     * 新增管理员
     *
     * @param newAdminBO
     */
    public void createAdminUser(NewAdminBO newAdminBO);


    /**
     * 分页查询admin列表
     * @param page
     * @param pageSize
     */
    public void queryAdminList(Integer page, Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/AdminUserServiceImpl.java
@Override
    public void queryAdminList(Integer page, Integer pageSize) &#123;
        Example adminExample = new Example(AdminUser.class);
        adminExample.orderBy(&quot;createdTime&quot;).asc();
        PageHelper.startPage(page, pageSize);
        List&lt;AdminUser&gt; adminUserList = adminUserMapper.selectByExample(adminExample);
        System.out.println(adminUserList);
    &#125; //下面一节会有改动
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/Swagger2.java
package com.imooc.api.config;

import com.google.common.base.Predicate;
import com.google.common.base.Predicates;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.RequestHandler;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

@Configuration //Springboot啓動的時候會被掃描到并且加載
@EnableSwagger2
public class Swagger2 &#123;

    //    http://localhost:8088/swagger-ui.html     原路径
    //    http://localhost:8088/doc.html            新路径

    // 配置swagger2核心配置 docket
    @Bean
    public Docket createRestApi() &#123;
        Predicate&lt;RequestHandler&gt; adminPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.admin.controller&quot;);
//        Predicate&lt;RequestHandler&gt; articlePredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.article.controller&quot;);
        Predicate&lt;RequestHandler&gt; userPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.user.controller&quot;);
        Predicate&lt;RequestHandler&gt; filesPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.files.controller&quot;);

        return new Docket(DocumentationType.SWAGGER_2)  // 指定api类型为swagger2
                .apiInfo(apiInfo())                 // 用于定义api文档汇总信息
                .select()
                .apis(Predicates.or(userPredicate, adminPredicate, filesPredicate))
//                .apis(Predicates.or(adminPredicate, articlePredicate, userPredicate, filesPredicate))
                .paths(PathSelectors.any())         // 所有controller
                .build();
    &#125;

    private ApiInfo apiInfo() &#123;
        return new ApiInfoBuilder()
                .title(&quot;慕课新闻·自媒体接口api&quot;)                       // 文档页标题
                .contact(new Contact(&quot;imooc&quot;,
                        &quot;https://www.imooc.com&quot;,
                        &quot;abc@imooc.com&quot;))                   // 联系人信息
                .description(&quot;专为慕课新闻·自媒体平台提供的api文档&quot;)      // 详细信息
                .version(&quot;1.0.1&quot;)                               // 文档版本号
                .termsOfServiceUrl(&quot;https://www.imooc.com&quot;)     // 网站地址
                .build();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/admin/AdminMngControllerApi.java
package com.imooc.api.controller.admin;


import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;管理员admin维护&quot;,tags = &#123;&quot;管理员admin维护的Controller&quot;&#125;)
@RequestMapping(&quot;adminMng&quot;)
public interface AdminMngControllerApi &#123;
    @ApiOperation(value = &quot;hello方法的接口&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminLogin&quot;)
    public GraceJSONResult adminLogin(@RequestBody AdminLoginBO adminLoginBO,
                                      HttpServletRequest request,
                                      HttpServletResponse response);

    @ApiOperation(value = &quot;查询admin用户名是否存在&quot;,notes = &quot;查询admin用户名是否存在&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminIsExist&quot;)
    public GraceJSONResult adminLogin(@RequestParam String username); //传回来

    @ApiOperation(value = &quot;创建admin&quot;,notes = &quot;创建admin&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/addNewAdmin&quot;)
    public GraceJSONResult addNewAdmin(@RequestBody NewAdminBO newAdminBO,HttpServletRequest request,HttpServletResponse response);

    @ApiOperation(value = &quot;查询admin列表&quot;,notes = &quot;查询admin列表&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAdminList&quot;)
    public GraceJSONResult getAdminList(@ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;,  required = false) @RequestParam Integer page,
                                        @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页查询每一页显示的条数&quot;, required = false) @RequestParam Integer pageSize);
&#125;

-----------------------------------------------------------------
http://admin.imoocnews.com:8005/doc.html
</code></pre>
<h3 id="封装PagedGridResult分页数据-调试分页接口-【admin账号】"><a href="#封装PagedGridResult分页数据-调试分页接口-【admin账号】" class="headerlink" title="封装PagedGridResult分页数据_调试分页接口 【admin账号】"></a><span style = "color:red">封装<del>PagedGridResult</del></span>分页数据_调试分页接口 【admin账号】</h3><pre><code class="java">service-admin  com/imooc/admin/service/impl/AdminUserServiceImpl.java
    @Override
    public PagedGridResult queryAdminList(Integer page, Integer pageSize) &#123;
        Example adminExample = new Example(AdminUser.class);
        adminExample.orderBy(&quot;createdTime&quot;).asc();
        PageHelper.startPage(page, pageSize);
        List&lt;AdminUser&gt; adminUserList = adminUserMapper.selectByExample(adminExample);
        return setterPagedGrid(adminUserList, page);
    &#125;

    private PagedGridResult setterPagedGrid( List&lt;?&gt; adminUserList, Integer page)&#123; //类型是? 后期不确定是什么泛型
        PageInfo&lt;?&gt; pageList = new PageInfo&lt;&gt;(adminUserList);
        PagedGridResult gridResult = new PagedGridResult();
        gridResult.setRows(adminUserList);
        gridResult.setPage(page);
        gridResult.setRecords(pageList.getPages());
        gridResult.setTotal(pageList.getTotal());
        return gridResult;

    &#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/AdminUserService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.utils.PagedGridResult;

public interface AdminUserService &#123;
    /**
     * 获得管理员的用户信息
     * @param username
     * @return
     */
    public AdminUser queryAdminByUsername(String username);

    /**
     * 新增管理员
     *
     * @param newAdminBO
     */
    public void createAdminUser(NewAdminBO newAdminBO);


    /**
     * 分页查询admin列表
     * @param page
     * @param pageSize
     */
    public PagedGridResult queryAdminList(Integer page, Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">dev-common  com/imooc/utils/PagedGridResult.java
package com.imooc.utils;

import java.util.List;

/**
 * 
 * @Title: PagedGridResult.java
 * @Package com.imooc.utils
 * @Description: 用来返回分页Grid的数据格式
 * Copyright: Copyright (c) 2019
 */
public class PagedGridResult &#123;
    
    private int page;            // 当前页数
    private long total;            // 总页数
    private long records;        // 总记录数
    private List&lt;?&gt; rows;        // 每行显示的内容
&#125;Getter + Setter
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
//拦截器新增地址
package com.imooc.api.config;

import com.imooc.api.interceptors.AdminTokenInterceptor;
import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UserActiveInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UserActiveInterceptor userActiveInterceptor() &#123;
        return new UserActiveInterceptor();
    &#125;

    @Bean
    public AdminTokenInterceptor adminTokenInterceptor() &#123;
        return new AdminTokenInterceptor();
    &#125;


    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;)
                .addPathPatterns(&quot;/fs/uploadFace&quot;);
        registry.addInterceptor(adminTokenInterceptor())//继续添加拦截器：查询admin列表 创建新admin用户
                .addPathPatterns(&quot;/adminMng/adminIsExist&quot;)
                .addPathPatterns(&quot;/adminMng/addNewAdmin&quot;)
                .addPathPatterns(&quot;/adminMng/getAdminList&quot;);

    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/interceptors/AdminTokenInterceptor.java
package com.imooc.api.interceptors;

import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import static com.imooc.api.BaseController.REDIS_ADMIN_TOKEN;

public class AdminTokenInterceptor extends BaseInterceptor implements HandlerInterceptor &#123;

    /**
     * 拦截请求，在访问controller调用之前
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;

        String adminUserId = request.getHeader(&quot;adminUserId&quot;);
        String adminUserToken = request.getHeader(&quot;adminUserToken&quot;);

        System.out.println(&quot;=====================================================================&quot;);
        System.out.println(&quot;AdminTokenInterceptor - adminUserId = &quot; + adminUserId);
        System.out.println(&quot;AdminTokenInterceptor - adminUserToken = &quot; + adminUserToken);
        System.out.println(&quot;=====================================================================&quot;);

        boolean run = verifyUserIdToken(adminUserId, adminUserToken, REDIS_ADMIN_TOKEN);
        return run;
    &#125;

    /**
     * 请求访问controller之后，渲染视图之前
     * @param request
     * @param response
     * @param handler
     * @param modelAndView
     * @throws Exception
     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;

    &#125;

    /**
     * 请求访问controller之后，渲染视图之后
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;

    &#125;
&#125;
</code></pre>
<h3 id="账号注销-【admin账号】-删掉redis和cookie数据"><a href="#账号注销-【admin账号】-删掉redis和cookie数据" class="headerlink" title="账号注销 【admin账号】(删掉redis和cookie数据)"></a>账号注销 【admin账号】(删掉redis和cookie数据)</h3><pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
package com.imooc.admin.controller;

import com.imooc.admin.service.AdminUserService;
import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.AdminMngControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.enums.FaceVerifyType;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.utils.FaceVerifyUtils;
import com.imooc.utils.PagedGridResult;
import com.imooc.utils.RedisOperator;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.kafka.KafkaProperties;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.UUID;

@RestController
public class AdminMngController extends BaseController implements AdminMngControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(AdminMngController.class);

    @Autowired
    private RedisOperator redis;

    @Autowired
    private AdminUserService adminUserService;

    @Autowired
    private FaceVerifyUtils faceVerifyUtils;

    @Override
    public GraceJSONResult adminLogin(AdminLoginBO adminLoginBO,
                                      HttpServletRequest request,
                                      HttpServletResponse response) &#123;
        // 0. TODO 验证BO中的用户名和密码不为空

        // 1. 查询admin用户的信息
        AdminUser admin = adminUserService.queryAdminByUsername(adminLoginBO.getUsername());
        // 2. 判断admin不为空，如果为空则登录失败
        if (admin == null) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_NOT_EXIT_ERROR);
        &#125;

        // 3. 判断密码是否匹配
        boolean isPwdMatch = BCrypt.checkpw(adminLoginBO.getPassword(), admin.getPassword());
        if (isPwdMatch) &#123;
            doLoginSettings(admin, request, response);
            return GraceJSONResult.ok();
        &#125; else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_NOT_EXIT_ERROR);
        &#125;
    &#125;


    /**
     * 用于admin用户登录过后的基本信息设置
     * @param admin
     * @param request
     * @param response
     */
    private void doLoginSettings(AdminUser admin,
                                 HttpServletRequest request,
                                 HttpServletResponse response) &#123;
        // 保存token放入到redis中
        String token = UUID.randomUUID().toString();
        redis.set(REDIS_ADMIN_TOKEN + &quot;:&quot; + admin.getId(), token);

        // 保存admin登录基本token信息到cookie中
        setCookie(request, response, &quot;atoken&quot;, token, COOKIE_MONTH);
        setCookie(request, response, &quot;aid&quot;, admin.getId(), COOKIE_MONTH);
        setCookie(request, response, &quot;aname&quot;, admin.getAdminName(), COOKIE_MONTH);
    &#125;

    @Override
    public GraceJSONResult adminIsExist(String username) &#123;
        checkAdminExist(username);
        return GraceJSONResult.ok();
    &#125;

    private void checkAdminExist(String username) &#123;
        AdminUser admin = adminUserService.queryAdminByUsername(username);

        if (admin != null) &#123;
            GraceException.display(ResponseStatusEnum.ADMIN_USERNAME_EXIST_ERROR);
        &#125;
    &#125;

    @Override
    public GraceJSONResult addNewAdmin(NewAdminBO newAdminBO,
                                       HttpServletRequest request,
                                       HttpServletResponse response) &#123;

        // 0. TODO 验证BO中的用户名和密码不为空

        // 1. base64不为空，则代表人脸入库，否则需要用户输入密码和确认密码
        if (StringUtils.isBlank(newAdminBO.getImg64())) &#123;
            if (StringUtils.isBlank(newAdminBO.getPassword()) ||
                    StringUtils.isBlank(newAdminBO.getConfirmPassword())
            ) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_PASSWORD_NULL_ERROR);
            &#125;
        &#125;

        // 2. 密码不为空，则必须判断两次输入一致
        if (StringUtils.isNotBlank(newAdminBO.getPassword())) &#123;
            if (!newAdminBO.getPassword()
                    .equalsIgnoreCase(newAdminBO.getConfirmPassword())) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_PASSWORD_ERROR);
            &#125;
        &#125;

        // 3. 校验用户名唯一
        checkAdminExist(newAdminBO.getUsername());

        // 4. 调用service存入admin信息
        adminUserService.createAdminUser(newAdminBO);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult getAdminList(Integer page, Integer pageSize) &#123;

        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult result = adminUserService.queryAdminList(page, pageSize);
        return GraceJSONResult.ok(result);
    &#125;

    @Override
    public GraceJSONResult adminLogout(String adminId,
                                       HttpServletRequest request,
                                       HttpServletResponse response) &#123;

        // 从redis中删除admin的会话token
        redis.del(REDIS_ADMIN_TOKEN + &quot;:&quot; + adminId);

        // 从cookie中清理adming登录的相关信息
        deleteCookie(request, response, &quot;atoken&quot;);
        deleteCookie(request, response, &quot;aid&quot;);
        deleteCookie(request, response, &quot;aname&quot;);

        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/admin/AdminMngControllerApi.java
package com.imooc.api.controller.admin;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;管理员admin维护&quot;, tags = &#123;&quot;管理员admin维护的controller&quot;&#125;)
@RequestMapping(&quot;adminMng&quot;)
public interface AdminMngControllerApi &#123;

    @ApiOperation(value = &quot;hello方法的接口&quot;, notes = &quot;hello方法的接口&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminLogin&quot;)
    public GraceJSONResult adminLogin(@RequestBody AdminLoginBO adminLoginBO,
                                      HttpServletRequest request,
                                      HttpServletResponse response);

    @ApiOperation(value = &quot;查询admin用户名是否存在&quot;, notes = &quot;查询admin用户名是否存在&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminIsExist&quot;)
    public GraceJSONResult adminIsExist(@RequestParam String username);

    @ApiOperation(value = &quot;创建admin&quot;, notes = &quot;创建admin&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/addNewAdmin&quot;)
    public GraceJSONResult addNewAdmin(@RequestBody NewAdminBO newAdminBO,
                                       HttpServletRequest request,
                                       HttpServletResponse response);

    @ApiOperation(value = &quot;查询admin列表&quot;, notes = &quot;查询admin列表&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAdminList&quot;)
    public GraceJSONResult getAdminList(
            @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
            @RequestParam Integer page,
            @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页查询每一页显示的条数&quot;, required = false)
            @RequestParam Integer pageSize);

    @ApiOperation(value = &quot;admin退出登录&quot;, notes = &quot;admin退出登录&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminLogout&quot;)
    public GraceJSONResult adminLogout(@RequestParam String adminId,
                                       HttpServletRequest request,
                                       HttpServletResponse response);
                                        HttpServletResponse response);
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java
public void setCookieValue(HttpServletRequest request,
                               HttpServletResponse response,
                               String cookieName,
                               String cookieValue,
                               Integer maxAge) &#123;
        Cookie cookie = new Cookie(cookieName, cookieValue);
        cookie.setMaxAge(maxAge);
//        cookie.setDomain(&quot;imoocnews.com&quot;);
        cookie.setDomain(DOMAIN_NAME);
        cookie.setPath(&quot;/&quot;);//都用cookie
        response.addCookie(cookie);//把cookie传入
    &#125;

    public void deleteCookie(HttpServletRequest request,HttpServletResponse response,String cookieName)&#123;
        try &#123;
            String deleteValue = URLEncoder.encode(&quot;&quot;, &quot;utf-8&quot;);
            setCookieValue(request, response, cookieName, deleteValue, COOKIE_DELETE);
        &#125; catch (UnsupportedEncodingException e) &#123;
            throw new RuntimeException(e);
        &#125;
    &#125;
</code></pre>
<h3 id="人脸业务流程图梳理"><a href="#人脸业务流程图梳理" class="headerlink" title="人脸业务流程图梳理"></a>人脸业务流程图梳理</h3><p><img src="https://raw.githubusercontent.com/P-luminary/images/fa7fae40efa428b638a2589c3203204ff0479b04/data/%E4%BA%BA%E8%84%B8%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png"></p>
<h3 id="Chrome开启视频调试模式"><a href="#Chrome开启视频调试模式" class="headerlink" title="Chrome开启视频调试模式"></a>Chrome开启视频调试模式</h3><blockquote>
<p>在谷歌浏览器中打开【每一次重启电脑都要操作】<br>chrome:&#x2F;&#x2F;flags&#x2F;#unsafely-treat-insecure-origin-as-secure<br>|————————————————————————————————|<br>|  <a href="http://admin.imoocnews.com:9090,http://admin.imoocnews.com">http://admin.imoocnews.com:9090,http://admin.imoocnews.com</a> |<br>|—— ——————————————————————————————|<br><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html">http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html</a><br>可以获取人脸</p>
</blockquote>
<h3 id="MongoDB概念-人脸数据存储-可以存储JSON数据"><a href="#MongoDB概念-人脸数据存储-可以存储JSON数据" class="headerlink" title="MongoDB概念 [人脸数据存储]可以存储JSON数据"></a>MongoDB概念 [人脸数据存储]<del>可以存储JSON数据</del></h3><ul>
<li>NoSql 数据库</li>
<li>内存级别查询</li>
<li>不支持事务</li>
<li>非并发读写 请求并发数据量大</li>
<li>GridFS 小文件存储</li>
</ul>
<h4 id="MongoDB术语"><a href="#MongoDB术语" class="headerlink" title="MongoDB术语"></a>MongoDB术语</h4><table>
<thead>
<tr>
<th align="center">数据库</th>
<th align="center">ElasticSearch</th>
<th align="center">MongoDB</th>
</tr>
</thead>
<tbody><tr>
<td align="center">database</td>
<td align="center">es库</td>
<td align="center">database</td>
</tr>
<tr>
<td align="center">table表</td>
<td align="center">index索引</td>
<td align="center">collection数据集合</td>
</tr>
<tr>
<td align="center">row行 (记录)</td>
<td align="center">document文档 (json)</td>
<td align="center">document文档 (json)</td>
</tr>
<tr>
<td align="center">column 字段列</td>
<td align="center">field域</td>
<td align="center">field域</td>
</tr>
<tr>
<td align="center">index索引</td>
<td align="center">-</td>
<td align="center">index索引</td>
</tr>
<tr>
<td align="center">join表关联查询</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">pk主键</td>
<td align="center">_id</td>
<td align="center">_id</td>
</tr>
</tbody></table>
<h5 id="MongoDB数据结构"><a href="#MongoDB数据结构" class="headerlink" title="MongoDB数据结构"></a>MongoDB数据结构</h5><pre><code class="vue">UserList:[
    &#123;
        userId: &quot;1001&quot;,
        username: &quot;lee&quot;,
        age: 18
    &#125;,
    &#123;
        userId: &quot;1002&quot;,
        username: &quot;jay&quot;,
        age: 20,
        sex: &quot;boy&quot;
    &#125;
]

----------------------------------------------------------

UserList --&gt;   collection
&#123;&#125;       --&gt;   document
属性        --&gt;   column
</code></pre>
<h3 id="MogoDB安装与配置使用"><a href="#MogoDB安装与配置使用" class="headerlink" title="MogoDB安装与配置使用"></a>MogoDB安装与配置使用</h3><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/enterprise">https://www.mongodb.com/try/download/enterprise</a></p>
<pre><code class="mysql">将mongodb-linux-x86_64-rhel70-4.2.8传入虚拟机
[imooc@imooc ~]$ tar -zxvf mongodb-linux-x86_64-rhel70-4.2.8.tgz 
[imooc@imooc ~]$ sudo mv mongodb-linux-x86_64-rhel70-4.2.8 /usr/local/mongodb
[imooc@imooc ~]$ cd /usr/local/
[imooc@imooc local]$ ll
drwxrwxr-x. 3 imooc imooc      135 7月  16 19:46 mongodb
[imooc@imooc local]$ cd mongodb/
[imooc@imooc mongodb]$ ll
总用量 312
drwxrwxr-x. 2 imooc imooc    231 7月  16 19:46 bin
-rw-r--r--. 1 imooc imooc  30608 6月  12 2020 LICENSE-Community.txt
-rw-r--r--. 1 imooc imooc  16726 6月  12 2020 MPL-2
-rw-r--r--. 1 imooc imooc   2617 6月  12 2020 README
-rw-r--r--. 1 imooc imooc  75405 6月  12 2020 THIRD-PARTY-NOTICES
-rw-r--r--. 1 imooc imooc 183512 6月  12 2020 THIRD-PARTY-NOTICES.gotools
[imooc@imooc mongodb]$ cd bin/
[imooc@imooc bin]$ pwd
/usr/local/mongodb/bin

[imooc@imooc bin]$ sudo vim /etc/profile
最下面添加：
export JAVA_HOME=/usr/java/jdk1.8.0_222-ea
export CLASSPATH=.:%JAVA_HOME%/lib/dt.jar:%JAVA_HOME%/lib/tools.jar
export PATH=$PATH:$JAVA_HOME/bin
#set mogodb config
export PATH=/usr/local/mongodb/bin:$PATH

#修改 /etc/profile 文件后，需要重新加载这个文件才能使新配置生效。你可以执行以下命令：
[imooc@imooc bin]$ source /etc/profile

[imooc@imooc bin]$ mongo --version
MongoDB shell version v4.2.8
git version: 43d25964249164d76d5e04dd6cf38f6111e21f5f
OpenSSL version: OpenSSL 1.0.1e-fips 11 Feb 2013
allocator: tcmalloc
modules: none
build environment:
    distmod: rhel70
    distarch: x86_64
    target_arch: x86_64

[imooc@imooc bin]$ cd /usr/local/mongodb/
[imooc@imooc mongodb]$ pwd
/usr/local/mongodb

#创建数据存储目录
[imooc@imooc mongodb]$ mkdir data/db -p #出来一个data
[imooc@imooc mongodb]$ ll
总用量 312
drwxrwxr-x. 2 imooc imooc    231 7月  16 19:46 bin
drwxrwxr-x. 3 imooc imooc     16 7月  16 20:00 data
[imooc@imooc mongodb]$ cd data
[imooc@imooc data]$ ll
总用量 0
drwxrwxr-x. 2 imooc imooc 6 7月  16 20:00 db
[imooc@imooc data]$ mkdir logs
[imooc@imooc data]$ ll
总用量 0
drwxrwxr-x. 2 imooc imooc 6 7月  16 20:00 db
drwxrwxr-x. 2 imooc imooc 6 7月  16 20:00 logs
[imooc@imooc data]$ cd logs/
[imooc@imooc logs]$ pwd
/usr/local/mongodb/data/logs
[imooc@imooc logs]$ touch mongodb.log
[imooc@imooc logs]$ ll
总用量 0
-rw-rw-r--. 1 imooc imooc 0 7月  16 20:01 mongodb.log
[imooc@imooc logs]$ cd ..
[imooc@imooc logs]$ cd ..

[imooc@imooc mongodb]$ vim mongodb.conf
port=27017
# datasource path
dbpath=/user/local/mongodb/data/db
# log path
logpath=/usr/local/mongodb/data/logs/mongodb.log
# append log
logappend=true
# cut useless log
quiet=true
# back desktop auto run
fork=true
# Maxcontect
maxConns=100
# Not open Verify permissions
noauth=true
# open Verify permissions
# auth=true
# open log =&gt; true
journal=true
# clash
bind_ip=0.0.0.0

[imooc@imooc mongodb]$ sudo yum install net-snmp
 
#错误：软件包：1:net-snmp-agent-libs-5.7.2-49.el7_9.4.x86_64 (updates)
          需要：libmysqlclient.so.18(libmysqlclient_18)(64bit)
#错误：软件包：1:net-snmp-5.7.2-49.el7_9.4.x86_64 (updates)
          需要：libmysqlclient.so.18()(64bit)
#错误：软件包：1:net-snmp-agent-libs-5.7.2-49.el7_9.4.x86_64 (updates)
          需要：libmysqlclient.so.18()(64bit)
# cd /usr/local/mongodb/
[imooc@imooc mongodb]$ mongod -f mongodb.conf
about to fork child process, waiting until server is ready for connections.
forked process: 4989
child process started successfully, parent exiting

[imooc@imooc mongodb]$ ps aux | grep mongod
imooc      4989  1.8  4.2 1550916 78280 ?       Sl   20:39   0:00 mongod -f mongodb.conf
imooc      5105  0.0  0.0 112824   988 pts/0    S+   20:40   0:00 grep --color=auto mongod

[imooc@imooc mongodb]$ ps -ef|grep mongodb
imooc      4989      1  0 20:39 ?        00:00:02 mongod -f mongodb.conf
imooc      5201   2948  0 20:44 pts/0    00:00:00 grep --color=auto mongodb


尝试连接到 MongoDB 实例： 
[imooc@imooc mongodb]$ mongo --port 27017
</code></pre>
<h3 id="可视化管理工具【MongoDB】"><a href="#可视化管理工具【MongoDB】" class="headerlink" title="可视化管理工具【MongoDB】"></a>可视化管理工具【MongoDB】</h3><pre><code class="mysql">在Navicat里新建链接MongoDB
主机：192.168.170.135
右键新建数据库school → 集合 → 右键新建 左上角保存student
[imooc@imooc mongodb]$ vim mongodb.conf
##### 启用用户账号权限
# Not open Verify permissions
# noauth=true
# open Verify permissions
  auth=true
#重启服务
[imooc@imooc mongodb]$ ps -ef|grep mongodb
imooc      4989      1  0 20:39 ?        00:00:05 mongod -f mongodb.conf
imooc      5380   2948  0 20:54 pts/0    00:00:00 grep --color=auto mongodb
[imooc@imooc mongodb]$ kill -2 4989
[imooc@imooc mongodb]$ ps -ef|grep mongodb
imooc      5395   2948  0 20:54 pts/0    00:00:00 grep --color=auto mongodb
[imooc@imooc mongodb]$ mongod -f mongodb.conf
about to fork child process, waiting until server is ready for connections.
forked process: 5419
child process started successfully, parent exiting

[imooc@imooc mongodb]$ mongo
MongoDB shell version v4.2.8
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb
Implicit session: session &#123; &quot;id&quot; : UUID(&quot;c87ffbd9-69cd-4e29-badd-5b86a314f428&quot;) &#125;
MongoDB server version: 4.2.8
&gt; use admin
switched to db admin
&gt; db.createUser(&#123;user:&quot;root&quot;,pwd:&quot;root&quot;,roles:[&quot;root&quot;]&#125;)
Successfully added user: &#123; &quot;user&quot; : &quot;root&quot;, &quot;roles&quot; : [ &quot;root&quot; ] &#125;
&gt; db.auth(&quot;root&quot;,&quot;root&quot;)
1
&gt; show users
&#123;
    &quot;_id&quot; : &quot;admin.root&quot;,
    &quot;userId&quot; : UUID(&quot;2ced1f0a-8de4-4fab-9cb8-8e420fe9dcba&quot;),
    &quot;user&quot; : &quot;root&quot;,
    &quot;db&quot; : &quot;admin&quot;,
    &quot;roles&quot; : [
        &#123;
            &quot;role&quot; : &quot;root&quot;,
            &quot;db&quot; : &quot;admin&quot;
        &#125;
    ],
    &quot;mechanisms&quot; : [
        &quot;SCRAM-SHA-1&quot;,
        &quot;SCRAM-SHA-256&quot;
    ]
&#125;
&gt; 
#后面关闭连接 编辑数据库 新增密码登录 root root
</code></pre>
<h3 id="整合SpringBoot-【GridFS】"><a href="#整合SpringBoot-【GridFS】" class="headerlink" title="整合SpringBoot 【GridFS】"></a>整合SpringBoot 【GridFS】</h3><pre><code class="xml">&lt;!-- 引入 mongodb 依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
            &lt;artifactId&gt;mongodb-driver&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/files/FileUploadControllerApi.java
package com.imooc.api.controller.files;


import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

@Api(value = &quot;文件上传的controller&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
@RequestMapping(&quot;fs&quot;)
public interface FileUploadControllerApi &#123;
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadFace&quot;)
    public GraceJSONResult uploadFace(@RequestParam String userId, MultipartFile file) throws Exception;

    //不可以通过swagger2调用的
    /**
     * 文件上传到mongodb的gridfs中
     * @param newAdminBO
     * @return
     * @throws Exception
     */
    @PostMapping(&quot;/uploadToGridFS&quot;)
    public GraceJSONResult uploadToGridFS(@RequestBody NewAdminBO newAdminBO) throws Exception;
&#125;
</code></pre>
<pre><code class="yaml">service-files  application.yml
  data:
    mongodb:
      uri: mongodb://root:root@192.168.170.135:27017
      database: imooc-news
</code></pre>
<h3 id="实现人脸入库-【GridFS】"><a href="#实现人脸入库-【GridFS】" class="headerlink" title="实现人脸入库 【GridFS】"></a>实现人脸入库 【GridFS】</h3><pre><code class="java">service-files  com/imooc/files/controller/FileUploadController.java

...
 @Autowired
    private GridFSBucket gridFSBucket;
...

 @Override
    public GraceJSONResult uploadToGridFS(NewAdminBO newAdminBO) throws Exception &#123;
        // 获得图片的base64字符串
        String file64 = newAdminBO.getImg64();
        // 将base64字符串转换为byte数组
        byte[] bytes = new BASE64Decoder().decodeBuffer(file64.trim());
        // 转换为输入流
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);
        //上传到gridfs中
        ObjectId fileId = gridFSBucket.uploadFromStream(newAdminBO.getUsername() + &quot;.png&quot;, inputStream);
        // 获取文件在gridfs中的主键id
        String fileIdStr = fileId.toString();
        // 下次提交的时候会提交到后端
        return GraceJSONResult.ok(fileIdStr);
    &#125;

http://admin.imoocnews.com:9090/imooc-news/admin/adminMng.html
注册并且提交人脸信息
去Navicat → MongoDB → imooc-news → GridFS存储桶 → fs → admin456.png
</code></pre>
<pre><code class="java">service-files  com/imooc/files/controller/FileUploadController.java
...
    @Override
    public GraceJSONResult uploadToGridFS(NewAdminBO newAdminBO) throws Exception &#123;
        // 获得图片的base64字符串
        String file64 = newAdminBO.getImg64();
        // 将base64字符串转换为byte数组
        byte[] bytes = new BASE64Decoder().decodeBuffer(file64.trim());
        // 转换为输入流
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);
        //上传到gridfs中
        ObjectId fileId = gridFSBucket.uploadFromStream(newAdminBO.getUsername() + &quot;.png&quot;, inputStream);
        // 获取文件在gridfs中的主键id
        String fileIdStr = fileId.toString();
        // 下次提交的时候会提交到后端
        return GraceJSONResult.ok(fileIdStr);
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/files/FileUploadControllerApi.java
package com.imooc.api.controller.files;


import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

@Api(value = &quot;文件上传的controller&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
@RequestMapping(&quot;fs&quot;)
public interface FileUploadControllerApi &#123;
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadFace&quot;)
    public GraceJSONResult uploadFace(@RequestParam String userId, MultipartFile file) throws Exception;

    //不可以通过swagger2调用的

    /**
     * 文件上传到mongodb的gridfs中
     * @param newAdminBO
     * @return
     * @throws Exception
     */
    @PostMapping(&quot;/uploadToGridFS&quot;)
    public GraceJSONResult uploadToGridFS(@RequestBody NewAdminBO newAdminBO) throws Exception;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/GridFSConfig.java
package com.imooc.files;

import com.mongodb.MongoClient;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.gridfs.GridFSBucket;
import com.mongodb.client.gridfs.GridFSBuckets;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.stereotype.Component;

@Component //可以被容器访问到
public class GridFSConfig &#123;
    @Value(&quot;$&#123;spring.data.mongodb.database&#125;&quot;)
    private String mongodb;

    @Bean
    public GridFSBucket gridFSBucket(MongoClient mongoClient)&#123;
        MongoDatabase mongoDatabase = mongoClient.getDatabase(mongodb);
        GridFSBucket bucket = GridFSBuckets.create(mongoDatabase);//存入mongodatabase
        return bucket;
    &#125;
&#125;
</code></pre>
<h3 id="查看admin人脸信息-【GridFS】"><a href="#查看admin人脸信息-【GridFS】" class="headerlink" title="查看admin人脸信息 【GridFS】"></a>查看admin人脸信息 【GridFS】</h3><pre><code class="java">service-files  com/imooc/files/controller/FileUploaderController.java
 @Override
    public GraceJSONResult uploadToGridFS(NewAdminBO newAdminBO)
            throws Exception &#123;

        // 获得图片的base64字符串
        String file64 = newAdminBO.getImg64();

        // 将base64字符串转换为byte数组
        byte[] bytes = new BASE64Decoder().decodeBuffer(file64.trim());

        // 转换为输入流
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);

        // 上传到gridfs中
        ObjectId fileId = gridFSBucket.uploadFromStream(newAdminBO.getUsername() + &quot;.png&quot;, inputStream);

        // 获得文件在gridfs中的主键id
        String fileIdStr = fileId.toString();

        return GraceJSONResult.ok(fileIdStr);
    &#125;

    @Override
    public void readInGridFS(String faceId,
                             HttpServletRequest request,
                             HttpServletResponse response) throws Exception &#123;

        // 0. 判断参数
        if (StringUtils.isBlank(faceId) || faceId.equalsIgnoreCase(&quot;null&quot;)) &#123;
            GraceException.display(ResponseStatusEnum.FILE_NOT_EXIST_ERROR);
        &#125;

        // 1. 从gridfs中读取
        File adminFace = readGridFSByFaceId(faceId);

        // 2. 把人脸图片输出到浏览器
        FileUtils.downloadFileByStream(response, adminFace);
    &#125;

    private File readGridFSByFaceId(String faceId) throws Exception &#123;

        GridFSFindIterable gridFSFiles
                = gridFSBucket.find(Filters.eq(&quot;_id&quot;, new ObjectId(faceId)));

        GridFSFile gridFS = gridFSFiles.first();

        if (gridFS == null) &#123;
            GraceException.display(ResponseStatusEnum.FILE_NOT_EXIST_ERROR);
        &#125;

        String fileName = gridFS.getFilename();
        System.out.println(fileName);

        // 获取文件流，保存文件到本地或者服务器的临时目录
        File fileTemp = new File(&quot;/workspace/temp_face&quot;);
        if (!fileTemp.exists()) &#123;
            fileTemp.mkdirs();
        &#125;

        File myFile = new File(&quot;/workspace/temp_face/&quot; + fileName);

        // 创建文件输出流
        OutputStream os = new FileOutputStream(myFile);
        // 下载到服务器或者本地
        gridFSBucket.downloadToStream(new ObjectId(faceId), os);

        return myFile;
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/files/FileUploaderControllerApi.java
package com.imooc.api.controller.files;


import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;文件上传的controller&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
@RequestMapping(&quot;fs&quot;)
public interface FileUploaderControllerApi &#123;
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadFace&quot;)
    public GraceJSONResult uploadFace(@RequestParam String userId, MultipartFile file) throws Exception;

    //不可以通过swagger2调用的

    /**
     * 文件上传到mongodb的gridfs中
     * @param newAdminBO
     * @return
     * @throws Exception
     */
    @PostMapping(&quot;/uploadToGridFS&quot;)
    public GraceJSONResult uploadToGridFS(@RequestBody NewAdminBO newAdminBO) throws Exception;

    @GetMapping(&quot;/readInGridFS&quot;)
    public void readInGridFS(String faceId, HttpServletRequest request, HttpServletResponse response) throws Exception;
&#125;

//AdminCookieToken也可以获得faceId
</code></pre>
<h3 id="阿里AI人脸识别介绍"><a href="#阿里AI人脸识别介绍" class="headerlink" title="阿里AI人脸识别介绍"></a>阿里AI人脸识别介绍</h3><p><a target="_blank" rel="noopener" href="https://vision.aliyun.com/facebody?spm=5176.21213303.J_qCOwPWspKEuWcmp8qiZNQ.20.f1892f3dvI78tU&scm=20140722.S_card@@%E5%95%86%E5%93%81@@143873.S_card0.ID_card@@%E5%95%86%E5%93%81@@143873-RL_%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB-LOC_search~UND~card~UND~item-OR_ser-V_3-RE_cardOld-P0_0">人脸人体-阿里云视觉智能开放平台 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://vision.console.aliyun.com/cn-shanghai/detail/facebody?spm=5176.6660585.viapi_facebody_public_cn-top.i0.7bbf7992dXgogs">视觉智能开放平台-控制台 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://vision.aliyun.com/experience/detail?tagName=facebody&children=CompareFace">能力展示-阿里云视觉智能开放平台 (aliyun.com)</a></p>
<h3 id="获得人脸faceId【人脸登录】"><a href="#获得人脸faceId【人脸登录】" class="headerlink" title="获得人脸faceId【人脸登录】"></a>获得人脸faceId【人脸登录】</h3><pre><code class="java">service-api  com/imooc/api/controller/admin/AdminMngControllerApi.java
@ApiOperation(value = &quot;admin管理员的人脸登录&quot;, notes = &quot;admin管理员的人脸登录&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/adminFaceLogin&quot;)
    public GraceJSONResult adminFaceLogin(@RequestBody AdminLoginBO adminLoginBO,
                                          HttpServletRequest request,
                                          HttpServletResponse response);
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
 @Override
    public GraceJSONResult adminFaceLogin(AdminLoginBO adminLoginBO, HttpServletRequest request, HttpServletResponse response) &#123;
        // 0. 判断用户名和人脸信息不能为空
        if(StringUtils.isBlank(adminLoginBO.getUsername()))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_USERNAME_NULL_ERROR);
        &#125;
        String tempFace64 = adminLoginBO.getImg64();
        if (StringUtils.isBlank(tempFace64))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_NULL_ERROR);
        &#125;
        // 1. 从数据库中查询出faceId
        AdminUser admin = adminUserService.queryAdminByUsername(adminLoginBO.getUsername());
        String adminFaceId = admin.getFaceId();
        if (StringUtils.isBlank(adminFaceId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_NULL_ERROR);
        &#125;
        // 2. 请求文件服务，获得人懒数据的base64数据

        // 3. 调用阿里ai进行人脸对比识别，判断可信度，从而实现人脸登录

        // 4. admin登录后的数据设置，redis与cookie

        return null;
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/files/FileUploaderControllerApi.java
package com.imooc.api.controller.files;


import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.NewAdminBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;文件上传的controller&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
@RequestMapping(&quot;fs&quot;)
public interface FileUploaderControllerApi &#123;
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;hello方法的接口&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadFace&quot;)
    public GraceJSONResult uploadFace(@RequestParam String userId, MultipartFile file) throws Exception;

    //不可以通过swagger2调用的

    /**
     * 文件上传到mongodb的gridfs中
     * @param newAdminBO
     * @return
     * @throws Exception
     */
    @PostMapping(&quot;/uploadToGridFS&quot;)
    public GraceJSONResult uploadToGridFS(@RequestBody NewAdminBO newAdminBO) throws Exception;

    @GetMapping(&quot;/readInGridFS&quot;)
    public void readInGridFS(String faceId, HttpServletRequest request, HttpServletResponse response) throws Exception;

    /**
     * 从gridfs中读取图片内容 返回base64数据
     * @param faceId
     * @param request
     * @param response
     * @return
     * @throws Exception
     */
    @GetMapping(&quot;/readFace64InGridFS&quot;)
    public GraceJSONResult readFace64InGridFS(String faceId, HttpServletRequest request, HttpServletResponse response) throws Exception;
&#125;
</code></pre>
<pre><code class="java">service-files  com/imooc/files/controller/FileUploaderController.java
@Override
    public GraceJSONResult readFace64InGridFS(String faceId, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;
        // 0. 获得gridfs中人脸文件
        File myface = readGridFSByFaceId(faceId);

        // 1. 转换人脸为base64
        String base64Face = FileUtils.fileToBase64(myface);
        return GraceJSONResult.ok(base64Face);
    &#125;
</code></pre>
<h3 id="整合RestTemplate服务通信-【人脸登录】"><a href="#整合RestTemplate服务通信-【人脸登录】" class="headerlink" title="整合RestTemplate服务通信 【人脸登录】"></a>整合RestTemplate服务通信 【人脸登录】</h3><pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
@RestController
public class AdminMngController extends BaseController implements AdminMngControllerApi &#123;

@Autowired
    private RestTemplate restTemplate;

@Override
    public GraceJSONResult adminFaceLogin(AdminLoginBO adminLoginBO, HttpServletRequest request, HttpServletResponse response) &#123;
        // 0. 判断用户名和人脸信息不能为空
        if(StringUtils.isBlank(adminLoginBO.getUsername()))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_USERNAME_NULL_ERROR);
        &#125;
        String tempFace64 = adminLoginBO.getImg64();
        if (StringUtils.isBlank(tempFace64))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_NULL_ERROR);
        &#125;
        // 1. 从数据库中查询出faceId
        AdminUser admin = adminUserService.queryAdminByUsername(adminLoginBO.getUsername());
        String adminFaceId = admin.getFaceId();
        if (StringUtils.isBlank(adminFaceId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_NULL_ERROR);
        &#125;
        // 2. 请求文件服务，获得人懒数据的base64数据
        String fileServerUrlExecute = &quot;http://files.imoocnews.com:8004/fs/readFace64InGridFS?faceId=&quot; + adminFaceId;
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity = restTemplate.getForEntity(fileServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        String base64DB = (String)bodyResult.getData();
        // 3. 调用阿里ai进行人脸对比识别，判断可信度，从而实现人脸登录

        // 4. admin登录后的数据设置，redis与cookie

        return null;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/CloudConfig.java
package com.imooc.api.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.OkHttp3ClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class CloudConfig &#123;

    public CloudConfig() &#123;
    &#125;

    /**
     * 会基于OKHttp3的配置来实例RestTemplate
     * @return
     */
    @Bean
    public RestTemplate restTemplate() &#123;

        return new RestTemplate(new OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;
</code></pre>
<h3 id="实现人脸对比进行登录【人脸对比】没买人脸识别服务-简单写了一下"><a href="#实现人脸对比进行登录【人脸对比】没买人脸识别服务-简单写了一下" class="headerlink" title="实现人脸对比进行登录【人脸对比】没买人脸识别服务,简单写了一下"></a>实现人脸对比进行登录【人脸对比】<del>没买人脸识别服务,简单写了一下</del></h3><pre><code class="java">service-admin  com/imooc/admin/controller/AdminMngController.java
@Override
    public GraceJSONResult adminFaceLogin(AdminLoginBO adminLoginBO, HttpServletRequest request, HttpServletResponse response) &#123;
        // 0. 判断用户名和人脸信息不能为空
        if(StringUtils.isBlank(adminLoginBO.getUsername()))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_USERNAME_NULL_ERROR);
        &#125;
        String tempFace64 = adminLoginBO.getImg64();
        if (StringUtils.isBlank(tempFace64))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_NULL_ERROR);
        &#125;
        // 1. 从数据库中查询出faceId
        AdminUser admin = adminUserService.queryAdminByUsername(adminLoginBO.getUsername());
        String adminFaceId = admin.getFaceId();
        if (StringUtils.isBlank(adminFaceId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_NULL_ERROR);
        &#125;
        // 2. 请求文件服务，获得人懒数据的base64数据
        String fileServerUrlExecute = &quot;http://files.imoocnews.com:8004/fs/readFace64InGridFS?faceId=&quot; + adminFaceId;
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity = restTemplate.getForEntity(fileServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        String base64DB = (String)bodyResult.getData();
        // 3. 调用阿里ai进行人脸对比识别，判断可信度，从而实现人脸登录
        boolean result = faceVerifyUtils.faceVerify(FaceVerifyType.BASE64.type,
                tempFace64,
                base64DB,
                60);
        if (!result)&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ADMIN_FACE_LOGIN_ERROR);
        &#125;
        // 4. admin登录后的数据设置，redis与cookie
        doLoginSettings(admin,request,response);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">dev-common  com/imooc/utils/FaceVerifyUtils.java
package com.imooc.utils;

import com.aliyuncs.utils.Base64Helper;
import com.imooc.enums.FaceVerifyType;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.extend.AliyunResource;
import org.apache.tomcat.util.codec.binary.Base64;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLConnection;
import java.security.MessageDigest;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Locale;
import java.util.Map;
import java.util.SimpleTimeZone;

@Component
public class FaceVerifyUtils &#123;

    final static Logger logger = LoggerFactory.getLogger(FaceVerifyUtils.class);

    @Autowired
    private AliyunResource aliyunResource;

    //网关地址
    private static final String gateway = &quot;https://dtplus-cn-shanghai.data.aliyuncs.com/face/verify&quot;;

    /*
     * 计算MD5+BASE64
     */
    public static String MD5Base64(String s) &#123;
        if (s == null)
            return null;
        String encodeStr = &quot;&quot;;
        byte[] utfBytes = s.getBytes();
        MessageDigest mdTemp;
        try &#123;
            mdTemp = MessageDigest.getInstance(&quot;MD5&quot;);
            mdTemp.update(utfBytes);
            byte[] md5Bytes = mdTemp.digest();
            Base64Helper b64Encoder = new Base64Helper();
            encodeStr = b64Encoder.encode(md5Bytes);
        &#125; catch (Exception e) &#123;
            throw new Error(&quot;Failed to generate MD5 : &quot; + e.getMessage());
        &#125;
        return encodeStr;
    &#125;

    /*
     * 计算 HMAC-SHA1
     */
    public static String HMACSha1(String data, String key) &#123;
        String result;
        try &#123;
            SecretKeySpec signingKey = new SecretKeySpec(key.getBytes(), &quot;HmacSHA1&quot;);
            Mac mac = Mac.getInstance(&quot;HmacSHA1&quot;);
            mac.init(signingKey);
            byte[] rawHmac = mac.doFinal(data.getBytes());
            result = (new Base64Helper()).encode(rawHmac);
        &#125; catch (Exception e) &#123;
            throw new Error(&quot;Failed to generate HMAC : &quot; + e.getMessage());
        &#125;
        return result;
    &#125;

    /*
     * 等同于javaScript中的 new Date().toUTCString();
     */
    public static String toGMTString(Date date) &#123;
        SimpleDateFormat df = new SimpleDateFormat(&quot;E, dd MMM yyyy HH:mm:ss z&quot;, Locale.UK);
        df.setTimeZone(new SimpleTimeZone(0, &quot;GMT&quot;));
        return df.format(date);
    &#125;

    /**
     * 发送POST请求 进行两张图的人脸对比
     * @param type
     *          0: 通过url识别，参数image_url不为空；1: 通过图片content识别，参数content不为空
     * @param face1
     *          type为0，则传入图片url，为1则传入base64
     * @param face2
     *          type为0，则传入图片url，为1则传入base64
     * @return
     */
    //如果发送的是转换为base64编码后后面加请求参数type为1，如果请求的是图片的url则不用加type参数。
    public String sendPostVerifyFace(int type, String face1, String face2) throws Exception &#123;
        String body = &quot;&quot;;
        if (type == FaceVerifyType.BASE64.type) &#123;
            body = &quot;&#123;\&quot;content_1\&quot;: \&quot;&quot; + face1 + &quot;\&quot;, \&quot;content_2\&quot;:\&quot;&quot; + face2 + &quot;\&quot;, \&quot;type\&quot;:\&quot;&quot; + type + &quot;\&quot;&#125;&quot;;
        &#125; else if (type == FaceVerifyType.IMAGE_URL.type) &#123;
            body = &quot;&#123;\&quot;image_url_1\&quot;: \&quot;&quot; + face1 + &quot;\&quot;, \&quot;image_url_2\&quot;:\&quot;&quot; + face2 + &quot;\&quot;, \&quot;type\&quot;:\&quot;&quot; + type + &quot;\&quot;&#125;&quot;;
        &#125; else &#123;
            GraceException.display(ResponseStatusEnum.FACE_VERIFY_TYPE_ERROR);
        &#125;
//        String body = &quot;&#123;\&quot;content_1\&quot;: \&quot;&quot; + face1 + &quot;\&quot;, \&quot;content_2\&quot;:\&quot;&quot; + face2 + &quot;\&quot;, \&quot;type\&quot;:\&quot;&quot; + &quot;1&quot; + &quot;\&quot;&#125;&quot;;
        PrintWriter out = null;
        BufferedReader in = null;
        String result = &quot;&quot;;
        int statusCode = 200;
        try &#123;
            URL realUrl = new URL(gateway);
            /*
             * http header 参数
             */
            String method = &quot;POST&quot;;
            // 返回值类型
            String accept = &quot;application/json&quot;;
            // 请求内容类型
            String content_type = &quot;application/json&quot;;
            String path = realUrl.getFile();
            // GMT时间
            String date = toGMTString(new Date());
            // 1.对body做MD5+BASE64加密
            String bodyMd5 = MD5Base64(body);
            String stringToSign = method + &quot;\n&quot; + accept + &quot;\n&quot; + bodyMd5 + &quot;\n&quot; + content_type + &quot;\n&quot; + date + &quot;\n&quot;
                    + path;
            // 2.计算 HMAC-SHA1
            String signature = HMACSha1(stringToSign, aliyunResource.getAccessKeySecret());
            // 3.得到 authorization header
            String authHeader = &quot;Dataplus &quot; + aliyunResource.getAccessKeyID() + &quot;:&quot; + signature;
            // 打开和URL之间的连接
            URLConnection conn = realUrl.openConnection();
            // 设置通用的请求属性
            conn.setRequestProperty(&quot;Accept&quot;, accept);
            conn.setRequestProperty(&quot;Content-type&quot;, content_type);
            conn.setRequestProperty(&quot;Date&quot;, date);
            // 认证信息
            conn.setRequestProperty(&quot;Authorization&quot;, authHeader);
            // 发送POST请求必须设置如下两行
            conn.setDoOutput(true);
            conn.setDoInput(true);
            // 获取URLConnection对象对应的输出流
            out = new PrintWriter(conn.getOutputStream());
            // 发送请求参数
            out.print(body);
            // flush输出流的缓冲
            out.flush();
            // 定义BufferedReader输入流来读取URL的响应
            statusCode = ((HttpURLConnection) conn).getResponseCode();
            if (statusCode != 200) &#123;
                in = new BufferedReader(new InputStreamReader(((HttpURLConnection) conn).getErrorStream()));
            &#125; else &#123;
                in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
            &#125;
            String line;
            while ((line = in.readLine()) != null) &#123;
                result += line;
            &#125;
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125; finally &#123;
            try &#123;
                if (out != null) &#123;
                    out.close();
                &#125;
                if (in != null) &#123;
                    in.close();
                &#125;
            &#125; catch (IOException ex) &#123;
                ex.printStackTrace();
            &#125;
        &#125;
        if (statusCode != 200) &#123;
            throw new IOException(&quot;\nHttp StatusCode: &quot; + statusCode + &quot;\nErrorMessage: &quot; + result);
        &#125;
        return result;
    &#125;

    /**
     *
     * @param type
     * @param face1
     * @param face2
     * @param targetConfidence
     *          目标可信度，自定义阈值
     * @return
     */
    public boolean faceVerify(int type, String face1, String face2, double targetConfidence) &#123;

        String response = null;
        try &#123;
            response = sendPostVerifyFace(type, face1, face2);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;

        Map&lt;String, String&gt; map = JsonUtils.jsonToPojo(response, Map.class);
        Object confidenceStr = map.get(&quot;confidence&quot;);
        Double responseConfidence = (Double)confidenceStr;

        logger.info(&quot;人脸对比结果：&#123;&#125;&quot;, responseConfidence);

//        System.out.println(response.toString());
//        System.out.println(map.toString());

        if (responseConfidence &gt; targetConfidence) &#123;
            return true;
        &#125; else &#123;
            return false;
        &#125;
    &#125;

    /**
     *
     * 将图片转换为Base64
     * 将base64编码字符串解码成img图片
     * @param imgUrl
     * @return
     */
    public String getImgBase64(String imgUrl)&#123;
        ByteArrayOutputStream data = new ByteArrayOutputStream();
        try &#123;
            // 创建URL
            URL url = new URL(imgUrl);
            byte[] by = new byte[1024];
            // 创建链接
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod(&quot;GET&quot;);
            conn.setConnectTimeout(5000);
            InputStream is = conn.getInputStream();
            // 将内容放到内存中
            int len = -1;
            while ((len = is.read(by)) != -1) &#123;
                data.write(by, 0, len);
            &#125;
            is.close();
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
        // 对字节数组Base64编码
        return Base64.encodeBase64String(data.toByteArray());
    &#125;

//    public static void main(String[] args) &#123;
//        String face3 = &quot;http://122.152.205.72:88/group1/M00/00/05/CpoxxF5MvvGAfnLXAAIHiv37wNk363.jpg&quot;;
//        String face4 = &quot;http://122.152.205.72:88/group1/M00/00/05/CpoxxF5Mv3yAH74mAACOiTd9pO4462.jpg&quot;;
//
//        boolean result = new FaceVerifyUtils().faceVerify(FaceVerifyType.IMAGE_URL.type, face3, face4, 60);
//
//        logger.info(&quot;人脸对比是否成功：&#123;&#125;&quot;, result);
//    &#125;
&#125;
</code></pre>
<h3 id="MongoDB使用场景-【分担数据库的大数据量】"><a href="#MongoDB使用场景-【分担数据库的大数据量】" class="headerlink" title="MongoDB使用场景 【分担数据库的大数据量】"></a>MongoDB使用场景 【分担数据库的大数据量】</h3><ul>
<li><strong>GridFS小文件存储</strong></li>
<li><strong>历史数据快照</strong> [买的东西涨价后 还是原来的价格] 【数据量大存入MongoDB】</li>
<li><strong>用户浏览记录</strong></li>
<li><strong>客服聊天记录</strong> [不是核心数据 可以剥离]</li>
</ul>
<h6 id="这些不建议放在Redis里-因为Redis是存储在内存里的-内存很贵-成本很大"><a href="#这些不建议放在Redis里-因为Redis是存储在内存里的-内存很贵-成本很大" class="headerlink" title="这些不建议放在Redis里 因为Redis是存储在内存里的 [内存很贵 成本很大]"></a>这些不建议放在Redis里 因为Redis是存储在内存里的 [内存很贵 成本很大]</h6><h3 id="友情连接保存与更新-【MongoDB】"><a href="#友情连接保存与更新-【MongoDB】" class="headerlink" title="友情连接保存与更新 【MongoDB】"></a>友情连接保存与更新 【MongoDB】</h3><h6 id="对连接的一些逻辑校验"><a href="#对连接的一些逻辑校验" class="headerlink" title="对连接的一些逻辑校验"></a>对连接的一些逻辑校验</h6><pre><code class="yaml">service-admin  application.yml 【加上mongodb配置】
  data:
    mongodb:
      uri: mongodb://root:root@192.168.170.135:27017
      database: imooc-news
</code></pre>
<pre><code class="java">service-admin  Application 【注释exclude 把mongodb配置进来】
package com.imooc.admin;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication  //(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.admin.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<p>dev-model  com&#x2F;imooc&#x2F;pojo&#x2F;bo&#x2F;SaveFriendLinkBO.java<br>package com.imooc.pojo.bo;</p>
<p>import com.imooc.validate.CheckUrl;</p>
<p>import javax.validation.constraints.NotBlank;<br>import javax.validation.constraints.NotNull;</p>
<p>public class SaveFriendLinkBO {<br>    private String id;<br>    @NotBlank(message &#x3D; “友情链接名不能为空”)<br>    private String linkName;<br>    @NotBlank(message &#x3D; “友情链接地址不能为空”)<br>    @CheckUrl 【ctrl+左键 显示↓ CheckUrl接口】<br>    @CheckName 【 &#x2F;&#x2F;不能有空格 不能为空 字符串长度要在6-12位】<br>    private String linkUrl;<br>    @NotNull(message &#x3D; “请选择保留或删除”)<br>    private Integer isDelete;<br>}Getter+Setter</p>
<pre><code class="java">dev-model  com/imooc/validate/CheckUrl.java
package com.imooc.validate;

import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = CheckUrlValidate.class)
public @interface CheckUrl &#123;

    String message() default &quot;Url不正确&quot;;
    Class&lt;?&gt;[] groups() default &#123;&#125;;
    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/validate/CheckName.java
package com.imooc.validate;

import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = CheckUrlValidate.class)
public @interface CheckName &#123;

    String message() default &quot;Name不正确&quot;;
    Class&lt;?&gt;[] groups() default &#123;&#125;;
    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/validate/CheckUrlValidate.java
package com.imooc.validate;

import com.imooc.utils.UrlUtil;

import javax.validation.ConstraintValidator;
import javax.validation.ConstraintValidatorContext;

public class CheckUrlValidate implements ConstraintValidator&lt;CheckUrl, String&gt; &#123;

    @Override
    public boolean isValid(String url, ConstraintValidatorContext context) &#123;
        return UrlUtil.verifyUrl(url.trim());
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/validate/CheckNameValidate.java
package com.imooc.validate;

import com.imooc.utils.UrlUtil;

import javax.validation.ConstraintValidator;
import javax.validation.ConstraintValidatorContext;

public class CheckNameValidate implements ConstraintValidator&lt;CheckName, String&gt; &#123;

    @Override
    public boolean isValid(String name, ConstraintValidatorContext context) &#123;
        return UrlUtil.verifyName(name.trim());
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-common  com/imooc/utils/UrlUtil.java 【Url+Name校验标准】
package com.imooc.utils;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class UrlUtil &#123;

    /**
     * 验证是否是URL
     * @param url
     * @return
     */
    public static boolean verifyUrl(String url)&#123;

        // URL验证规则
//        String regEx =&quot;[A-Za-z]+://[A-Za-z0-9-_]+\\\\.[A-Za-z0-9-_%&amp;\\?\\/.=]+&quot;;
        String regEx = &quot;^([hH][tT]&#123;2&#125;[pP]:/*|[hH][tT]&#123;2&#125;[pP][sS]:/*|[fF][tT][pP]:/*)(([A-Za-z0-9-~]+).)+([A-Za-z0-9-~\\/])+(\\?&#123;0,1&#125;(([A-Za-z0-9-~]+\\=&#123;0,1&#125;)([A-Za-z0-9-~]*)\\&amp;&#123;0,1&#125;)*)$&quot;;
        // 编译正则表达式
        Pattern pattern = Pattern.compile(regEx);
        // 忽略大小写的写法
        // Pattern pat = Pattern.compile(regEx, Pattern.CASE_INSENSITIVE);
        Matcher matcher = pattern.matcher(url);
        // 字符串是否与正则表达式相匹配
        boolean rs = matcher.matches();
        return rs;

    &#125;
    //不能有空格 不能为空 字符串长度要在6-12位
    public static boolean verifyName(String name)&#123;
        // Name验证规则
        String nameEx = &quot;^[^\\s]&#123;6,12&#125;$&quot;;
        // 编译正则表达式
        Pattern pattern = Pattern.compile(nameEx);
        // 忽略大小写的写法
        // Pattern pat = Pattern.compile(regEx, Pattern.CASE_INSENSITIVE);
        Matcher matcher = pattern.matcher(name);
        // 字符串是否与正则表达式相匹配
        boolean rs = matcher.matches();
        return rs;
    &#125;

    public static void main(String[] args) &#123;
        boolean res = verifyUrl(&quot;http://admin.imoocnews.com:9090/imooc-news/admin/friendLinks.html&quot;);
        boolean nres = verifyName(&quot;Jerry&quot;);
        System.out.println(nres);
    &#125;
&#125;
</code></pre>
<pre><code class="xml">dev-model  pom.xml
 &lt;!-- 引入 mongodb 依赖 --&gt; 【springboot整合mongodb】
        &lt;dependency&gt;
            &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
            &lt;artifactId&gt;mongodb-driver&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mariadb.jdbc&lt;/groupId&gt;
            &lt;artifactId&gt;mariadb-java-client&lt;/artifactId&gt;
            &lt;version&gt;2.7.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<h6 id="真正的友链保存接口"><a href="#真正的友链保存接口" class="headerlink" title="真正的友链保存接口"></a>真正的友链保存接口</h6><pre><code class="java">service-api  com/imooc/api/controller/admin/FriendLinkControllerApi.java
package com.imooc.api.controller.admin;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.bo.SaveFriendLinkBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;首页友情连接维护&quot;, tags = &#123;&quot;首页友情连接维护&quot;&#125;)
@RequestMapping(&quot;friendLinkMng&quot;)
public interface FriendLinkControllerApi &#123;

    @ApiOperation(value = &quot;新增或者修改友情连接&quot;, notes = &quot;新增或者修改友情连接&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/saveOrUpdateFriendLink&quot;)
    public GraceJSONResult saveOrUpdateFriendLink(@RequestBody SaveFriendLinkBO saveFriendLinkBO,
                                      BindingResult result);
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/FriendLinkController.java
package com.imooc.admin.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.FriendLinkControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.SaveFriendLinkBO;
import com.imooc.pojo.mo.FriendLinkMO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RestController;

import java.util.Date;
import java.util.Map;

@RestController
public class FriendLinkController extends BaseController implements FriendLinkControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FriendLinkController.class);


    @Override
    public GraceJSONResult saveOrUpdateFriendLink(SaveFriendLinkBO saveFriendLinkBO, BindingResult result) &#123;
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;

//      saveFriendLinkBO -&gt; ***Mo  MongoDB校验的对象
        FriendLinkMO friendLinkMO = new FriendLinkMO();
        BeanUtils.copyProperties(saveFriendLinkBO,friendLinkMO);
        friendLinkMO.setCreateTime(new Date());
        friendLinkMO.setUpdateTime(new Date());
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/mo/FriendLinkMO.java
//这些都是设置到MongoDB数据库的名字
//@Document(&quot;FriendLink&quot;) //MongoDB文件起别名
public class FriendLinkMO &#123;
    @Id //作为MongDB的主键了
    private String id;
    @Field(&quot;link_name&quot;)
    private String linkName;
    @Field(&quot;link_url&quot;)
    private String linkUrl;
    @Field(&quot;is_delete&quot;)
    private Integer isDelete;
    @Field(&quot;create_time&quot;)
    private Date createTime;
    @Field(&quot;update_time&quot;)
    private Date updateTime;
&#125;Getter + Setter
</code></pre>
<h3 id="Repository持久层操作保存记录"><a href="#Repository持久层操作保存记录" class="headerlink" title="Repository持久层操作保存记录"></a>Repository持久层操作保存记录</h3><pre><code class="java">service-api  com/imooc/api/controller/admin/FriendLinkControllerApi.java
package com.imooc.api.controller.admin;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.bo.SaveFriendLinkBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;首页友情连接维护&quot;, tags = &#123;&quot;首页友情连接维护&quot;&#125;)
@RequestMapping(&quot;friendLinkMng&quot;)
public interface FriendLinkControllerApi &#123;

    @ApiOperation(value = &quot;新增或者修改友情连接&quot;, notes = &quot;新增或者修改友情连接&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/saveOrUpdateFriendLink&quot;)
    public GraceJSONResult saveOrUpdateFriendLink(@RequestBody SaveFriendLinkBO saveFriendLinkBO,
                                      BindingResult result);
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/FriendLinkController.java
package com.imooc.admin.controller;

import com.imooc.admin.repository.FriendLinkRepository;
import com.imooc.admin.service.FriendLinkService;
import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.FriendLinkControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.SaveFriendLinkBO;
import com.imooc.pojo.mo.FriendLinkMO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RestController;

import java.util.Date;
import java.util.Map;

@RestController
public class FriendLinkController extends BaseController implements FriendLinkControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FriendLinkController.class);
    @Autowired
    private FriendLinkService friendLinkService;

    @Override
    public GraceJSONResult saveOrUpdateFriendLink(SaveFriendLinkBO saveFriendLinkBO, BindingResult result) &#123;
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;

//      saveFriendLinkBO -&gt; ***Mo  MongoDB校验的对象
        FriendLinkMO friendLinkMO = new FriendLinkMO();
        BeanUtils.copyProperties(saveFriendLinkBO,friendLinkMO);
        friendLinkMO.setCreateTime(new Date());
        friendLinkMO.setUpdateTime(new Date());

        friendLinkService.saveOrUpdateFriendLink(friendLinkMO);
        return GraceJSONResult.ok();
    &#125;
&#125;
// http://admin.imoocnews.com:9090/imooc-news/admin/friendLinks.html
/* 友情连接 → 
链接名称：慕课网
链接地址：www.imooc.com
[新增/添加]

打开检查→Console
&#123;&quot;status&quot;:200,&quot;msg&quot;:&quot;操作成功！&quot;,&quot;success&quot;:true,&quot;data&quot;:null&#125;

打开数据库查看MongoDB→friendLinkMO有存入的数据即操作成功
*/
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/FriendLinkService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.mo.FriendLinkMO;
import com.imooc.utils.PagedGridResult;

public interface FriendLinkService &#123;
    /**
     * 新增或者更新友情链接
     */
    public void saveOrUpdateFriendLink(FriendLinkMO friendLinkMO);
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/FriendLinkServiceImpl.java
package com.imooc.admin.service.impl;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.imooc.admin.mapper.AdminUserMapper;
import com.imooc.admin.repository.FriendLinkRepository;
import com.imooc.admin.service.AdminUserService;
import com.imooc.admin.service.FriendLinkService;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.mo.FriendLinkMO;
import com.imooc.utils.PagedGridResult;
import org.apache.commons.lang3.StringUtils;
import org.n3r.idworker.Sid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.stereotype.Service;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;
import java.util.List;

@Service
public class FriendLinkServiceImpl implements FriendLinkService &#123;

    @Autowired
    private FriendLinkRepository friendLinkRepository;
    @Override
    public void saveOrUpdateFriendLink(FriendLinkMO friendLinkMO) &#123;
        friendLinkRepository.save(friendLinkMO); //有id更新 无id直接保存
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/repository/FriendLinkRepository.java
package com.imooc.admin.repository;

import com.imooc.pojo.mo.FriendLinkMO;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface FriendLinkRepository extends MongoRepository&lt;FriendLinkMO, String&gt; &#123; //持久层
    // 内置提供了很多方法 find.. delete...
&#125;
</code></pre>
<h3 id="友情链接查询列表-【MongoDB】"><a href="#友情链接查询列表-【MongoDB】" class="headerlink" title="友情链接查询列表 【MongoDB】"></a>友情链接查询列表 【MongoDB】</h3><h6 id="Document-“FriendLink”-x2F-x2F-文件起别名-记得要在MongoDB里面找这个-下面搜索的都在这个文件里面"><a href="#Document-“FriendLink”-x2F-x2F-文件起别名-记得要在MongoDB里面找这个-下面搜索的都在这个文件里面" class="headerlink" title="@Document(“FriendLink”) &#x2F;&#x2F;文件起别名 记得要在MongoDB里面找这个 下面搜索的都在这个文件里面"></a>@Document(“FriendLink”) &#x2F;&#x2F;文件起别名 记得要在MongoDB里面找这个 下面搜索的都在这个文件里面</h6><pre><code class="java">service-api  com/imooc/api/controller/admin/FriendLinkControllerApi.java
package com.imooc.api.controller.admin;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.AdminLoginBO;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.bo.SaveFriendLinkBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Api(value = &quot;首页友情连接维护&quot;, tags = &#123;&quot;首页友情连接维护&quot;&#125;)
@RequestMapping(&quot;friendLinkMng&quot;)
public interface FriendLinkControllerApi &#123;

    @ApiOperation(value = &quot;新增或者修改友情连接&quot;, notes = &quot;新增或者修改友情连接&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/saveOrUpdateFriendLink&quot;)
    public GraceJSONResult saveOrUpdateFriendLink(@RequestBody SaveFriendLinkBO saveFriendLinkBO,
                                      BindingResult result);
    @ApiOperation(value = &quot;查询改友情连接列表&quot;, notes = &quot;查询改友情连接列表&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getFriendLinkList&quot;)
    public GraceJSONResult getFriendLinkList();
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/FriendLinkController.java
package com.imooc.admin.controller;

import com.imooc.admin.repository.FriendLinkRepository;
import com.imooc.admin.service.FriendLinkService;
import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.FriendLinkControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.SaveFriendLinkBO;
import com.imooc.pojo.mo.FriendLinkMO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RestController;

import java.util.Date;
import java.util.Map;

@RestController
public class FriendLinkController extends BaseController implements FriendLinkControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(FriendLinkController.class);
    @Autowired
    private FriendLinkService friendLinkService;

    @Override
    public GraceJSONResult saveOrUpdateFriendLink(SaveFriendLinkBO saveFriendLinkBO, BindingResult result) &#123;
        if (result.hasErrors())&#123;
            Map&lt;String, String&gt; map = getErrors(result);
            return GraceJSONResult.errorMap(map);
        &#125;

//      saveFriendLinkBO -&gt; ***Mo  MongoDB校验的对象
        FriendLinkMO friendLinkMO = new FriendLinkMO();
        BeanUtils.copyProperties(saveFriendLinkBO,friendLinkMO);
        friendLinkMO.setCreateTime(new Date());
        friendLinkMO.setUpdateTime(new Date());

        friendLinkService.saveOrUpdateFriendLink(friendLinkMO);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult getFriendLinkList() &#123; 
//【用了FriendLinkRepository里面的】extends MongoRepository 中的简单增删改查 
// 里面的删除是逻辑删除
        return GraceJSONResult.ok(friendLinkService.queryAllFriendLinkList());
    &#125;
&#125;
// http://admin.imoocnews.com:9090/imooc-news/admin/friendLinks.html
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/FriendLinkService.java
package com.imooc.admin.service;

import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.mo.FriendLinkMO;
import com.imooc.utils.PagedGridResult;

import java.util.List;

public interface FriendLinkService &#123;
    /**
     * 新增或者更新友情链接
     */
    public void saveOrUpdateFriendLink(FriendLinkMO friendLinkMO);

    /**
     * 查询友情链接
     */
    public List&lt;FriendLinkMO&gt; queryAllFriendLinkList();

&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/FriendLinkServiceImpl.java
package com.imooc.admin.service.impl;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.imooc.admin.mapper.AdminUserMapper;
import com.imooc.admin.repository.FriendLinkRepository;
import com.imooc.admin.service.AdminUserService;
import com.imooc.admin.service.FriendLinkService;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AdminUser;
import com.imooc.pojo.bo.NewAdminBO;
import com.imooc.pojo.mo.FriendLinkMO;
import com.imooc.utils.PagedGridResult;
import org.apache.commons.lang3.StringUtils;
import org.n3r.idworker.Sid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.stereotype.Service;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;
import java.util.List;

@Service
public class FriendLinkServiceImpl implements FriendLinkService &#123;

    @Autowired
    private FriendLinkRepository friendLinkRepository;
    @Override
    public void saveOrUpdateFriendLink(FriendLinkMO friendLinkMO) &#123;
        friendLinkRepository.save(friendLinkMO); //有id更新 无id直接保存
    &#125;

    @Override
    public List&lt;FriendLinkMO&gt; queryAllFriendLinkList() &#123;
//        Pageable pageable = PageRequest.of(1,10);
//        friendLinkRepository.findAll(pageable);
        return friendLinkRepository.findAll();
    &#125;
&#125;
</code></pre>
<h3 id="友情链接删除-【MongoDB】-增加真实删除"><a href="#友情链接删除-【MongoDB】-增加真实删除" class="headerlink" title="友情链接删除 【MongoDB】[增加真实删除]"></a>友情链接删除 【MongoDB】[增加真实删除]</h3><pre><code class="java">service-api  com/imooc/api/controller/admin/FriendLinkControllerApi.java
...
/*
@Api(value = &quot;首页友情连接维护&quot;, tags = &#123;&quot;首页友情连接维护&quot;&#125;)
@RequestMapping(&quot;friendLinkMng&quot;)
public interface FriendLinkControllerApi &#123;

    @ApiOperation(value = &quot;新增或者修改友情连接&quot;, notes = &quot;新增或者修改友情连接&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/saveOrUpdateFriendLink&quot;)
    public GraceJSONResult saveOrUpdateFriendLink(@RequestBody SaveFriendLinkBO saveFriendLinkBO,
                                      BindingResult result);
    @ApiOperation(value = &quot;查询改友情连接列表&quot;, notes = &quot;查询改友情连接列表&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getFriendLinkList&quot;)
    public GraceJSONResult getFriendLinkList();
*/
    @ApiOperation(value = &quot;删除改友情连接列表&quot;, notes = &quot;删除改友情连接列表&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/delete&quot;)
    public GraceJSONResult delete(@RequestParam String linkId);
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/FriendLinkController.java
@Override
    public GraceJSONResult delete(String linkId) &#123;
        friendLinkService.delete(linkId);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/FriendLinkService.java
    /**
     * 删除友情链接
     */
    public void delete(String linkId);
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/AdminUserService.java
@Override
    public void delete(String linkId) &#123;
        friendLinkRepository.deleteById(linkId);
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java 【增加友链拦截器】
/*
package com.imooc.api.config;

import com.imooc.api.interceptors.AdminTokenInterceptor;
import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UserActiveInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UserActiveInterceptor userActiveInterceptor() &#123;
        return new UserActiveInterceptor();
    &#125;

    @Bean
    public AdminTokenInterceptor adminTokenInterceptor() &#123;
        return new AdminTokenInterceptor();
    &#125;


    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;)
                .addPathPatterns(&quot;/fs/uploadFace&quot;);
        registry.addInterceptor(adminTokenInterceptor())//继续添加拦截器：查询admin列表 创建新admin用户
                .addPathPatterns(&quot;/adminMng/adminIsExist&quot;)
                .addPathPatterns(&quot;/adminMng/addNewAdmin&quot;)
                .addPathPatterns(&quot;/adminMng/getAdminList&quot;)
                .addPathPatterns(&quot;/fs/uploadToGridFS&quot;)
*/
                .addPathPatterns(&quot;/friendLinkMng/saveOrUpdateFriendLink&quot;)
                .addPathPatterns(&quot;/friendLinkMng/getFriendLinkList&quot;)
                .addPathPatterns(&quot;/friendLinkMng/delete&quot;);
    &#125;
&#125;
</code></pre>
<h3 id="【作业】文章分类管理-新增或修改分类、查询分类列表、用户端查询分类列表"><a href="#【作业】文章分类管理-新增或修改分类、查询分类列表、用户端查询分类列表" class="headerlink" title="【作业】文章分类管理 [新增或修改分类、查询分类列表、用户端查询分类列表]"></a>【作业】文章分类管理 <del>[新增或修改分类、查询分类列表、用户端查询分类列表]</del></h3><p><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/categoryMng.html">http://admin.imoocnews.com:9090/imooc-news/admin/categoryMng.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/justry_deng/article/details/80972817">@RequestBody的使用-CSDN博客</a></p>
<pre><code class="java">service-api  com/imooc/api/controller/admin/CategoryMngControllerApi.java
package com.imooc.api.controller.admin;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.SaveCatrgoryBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@Api(value = &quot;文章分类维护&quot;, tags = &#123;&quot;文章分类维护controller&quot;&#125;)
@RequestMapping(&quot;categoryMng&quot;)
public interface CategoryMngControllerApi &#123;
    @PostMapping(&quot;saveOrUpdateCategory&quot;)
    @ApiOperation(value = &quot;新增或修改分类&quot;, notes = &quot;新增或修改分类&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult saveOrUpdateCategory(@RequestBody @Valid SaveCatrgoryBO saveCatrgoryBO,
                                                BindingResult result);
    @PostMapping(&quot;getCatList&quot;)
    @ApiOperation(value = &quot;查询分类列表&quot;, notes = &quot;查询分类列表&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult getCatList();

    @GetMapping(&quot;getCats&quot;)
    @ApiOperation(value = &quot;用户端查询分类列表&quot;, notes = &quot;用户端查询分类列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult getCats();
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/CategoryMngController.java
package com.imooc.admin.controller;

import com.imooc.admin.service.CategoryService;
import com.imooc.api.BaseController;
import com.imooc.api.controller.admin.CategoryMngControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.Category;
import com.imooc.pojo.bo.SaveCatrgoryBO;
import com.imooc.utils.JsonUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.Map;

@RestController
public class CategoryMngController extends BaseController implements CategoryMngControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(CategoryMngController.class);

    @Autowired
    private CategoryService categoryService;

    @Override
    public GraceJSONResult saveOrUpdateCategory(SaveCatrgoryBO saveCatrgoryBO, BindingResult result) &#123;
        if (result.hasErrors())&#123;
        // 判断BindingResult是否保存错误的验证信息，如果有，则直接return
            Map&lt;String, String&gt; errorMap = getErrors(result);
            return GraceJSONResult.errorMap(errorMap);
        &#125;
        Category newCat = new Category();
        BeanUtils.copyProperties(saveCatrgoryBO,newCat);
        // id为空新增，不为空修改
        if (saveCatrgoryBO.getId() == null)&#123;
            //查询新增的分类名称不能重复存在
            boolean isExist = categoryService.queryCatIsExist(newCat.getName(), null);
            if (!isExist)&#123;
                //新增到数据库
                categoryService.createCategory(newCat);
            &#125;else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.CATEGORY_EXIST_ERROR);
            &#125;
        &#125;else &#123;
            //查询修改的分类名称不能重复存在
            boolean isExist = categoryService.queryCatIsExist(newCat.getName(), saveCatrgoryBO.getOldName());
            if (!isExist)&#123;
                //修改到数据库
                categoryService.modifyCategory(newCat);
            &#125; else &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.CATEGORY_EXIST_ERROR);
            &#125;
        &#125;
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult getCatList() &#123;
        List&lt;Category&gt; categoryList = categoryService.queryCategoryList();
        return GraceJSONResult.ok(categoryList);
    &#125;

    @Override
    public GraceJSONResult getCats() &#123;
        // 先从redis中查询，如果有，则返回，如果没有，则查询数据库库后先放缓存，放返回
        String allCatJson = redis.get(REDIS_ALL_CATEGORY);

        List&lt;Category&gt; categoryList = null;
        if (StringUtils.isBlank(allCatJson)) &#123;
            categoryList = categoryService.queryCategoryList();
            redis.set(REDIS_ALL_CATEGORY, JsonUtils.objectToJson(categoryList));
        &#125; else &#123;
            categoryList = JsonUtils.jsonToList(allCatJson, Category.class);
        &#125;

        return GraceJSONResult.ok(categoryList);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/CategoryService.java
package com.imooc.admin.service;

import com.imooc.pojo.Category;
import java.util.List;

public interface CategoryService &#123;

    /**
     * 新增文章分类
     */
    public void createCategory(Category category);

    /**
     * 修改文章分类列表
     */
    public void modifyCategory(Category category);

    /**
     * 查询分类名是否已经存在
     */
    public boolean queryCatIsExist(String catName, String oldCatName);

    /**
     * 获得文章分类列表
     */
    public List&lt;Category&gt; queryCategoryList();
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/CategoryServiceImpl.java
package com.imooc.admin.service.impl;

import com.imooc.admin.mapper.CategoryMapper;
import com.imooc.admin.service.CategoryService;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.Category;
import com.imooc.utils.RedisOperator;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;

import java.util.List;

import static com.imooc.api.BaseController.REDIS_ALL_CATEGORY;


@Service
public class CategoryServiceImpl implements CategoryService &#123;
    @Autowired
    public CategoryMapper categoryMapper;
    @Autowired
    public RedisOperator redis;

    @Transactional
    @Override
    public void createCategory(Category category) &#123;
// 分类不会很多，所以id不需要自增，这个表的数据也不会多到几万甚至分表，数据都会集中在一起
        int result = categoryMapper.insert(category);
        if (result != 1)&#123;
            GraceException.display(ResponseStatusEnum.SYSTEM_OPERATION_ERROR);
            /**
             * 不建议如下做法：
             * 1. 查询redis中的categoryList
             * 2. 转化categoryList为list类型
             * 3. 在categoryList中add一个当前的category
             * 4. 再次转换categoryList为json，并存入redis中
             */
            // 直接使用redis删除缓存即可，用户端在查询的时候会直接查库，再把最新的数据放入到缓存中
            redis.del(REDIS_ALL_CATEGORY);
        &#125;
    &#125;

    @Transactional
    @Override
    public void modifyCategory(Category category) &#123;
        int result = categoryMapper.updateByPrimaryKey(category);
        if (result != 1) &#123;
            GraceException.display(ResponseStatusEnum.SYSTEM_OPERATION_ERROR);
        &#125;
        // 直接使用redis删除缓存即可，用户端在查询的时候会直接查库，再把最新的数据放入到缓存中
        redis.del(REDIS_ALL_CATEGORY);
    &#125;

    @Override
    public boolean queryCatIsExist(String catName, String oldCatName) &#123;
        Example example = new Example(Category.class);
        Example.Criteria catCriteria = example.createCriteria();
        catCriteria.andEqualTo(&quot;name&quot;, catName);
        if (StringUtils.isNotBlank(oldCatName)) &#123;
            catCriteria.andNotEqualTo(&quot;name&quot;, oldCatName);
        &#125;

        List&lt;Category&gt; catList = categoryMapper.selectByExample(example);

        boolean isExist = false;
        if (catList != null &amp;&amp; !catList.isEmpty() &amp;&amp; catList.size() &gt; 0) &#123;
            isExist = true;
        &#125;

        return isExist;
    &#125;

    @Override
    public List&lt;Category&gt; queryCategoryList() &#123;
        return categoryMapper.selectAll();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/mapper/CategoryMapper.java
package com.imooc.admin.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Category;
import org.springframework.stereotype.Repository;

@Repository
public interface CategoryMapper extends MyMapper&lt;Category&gt; &#123;
&#125;
</code></pre>
<pre><code class="xml">service-admin  resources/mapper/CategoryMapper.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.admin.mapper.CategoryMapper&quot; &gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Category&quot; &gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;name&quot; property=&quot;name&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;tag_color&quot; property=&quot;tagColor&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java
public abstract class BaseController &#123;
    @Autowired
    public RedisOperator redis;
    public static final String MOBILE_SMSCODE = &quot;mobile:smscode&quot;;
    public static final String REDIS_USER_TOKEN = &quot;redis_user_token&quot;;//ctrl+shift+u直接大写
    public static final String REDIS_USER_INFO = &quot;redis_user_info&quot;;//ctrl+shift+u直接大写
    public static final String REDIS_ADMIN_TOKEN = &quot;redis_admin_token&quot;;//ctrl+shift+u直接大写
    public static final String REDIS_ALL_CATEGORY = &quot;redis_all_category&quot;;

    public static final String REDIS_WRITER_FANS_COUNTS = &quot;redis_writer_fans_counts&quot;;
    public static final String REDIS_MY_FOLLOW_COUNTS = &quot;redis_my_follow_counts&quot;;

    public static final String REDIS_ARTICLE_READ_COUNTS = &quot;redis_article_read_counts&quot;;
    public static final String REDIS_ALREADY_READ = &quot;redis_already_read&quot;;

    public static final String REDIS_ARTICLE_COMMENT_COUNTS = &quot;redis_article_comment_counts&quot;;

    @Value(&quot;$&#123;website.domain-name&#125;&quot;)
    public String DOMAIN_NAME;
    public static final Integer COOKIE_MONTH = 30 * 24 * 60 * 60;
    public static final Integer COOKIE_DELETE = 0;

    public static final Integer COMMON_START_PAGE = 1;
    public static final Integer COMMON_PAGE_SIZE = 10;
&#125;...
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/Category.java
package com.imooc.pojo;

import javax.persistence.Column;
import javax.persistence.Id;

public class Category &#123;
    @Id
    private Integer id;

    /**
     * 分类名，比如：科技，人文，历史，汽车等等
     */
    private String name;

    /**
     * 标签颜色
     */
    @Column(name = &quot;tag_color&quot;)
    private String tagColor;
&#125;Getter + Setter
</code></pre>
<h3 id="查询用户列表-设置时间日期转换配置-【用户管理】"><a href="#查询用户列表-设置时间日期转换配置-【用户管理】" class="headerlink" title="查询用户列表_设置时间日期转换配置 【用户管理】"></a>查询用户列表_设置时间日期转换配置 【用户管理】</h3><pre><code class="java">service-api  com/imooc/api/controller/user/AppUserMngControllerApi.java
package com.imooc.api.controller.user;


import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.Date;

@Api(value = &quot;用户管理相关的接口定义&quot;,tags = &#123;&quot;用户管理相关功能的controller&quot;&#125;)
@RequestMapping(&quot;appUser&quot;)
public interface AppUserMngControllerApi &#123;
    @ApiOperation(value = &quot;查询所有网站用户&quot;,notes = &quot;查询所有网站用户&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;queryAll&quot;)
    public GraceJSONResult queryAll(@RequestParam String nickname,
                                    @RequestParam Integer status,
                                    @RequestParam Date startDate,
                                    @RequestParam Date endDate,
                                    @RequestParam Integer page,
                                    @RequestParam Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/AppUserMngController.java
package com.imooc.user.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.user.AppUserMngControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.RedisOperator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Date;

@RestController
public class AppUserMngController extends BaseController implements AppUserMngControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(AppUserMngController.class);
// 字符串无法直接转换成Date类型 需要工具类转换 DateConverterConfig com/imooc/api/config/DateConverterConfig.java

    @Override
    public GraceJSONResult queryAll(String nickname, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize) &#123;
        System.out.println(startDate);
        System.out.println(endDate);
        if (page == null)&#123;
            page = COMMON_START_PAGE;
        &#125;
        if (pageSize == null)&#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        return GraceJSONResult.ok();
    &#125;
&#125;
// http://admin.imoocnews.com:9090/imooc-news/admin/userList.html
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/DateConverterConfig.java
package com.imooc.api.config;


import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.convert.converter.Converter;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/**
 * 请求路径url中的参数进行时间日期类型的转换，字符串-&gt;日期Date
 */
@Configuration
public class DateConverterConfig implements Converter&lt;String, Date&gt; &#123;

    private static final List&lt;String&gt; formatterList = new ArrayList&lt;&gt;(4);
    static&#123;
        formatterList.add(&quot;yyyy-MM&quot;);
        formatterList.add(&quot;yyyy-MM-dd&quot;);
        formatterList.add(&quot;yyyy-MM-dd hh:mm&quot;);
        formatterList.add(&quot;yyyy-MM-dd hh:mm:ss&quot;);
    &#125;

    @Override
    public Date convert(String source) &#123;
        String value = source.trim();
        if (&quot;&quot;.equals(value)) &#123;
            return null;
        &#125;
        if(source.matches(&quot;^\\d&#123;4&#125;-\\d&#123;1,2&#125;$&quot;))&#123;
            return parseDate(source, formatterList.get(0));
        &#125;else if(source.matches(&quot;^\\d&#123;4&#125;-\\d&#123;1,2&#125;-\\d&#123;1,2&#125;$&quot;))&#123;
            return parseDate(source, formatterList.get(1));
        &#125;else if(source.matches(&quot;^\\d&#123;4&#125;-\\d&#123;1,2&#125;-\\d&#123;1,2&#125; &#123;1&#125;\\d&#123;1,2&#125;:\\d&#123;1,2&#125;$&quot;))&#123;
            return parseDate(source, formatterList.get(2));
        &#125;else if(source.matches(&quot;^\\d&#123;4&#125;-\\d&#123;1,2&#125;-\\d&#123;1,2&#125; &#123;1&#125;\\d&#123;1,2&#125;:\\d&#123;1,2&#125;:\\d&#123;1,2&#125;$&quot;))&#123;
            return parseDate(source, formatterList.get(3));
        &#125;else &#123;
            GraceException.display(ResponseStatusEnum.SYSTEM_DATE_PARSER_ERROR);
        &#125;
        return null;
    &#125;

    /**
     * 日期转换方法
     * @param dateStr
     * @param formatter
     * @return
     */
    public Date parseDate(String dateStr, String formatter) &#123;
        Date date=null;
        try &#123;
            DateFormat dateFormat = new SimpleDateFormat(formatter);
            date = dateFormat.parse(dateStr);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
        return date;
    &#125;
&#125;
</code></pre>
<h3 id="查询用户列表-实现service与联调-【用户管理】"><a href="#查询用户列表-实现service与联调-【用户管理】" class="headerlink" title="查询用户列表_实现service与联调 【用户管理】"></a>查询用户列表_实现service与联调 【用户管理】</h3><pre><code class="java">service-user  com/imooc/user/service/AppUserMngService.java
package com.imooc.user.service;

import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import com.imooc.utils.PagedGridResult;

import java.util.Date;

public interface AppUserMngService &#123;
    /**
     * 查询管理员列表
     * @param nickname
     * @param status
     * @param startDate
     * @param endDate
     * @param page
     * @param pageSize
     * @return
     */
    public PagedGridResult queryAllUserList(String nickname, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize);

&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/service/BaseService.java
package com.imooc.api.service;

import com.github.pagehelper.PageInfo;
import com.imooc.utils.PagedGridResult;

import java.util.List;

public class BaseService &#123;
    public PagedGridResult setterPagedGrid(List&lt;?&gt; list, Integer page)&#123; //类型是? 后期不确定是什么泛型
        PageInfo&lt;?&gt; pageList = new PageInfo&lt;&gt;(list);
        PagedGridResult gridResult = new PagedGridResult();
        gridResult.setRows(list);
        gridResult.setPage(page);
        gridResult.setRecords(pageList.getTotal());
        gridResult.setTotal(pageList.getPages());
        return gridResult;

    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/AppUserMngServiceImpl.java
package com.imooc.user.service.impl;

import com.github.pagehelper.PageHelper;
import com.imooc.api.service.BaseService;
import com.imooc.enums.Sex;
import com.imooc.enums.UserStatus;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import com.imooc.user.mapper.AppUserMapper;
import com.imooc.user.service.AppUserMngService;
import com.imooc.user.service.UserService;
import com.imooc.utils.*;
import org.apache.commons.lang3.StringUtils;
import org.n3r.idworker.Sid;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;
import java.util.List;

@Service
public class AppUserMngServiceImpl extends BaseService implements AppUserMngService &#123;
    @Autowired
    public AppUserMapper appUserMapper;

    @Override
    public PagedGridResult queryAllUserList(String nickname, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize) &#123;
        Example example = new Example(AppUser.class);
        example.orderBy(&quot;createdTime&quot;).desc();
        Example.Criteria criteria = example.createCriteria();
        if (StringUtils.isNotBlank(nickname)) &#123;
            criteria.andLike(&quot;nickname&quot;, &quot;%&quot; + nickname + &quot;%&quot;);
        &#125;
        if (UserStatus.isUserStatusValid(status))&#123;
            criteria.andEqualTo(&quot;activeStatus&quot;, status); //对比状态
        &#125;
        if (startDate != null)&#123;
            criteria.andGreaterThanOrEqualTo(&quot;createdTime&quot;, startDate);//数据库和传入参数对比
        &#125;
        if (endDate != null)&#123;
            criteria.andLessThanOrEqualTo(&quot;endTime&quot;, endDate);//数据库和传入参数对比
        &#125;
        PageHelper.startPage(page, pageSize);
        List&lt;AppUser&gt; list = appUserMapper.selectByExample(example);

        return setterPagedGrid(list,page);
    &#125;
&#125;
</code></pre>
<h3 id="查询用户账户-冻结与解封-【用户管理】"><a href="#查询用户账户-冻结与解封-【用户管理】" class="headerlink" title="查询用户账户_冻结与解封 【用户管理】"></a>查询用户账户_冻结与解封 【用户管理】</h3><pre><code class="java">service-api  com/imooc/api/controller/user/AppUserMngControllerApi.java
package com.imooc.api.controller.user;


import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.Date;

@Api(value = &quot;用户管理相关的接口定义&quot;,tags = &#123;&quot;用户管理相关功能的controller&quot;&#125;)
@RequestMapping(&quot;appUser&quot;)
public interface AppUserMngControllerApi &#123;
    @ApiOperation(value = &quot;查询所有网站用户&quot;,notes = &quot;查询所有网站用户&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;queryAll&quot;)
    public GraceJSONResult queryAll(@RequestParam String nickname,
                                    @RequestParam Integer status,
                                    @RequestParam Date startDate,
                                    @RequestParam Date endDate,
                                    @RequestParam Integer page,
                                    @RequestParam Integer pageSize);

    @ApiOperation(value = &quot;查看用户详情&quot;,notes = &quot;查看用户详情&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;userDetail&quot;)
    public GraceJSONResult userDetail(@RequestParam String userId);

    @ApiOperation(value = &quot;冻结用户或者解冻用户&quot;,notes = &quot;冻结用户或者解冻用户&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;freezeUserOrNot&quot;)
    public GraceJSONResult freezeUserOrNot(@RequestParam String userId,@RequestParam Integer doStatus);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/AppUserMngController.java
@RestController
public class AppUserMngController extends BaseController implements AppUserMngControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(AppUserMngController.class);
    
    @Autowired
    private AppUserMngService appUserMngService;
    @Autowired
    private UserService userService;
......
    
     @Override
    public GraceJSONResult freezeUserOrNot(String userId, Integer doStatus) &#123;
        if (!UserStatus.isUserStatusValid(doStatus))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_STATUS_ERROR);
        &#125;
        appUserMngService.freezeUserOrNot(userId, doStatus);
        //若冻结后 用户处于登录状态 还可以进行操作 所以要刷新用户状态
        //方法①：删除用户会话，从而保证用户需要重新登陆以后再来刷新她的会话状态
        redis.del(REDIS_USER_INFO + &quot;:&quot; + userId);
        //方法②：查询最新用户的信息，重新放入redis中，做一次更新
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/AppUserMngService.java
package com.imooc.user.service;

import com.imooc.pojo.AppUser;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import com.imooc.utils.PagedGridResult;

import java.util.Date;

public interface AppUserMngService &#123;
    /**
     * 查询管理员列表
     */
    public PagedGridResult queryAllUserList(String nickname, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize);

    /**
     * 冻结用户账号或者解除冻结
     */
    public void freezeUserOrNot(String userId, Integer doStatus);

&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/AppUserMngServiceImpl.java
    @Transactional
    @Override
    public void freezeUserOrNot(String userId, Integer doStatus) &#123;
        AppUser user = new AppUser();
        user.setId(userId);
        user.setActiveStatus(doStatus);
        appUserMapper.updateByPrimaryKeySelective(user);
    &#125;
</code></pre>
<h3 id="梳理文章article表结构-【文章服务】"><a href="#梳理文章article表结构-【文章服务】" class="headerlink" title="梳理文章article表结构 【文章服务】"></a>梳理文章article表结构 【文章服务】</h3><ul>
<li><strong>构建文章服务</strong></li>
<li><strong>作者中心发表文章</strong></li>
<li><strong>作者中心内容管理</strong></li>
<li><strong>自动审核<del>[阿里客户端]</del>，手动审核</strong></li>
</ul>
<h3 id="构建文章服务工程-【文章服务】"><a href="#构建文章服务工程-【文章服务】" class="headerlink" title="构建文章服务工程 【文章服务】"></a>构建文章服务工程 【文章服务】</h3><blockquote>
<p>新创建一个Module<br>GroupId：com.imooc<br>ArtifactId：imooc-news-dev-service-article<br>pom参考service-admin移植  resources里的所有文件(除mapper)也要移植</p>
</blockquote>
<pre><code class="xml">service-article  pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;artifactId&gt;imooc-news-dev-service-article&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<pre><code class="xml">resources logback-spring.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;configuration&gt;
    &lt;!-- 指定日志文件的存储地址，使用绝对路径 --&gt;
&lt;!--    &lt;property name=&quot;LOG_HOME&quot; value=&quot;/workspaces/logs/imooc-news-dev/service-article&quot;/&gt;--&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;C:/Users/Pluminary/Desktop/imooc-news-article&quot;/&gt;

    &lt;!-- Console 输出设置 --&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;
            &lt;pattern&gt;%white(%d&#123;mm:ss.SSS&#125;) %green([%thread]) %cyan(%-5level) %yellow(%logger&#123;36&#125;) %magenta(-) %black(%msg%n)&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 按照每天生成日志文件 --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- 日志文件输出的文件名 --&gt;
            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/service-article.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!--&lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;--&gt;
        &lt;!--&lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;--&gt;
    &lt;!--&lt;/logger&gt;--&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/Application.java
package com.imooc.article;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/HelloController.java
package com.imooc.article.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);

    public Object hello() &#123;
        return GraceJSONResult.ok();
    &#125;
&#125;

========================================================================
http://localhost:8001/hello
&#123;
    &quot;status&quot;: 200,
    &quot;msg&quot;: &quot;操作成功！&quot;,
    &quot;success&quot;: true,
    &quot;data&quot;: null
&#125;
</code></pre>
<pre><code class="yaml">service-article  application-dev
server:
  port: 8001

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
## setup CN from java, This is resource
website:
  domain-name: imoocnews.com

## open mybatis log in dev
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre>
<pre><code class="yaml">############################################################
#
# admin用户微服务
# web访问端口号  约定：8001
#
############################################################
server:
# port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-article
  datasource: # 数据源的相关配置
    type: com.zaxxer.hikari.HikariDataSource          # 数据源类型：HikariCP
    driver-class-name: org.mariadb.jdbc.Driver       # mysql驱动
    url: jdbc:mysql://localhost:3306/imooc-news-dev?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;sessionVariables=tx_isolation=&#39;READ-COMMITTED&#39;
    username: root
    password: root
    hikari:
      connection-timeout: 30000       # 等待连接池分配连接的最大时长（毫秒），超过这个时长还没可用的连接则发生SQLException， 默认:30秒
      minimum-idle: 5                 # 最小连接数
      maximum-pool-size: 20           # 最大连接数
      auto-commit: true               # 自动提交
      idle-timeout: 600000            # 连接超时的最大时长（毫秒），超时则被释放（retired），默认:10分钟
      pool-name: DateSourceHikariCP     # 连接池名字
      max-lifetime: 1800000           # 连接的生命时长（毫秒），超时而且没被使用则被释放（retired），默认:30分钟 1800000ms
      connection-test-query: SELECT 1
      data-source-properties:
        tx_isolation: &#39;READ-COMMITTED&#39;
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8

  data:
    mongodb:
      uri: mongodb://root:root@192.168.170.135:27017
      database: imooc-news
############################################################
#
# mybatis 配置
#
############################################################
mybatis:
  type-aliases-package: com.imooc.pojo          # 所有POJO类所在包路径
  mapper-locations: classpath:mapper/*.xml      # mapper映射文件

############################################################
#
# mybatis mapper 配置
#
############################################################
# 通用 Mapper 配置
mapper:
  mappers: com.imooc.my.mapper.MyMapper
  not-empty: false    # 在进行数据库操作的的时候，判断表达式 username != null, 是否追加 username != &#39;&#39;
  identity: MYSQL
# 分页插件配置
pagehelper:
  helperDialect: mysql
  supportMethodsArguments: true
</code></pre>
<h3 id="summernote与多文件上传需求-【发头条】"><a href="#summernote与多文件上传需求-【发头条】" class="headerlink" title="summernote与多文件上传需求 【发头条】"></a>summernote与多文件上传需求 【发头条】</h3><p><a target="_blank" rel="noopener" href="https://summernote.org/">https://summernote.org/</a></p>
<pre><code class="html">【前端工程里面的】createArticle.html
...
&lt;script src=&quot;libs/vue.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;libs/axios.min.js&quot;&gt;&lt;/script&gt;

&lt;link href=&quot;./libs/bootstrap/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;script src=&quot;./libs/jquery-3.4.1.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;libs/layDate-v5.0.9/laydate/laydate.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;./libs/bootstrap/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;link href=&quot;./libs/summernote/dist/summernote.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;script src=&quot;./libs/summernote/dist/summernote.js&quot;&gt;&lt;/script&gt;
&lt;!-- 中文汉化 --&gt;
&lt;script src=&quot;libs/summernote/lang/summernote-zh-CN.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/app.js&quot;&gt;&lt;/script&gt;

&lt;script type=&quot;text/javascript&quot;&gt;

......
&lt;!-- 富文本编辑器 --&gt;
        &lt;div id=&quot;editor2&quot; class=&quot;editor-container&quot;&gt;

            &lt;div class=&quot;article-title-wrapper&quot;&gt;
                &lt;input id=&quot;title&quot; class=&quot;article-title&quot; placeholder=&quot;请输入文字标题（6-30长度）&quot; v-model=&quot;articleTitle&quot; maxlength=&quot;30&quot;/&gt;
            &lt;/div&gt;

            &lt;div class=&quot;article-content-wrapper&quot;&gt;
                &lt;div id=&quot;summernote&quot; class=&quot;summernote&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;

            &lt;div class=&quot;other-info&quot;&gt;
                &lt;div class=&quot;cover-wrapper&quot;&gt;
                    &lt;div class=&quot;cover&quot;&gt;文章领域&lt;/div&gt;
                    &lt;div class=&quot;choose-type&quot;&gt;
                        &lt;!-- &lt;select v-model=&quot;articleCategory&quot;&gt;
                            &lt;option value=&quot;0&quot;&gt;请选择&lt;/option&gt;
                            &lt;option value=&quot;1&quot;&gt;汽车&lt;/option&gt;
                            &lt;option value=&quot;2&quot;&gt;科技&lt;/option&gt;
                            &lt;option value=&quot;3&quot;&gt;历史&lt;/option&gt;
                        &lt;/select&gt; --&gt;

                        &lt;select v-model=&quot;articleCategory&quot;&gt;
                            &lt;option :value=&quot;cat.id&quot; v-for=&quot;(cat, index) in catList&quot; v-key=&quot;index&quot;&gt;&#123;&#123;cat.name&#125;&#125;&lt;/option&gt;
                        &lt;/select&gt;
                        
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;cover-wrapper&quot;&gt;
                    &lt;div class=&quot;cover&quot;&gt;文章封面&lt;/div&gt;
                    &lt;div class=&quot;choose-type&quot;&gt;
                        &lt;div&gt;&lt;input type=&quot;radio&quot; name=&quot;articleType&quot; v-model=&quot;articleType&quot; value=&quot;1&quot; checked/&gt;&lt;span class=&quot;choose-words&quot;&gt;单封面&lt;/span&gt;&lt;/div&gt;
                        &lt;div style=&quot;margin-left: 30px;&quot;&gt;&lt;input type=&quot;radio&quot; v-model=&quot;articleType&quot; value=&quot;2&quot; name=&quot;articleType&quot;/&gt;&lt;span class=&quot;choose-words&quot;&gt;无封面&lt;/span&gt;&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;cover-wrapper&quot; v-show=&quot;articleType==1&quot;&gt;
                    &lt;div class=&quot;cover&quot;&gt;&lt;/div&gt;
                    &lt;div class=&quot;choose-cover&quot;&gt;
                        &lt;div class=&quot;uploader-comp&quot;&gt;
                            &lt;div id=&quot;block-choose&quot; class=&quot;block-choose&quot; :style=&quot;coverStyle&quot;&gt;
                                &lt;img src=&quot;./img/icon-go-upload.png&quot; style=&quot;width: 20px; height: 20px; align-self: center;&quot; v-show=&quot;articleCover == &#39;&#39; || articleCover == null&quot;/&gt;
                            &lt;/div&gt;
                            &lt;input type=&quot;file&quot; @change=&quot;uploadCover&quot; @mouseover=&quot;mouseOver&quot; @mouseout=&quot;mouseOut&quot; id=&quot;inputPic&quot; class=&quot;inputPic&quot; accept=&quot;image/jpeg,image/jpg,image/png&quot;&gt;
                        &lt;/div&gt;
                        &lt;div style=&quot;margin-top: 10px; color: #9b9d9e;&quot;&gt;请上传JPG、JPEG、PNG格式的封面图噢~&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div class=&quot;publish-bottom&quot;&gt;
                &lt;div class=&quot;buttons&quot;&gt;
                    &lt;button class=&quot;white-btn&quot; type=&quot;button&quot; @click=&quot;goBack&quot;&gt;返回&lt;/button&gt;
                    &lt;button class=&quot;white-btn&quot; type=&quot;button&quot; @click=&quot;preview&quot;&gt;预览&lt;/button&gt;
                    &lt;!-- &lt;button class=&quot;white-btn&quot; type=&quot;button&quot; @click=&quot;save&quot;&gt;保存草稿&lt;/button&gt; --&gt;
                    &lt;!-- FIXME: 计算剩余时间，使用RMQ延时队列，或分布式定时任务 --&gt;
                    &lt;button class=&quot;white-btn&quot; type=&quot;button&quot; @click=&quot;doTiming&quot;&gt;&#123;&#123;appointWords&#125;&#125;&lt;/button&gt;
                    
                    &lt;input type=&quot;text&quot; class=&quot;timing-date-picker&quot; placeholder=&quot;定时日期&quot; id=&quot;choose-date&quot; v-show=&quot;isAppoint==1&quot; readonly&gt;

                    &lt;button class=&quot;red-btn&quot; type=&quot;button&quot; @click=&quot;publish&quot;&gt;发布文章&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

......
// 初始化编辑器
            $(&#39;#summernote&#39;).summernote(&#123;
                placeholder: &#39;请输入正文...&#39;,
                lang: &#39;zh-CN&#39;,
                height: 600,
                width: 800,
                border: 0,
                // disableDragAndDrop: true, // 禁止文件拖放
                toolbar: [
                    [&#39;style&#39;, [&#39;style&#39;]],
                    [&#39;font&#39;, [&#39;bold&#39;, &#39;underline&#39;, &#39;clear&#39;]],
                    [&#39;color&#39;, [&#39;color&#39;]],
                    [&#39;para&#39;, [&#39;ul&#39;, &#39;ol&#39;, &#39;paragraph&#39;]],
                    [&#39;table&#39;, [&#39;table&#39;]],
                    [&#39;insert&#39;, [&#39;link&#39;, &#39;picture&#39;]],
                    [&#39;view&#39;, [&#39;fullscreen&#39;, &#39;codeview&#39;, &#39;help&#39;]]
                ],
</code></pre>
<h3 id="实现多文件上传uploadSomeFiles-【发头条】"><a href="#实现多文件上传uploadSomeFiles-【发头条】" class="headerlink" title="实现多文件上传uploadSomeFiles 【发头条】"></a>实现多文件上传<del>uploadSomeFiles</del> 【发头条】</h3><p><a target="_blank" rel="noopener" href="http://writer.imoocnews.com:9090/imooc-news/writer/createArticle.html">媒体号作家中心 | 发文章 (imoocnews.com)</a></p>
<pre><code class="java">service-api  com/imooc/api/controller/files/FileUploaderControllerApi.java
package com.imooc.api.controller.files;

@Api(value = &quot;文件上传的controller&quot;,tags = &#123;&quot;xx功能的Controller&quot;&#125;)
@RequestMapping(&quot;fs&quot;)
public interface FileUploaderControllerApi &#123;
    /**
     * 上传单文件
     * @param userId
     * @param file
     * @return
     * @throws Exception
     */
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;上传用户头像&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadFace&quot;)
    public GraceJSONResult uploadFace(@RequestParam String userId, MultipartFile file) throws Exception;

    /**
     * 上传多文件
     * @param userId
     * @param files
     * @return
     * @throws Exception
     */
    @ApiOperation(value = &quot;上传用户头像&quot;,notes = &quot;上传用户头像&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/uploadSomeFiles&quot;)  //因为前端createArticle.html 178行 multiForm.append(&#39;files&#39;,f,f.name);
    public GraceJSONResult uploadSomeFiles(@RequestParam String userId, MultipartFile[] files) throws Exception;
......
&#125;
</code></pre>
<pre><code class="java">service-file  com/imooc/files/controller/FileUploaderController.java
......
@Override
    public GraceJSONResult uploadSomeFiles(String userId, MultipartFile[] files) throws Exception &#123;
        // 声明一个list，用于存放多个图片的地址路径，返回到前端
        List&lt;String&gt; imageUrlList = new ArrayList&lt;&gt;();
        if (files != null &amp;&amp; files.length &gt; 0)&#123;
            for (MultipartFile file: files)&#123;
                String path = &quot;&quot;;
                if (file != null)&#123;
                    // 获得文件上传的名称
                    String fileName = file.getOriginalFilename();
                    //判断文件名不能为空
                    if (StringUtils.isNotBlank(fileName))&#123;
                        String fileNameArr[] = fileName.split(&quot;\\.&quot;);
                        //获得后缀名
                        String suffix = fileNameArr[fileNameArr.length - 1];
                        //防止黑客上传文件攻击服务器 判断后缀符合我们的预定义规范
                        if (!suffix.equalsIgnoreCase(&quot;png&quot;) &amp;&amp;
                                !suffix.equalsIgnoreCase(&quot;jpg&quot;) &amp;&amp;
                                !suffix.equalsIgnoreCase(&quot;jpeg&quot;)
                        )&#123;
                           continue;
                        &#125;
                        // fdfs执行上传     要让外面得以访问 ①需要把内网的环境发布到公网 [内网穿透]  ②路由器端口映射到外网  ③fastdfs安装到公网里
                        // path = uploaderService.uploadFdfs(file, suffix);
                        // OSS执行上传
                        path = uploaderService.uploadOSS(file, userId, suffix);
                    &#125;else &#123;
                        continue;
                    &#125;
                &#125;else &#123;
                    continue;
                &#125;
                String finalPath = &quot;&quot;;
                if (StringUtils.isNotBlank(path))&#123;
//            finalPath = fileResource.getHost() + path;
                    finalPath = fileResource.getOssHost() + path;
                    // FIXME: 放入到imageUrlList之前，需要对图片做一次审核 [doAliImageReview]
                    imageUrlList.add(finalPath);
                &#125;  else&#123;
                    continue;
                &#125;
//                return GraceJSONResult.ok(finalPath);
//        return GraceJSONResult.ok(doAliImageReview(finalPath)); //这里加了图片审核咯
            &#125;
        &#125;
        return GraceJSONResult.ok(imageUrlList);
    &#125;
......
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java 
package com.imooc.api.config;
//【增加拦截uploadSomeFiles】
@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UserActiveInterceptor userActiveInterceptor() &#123;
        return new UserActiveInterceptor();
    &#125;

    @Bean
    public AdminTokenInterceptor adminTokenInterceptor() &#123;
        return new AdminTokenInterceptor();
    &#125;


    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;)
                .addPathPatterns(&quot;/fs/uploadFace&quot;)
                .addPathPatterns(&quot;/fs/uploadSomeFiles&quot;);

        registry.addInterceptor(adminTokenInterceptor())//继续添加拦截器：查询admin列表 创建新admin用户
                .addPathPatterns(&quot;/adminMng/adminIsExist&quot;)
                .addPathPatterns(&quot;/adminMng/addNewAdmin&quot;)
                .addPathPatterns(&quot;/adminMng/getAdminList&quot;)
                .addPathPatterns(&quot;/fs/uploadToGridFS&quot;)
                .addPathPatterns(&quot;/friendLinkMng/saveOrUpdateFriendLink&quot;)
                .addPathPatterns(&quot;/friendLinkMng/getFriendLinkList&quot;)
                .addPathPatterns(&quot;/friendLinkMng/delete&quot;)
                .addPathPatterns(&quot;/categoryMng/saveOrUpdateCategory&quot;)
                .addPathPatterns(&quot;/categoryMng/getCatList&quot;);

        registry.addInterceptor(userActiveInterceptor())
                .addPathPatterns(&quot;/fs/uploadSomeFiles&quot;);
    &#125;
&#125;
</code></pre>
<h3 id="获得列表-业务接口解耦与Redis缓存应用-【文章领域】"><a href="#获得列表-业务接口解耦与Redis缓存应用-【文章领域】" class="headerlink" title="获得列表_业务接口解耦与Redis缓存应用 【文章领域】"></a>获得列表_业务接口解耦与Redis缓存应用 【文章领域】</h3><blockquote>
<p>getCatList 和 getCats 一个是用户端一个是admin 业务体系不一样 所以同样是查询分类列表<br>但是还是应该拆开 使耦合减少 得到高效解耦<br>查询放在Redis里面 效率变高</p>
<p><a target="_blank" rel="noopener" href="http://writer.imoocnews.com:9090/imooc-news/writer/createArticle.html">媒体号作家中心 | 发文章 (imoocnews.com)</a><br>刷新一下 文章领域就可以找到那些分类<br>Redis里面会有信息 redis_all_category<br>[{“id”:2,”name”:”汽车”,”tagColor”:”#8939bd”},{“id”:3,”name”:”娱乐”,”tagColor”:”#c939aa”},{“id”:5,”name”:”地理”,”tagColor”:”#57394a”},{“id”:6,”name”:”历史”,”tagColor”:”#29ab4a”},{“id”:7,”name”:”科技”,”tagColor”:”#2467bc”},{“id”:9,”name”:”体育”,”tagColor”:”#c98f4a”},{“id”:10,”name”:”搞笑”,”tagColor”:”#68b84a”},{“id”:11,”name”:”技术”,”tagColor”:”#c9394a”},{“id”:12,”name”:”慕课”,”tagColor”:”#682aa8”},{“id”:13,”name”:”技能”,”tagColor”:”#c9394a”},{“id”:14,”name”:”课网”,”tagColor”:”#c9a24a”}]</p>
</blockquote>
<pre><code class="java">service-api  com/imooc/api/controller/admin/CategoryMngControllerApi.java
// 【getCasts】
package com.imooc.api.controller.admin;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.SaveCatrgoryBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@Api(value = &quot;文章分类维护&quot;, tags = &#123;&quot;文章分类维护controller&quot;&#125;)
@RequestMapping(&quot;categoryMng&quot;)
public interface CategoryMngControllerApi &#123;
    @PostMapping(&quot;saveOrUpdateCategory&quot;)
    @ApiOperation(value = &quot;新增或修改分类&quot;, notes = &quot;新增或修改分类&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult saveOrUpdateCategory(@RequestBody @Valid SaveCatrgoryBO saveCatrgoryBO,
                                                BindingResult result);
    @PostMapping(&quot;getCatList&quot;)
    @ApiOperation(value = &quot;查询分类列表&quot;, notes = &quot;查询分类列表&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult getCatList();

    @GetMapping(&quot;getCats&quot;)
    @ApiOperation(value = &quot;用户端查询分类列表&quot;, notes = &quot;用户端查询分类列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult getCats();
&#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/CategoryMngController.java
@Override
    public GraceJSONResult getCats() &#123;
        // 先从redis中查询，如果有，则返回，如果没有，则查询数据库库后先放缓存，放返回
        String allCatJson = redis.get(REDIS_ALL_CATEGORY);

        List&lt;Category&gt; categoryList = null;
        if (StringUtils.isBlank(allCatJson)) &#123;
            categoryList = categoryService.queryCategoryList();
            redis.set(REDIS_ALL_CATEGORY, JsonUtils.objectToJson(categoryList));
        &#125; else &#123;
            categoryList = JsonUtils.jsonToList(allCatJson, Category.class);
        &#125;

        return GraceJSONResult.ok(categoryList);
    &#125;
</code></pre>
<h3 id="admin端维护数据缓存-【文章领域】"><a href="#admin端维护数据缓存-【文章领域】" class="headerlink" title="admin端维护数据缓存 【文章领域】"></a>admin端维护数据缓存 【文章领域】</h3><blockquote>
<p><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/categoryMng.html">文章分类 | 运营管理平台 (imoocnews.com)</a><br>在管理员修改文章类型后 【课网 → 课课】<br><a target="_blank" rel="noopener" href="http://writer.imoocnews.com:9090/imooc-news/writer/createArticle.html">媒体号作家中心 | 发文章 (imoocnews.com)</a><br>回到用户发文章的文章领域类型也会一起修改<br><a target="_blank" rel="noopener" href="http://www.imoocnews.com:9090/imooc-news/portal/index.html">慕课新闻 | 风间影月 (imoocnews.com)</a><br>同时首页上方的栏目框也会修改</p>
</blockquote>
<pre><code class="java">service-admin  com/imooc/admin/service/impl/CategoryServiceImpl.java
@Service
public class CategoryServiceImpl extends BaseService implements CategoryService &#123;
    @Autowired
    public CategoryMapper categoryMapper;

    @Transactional
    @Override
    public void createCategory(Category category) &#123;
// 分类不会很多，所以id不需要自增，这个表的数据也不会多到几万甚至分表，数据都会集中在一起
        int result = categoryMapper.insert(category);
        if (result != 1)&#123;
            GraceException.display(ResponseStatusEnum.SYSTEM_OPERATION_ERROR);
            /**
             * 不建议如下做法：
             * 1. 查询redis中的categoryList
             * 2. 转化categoryList为list类型
             * 3. 在categoryList中add一个当前的category
             * 4. 再次转换categoryList为json，并存入redis中
             */
            // 直接使用redis删除缓存即可，用户端在查询的时候会直接查库，再把最新的数据放入到缓存中
            redis.del(REDIS_ALL_CATEGORY);
        &#125;
    &#125;

    @Transactional
    @Override
    public void modifyCategory(Category category) &#123;
        int result = categoryMapper.updateByPrimaryKey(category);
        if (result != 1) &#123;
            GraceException.display(ResponseStatusEnum.SYSTEM_OPERATION_ERROR);
        &#125;
        // 直接使用redis删除缓存即可，用户端在查询的时候会直接查库，再把最新的数据放入到缓存中
        redis.del(REDIS_ALL_CATEGORY);
    &#125;
......
</code></pre>
<h3 id="发布文章入库Controller及验证【发头条】"><a href="#发布文章入库Controller及验证【发头条】" class="headerlink" title="发布文章入库Controller及验证【发头条】"></a>发布文章入库Controller及验证【发头条】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticleControllerApi.java
package com.imooc.api.controller.article;

@Api(value = &quot;文章业务的controller&quot;, tags = &#123;&quot;文章业务的controller&quot;&#125;)
@RequestMapping(&quot;article&quot;)
public interface ArticleControllerApi &#123;
    @PostMapping(&quot;createArticle&quot;)
    @ApiOperation(value = &quot;用户发文&quot;, notes = &quot;用户发文&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult createArticle(@RequestBody @Valid NewArticleBO newArticleBO, BindingResult result);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
package com.imooc.article.controller;

@RestController
public class ArticleController extends BaseController implements ArticleControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(ArticleController.class);

    @Override
    public GraceJSONResult createArticle(NewArticleBO newArticleBO, BindingResult result) &#123;
            if (result.hasErrors())&#123;
                // 判断BindingResult是否保存错误的验证信息，如果有，则直接return
                Map&lt;String, String&gt; errorMap = getErrors(result);
                return GraceJSONResult.errorMap(errorMap);
            &#125;
            // 判断文章封面类型，单图必填，纯文字则设置为空
            if (newArticleBO.getArticleType() == ArticleCoverType.ONE_IMAGE.type)&#123;
                if (StringUtils.isBlank(newArticleBO.getArticleCover()))&#123;
                    return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_CATEGORY_NOT_EXIST_ERROR);
                &#125;
            &#125; else if (newArticleBO.getArticleType() == ArticleCoverType.WORDS.type) &#123;
                newArticleBO.setArticleCover(&quot;&quot;);
            &#125;

        // 判断分类id是否存在
        String allCatJson = redis.get(REDIS_ALL_CATEGORY);
        Category temp = null;
        if (StringUtils.isBlank(allCatJson)) &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.SYSTEM_OPERATION_ERROR);
        &#125; else &#123;
            List&lt;Category&gt; catList =
                    JsonUtils.jsonToList(allCatJson, Category.class);
            for (Category c : catList) &#123;
                if(c.getId() == newArticleBO.getCategoryId()) &#123;
                    temp = c;
                    break;
                &#125;
            &#125;
            if (temp == null) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_CATEGORY_NOT_EXIST_ERROR);
            &#125;
        &#125;
        return GraceJSONResult.ok();
    &#125;
&#125;
http://writer.imoocnews.com:9090/imooc-news/writer/createArticle.html
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/bo/NewArticleBO.java
package com.imooc.pojo.bo;

import com.fasterxml.jackson.annotation.JsonFormat;
import org.hibernate.validator.constraints.Length;

import javax.validation.constraints.Max;
import javax.validation.constraints.Min;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import java.util.Date;
/**
 * 用户发文的BO
 */
public class NewArticleBO &#123;

    @NotBlank(message = &quot;文章标题不能为空&quot;)
    @Length(max = 30, message = &quot;文章标题长度不能超过30&quot;)
    private String title;

    @NotBlank(message = &quot;文章内容不能为空&quot;)
    @Length(max = 9999, message = &quot;文章内容长度不能超过10000&quot;)
    private String content;

    @NotNull(message = &quot;请选择文章领域&quot;)
    private Integer categoryId;

    @NotNull(message = &quot;请选择正确的文章封面类型&quot;)
    @Min(value = 1, message = &quot;请选择正确的文章封面类型&quot;)
    @Max(value = 2, message = &quot;请选择正确的文章封面类型&quot;)
    private Integer articleType;
    private String articleCover;

    @NotNull(message = &quot;文章发布类型不正确&quot;)
    @Min(value = 0, message = &quot;文章发布类型不正确&quot;)
    @Max(value = 1, message = &quot;文章发布类型不正确&quot;)
    private Integer isAppoint;

    @JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;) // 前端日期字符串传到后端后，转换为Date类型
    private Date publishTime;

    @NotBlank(message = &quot;用户未登录&quot;)
    private String publishUserId;
&#125;Getter + Setter
</code></pre>
<h3 id="发布文章入库Service及联调【也可以定时发布】"><a href="#发布文章入库Service及联调【也可以定时发布】" class="headerlink" title="发布文章入库Service及联调【也可以定时发布】"></a>发布文章入库Service及联调【也可以定时发布】</h3><p><a target="_blank" rel="noopener" href="http://writer.imoocnews.com:9090/imooc-news/writer/contentMng.html">http://writer.imoocnews.com:9090/imooc-news/writer/contentMng.html</a><br>发布完成后去数据库article中就会存在数据了</p>
<pre><code class="xml">generator-datebase  generatorConfig-article.xml [逆向生成]
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE generatorConfiguration
        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;

&lt;generatorConfiguration&gt;
    &lt;context id=&quot;MysqlContext&quot; targetRuntime=&quot;MyBatis3Simple&quot; defaultModelType=&quot;flat&quot;&gt;
        &lt;property name=&quot;beginningDelimiter&quot; value=&quot;`&quot;/&gt;
        &lt;property name=&quot;endingDelimiter&quot; value=&quot;`&quot;/&gt;

        &lt;!-- 通用mapper所在目录 --&gt;
        &lt;plugin type=&quot;tk.mybatis.mapper.generator.MapperPlugin&quot;&gt;
            &lt;property name=&quot;mappers&quot; value=&quot;com.imooc.my.mapper.MyMapper&quot;/&gt;
        &lt;/plugin&gt;

        &lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot;
                        connectionURL=&quot;jdbc:mysql://localhost:3306/imooc-news-dev&quot;
                        userId=&quot;root&quot;
                        password=&quot;root&quot;&gt;
        &lt;/jdbcConnection&gt;

        &lt;!-- 对应生成的pojo所在包 --&gt;
        &lt;javaModelGenerator targetPackage=&quot;com.imooc.pojo&quot; targetProject=&quot;mybatis-generator-database/src/main/java&quot;/&gt;

        &lt;!-- 对应生成的mapper所在目录 --&gt;
        &lt;sqlMapGenerator targetPackage=&quot;mapper.article&quot; targetProject=&quot;mybatis-generator-database/src/main/resources&quot;/&gt;

        &lt;!-- 配置mapper对应的java映射 --&gt;
        &lt;javaClientGenerator targetPackage=&quot;com.imooc.article.mapper&quot; targetProject=&quot;mybatis-generator-database/src/main/java&quot; type=&quot;XMLMAPPER&quot;/&gt;

        &lt;!-- 数据库表 --&gt;
        &lt;table tableName=&quot;comments&quot;&gt;&lt;/table&gt;

    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
</code></pre>
<pre><code class="java">generator-datebase  com/imooc/mybatis/utils/ArticleGenerator.java
//[运行时候就会自动生成对应文件 目录是上面的generatorConfig-article.xml]
package com.imooc.mybatis.utils;

import org.mybatis.generator.api.MyBatisGenerator;
import org.mybatis.generator.config.Configuration;
import org.mybatis.generator.config.xml.ConfigurationParser;
import org.mybatis.generator.internal.DefaultShellCallback;

import java.io.File;
import java.util.ArrayList;
import java.util.List;


public class ArticleGenerator &#123;

    public void generator() throws Exception &#123;

        List&lt;String&gt; warnings = new ArrayList&lt;String&gt;();
        boolean overwrite = true;
        //指定 逆向工程配置文件
        File configFile = new File(&quot;mybatis-generator-database&quot;
                                            + File.separator
                                            + &quot;generatorConfig-article.xml&quot;);
        ConfigurationParser cp = new ConfigurationParser(warnings);
        Configuration config = cp.parseConfiguration(configFile);
        DefaultShellCallback callback = new DefaultShellCallback(overwrite);
        MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config,
                callback, warnings);
        myBatisGenerator.generate(null);

    &#125; 
    
    public static void main(String[] args) throws Exception &#123;
        try &#123;
            ArticleGenerator generatorSqlmap = new ArticleGenerator();
            generatorSqlmap.generator();
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  mapper/ArticleMapper.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.ArticleMapper&quot; &gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Article&quot; &gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;title&quot; property=&quot;title&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;category_id&quot; property=&quot;categoryId&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;article_type&quot; property=&quot;articleType&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;article_cover&quot; property=&quot;articleCover&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;is_appoint&quot; property=&quot;isAppoint&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;article_status&quot; property=&quot;articleStatus&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;publish_user_id&quot; property=&quot;publishUserId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;publish_time&quot; property=&quot;publishTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
    &lt;result column=&quot;read_counts&quot; property=&quot;readCounts&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;comment_counts&quot; property=&quot;commentCounts&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;mongo_file_id&quot; property=&quot;mongoFileId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;is_delete&quot; property=&quot;isDelete&quot; jdbcType=&quot;INTEGER&quot; /&gt;
    &lt;result column=&quot;create_time&quot; property=&quot;createTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
    &lt;result column=&quot;update_time&quot; property=&quot;updateTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
    &lt;result column=&quot;content&quot; property=&quot;content&quot; jdbcType=&quot;LONGVARCHAR&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
package com.imooc.article.service;

import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;

import java.util.List;

public interface ArticleService &#123;
    /**
     * 发布文章
     */
    public void createArticle(NewArticleBO newArticleBO, Category category);

&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
package com.imooc.article.service.impl;

import com.imooc.api.service.BaseService;
import com.imooc.article.mapper.ArticleMapper;
import com.imooc.article.service.ArticleService;
import com.imooc.enums.ArticleAppointType;
import com.imooc.enums.ArticleReviewStatus;
import com.imooc.enums.YesOrNo;
import com.imooc.exception.GraceException;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.Article;
import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;
import com.imooc.utils.DateUtil;
import org.apache.commons.lang3.StringUtils;
import org.n3r.idworker.Sid;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;
import java.util.List;

import static com.imooc.api.BaseController.REDIS_ALL_CATEGORY;


@Service
public class ArticleServiceImpl extends BaseService implements ArticleService &#123;
    @Autowired
    private ArticleMapper articleMapper; //红色波浪线就去ArticleMapper上面加@Repository
    @Autowired
    private Sid sid;

    @Transactional
    @Override
    public void createArticle(NewArticleBO newArticleBO, Category category) &#123;
        String articleId = sid.nextShort();

        Article article = new Article();
        BeanUtils.copyProperties(newArticleBO, article);

        article.setId(articleId);
        article.setCategoryId(category.getId());
        article.setArticleStatus(ArticleReviewStatus.REVIEWING.type);
        article.setCommentCounts(0);
        article.setReadCounts(0);

        article.setIsDelete(YesOrNo.NO.type);
        article.setCreateTime(new Date());
        article.setUpdateTime(new Date());

        if (article.getIsAppoint() == ArticleAppointType.TIMING.type) &#123;
            article.setPublishTime(newArticleBO.getPublishTime()); //用户可以在前端选择定时发布
        &#125; else if (article.getIsAppoint() == ArticleAppointType.IMMEDIATELY.type) &#123;
            article.setPublishTime(new Date());
        &#125;

        int res = articleMapper.insert(article);
        if (res != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_CREATE_ERROR);
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/Article.java
package com.imooc.pojo;

import javax.persistence.Column;
import javax.persistence.Id;
import java.util.Date;

public class Article &#123;
    @Id
    private String id;

    /**
     * 文章标题
     */
    private String title;

    /**
     * 文章所属分类id
     */
    @Column(name = &quot;category_id&quot;)
    private Integer categoryId;

    /**
     * 文章类型，1：图文（1张封面），2：纯文字
     */
    @Column(name = &quot;article_type&quot;)
    private Integer articleType;

    /**
     * 文章封面图，article_type=1 的时候展示
     */
    @Column(name = &quot;article_cover&quot;)
    private String articleCover;

    /**
     * 是否是预约定时发布的文章，1：预约（定时）发布，0：即时发布    在预约时间到点的时候，把1改为0，则发布
     */
    @Column(name = &quot;is_appoint&quot;)
    private Integer isAppoint;

    /**
     * 文章状态，1：审核中（用户已提交），2：机审结束，等待人工审核，3：审核通过（已发布），4：审核未通过；5：文章撤回（已发布的情况下才能撤回和删除）
     */
    @Column(name = &quot;article_status&quot;)
    private Integer articleStatus;

    /**
     * 发布者用户id
     */
    @Column(name = &quot;publish_user_id&quot;)
    private String publishUserId;

    /**
     * 文章发布时间（也是预约发布的时间）
     */
    @Column(name = &quot;publish_time&quot;)
    private Date publishTime;

    /**
     * 用户累计点击阅读数（喜欢数）（点赞） - 放redis
     */
    @Column(name = &quot;read_counts&quot;)
    private Integer readCounts;

    /**
     * 文章评论总数。评论防刷，距离上次评论需要间隔时间控制几秒
     */
    @Column(name = &quot;comment_counts&quot;)
    private Integer commentCounts;

    @Column(name = &quot;mongo_file_id&quot;)
    private String mongoFileId;

    /**
     * 逻辑删除状态，非物理删除，1：删除，0：未删除
     */
    @Column(name = &quot;is_delete&quot;)
    private Integer isDelete;

    /**
     * 文章的创建时间
     */
    @Column(name = &quot;create_time&quot;)
    private Date createTime;

    /**
     * 文章的修改时间
     */
    @Column(name = &quot;update_time&quot;)
    private Date updateTime;

    /**
     * 文章内容，长度不超过9999，需要在前后端判断
     */
    private String content;
</code></pre>
<h3 id="构建定时任务-定时发布文章【定时任务】"><a href="#构建定时任务-定时发布文章【定时任务】" class="headerlink" title="构建定时任务 定时发布文章【定时任务】"></a>构建定时任务 定时发布文章【定时任务】</h3><p><a target="_blank" rel="noopener" href="https://cron.qqe2.com/">在线Cron表达式生成器 (qqe2.com)</a></p>
<pre><code class="java">service-article  com/imooc/article/task/TaskPublishArticles.java
package com.imooc.article.task;

import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

import java.time.LocalDateTime;

@Configuration  // 1.标记配置类，使得springboot容器扫描到
@EnableScheduling // 2.开启定时任务
public class TaskPublishArticles &#123;
    @Scheduled(cron = &quot;0/3 * * * * ? &quot;)
    private void publishArticles()&#123;
        System.out.println(&quot;执行定时任务：&quot; + LocalDateTime.now());
    &#125;
&#125;

=================================================================
执行定时任务：2024-07-22T14:34:54.009
执行定时任务：2024-07-22T14:34:57.013
执行定时任务：2024-07-22T14:35:00.012
执行定时任务：2024-07-22T14:35:03.002
执行定时任务：2024-07-22T14:35:06.001
执行定时任务：2024-07-22T14:35:09.006
</code></pre>
<pre><code class="java">service-article  com/imooc/article/task/TaskPublishArticles.java
package com.imooc.article.task;

import com.imooc.article.service.ArticleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

import java.time.LocalDateTime;

@Configuration  // 1.标记配置类，使得springboot容器扫描到
@EnableScheduling // 2.开启定时任务
public class TaskPublishArticles &#123;
    @Autowired
    private ArticleService articleService;
    // 添加定时任务，注明定时任务的表达式
    // 【若文章数量庞大 需要RabbitMQ去做优化 后面会讲！】
    @Scheduled(cron = &quot;0/3 * * * * ? &quot;)
    private void publishArticles()&#123;
        System.out.println(&quot;执行定时任务：&quot; + LocalDateTime.now());
        // 4. 调用文章service，把当前时间应该发布的定时文章，状态改为即时
        articleService.updateAppointToPublish();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/mapper/ArticleMapperCustom.java
package com.imooc.article.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Article;
import org.springframework.stereotype.Repository;

@Repository
public interface ArticleMapperCustom extends MyMapper&lt;Article&gt; &#123;
    public void updateAppointToPublish();
&#125;
</code></pre>
<pre><code class="java">service-article resources/mapper/ArticleMapperCustom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.ArticleMapperCustom&quot; &gt;
    &lt;update id=&quot;updateAppointToPublish&quot;&gt;
        update
            article
        set
            is_appoint = 0
        where
            publish_time &amp;lt;= NOW()
        and
            is_appoint = 1
    &lt;/update&gt;
&lt;/mapper&gt;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
package com.imooc.article.service;

import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;

import java.util.List;

public interface ArticleService &#123;

    /**
     * 发布文章
     */
    public void createArticle(NewArticleBO newArticleBO, Category category);

    /**
     * 更新定时发布为即使发布
     */
    public void updateAppointToPublish();

&#125;
</code></pre>
<pre><code class="java">service-article   com/imooc/article/service/impl/ArticleServiceImpl.java

@Transactional //添加事务[更新操作]
    @Override
    public void updateAppointToPublish() &#123;
        articleMapperCustom.updateAppointToPublish();
    &#125;
</code></pre>
<h3 id="文章列表展示-【内容管理】"><a href="#文章列表展示-【内容管理】" class="headerlink" title="文章列表展示 【内容管理】"></a>文章列表展示 【内容管理】</h3><p>[mybatis中关于example类详解mybatis的Example</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/suizhikuo/p/13191209.html">Criteria]的使用 - 万事俱备就差个程序员 - 博客园 (cnblogs.com)</a></p>
<pre><code class="java">service-api  com/imooc/api/controller/article/ArticleControllerApi.java
@Api(value = &quot;文章业务的controller&quot;, tags = &#123;&quot;文章业务的controller&quot;&#125;)
@RequestMapping(&quot;article&quot;)
public interface ArticleControllerApi &#123;

    @PostMapping(&quot;createArticle&quot;)
    @ApiOperation(value = &quot;用户发文&quot;, notes = &quot;用户发文&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult createArticle(@RequestBody @Valid NewArticleBO newArticleBO, BindingResult result);

    @PostMapping(&quot;queryMyList&quot;) //对应着前端contentMng.html 340行
    @ApiOperation(value = &quot;查询用户的所有文章列表&quot;, notes = &quot;查询用户的所有文章列表&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult queryMyList(@RequestParam String userId,
                                       @RequestParam String keyword,
                                       @RequestParam Integer status,
                                       @RequestParam Date startDate,
                                       @RequestParam Date endDate,
                                       @RequestParam Integer page,
                                       @RequestParam Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
@Override
    public GraceJSONResult queryMyList(String userId, String keyword, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize) &#123;
        if (StringUtils.isBlank(userId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_QUERY_PARAMS_ERROR);
        &#125;
        if (page == null)&#123;
            page = COMMON_START_PAGE;
        &#125;
        if (pageSize == null)&#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;
        // 查询我的列表，调用service
        PagedGridResult grid =  articleService.queryMyArticleList(userId, keyword, status, startDate, endDate, page, pageSize);
        return GraceJSONResult.ok(grid);
    &#125;
=========================================================================
http://writer.imoocnews.com:9090/imooc-news/writer/contentMng.html
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
package com.imooc.article.service;

import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;
import com.imooc.utils.PagedGridResult;

import java.util.Date;
import java.util.List;

public interface ArticleService &#123;

    /**
     * 发布文章
     */
    public void createArticle(NewArticleBO newArticleBO, Category category);

    /**
     * 更新定时发布为即使发布
     */
    public void updateAppointToPublish();

    /**
     * 用户中心-查询我的文章列表
     */
    public PagedGridResult queryMyArticleList(String userId, String keyword, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize);

&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
@Service
public class ArticleServiceImpl extends BaseService implements ArticleService &#123;
    @Autowired
    private ArticleMapper articleMapper; //红色波浪线就去ArticleMapper上面加@Repository
    @Autowired
    private ArticleMapperCustom articleMapperCustom;
    @Autowired
    private Sid sid;
     //匹配到前端的一种显示方法
    @Override
    public PagedGridResult queryMyArticleList(String userId, String keyword, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize) &#123;
        Example example = new Example(Article.class);
        example.orderBy(&quot;createTime&quot;).desc();
        Example.Criteria criteria = example.createCriteria();
        criteria.andEqualTo(&quot;publishUserId&quot;, userId);
        if (StringUtils.isNotBlank(keyword))&#123;
            //模糊查询
            criteria.andLike(&quot;title&quot;, &quot;%&quot;+keyword+&quot;%&quot;);
        &#125;
        if (ArticleReviewStatus.isArticleStatusValid(status))&#123;
            // 有效就匹配 无效就查询所有
            criteria.andEqualTo(&quot;articleStatus&quot;, status);
        &#125;
        // 12是在前端显示审核中
        if (status != null &amp;&amp; status == 12)&#123;
            criteria.andEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.REVIEWING.type)
                    .orEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.WAITING_MANUAL.type);
        &#125;
        // 逻辑删除
        criteria.andEqualTo(&quot;isDelete&quot;, YesOrNo.NO.type);
        if (startDate != null)&#123; //大于等于
            criteria.andGreaterThanOrEqualTo(&quot;publishTime&quot;, startDate);
        &#125;
        if (startDate != null)&#123; //小于等于
            criteria.andLessThanOrEqualTo(&quot;publishTime&quot;,endDate);
        &#125;
        PageHelper.startPage(page, pageSize);
        List&lt;Article&gt; list = articleMapper.selectByExample(example);
        return setterPagedGrid(list,page);
    &#125;
/*
ArticleMapper 可以实现 selectByExample 是因为它继承了 MyMapper 接口，而 MyMapper 提供了一些通用的 CRUD 操作，这些操作包括 selectByExample。

selectByExample 是 MyBatis 提供的一种动态查询方法。它允许你根据条件动态地生成 SQL 查询，而不需要手动编写复杂的 SQL 语句。这在实际开发中非常方便，因为你可以通过构建 Example 对象来动态设置查询条件。

ArticleMapper 继承了 MyMapper&lt;Article&gt;，这意味着它自动获得了 MyMapper 中定义的所有方法，包括 selectByExample。MyMapper 是一个通用的 Mapper 接口，封装了常用的数据库操作方法。

Example 和 Criteria
Example: 用于构建查询条件的对象。在这里，我们创建了一个 Example 对象，用于设置查询的表（Article.class）和排序规则（按 createTime 降序）。

Criteria: 用于添加具体的查询条件。在 Example 对象中创建 Criteria 对象，并使用它来添加各种条件（例如 publishUserId、title、articleStatus、isDelete 等）。

selectByExample
selectByExample 方法使用 Example 对象中的条件动态生成 SQL 查询，并从数据库中获取符合条件的记录。在这个例子中，我们使用了 articleMapper.selectByExample(example) 来根据构建的 Example 对象进行查询。

Example 详细用法
Example 和 Criteria 的使用使得我们可以非常灵活地构建查询条件，而不需要直接拼接 SQL 语句。这不仅提高了代码的可读性，还减少了 SQL 注入的风险。
*/
</code></pre>
<pre><code class="java">service-article  com/imooc/article/mapper/ArticleMapper.java
package com.imooc.article.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Article;
import org.springframework.stereotype.Repository;

@Repository
public interface ArticleMapper extends MyMapper&lt;Article&gt; &#123;
&#125;
</code></pre>
<h3 id="阿里AI文本检测【内容审核】-机器审核"><a href="#阿里AI文本检测【内容审核】-机器审核" class="headerlink" title="阿里AI文本检测【内容审核】[机器审核]"></a>阿里AI文本检测【内容审核】<del>[机器审核]</del></h3><pre><code class="xml">dev-common pom.xml 
       &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-java-sdk-core&lt;/artifactId&gt;
            &lt;version&gt;4.5.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun.oss&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-sdk-oss&lt;/artifactId&gt;
            &lt;version&gt;3.10.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
            &lt;artifactId&gt;aliyun-java-sdk-green&lt;/artifactId&gt;
            &lt;version&gt;3.5.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;1.2.51&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">dev-common  com/imooc/utils/extend/AliTextReviewUtils.java
package com.imooc.utils.extend;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.aliyuncs.DefaultAcsClient;
import com.aliyuncs.IAcsClient;
import com.aliyuncs.exceptions.ClientException;
import com.aliyuncs.green.model.v20180509.TextScanRequest;
import com.aliyuncs.http.FormatType;
import com.aliyuncs.http.HttpResponse;
import com.aliyuncs.profile.DefaultProfile;
import com.aliyuncs.profile.IClientProfile;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.UnsupportedEncodingException;
import java.util.*;

@Component
public class AliTextReviewUtils &#123;

    @Autowired
    private AliyunResource aliyunResource;

    public String reviewTextContent(String content) &#123;
        IClientProfile profile = DefaultProfile.getProfile(&quot;cn-shanghai&quot;,
                aliyunResource.getAccessKeyID(),
                aliyunResource.getAccessKeySecret());
        IAcsClient client = new DefaultAcsClient(profile);
        TextScanRequest textScanRequest = new TextScanRequest();
        textScanRequest.setAcceptFormat(FormatType.JSON); // 指定api返回格式
        textScanRequest.setHttpContentType(FormatType.JSON);
        textScanRequest.setMethod(com.aliyuncs.http.MethodType.POST); // 指定请求方法
        textScanRequest.setEncoding(&quot;UTF-8&quot;);
        textScanRequest.setRegionId(&quot;cn-shanghai&quot;);
        List&lt;Map&lt;String, Object&gt;&gt; tasks = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
        Map&lt;String, Object&gt; task1 = new LinkedHashMap&lt;String, Object&gt;();
        task1.put(&quot;dataId&quot;, UUID.randomUUID().toString());
        /**
         * 待检测的文本，长度不超过10000个字符
         */
//        抵制毒品交易
//          尼玛
        task1.put(&quot;content&quot;, content);
        tasks.add(task1);
        JSONObject data = new JSONObject();

        /**
         * 检测场景，文本垃圾检测传递：antispam
         **/
        data.put(&quot;scenes&quot;, Arrays.asList(&quot;antispam&quot;));
        data.put(&quot;tasks&quot;, tasks);
        System.out.println(JSON.toJSONString(data, true));

        try &#123;
            textScanRequest.setHttpContent(data.toJSONString().getBytes(&quot;UTF-8&quot;), &quot;UTF-8&quot;, FormatType.JSON);
            // 请务必设置超时时间
            textScanRequest.setConnectTimeout(3000);
            textScanRequest.setReadTimeout(6000);

            HttpResponse httpResponse = client.doAction(textScanRequest);
            if(httpResponse.isSuccess())&#123;
                JSONObject scrResponse = JSON.parseObject(new String(httpResponse.getHttpContent(), &quot;UTF-8&quot;));
                System.out.println(JSON.toJSONString(scrResponse, true));
                if (200 == scrResponse.getInteger(&quot;code&quot;)) &#123;
                    JSONArray taskResults = scrResponse.getJSONArray(&quot;data&quot;);
                    for (Object taskResult : taskResults) &#123;
                        if(200 == ((JSONObject)taskResult).getInteger(&quot;code&quot;))&#123;
                            JSONArray sceneResults = ((JSONObject)taskResult).getJSONArray(&quot;results&quot;);
                            JSONObject sceneResult = (JSONObject)sceneResults.get(0);
        //                            for (Object sceneResult : sceneResults) &#123;
                                String scene = sceneResult.getString(&quot;scene&quot;);
                                String suggestion = sceneResult.getString(&quot;suggestion&quot;);
                                //根据scene和suggetion做相关处理
                                //suggestion == pass 未命中垃圾  suggestion == block 命中了垃圾，可以通过label字段查看命中的垃圾分类
                                System.out.println(&quot;args = [&quot; + scene + &quot;]&quot;);
                                System.out.println(&quot;args = [&quot; + suggestion + &quot;]&quot;);

        //                            suggestion=pass：文本正常，文章状态改为发布通过
        //                            review：需要人工审核，需要在后台管理系统中进行人工审核（很多自媒体平台都会采用机审+人工审的方式）
        //                            block：文本违规，可以直接删除或者做限制处理，审核不通过
        //                            &#125;
                                return suggestion;
                        &#125;else&#123;
                            System.out.println(&quot;task process fail:&quot; + ((JSONObject)taskResult).getInteger(&quot;code&quot;));
                            return null;
                        &#125;
                    &#125;
                &#125; else &#123;
                    System.out.println(&quot;detect not success. code:&quot; + scrResponse.getInteger(&quot;code&quot;));
                    return null;
                &#125;
            &#125;else&#123;
                System.out.println(&quot;response not success. status:&quot; + httpResponse.getStatus());
                return null;
            &#125;
        &#125; catch (UnsupportedEncodingException e) &#123;
            e.printStackTrace();
        &#125; catch (ClientException e) &#123;
            e.printStackTrace();
        &#125;
        return null;
    &#125;
&#125;
</code></pre>
<h3 id="实现阿里AI自动审核文章【内容审核】"><a href="#实现阿里AI自动审核文章【内容审核】" class="headerlink" title="实现阿里AI自动审核文章【内容审核】"></a>实现阿里AI自动审核文章【内容审核】</h3><pre><code class="java">【沿用上面的AliTextReviewUtils】
@Service
public class ArticleServiceImpl extends BaseService implements ArticleService &#123;
    @Autowired
    private ArticleMapper articleMapper; //红色波浪线就去ArticleMapper上面加@Repository
    @Autowired
    private ArticleMapperCustom articleMapperCustom;
    @Autowired
    private AliTextReviewUtils aliTextReviewUtils;
    @Autowired
    private Sid sid;

    @Transactional
    @Override
    public void createArticle(NewArticleBO newArticleBO, Category category) &#123;
        String articleId = sid.nextShort();

        Article article = new Article();
        BeanUtils.copyProperties(newArticleBO, article);

        article.setId(articleId);
        article.setCategoryId(category.getId());
        article.setArticleStatus(ArticleReviewStatus.REVIEWING.type);
        article.setCommentCounts(0);
        article.setReadCounts(0);

        article.setIsDelete(YesOrNo.NO.type);
        article.setCreateTime(new Date());
        article.setUpdateTime(new Date());

        if (article.getIsAppoint() == ArticleAppointType.TIMING.type) &#123;
            article.setPublishTime(newArticleBO.getPublishTime()); //用户可以在前端选择定时发布
        &#125; else if (article.getIsAppoint() == ArticleAppointType.IMMEDIATELY.type) &#123;
            article.setPublishTime(new Date());
        &#125;

        int res = articleMapper.insert(article);
        if (res != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_CREATE_ERROR);
        &#125;

        /**
         * FIXME: 我们只检测正常的词汇，非正常词汇大家课后去检测
         */
        // 通过阿里智能AI实现对文章文本的自动检测（自动审核）
//        String reviewTextResult = aliTextReviewUtils.reviewTextContent(newArticleBO.getContent());
        String reviewTextResult = ArticleReviewLevel.REVIEW.type;

        if (reviewTextResult
                .equalsIgnoreCase(ArticleReviewLevel.PASS.type)) &#123;
            // 修改当前的文章，状态标记为审核通过
            this.updateArticleStatus(articleId, ArticleReviewStatus.SUCCESS.type);
        &#125; else if (reviewTextResult
                .equalsIgnoreCase(ArticleReviewLevel.REVIEW.type)) &#123;
            // 修改当前的文章，状态标记为需要人工审核
            this.updateArticleStatus(articleId, ArticleReviewStatus.WAITING_MANUAL.type);
        &#125; else if (reviewTextResult
                .equalsIgnoreCase(ArticleReviewLevel.BLOCK.type)) &#123;
            // 修改当前的文章，状态标记为审核未通过
            this.updateArticleStatus(articleId, ArticleReviewStatus.FAILED.type);
        &#125;
    &#125;
......
......
    @Transactional
    @Override
    public void updateArticleStatus(String articleId, Integer pendingStatus) &#123;
        Example example = new Example(Article.class);
        Example.Criteria criteria = example.createCriteria();
        criteria.andEqualTo(&quot;id&quot;,articleId);

        Article pendingArticle = new Article();
        pendingArticle.setArticleStatus(pendingStatus);
        int res = articleMapper.updateByExampleSelective(pendingArticle, example);
        if (res != 1)&#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
package com.imooc.article.service;

import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;
import com.imooc.utils.PagedGridResult;

import java.util.Date;
import java.util.List;

public interface ArticleService &#123;

    /**
     * 发布文章
     */
    public void createArticle(NewArticleBO newArticleBO, Category category);

    /**
     * 更新定时发布为即使发布
     */
    public void updateAppointToPublish();

    /**
     * 用户中心-查询我的文章列表
     */
    public PagedGridResult queryMyArticleList(String userId, String keyword, Integer status, Date startDate, Date endDate, Integer page, Integer pageSize);

    /**
     * 更改文章的状态
     * @param articleId
     * @param pendingStatus
     */
    public void updateArticleStatus(String articleId, Integer pendingStatus);
&#125;
</code></pre>
<h3 id="admin文章管理列表【内容审核】【作业】"><a href="#admin文章管理列表【内容审核】【作业】" class="headerlink" title="admin文章管理列表【内容审核】【作业】"></a>admin文章管理列表【内容审核】<del>【作业】</del></h3><h5 id="管理员查询用户的所有文章列表"><a href="#管理员查询用户的所有文章列表" class="headerlink" title="管理员查询用户的所有文章列表"></a>管理员查询用户的所有文章列表</h5><pre><code class="java">service-api  com/imooc/api/controller/article/ArticleControllerApi.java
@PostMapping(&quot;queryAllList&quot;)
    @ApiOperation(value = &quot;管理员查询用户的所有文章列表&quot;, notes = &quot;管理员查询用户的所有文章列表&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult queryAllList(@RequestParam Integer status,
                                        @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
                                        @RequestParam Integer page,
                                        @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页的每一页显示的条数&quot;, required = false)
                                        @RequestParam Integer pageSize);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
@Override
    public GraceJSONResult queryAllList(Integer status, Integer page, Integer pageSize) &#123;
        if (page == null)&#123;
            page = COMMON_START_PAGE;
        &#125;
        if (pageSize == null)&#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;
        PagedGridResult gridResult = articleService.queryAllArticleListAdmin(status,page,pageSize);

        return GraceJSONResult.ok(gridResult);
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
    /**
     * 管理员查询文章列表
     */
    public PagedGridResult queryAllArticleListAdmin(Integer status, Integer page, Integer pageSize);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
@Override
    public PagedGridResult queryAllArticleListAdmin(Integer status, Integer page, Integer pageSize) &#123;
        Example articleExample = new Example(Article.class);
        articleExample.orderBy(&quot;createTime&quot;).desc();
        Example.Criteria criteria = articleExample.createCriteria();
        //这里是检测文章状态 与前端做匹配
        if (ArticleReviewStatus.isArticleStatusValid(status)) &#123;
            criteria.andEqualTo(&quot;articleStatus&quot;, status);
        &#125;

        // 审核中是机审和人审核的两个状态，所以需要单独判断
        if (status != null &amp;&amp; status == 12) &#123;
            criteria.andEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.REVIEWING.type)
                    .orEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.WAITING_MANUAL.type);
        &#125;
        //isDelete必须是0
        criteria.andEqualTo(&quot;isDelete&quot;, YesOrNo.NO.type);
        /**
         * page: 第几页
         * pageSize: 每页显示条数
         */
        PageHelper.startPage(page, pageSize);
        List&lt;Article&gt; list = articleMapper.selectByExample(articleExample);
        return setterPagedGrid(list, page);
    &#125;
</code></pre>
<h3 id="人工审核-【内容审核】"><a href="#人工审核-【内容审核】" class="headerlink" title="人工审核 【内容审核】"></a>人工审核 【内容审核】</h3><p><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/contentReview.html">内容审核 | 运营管理平台 (imoocnews.com)</a> 【[待审核]手动审核通过】</p>
<pre><code class="java">service-api  com/imooc/api/controller/article/ArticleControllerApi.java
    @PostMapping(&quot;doReview&quot;)
    @ApiOperation(value = &quot;管理员对文章进行审核通过或者失败&quot;, notes = &quot;管理员对文章进行审核通过或者失败&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult doReview(@RequestParam String articleId,
                                    @RequestParam Integer passOrNot);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
@Override
    public GraceJSONResult doReview(String articleId, Integer passOrNot) &#123;
        Integer pendingStatus;
        if (passOrNot == YesOrNo.YES.type) &#123;
            // 审核成功
            pendingStatus = ArticleReviewStatus.SUCCESS.type;
        &#125; else if (passOrNot == YesOrNo.NO.type) &#123;
            // 审核失败
            pendingStatus = ArticleReviewStatus.FAILED.type;
        &#125; else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
        // 保存到数据库，更改文章状态为审核成功或者失败
        articleService.updateArticleStatus(articleId, pendingStatus);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<h3 id="撤回-删除文章作业-【内容管理】"><a href="#撤回-删除文章作业-【内容管理】" class="headerlink" title="撤回_删除文章作业 【内容管理】"></a>撤回_删除文章作业 【内容管理】</h3><p><a target="_blank" rel="noopener" href="http://writer.imoocnews.com:9090/imooc-news/writer/contentMng.html">媒体号作家中心 | 内容管理 (imoocnews.com)</a><br>[这个是用户撤回和删除噢 而不是管理员的撤回与删除]<br><a target="_blank" rel="noopener" href="http://writer.imoocnews.com:9090/imooc-news/writer/contentMng.html">用户：媒体号作家中心 | 内容管理 (imoocnews.com)</a><br><a target="_blank" rel="noopener" href="http://admin.imoocnews.com:9090/imooc-news/admin/contentReview.html">管理员：内容审核 | 运营管理平台 (imoocnews.com)</a></p>
<pre><code class="java">service-api  com/imooc/api/controller/article/ArticleControllerApi.java
    @PostMapping(&quot;/delete&quot;)
    @ApiOperation(value = &quot;用户删除文章&quot;, notes = &quot;用户删除文章&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult delete(@RequestParam String userId,
                                  @RequestParam String articleId);

    @PostMapping(&quot;/withdraw&quot;)
    @ApiOperation(value = &quot;用户撤回文章&quot;, notes = &quot;用户撤回文章&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult withdraw(@RequestParam String userId,
                                    @RequestParam String articleId);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
@Override
    public GraceJSONResult delete(String userId, String articleId) &#123;
        articleService.deleteArticle(userId,articleId);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult withdraw(String userId, String articleId) &#123;
        articleService.withdrawArticle(userId, articleId);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
package com.imooc.article.service;

import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;
import com.imooc.utils.PagedGridResult;

import java.util.Date;
import java.util.List;

public interface ArticleService &#123;

   /**
     * 删除文章
     */
    public void deleteArticle(String userId, String articleId);

    /**
     * 撤回文章
     */
    public void withdrawArticle(String userId, String articleId);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
 @Transactional
    @Override
    public void deleteArticle(String userId, String articleId) &#123;
        Example articleExample = makeExampleCriteria(userId, articleId);

        Article pending = new Article();
        pending.setIsDelete(YesOrNo.YES.type);

        int result = articleMapper.updateByExampleSelective(pending, articleExample);
        if (result != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_DELETE_ERROR);
        &#125;
    &#125;

    @Transactional
    @Override
    public void withdrawArticle(String userId, String articleId) &#123;
        Example articleExample = makeExampleCriteria(userId, articleId);

        Article pending = new Article();
        pending.setArticleStatus(ArticleReviewStatus.WITHDRAW.type);

        int result = articleMapper.updateByExampleSelective(pending, articleExample);
        if (result != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_WITHDRAW_ERROR);
        &#125;
//        deleteHTML(articleId);
    &#125;

    private Example makeExampleCriteria(String userId, String articleId) &#123;
        Example articleExample = new Example(Article.class);
        Example.Criteria criteria = articleExample.createCriteria();
        criteria.andEqualTo(&quot;publishUserId&quot;, userId);
        criteria.andEqualTo(&quot;id&quot;, articleId);
        return articleExample;
    &#125;
</code></pre>
<h2 id="首页-作者页面介绍【章节描述】"><a href="#首页-作者页面介绍【章节描述】" class="headerlink" title="首页_作者页面介绍【章节描述】"></a>首页_作者页面介绍【章节描述】</h2><ul>
<li><strong>开发首页与作家个人展示页</strong></li>
<li><strong>文章列表、友情链接查询</strong></li>
<li><strong>粉丝关注与取关</strong></li>
<li><strong>我的粉丝与粉丝画像</strong></li>
</ul>
<h3 id="根据MongoDB字段查询友情链接"><a href="#根据MongoDB字段查询友情链接" class="headerlink" title="根据MongoDB字段查询友情链接"></a>根据MongoDB字段查询友情链接</h3><pre><code class="java">service-api  com/imooc/api/controller/admin/FriendLinkControllerApi.java
    @ApiOperation(value = &quot;门户端查询友情链接列表&quot;, notes = &quot;门户端查询友情链接列表&quot;, httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;portal/list&quot;)
    public GraceJSONResult queryPortalAllFriendLinkList();
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/controller/FriendLinkController.java
    @Override
    public GraceJSONResult queryPortalAllFriendLinkList() &#123;
        List&lt;FriendLinkMO&gt; list = friendLinkService.queryPortalAllFriendLinkList();
        return GraceJSONResult.ok(list);
    &#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/service/FriendLinkService.java
    /**
     * 首页查询友情链接
     */
    public List&lt;FriendLinkMO&gt; queryPortalAllFriendLinkList();
</code></pre>
<pre><code class="java">service-admin com/imooc/admin/service/impl/FriendLinkServiceImpl.java 
@Override
    public List&lt;FriendLinkMO&gt; queryPortalAllFriendLinkList() &#123;
        return friendLinkRepository.getAllByIsDelete(YesOrNo.NO.type);
    &#125;
</code></pre>
<pre><code class="java">service-admin  com/imooc/admin/repository/FriendLinkRepository.java
@Repository
public interface FriendLinkRepository extends MongoRepository&lt;FriendLinkMO, String&gt; &#123; //持久层
    // 内置提供了很多方法 find.. delete...
    public List&lt;FriendLinkMO&gt; getAllByIsDelete(Integer isDelete); //后面可以加ANDID
&#125;
</code></pre>
<h3 id="搜索并展示文章列表【首页】"><a href="#搜索并展示文章列表【首页】" class="headerlink" title="搜索并展示文章列表【首页】"></a>搜索并展示文章列表【首页】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
@Api(value = &quot;门户端文章业务的controller&quot;, tags = &#123;&quot;门户端文章业务的controller&quot;&#125;)
@RequestMapping(&quot;portal/article&quot;)
public interface ArticlePortalControllerApi &#123;
    @ApiOperation(value = &quot;首页查询文章列表&quot;, notes = &quot;首页查询文章列表&quot;, httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;list&quot;)
    public GraceJSONResult list(@RequestParam String keyword,
                                @RequestParam Integer category,
                                @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
                                @RequestParam Integer page,
                                @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页的每一页显示的条数&quot;, required = false)
                                @RequestParam Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
@RestController
public class ArticlePortalController extends BaseController implements ArticlePortalControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(ArticlePortalController.class);

    @Autowired
    private ArticlePortalService articlePortalService;

    @Autowired
    private RestTemplate restTemplate;

    @Override
    public GraceJSONResult list(String keyword,
                                Integer category,
                                Integer page,
                                Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult
                = articlePortalService.queryIndexArticleList(keyword,
                category,
                page,
                pageSize);
        return GraceJSONResult.ok(gridResult);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticlePortalServiceImpl.java
@Service
public class ArticlePortalServiceImpl extends BaseService implements ArticlePortalService &#123;
    @Autowired
    private ArticleMapper articleMapper; //红色波浪线就去ArticleMapper上面加@Repository


    @Override
    public PagedGridResult queryIndexArticleList(String keyword,
                                                 Integer category,
                                                 Integer page,
                                                 Integer pageSize) &#123;

        Example articleExample = new Example(Article.class);
        articleExample.orderBy(&quot;publishTime&quot;).desc();//使用时间进行排序
        Example.Criteria criteria = articleExample.createCriteria();

        /**
         * 查询首页文章的自带隐性查询条件：
         * isAppoint=即使发布，表示文章已经直接发布的，或者定时任务到点发布的
         * isDelete=未删除，表示文章只能够显示未删除
         * articleStatus=审核通过，表示只有文章经过机审/人工审核之后才能展示
         */
        criteria.andEqualTo(&quot;isAppoint&quot;, YesOrNo.NO.type);
        criteria.andEqualTo(&quot;isDelete&quot;, YesOrNo.NO.type);
        criteria.andEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.SUCCESS.type);

        if (StringUtils.isNotBlank(keyword)) &#123;
            criteria.andLike(&quot;title&quot;, &quot;%&quot; + keyword + &quot;%&quot;);
        &#125;
        if (category != null) &#123;
            criteria.andEqualTo(&quot;categoryId&quot;, category);
        &#125;

        PageHelper.startPage(page, pageSize);
        List&lt;Article&gt; list = articleMapper.selectByExample(articleExample);
        System.out.println(keyword);
        System.out.println(category);
        return setterPagedGrid(list, page);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticlePortalService.java
public interface ArticlePortalService &#123;

    /**
     * 首页查询文章列表
     */
    public PagedGridResult queryIndexArticleList(String keyword,
                                                 Integer category,
                                                 Integer page,
                                                 &#125;
</code></pre>
<pre><code class="html">index.html
&lt;!-- 中间容器 --&gt;
        &lt;div class=&quot;container&quot;&gt;
            &lt;!-- 文章列表 --&gt;
            &lt;div id=&quot;articleList&quot; class=&quot;article-list&quot;&gt;
                &lt;ul&gt;
                    &lt;li class=&quot;single-article-wrapper&quot; v-for=&quot;(article, index) in articleList&quot; :key=&quot;index&quot;&gt;
                        &lt;img :src=&quot;article.articleCover&quot; class=&quot;article-cover&quot; v-show=&quot;article.articleType == 1&quot;&gt;

                        &lt;div class=&quot;single-article&quot;&gt;
                            &lt;div class=&quot;article-title&quot;&gt;
                                &lt;!-- TODO: 后期改为静态页面跳转 --&gt;
                                &lt;a :href=&quot;&#39;detail.html?articleId=&#39;+article.id&quot; target=&quot;_blank&quot; class=&quot;link-article-title&quot;&gt;&#123;&#123;article.title&#125;&#125;&lt;/a&gt;
                            &lt;/div&gt;
                            &lt;div class=&quot;publisher&quot;&gt;
                                &lt;div class=&quot;category-tag&quot; :style=&quot;&#123;color: getCatTagColor(article.categoryId), borderColor: getCatTagColor(article.categoryId) &#125;&quot;&gt;&#123;&#123;getCatName(article.categoryId)&#125;&#125;&lt;/div&gt;
                                &lt;!-- TODO: 这里需要显示用户的昵称以及用户头像 --&gt;
                                    &lt;img src=&quot;img/face1.png&quot; class=&quot;publisher-face&quot; v-if=&quot;article.publisherVO == null || article.publisherVO == undefined&quot;&gt;
                                    &lt;div class=&quot;publisher-name&quot; v-if=&quot;article.publisherVO == null || article.publisherVO == undefined&quot;&gt;&amp;nbsp;&amp;nbsp;&#123;&#123;article.publishUserId&#125;&#125;&amp;nbsp;⋅&lt;/div&gt;
                                
                                
                                    &lt;img :src=&quot;article.publisherVO.face&quot; class=&quot;publisher-face&quot; v-if=&quot;article.publisherVO != null &amp;&amp; article.publisherVO != undefined&quot;&gt;
                                &lt;!--
                                    &lt;a :href=&quot;&#39;writer.html?writerId=&#39;+article.publisherVO.id&quot; target=&quot;_blank&quot;&gt;
                                    &lt;div class=&quot;publisher-name&quot; v-if=&quot;article.publisherVO != null &amp;&amp; article.publisherVO != undefined&quot;&gt;&amp;nbsp;&amp;nbsp;&#123;&#123;article.publisherVO.nickname&#125;&#125;&amp;nbsp;⋅&lt;/div&gt;
                                &lt;/a&gt;
                                    --&gt;

                                &lt;div class=&quot;article-name&quot;&gt;&amp;nbsp;&#123;&#123;article.readCounts&#125;&#125;阅读&amp;nbsp;⋅&lt;/div&gt;
                                
                                &lt;!-- &lt;div class=&quot;publish-time&quot;&gt;&amp;nbsp;&#123;&#123;formatData(article.publishTime)&#125;&#125;&lt;/div&gt; --&gt;
                                &lt;div class=&quot;publish-time&quot;&gt;&amp;nbsp;&#123;&#123;getDateBeforeNow(article.publishTime)&#125;&#125;&lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
</code></pre>
<h3 id="文章列表展示发布者需求【首页】"><a href="#文章列表展示发布者需求【首页】" class="headerlink" title="文章列表展示发布者需求【首页】"></a>文章列表展示发布者需求【首页】</h3><pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
[其他不变加上点代码]
package com.imooc.article.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.article.ArticleControllerApi;
import com.imooc.api.controller.article.ArticlePortalControllerApi;
import com.imooc.article.service.ArticlePortalService;
import com.imooc.article.service.ArticleService;
import com.imooc.enums.ArticleCoverType;
import com.imooc.enums.ArticleReviewStatus;
import com.imooc.enums.YesOrNo;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.Article;
import com.imooc.pojo.Category;
import com.imooc.pojo.bo.NewArticleBO;
import com.imooc.utils.JsonUtils;
import com.imooc.utils.PagedGridResult;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import java.util.*;

@RestController
public class ArticlePortalController extends BaseController implements ArticlePortalControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(ArticlePortalController.class);

    @Autowired
    private ArticlePortalService articlePortalService;

    @Autowired
    private RestTemplate restTemplate;

    @Override
    public GraceJSONResult list(String keyword,
                                Integer category,
                                Integer page,
                                Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult
                = articlePortalService.queryIndexArticleList(keyword,
                category,
                page,
                pageSize);
   //START
        List&lt;Article&gt; list = (List&lt;Article&gt;) gridResult.getRows();
        // 1. 构建发布者id列表
        Set&lt;String&gt; idset = new HashSet&lt;&gt;();
        for (Article a : list)&#123;
//            System.out.println(a.getPublishUserId());
            idset.add(a.getPublishUserId());
        &#125;
        System.out.println(idset.toString());
        // 2. 发起远程调用(restTemplate)，请求用户服务获得用户(idSet 发布者)列表

        // 3. 拼接两个list，重组文章列表
   //END
        return GraceJSONResult.ok(gridResult);
    &#125;
&#125;
</code></pre>
<h3 id="发起restTemplate请求查询用户服务获得发布者列表【首页】二级用户"><a href="#发起restTemplate请求查询用户服务获得发布者列表【首页】二级用户" class="headerlink" title="发起restTemplate请求查询用户服务获得发布者列表【首页】二级用户"></a>发起restTemplate请求查询用户服务获得发布者列表【首页】<del>二级用户</del></h3><pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
@Override
    public GraceJSONResult list(String keyword,
                                Integer category,
                                Integer page,
                                Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult
                = articlePortalService.queryIndexArticleList(keyword,
                category,
                page,
                pageSize);
   //START 用户量大就双表关联查询      单表双查询 → 【首页不会显示发布者的用户id 和 头像】
        List&lt;Article&gt; list = (List&lt;Article&gt;) gridResult.getRows();
        // 1. 构建发布者id列表
        Set&lt;String&gt; idset = new HashSet&lt;&gt;();
        for (Article a : list)&#123;
//            System.out.println(a.getPublishUserId());
            idset.add(a.getPublishUserId());
        &#125;
        System.out.println(idset.toString());
        // 2. 发起远程调用(restTemplate)，请求用户服务获得用户(idSet 发布者)列表
        String userServerUrlExecute
                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idset);
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity =
        restTemplate.getForEntity(userServerUrlExecute,GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200)&#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        for (AppUserVO u : publisherList)&#123;
            System.out.println(u.toString());
        &#125;
        // 3. 拼接两个list，重组文章列表
   //END
        return GraceJSONResult.ok(gridResult);
    &#125;
===================成功输出二级用户基本信息===============================
AppUserVO&#123;id=&#39;240629F21AK1BHX4&#39;, nickname=&#39;15027597319&#39;, face=&#39;https://iimooc-news-dev.oss-cn-shanghai.aliyuncs.com/images/abc/240629F21AK1BHX4/240712FM0G1WMZHH.png&#39;, activeStatus=1&#125;
AppUserVO&#123;id=&#39;200628AFYM7AGWPH&#39;, nickname=&#39;我是慕课网&#39;, face=&#39;https://imooc-news-dev.oss-cn-shanghai.aliyuncs.com/images/abc/200628AFYM7AGWPH/2007088XH2WT7GXP.png&#39;, activeStatus=1&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/AppUserVO.java
public class AppUserVO &#123;
    private String id;
    private String nickname;
    private String face;
    private Integer activeStatus;
&#125;Getter + Setter + ToString
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
@RestController
public class UserController extends BaseController implements UserControllerApi &#123;
@Override
    public GraceJSONResult queryByIds(String userIds) &#123;
        if (StringUtils.isBlank(userIds))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_NOT_EXIST_ERROR);
        &#125;
        List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
        List&lt;String&gt; userIdList = JsonUtils.jsonToList(userIds, String.class);//传过来两个用户的id
        for (String userId : userIdList)&#123;
            //获得用户基本信息
            AppUserVO userVO = getBasicUserInfo(userId);
            // 3.添加到publisherList
            publisherList.add(userVO);
        &#125;
        return GraceJSONResult.ok(publisherList);
    &#125;

    private AppUserVO getBasicUserInfo(String userId)&#123;
        // 1. 根据userId查询用户的信息 UserService+impl
        AppUser user = getUser(userId);
        // 2. 返回用户信息
        AppUserVO userVO = new AppUserVO();
        BeanUtils.copyProperties(user, userVO); //拷贝信息
        return userVO;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/user/UserControllerApi.java
package com.imooc.api.controller.user;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

@Api(value = &quot;用户信息相关Controller&quot;,tags = &#123;&quot;用户信息相关Controller&quot;&#125;)
@RequestMapping(&quot;user&quot;)
public interface UserControllerApi &#123;

    @ApiOperation(value = &quot;获得用户基本信息&quot;,notes = &quot;获得用户基本信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getUserInfo&quot;)
    public GraceJSONResult getUserInfo(@RequestParam String userId);
    @ApiOperation(value = &quot;获得用户账户信息&quot;,notes = &quot;获得用户账户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAccountInfo&quot;)
    public GraceJSONResult getAccountInfo(@RequestParam String userId);

    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/updateUserInfo&quot;)
    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO,
                                          BindingResult result);

    @ApiOperation(value = &quot;根据用户的ids查询用户列表&quot;,notes = &quot;根据用户的ids查询用户列表&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/queryByids&quot;)
    public GraceJSONResult queryByIds(@RequestParam String userIds);
&#125;
</code></pre>
<h3 id="重组文章列表并且渲染【首页】"><a href="#重组文章列表并且渲染【首页】" class="headerlink" title="重组文章列表并且渲染【首页】"></a>重组文章列表并且渲染【首页】</h3><pre><code class="html">index.html
&lt;!-- 中间容器 --&gt;
        &lt;div class=&quot;container&quot;&gt;
            &lt;!-- 文章列表 --&gt;
            &lt;div id=&quot;articleList&quot; class=&quot;article-list&quot;&gt;
                &lt;ul&gt;
                    &lt;li class=&quot;single-article-wrapper&quot; v-for=&quot;(article, index) in articleList&quot; :key=&quot;index&quot;&gt;
                        &lt;img :src=&quot;article.articleCover&quot; class=&quot;article-cover&quot; v-show=&quot;article.articleType == 1&quot;&gt;

                        &lt;div class=&quot;single-article&quot;&gt;
                            &lt;div class=&quot;article-title&quot;&gt;
                                &lt;!-- TODO: 后期改为静态页面跳转 --&gt;
                                &lt;a :href=&quot;&#39;detail.html?articleId=&#39;+article.id&quot; target=&quot;_blank&quot; class=&quot;link-article-title&quot;&gt;&#123;&#123;article.title&#125;&#125;&lt;/a&gt;
                            &lt;/div&gt;
                            &lt;div class=&quot;publisher&quot;&gt;
                                &lt;div class=&quot;category-tag&quot; :style=&quot;&#123;color: getCatTagColor(article.categoryId), borderColor: getCatTagColor(article.categoryId) &#125;&quot;&gt;&#123;&#123;getCatName(article.categoryId)&#125;&#125;&lt;/div&gt;
          &lt;!-- ★★★★★ TODO: 这里需要显示用户的昵称以及用户头像 ★★★★★ --&gt;
                                    &lt;img src=&quot;img/face1.png&quot; class=&quot;publisher-face&quot; v-if=&quot;article.publisherVO == null || article.publisherVO == undefined&quot;&gt;
                                    &lt;div class=&quot;publisher-name&quot; v-if=&quot;article.publisherVO == null || article.publisherVO == undefined&quot;&gt;&amp;nbsp;&amp;nbsp;&#123;&#123;article.publishUserId&#125;&#125;&amp;nbsp;⋅&lt;/div&gt;
                                    &lt;img :src=&quot;article.publisherVO.face&quot; class=&quot;publisher-face&quot; v-if=&quot;article.publisherVO != null &amp;&amp; article.publisherVO != undefined&quot;&gt;
                                
                                    &lt;a :href=&quot;&#39;writer.html?writerId=&#39;+article.publisherVO.id&quot; target=&quot;_blank&quot;&gt;
                                    &lt;div class=&quot;publisher-name&quot; v-if=&quot;article.publisherVO != null &amp;&amp; article.publisherVO != undefined&quot;&gt;&amp;nbsp;&amp;nbsp;&#123;&#123;article.publisherVO.nickname&#125;&#125;&amp;nbsp;⋅&lt;/div&gt;
                                &lt;/a&gt;            
                                &lt;div class=&quot;article-name&quot;&gt;&amp;nbsp;&#123;&#123;article.readCounts&#125;&#125;阅读&amp;nbsp;⋅&lt;/div&gt;
                                &lt;!-- &lt;div class=&quot;publish-time&quot;&gt;&amp;nbsp;&#123;&#123;formatData(article.publishTime)&#125;&#125;&lt;/div&gt; --&gt;
                                &lt;div class=&quot;publish-time&quot;&gt;&amp;nbsp;&#123;&#123;getDateBeforeNow(article.publishTime)&#125;&#125;&lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/IndexArticleVO.java
public class IndexArticleVO &#123;

    private String id;
    private String title;
    private Integer categoryId;
    private Integer articleType;
    private String articleCover;
    private Integer isAppoint;
    private Integer articleStatus;
    private String publishUserId;
    private Date publishTime;
    private Integer readCounts;
    private Integer commentCounts;
    private String mongoFileId;
    private Integer isDelete;
    private Date createTime;
    private Date updateTime;
    private String content;
&#125;Getter+Setter
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
package com.imooc.article.controller;
......
import java.util.*;

@RestController
public class ArticlePortalController extends BaseController implements ArticlePortalControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(ArticlePortalController.class);

    @Autowired
    private ArticlePortalService articlePortalService;

    @Autowired
    private RestTemplate restTemplate;

    @Override
    public GraceJSONResult list(String keyword,
                                Integer category,
                                Integer page,
                                Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult
                = articlePortalService.queryIndexArticleList(keyword,
                category,
                page,
                pageSize);
   //START 用户量大就双表关联查询      单表双查询 → 【首页不会显示发布者的用户id 和 头像】
        List&lt;Article&gt; list = (List&lt;Article&gt;) gridResult.getRows();
        // 1. 构建发布者id列表
        Set&lt;String&gt; idset = new HashSet&lt;&gt;();
        for (Article a : list)&#123;
//            System.out.println(a.getPublishUserId());
            idset.add(a.getPublishUserId());
        &#125;
        System.out.println(idset.toString());
        // 2. 发起远程调用(restTemplate)，请求用户服务获得用户(idSet 发布者)列表
        String userServerUrlExecute
                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idset);
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity =
        restTemplate.getForEntity(userServerUrlExecute,GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200)&#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
//        for (AppUserVO u : publisherList)&#123;
//            System.out.println(u.toString());
//        &#125;
        // 3. 拼接两个list，重组文章列表
        List&lt;IndexArticleVO&gt; indexArticleList = new ArrayList&lt;&gt;();
        for (Article a : list)&#123;
            IndexArticleVO indexArticleVO = new IndexArticleVO();
            BeanUtils.copyProperties(a, indexArticleVO);

            // 3.1 从publisherList中获得发布者的基本信息
            AppUserVO publisher = getUserIfPublisher(a.getPublishUserId(), publisherList);
            indexArticleVO.setPublisherVO(publisher);
            indexArticleList.add(indexArticleVO);
        &#125;
        gridResult.setRows(indexArticleList);
   //END
        return GraceJSONResult.ok(gridResult);
    &#125;
    // 用于获得publish
    private AppUserVO getUserIfPublisher(String publisherId, List&lt;AppUserVO&gt; publisherList)&#123;
        for (AppUserVO user : publisherList)&#123;
            if (user.getId().equalsIgnoreCase(publisherId))&#123;
                return user;
            &#125;
        &#125;
        return null;
    &#125;
&#125;
</code></pre>
<h3 id="查询热闻【首页】阅读数从最新新闻进行排名"><a href="#查询热闻【首页】阅读数从最新新闻进行排名" class="headerlink" title="查询热闻【首页】阅读数从最新新闻进行排名"></a>查询热闻【首页】<del>阅读数从最新新闻进行排名</del></h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
@Api(value = &quot;门户端文章业务的controller&quot;, tags = &#123;&quot;门户端文章业务的controller&quot;&#125;)
@RequestMapping(&quot;portal/article&quot;)
public interface ArticlePortalControllerApi &#123;
 @GetMapping(&quot;hotList&quot;)
    @ApiOperation(value = &quot;首页查询新闻列表&quot;, notes = &quot;首页查询新闻列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult hotList();
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticlePortalService.java
public interface ArticlePortalService &#123;

    /**
     * 首页查询文章列表
     */
    public PagedGridResult queryIndexArticleList(String keyword,
                                                 Integer category,
                                                 Integer page,
                                                 Integer pageSize);
    /**
     * 首页查询热闻列表
     */
    public List&lt;Article&gt; queryHotList();
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticlePortalServiceImpl.java
@Override
    public List&lt;Article&gt; queryHotList() &#123;
        Example articleExample = new Example(Article.class);
        Example.Criteria criteria = setDefualArticleExample(articleExample);

        PageHelper.startPage(1, 5);
        List&lt;Article&gt; list  = articleMapper.selectByExample(articleExample);
        return list;
    &#125;

    private Example.Criteria setDefualArticleExample(Example articleExample) &#123;
        articleExample.orderBy(&quot;publishTime&quot;).desc();
        Example.Criteria criteria = articleExample.createCriteria();

        /**
         * 查询首页文章的自带隐性查询条件：
         * isAppoint=即使发布，表示文章已经直接发布的，或者定时任务到点发布的
         * isDelete=未删除，表示文章只能够显示未删除
         * articleStatus=审核通过，表示只有文章经过机审/人工审核之后才能展示
         */
        criteria.andEqualTo(&quot;isAppoint&quot;, YesOrNo.NO.type);
        criteria.andEqualTo(&quot;isDelete&quot;, YesOrNo.NO.type);
        criteria.andEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.SUCCESS.type);

        return criteria;
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
@Override
    public GraceJSONResult hotList() &#123;
        return GraceJSONResult.ok(articlePortalService.queryHotList());
    &#125;
</code></pre>
<h3 id="基本信息展示-历史文章列表【作者主页】"><a href="#基本信息展示-历史文章列表【作者主页】" class="headerlink" title="基本信息展示_历史文章列表【作者主页】"></a>基本信息展示_历史文章列表【作者主页】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
 package com.imooc.api.controller.article;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.NewArticleBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;
import java.util.Date;

@Api(value = &quot;门户端文章业务的controller&quot;, tags = &#123;&quot;门户端文章业务的controller&quot;&#125;)
@RequestMapping(&quot;portal/article&quot;)
public interface ArticlePortalControllerApi &#123;

    @GetMapping(&quot;list&quot;)
    @ApiOperation(value = &quot;首页查询文章列表&quot;, notes = &quot;首页查询文章列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult list(@RequestParam String keyword,
                                @RequestParam Integer category,
                                @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
                                @RequestParam Integer page,
                                @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页的每一页显示的条数&quot;, required = false)
                                @RequestParam Integer pageSize);

    @GetMapping(&quot;hotList&quot;)
    @ApiOperation(value = &quot;首页查询新闻列表&quot;, notes = &quot;首页查询新闻列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult hotList();

    /**
     * 查询作家发布的所有文章列表
     */
    @GetMapping(&quot;queryArticleListOfWriter&quot;)
    @ApiOperation(value = &quot;查询作家发布的所有文章列表&quot;, notes = &quot;查询作家发布的所有文章列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult queryArticleListOfWriter(@RequestParam String writerId,
                                                    @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
                                                        @RequestParam Integer page,
                                                    @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页的每一页显示的条数&quot;, required = false)
                                                        @RequestParam Integer pageSize);

    @GetMapping(&quot;queryGoodArticleListOfWriter&quot;)
    @ApiOperation(value = &quot;作家页面查询近期佳文&quot;, notes = &quot;作家页面查询近期佳文&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult queryGoodArticleListOfWriter(@RequestParam String writerId);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
@Override
    public GraceJSONResult queryArticleListOfWriter(String writerId, Integer page, Integer pageSize) &#123;

        System.out.println(&quot;writerId=&quot; + writerId);

        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult = articlePortalService.queryArticleListOfWriter(writerId, page, pageSize);
        gridResult = rebuildArticleGrid(gridResult);
        return GraceJSONResult.ok(gridResult);
    &#125;

    @Override
    public GraceJSONResult queryGoodArticleListOfWriter(String writerId) &#123;
        PagedGridResult gridResult = articlePortalService.queryGoodArticleListOfWriter(writerId);
        return GraceJSONResult.ok(gridResult);
    &#125;
&#125;
</code></pre>
<pre><code class="java">/* 完全版ArticlePortalController
package com.imooc.article.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.article.ArticlePortalControllerApi;
import com.imooc.article.service.ArticlePortalService;
import com.imooc.article.service.ArticleService;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.Article;
import com.imooc.pojo.vo.AppUserVO;
import com.imooc.pojo.vo.IndexArticleVO;
import com.imooc.utils.IPUtil;
import com.imooc.utils.JsonUtils;
import com.imooc.utils.PagedGridResult;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@RestController
public class ArticlePortalController extends BaseController implements ArticlePortalControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(ArticlePortalController.class);

    @Autowired
    private ArticlePortalService articlePortalService;

    @Autowired
    private RestTemplate restTemplate;

    @Override
    public GraceJSONResult list(String keyword,
                                Integer category,
                                Integer page,
                                Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult
                = articlePortalService.queryIndexArticleList(keyword,
                category,
                page,
                pageSize);
        gridResult = rebuildArticleGrid(gridResult);
        return GraceJSONResult.ok(gridResult);
    &#125;

    private PagedGridResult rebuildArticleGrid(PagedGridResult gridResult) &#123;
        // START

        List&lt;Article&gt; list = (List&lt;Article&gt;)gridResult.getRows();

        // 1. 构建发布者id列表
        Set&lt;String&gt; idSet = new HashSet&lt;&gt;();
        List&lt;String&gt; idList = new ArrayList&lt;&gt;();
        for (Article a : list) &#123;
//            System.out.println(a.getPublishUserId());
            // 1.1 构建发布者的set
            idSet.add(a.getPublishUserId());
            // 1.2 构建文章id的list
            idList.add(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + a.getId());
        &#125;
        System.out.println(idSet.toString());
        // 发起redis的mget批量查询api，获得对应的值
        List&lt;String&gt; readCountsRedisList = redis.mget(idList);
        List&lt;AppUserVO&gt; publisherList = getPublisherList(idSet);

        // 3. 拼接两个list，重组文章列表
        List&lt;IndexArticleVO&gt; indexArticleList = new ArrayList&lt;&gt;();
        for (int i = 0 ; i &lt; list.size() ; i ++) &#123;
            IndexArticleVO indexArticleVO = new IndexArticleVO();
            Article a = list.get(i);
            BeanUtils.copyProperties(a, indexArticleVO);

            // 3.1 从publisherList中获得发布者的基本信息
            AppUserVO publisher  = getUserIfPublisher(a.getPublishUserId(), publisherList);
            indexArticleVO.setPublisherVO(publisher);

            // 3.2 重新组装设置文章列表中的阅读量
            String redisCountsStr = readCountsRedisList.get(i);
            int readCounts = 0;
            if (StringUtils.isNotBlank(redisCountsStr)) &#123;
                readCounts = Integer.valueOf(redisCountsStr);
            &#125;
            indexArticleVO.setReadCounts(readCounts);

            indexArticleList.add(indexArticleVO);
        &#125;


        gridResult.setRows(indexArticleList);
// END
        return gridResult;
    &#125;

    private AppUserVO getUserIfPublisher(String publisherId,
                                         List&lt;AppUserVO&gt; publisherList) &#123;
        for (AppUserVO user : publisherList) &#123;
            if (user.getId().equalsIgnoreCase(publisherId)) &#123;
                return user;
            &#125;
        &#125;
        return null;
    &#125;

    // 发起远程调用，获得用户的基本信息
    private List&lt;AppUserVO&gt; getPublisherList(Set idSet) &#123;
        String userServerUrlExecute
                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
                = restTemplate.getForEntity(userServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        return publisherList;
    &#125;

    @Override
    public GraceJSONResult hotList() &#123;
        return GraceJSONResult.ok(articlePortalService.queryHotList());
    &#125;

    @Override
    public GraceJSONResult queryArticleListOfWriter(String writerId, Integer page, Integer pageSize) &#123;

        System.out.println(&quot;writerId=&quot; + writerId);

        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult = articlePortalService.queryArticleListOfWriter(writerId, page, pageSize);
        gridResult = rebuildArticleGrid(gridResult);
        return GraceJSONResult.ok(gridResult);
    &#125;

    @Override
    public GraceJSONResult queryGoodArticleListOfWriter(String writerId) &#123;
        PagedGridResult gridResult = articlePortalService.queryGoodArticleListOfWriter(writerId);
        return GraceJSONResult.ok(gridResult);
    &#125;
&#125;

*/
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticlePortalServiceImpl.java
public interface ArticlePortalService &#123;

    /**
     * 首页查询文章列表
     */
    public PagedGridResult queryIndexArticleList(String keyword,
                                                 Integer category,
                                                 Integer page,
                                                 Integer pageSize);
    /**
     * 首页查询热闻列表
     */
    public List&lt;Article&gt; queryHotList();

    /**
     * 查询作家发布的所有文章列表
     */
    public PagedGridResult queryArticleListOfWriter(String writerId,
                                                    Integer page,
                                                    Integer pageSize);

    /**
     * 作家页面查询近期佳文
     */
    public PagedGridResult queryGoodArticleListOfWriter(String writerId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticlePortalServiceImpl.java

@Override
    public PagedGridResult queryArticleListOfWriter(String writerId, Integer page, Integer pageSize) &#123;
        Example articleExample = new Example(Article.class);

        Example.Criteria criteria = setDefualArticleExample(articleExample);
        criteria.andEqualTo(&quot;publishUserId&quot;, writerId);

        /**
         * page: 第几页
         * pageSize: 每页显示条数
         */
        PageHelper.startPage(page, pageSize);
        List&lt;Article&gt; list = articleMapper.selectByExample(articleExample);
        return setterPagedGrid(list, page);
    &#125;

    @Override
    public PagedGridResult queryGoodArticleListOfWriter(String writerId) &#123;
        Example articleExample = new Example(Article.class);
        articleExample.orderBy(&quot;publishTime&quot;).desc();

        Example.Criteria criteria = setDefualArticleExample(articleExample);
        criteria.andEqualTo(&quot;publishUserId&quot;, writerId);

        /**
         * page: 第几页
         * pageSize: 每页显示条数
         */
        PageHelper.startPage(1, 5);
        List&lt;Article&gt; list = articleMapper.selectByExample(articleExample);
        return setterPagedGrid(list, 1);
    &#125;

    private Example.Criteria setDefualArticleExample(Example articleExample) &#123;
        articleExample.orderBy(&quot;publishTime&quot;).desc();
        Example.Criteria criteria = articleExample.createCriteria();

        /**
         * 查询首页文章的自带隐性查询条件：
         * isAppoint=即使发布，表示文章已经直接发布的，或者定时任务到点发布的
         * isDelete=未删除，表示文章只能够显示未删除
         * articleStatus=审核通过，表示只有文章经过机审/人工审核之后才能展示
         */
        criteria.andEqualTo(&quot;isAppoint&quot;, YesOrNo.NO.type);
        criteria.andEqualTo(&quot;isDelete&quot;, YesOrNo.NO.type);
        criteria.andEqualTo(&quot;articleStatus&quot;, ArticleReviewStatus.SUCCESS.type);

        return criteria;
    &#125;
</code></pre>
<h4 id="关注与取关-redis单线程计数统计-【粉丝关注】"><a href="#关注与取关-redis单线程计数统计-【粉丝关注】" class="headerlink" title="关注与取关_redis单线程计数统计 【粉丝关注】"></a>关注与取关_redis单线程计数统计 【粉丝关注】</h4><blockquote>
<p>阅读数可以用数据库COUNT* 但是压力会很大 若很多人一起刷新会音响很大<br>用redis 数量累加累减 单线程安全<br>减少数据库压力</p>
</blockquote>
<pre><code class="mysql">【注意 redis我安装到了本地计算机里面 D:\Redis-x64-3.0.504】
打开redis-cli.exe
127.0.0.1:6379&gt; keys *
1) &quot;redis_all_category&quot;
2) &quot;redis_admin_token:1001&quot;
3) &quot;redis_user_info:1001&quot;
4) &quot;redis_user_info:200628AFYM7AGWPH&quot;
5) &quot;redis_user_token:240629F21AK1BHX4&quot;
6) &quot;redis_user_info:240629F21AK1BHX4&quot;
7) &quot;redis_user_token:200628AFYM7AGWPH&quot;
127.0.0.1:6379&gt; INCR 1001:fans #【增加】
(integer) 1
127.0.0.1:6379&gt; INCR 1001:fans
(integer) 2
127.0.0.1:6379&gt; INCR 1001:fans
(integer) 3
127.0.0.1:6379&gt; get 1001:fans #【获取】
&quot;3&quot;
127.0.0.1:6379&gt; DECR 1001:fans #【减少】
(integer) 2
127.0.0.1:6379&gt; DECR 1001:fans
(integer) 1
127.0.0.1:6379&gt; incr 1001:follows #【关注的粉丝】
(integer) 1
127.0.0.1:6379&gt; get 1001:follows
&quot;1&quot;
</code></pre>
<h3 id="查询用户关注状态【粉丝关注】"><a href="#查询用户关注状态【粉丝关注】" class="headerlink" title="查询用户关注状态【粉丝关注】"></a>查询用户关注状态【粉丝关注】</h3><pre><code class="java">service-api  com/imooc/api/controller/user/MyFansControllerApi.java
package com.imooc.api.controller.user;


import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

@Api(value = &quot;粉丝管理&quot;,tags = &#123;&quot;粉丝管理功能的controller&quot;&#125;)
@RequestMapping(&quot;fans&quot;)
public interface MyFansControllerApi &#123;
    @ApiOperation(value = &quot;查询当前用户是否关注作家&quot;,notes = &quot;查询当前用户是否关注作家&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/isMeFollowThisWriter&quot;)
    public GraceJSONResult isMeFollowThisWriter(@RequestParam String writerId, @RequestParam String fanId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/MyFansController.java
package com.imooc.user.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.api.controller.user.MyFansControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.user.service.MyFansService;
import com.imooc.utils.RedisOperator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class MyFansController extends BaseController implements MyFansControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(MyFansController.class);

    @Autowired
    private MyFansService myFansService;

    @Override
    public GraceJSONResult isMeFollowThisWriter(String writerId, String fanId) &#123;
        boolean res = myFansService.isMeFollowThisWriter(writerId,fanId);
        return GraceJSONResult.ok(res);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/MyFansService.java
package com.imooc.user.service;

import com.imooc.utils.PagedGridResult;

import java.util.Date;

public interface MyFansService &#123;
    /**
     * 查询当前用户是否关注作家
     */
    public boolean isMeFollowThisWriter(String writerId, String fanId);

&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/MyFansServiceImpl.java
package com.imooc.user.service.impl;

import com.github.pagehelper.PageHelper;
import com.imooc.api.service.BaseService;
import com.imooc.enums.UserStatus;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.Fans;
import com.imooc.user.mapper.AppUserMapper;
import com.imooc.user.mapper.FansMapper;
import com.imooc.user.service.AppUserMngService;
import com.imooc.user.service.MyFansService;
import com.imooc.utils.PagedGridResult;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;
import java.util.List;

@Service
public class MyFansServiceImpl extends BaseService implements MyFansService &#123;
    @Autowired
    public FansMapper fansMapper;


    @Override
    public boolean isMeFollowThisWriter(String writerId, String fanId) &#123;
        Fans fan = new Fans();
        fan.setFanId(fanId);
        fan.setWriterId(writerId);
        int count = fansMapper.selectCount(fan); //前期先放在数据库里
        return count &gt; 0 ? true : false;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/mapper/FansMapper.java
package com.imooc.user.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Fans;
import org.springframework.stereotype.Repository;

@Repository
public interface FansMapper extends MyMapper&lt;Fans&gt; &#123;
&#125;
</code></pre>
<h3 id="用户关注-粉丝累加-amp-amp-粉丝累减"><a href="#用户关注-粉丝累加-amp-amp-粉丝累减" class="headerlink" title="用户关注_粉丝累加 &amp;&amp; 粉丝累减"></a>用户关注_粉丝累加 &amp;&amp; 粉丝累减</h3><pre><code class="java">service-api  com/imooc/api/controller/user/MyFansControllerApi.java
package com.imooc.api.controller.user;


import com.imooc.grace.result.GraceJSONResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

@Api(value = &quot;粉丝管理&quot;,tags = &#123;&quot;粉丝管理功能的controller&quot;&#125;)
@RequestMapping(&quot;fans&quot;)
public interface MyFansControllerApi &#123;
    @ApiOperation(value = &quot;用户关注作家，成为粉丝&quot;,notes = &quot;用户关注作家，成为粉丝&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/follow&quot;)
    public GraceJSONResult follow(@RequestParam String writerId, @RequestParam String fanId);
    
    @ApiOperation(value = &quot;取消关注，作家损失粉丝&quot;,notes = &quot;取消关注，作家损失粉丝&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/unfollow&quot;)
    public GraceJSONResult unfollow(@RequestParam String writerId, @RequestParam String fanId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/MyFansController.java
package com.imooc.user.controller;

import com.imooc.api.BaseController;
import com.imooc.api.controller.user.MyFansControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.user.service.MyFansService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class MyFansController extends BaseController implements MyFansControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(MyFansController.class);

    @Autowired
    private MyFansService myFansService;

    @Override
    public GraceJSONResult isMeFollowThisWriter(String writerId, String fanId) &#123;
        boolean res = myFansService.isMeFollowThisWriter(writerId,fanId);
        return GraceJSONResult.ok(res);
    &#125;

    @Override
    public GraceJSONResult follow(String writerId, String fanId) &#123;
        myFansService.follow(writerId,fanId);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult unfollow(String writerId, String fanId) &#123;
        myFansService.unfollow(writerId, fanId);
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/MyFansService.java
package com.imooc.user.service;

public interface MyFansService &#123;
    /**
     * 查询当前用户是否关注作家
     */
    public boolean isMeFollowThisWriter(String writerId, String fanId);

    /**
     * 关注成为粉丝
     */
    public void follow(String writerId, String fanId);
    
    /**
     * 粉丝取消关注
     */
    public void unfollow(String writerId, String fanId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/MyFansServiceImpl.java
package com.imooc.user.service.impl;

import com.github.pagehelper.PageHelper;
import com.imooc.api.service.BaseService;
import com.imooc.enums.UserStatus;
import com.imooc.pojo.AppUser;
import com.imooc.pojo.Fans;
import com.imooc.user.mapper.AppUserMapper;
import com.imooc.user.mapper.FansMapper;
import com.imooc.user.service.AppUserMngService;
import com.imooc.user.service.MyFansService;
import com.imooc.utils.PagedGridResult;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tk.mybatis.mapper.entity.Example;

import java.util.Date;
import java.util.List;

@Service
public class MyFansServiceImpl extends BaseService implements MyFansService &#123;
    @Autowired
    public FansMapper fansMapper;
    @Override
    public boolean isMeFollowThisWriter(String writerId, String fanId) &#123;
        Fans fan = new Fans();
        fan.setFanId(fanId);
        fan.setWriterId(writerId);
        int count = fansMapper.selectCount(fan); //前期先放在数据库里
        return count &gt; 0 ? true : false;
    &#125;
    
    @Transactional
    @Override
    public void follow(String writerId, String fanId) &#123;
        // 获得粉丝用户的信息
        AppUser fanInfo = userService.getUser(fanId);

        String fanPkId = sid.nextShort();

        Fans fans = new Fans();
        fans.setId(fanPkId);
        fans.setFanId(fanId);
        fans.setWriterId(writerId);

        fans.setFace(fanInfo.getFace());
        fans.setFanNickname(fanInfo.getNickname());
        fans.setSex(fanInfo.getSex());
        fans.setProvince(fanInfo.getProvince());

        fansMapper.insert(fans);

        // redis 作家粉丝数累加
        redis.increment(REDIS_WRITER_FANS_COUNTS + &quot;:&quot; + writerId, 1);  //增加key一次
        // redis 当前用户的(我的)关注数累加
        redis.increment(REDIS_MY_FOLLOW_COUNTS + &quot;:&quot; + fanId, 1);  //增加key一次
    &#125;
    
    @Transactional
    @Override
    public void unfollow(String writerId, String fanId) &#123;
        Fans fans = new Fans();
        fans.setWriterId(writerId);
        fans.setFanId(fanId);

        fansMapper.delete(fans);

        // redis 作家粉丝数累减
        redis.decrement(REDIS_WRITER_FANS_COUNTS + &quot;:&quot; + writerId, 1);  //增加key一次
        // redis 当前用户的(我的)关注数累减
        redis.decrement(REDIS_MY_FOLLOW_COUNTS + &quot;:&quot; + fanId, 1);  //增加key一次
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/service/BaseService.java
package com.imooc.api.service;

import com.github.pagehelper.PageInfo;
import com.imooc.utils.PagedGridResult;
import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;

public class BaseService &#123;
    public static final String REDIS_ALL_CATEGORY = &quot;redis_all_category&quot;;

    public static final String REDIS_WRITER_FANS_COUNTS = &quot;redis_writer_fans_counts&quot;;
    public static final String REDIS_MY_FOLLOW_COUNTS = &quot;redis_my_follow_counts&quot;;

    public static final String REDIS_ARTICLE_COMMENT_COUNTS = &quot;redis_article_comment_counts&quot;;

    @Autowired
    public RedisOperator redis;
    public PagedGridResult setterPagedGrid(List&lt;?&gt; list, Integer page)&#123; //类型是? 后期不确定是什么泛型
        PageInfo&lt;?&gt; pageList = new PageInfo&lt;&gt;(list);
        PagedGridResult gridResult = new PagedGridResult();
        gridResult.setRows(list);
        gridResult.setPage(page);
        gridResult.setRecords(pageList.getTotal());
        gridResult.setTotal(pageList.getPages());
        return gridResult;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java //增加粉丝接口的拦截
package com.imooc.api.config;

import com.imooc.api.interceptors.AdminTokenInterceptor;
import com.imooc.api.interceptors.PassportInterceptor;
import com.imooc.api.interceptors.UserActiveInterceptor;
import com.imooc.api.interceptors.UserTokenInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Bean
    public PassportInterceptor passportInterceptor()&#123;
        return new PassportInterceptor();
    &#125;
    @Bean
    public UserTokenInterceptor userTokenInterceptor()&#123;
        return new UserTokenInterceptor();
    &#125;
    @Bean
    public UserActiveInterceptor userActiveInterceptor() &#123;
        return new UserActiveInterceptor();
    &#125;

    @Bean
    public AdminTokenInterceptor adminTokenInterceptor() &#123;
        return new AdminTokenInterceptor();
    &#125;


    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
        registry.addInterceptor(passportInterceptor())
                .addPathPatterns(&quot;/passport/getSMSCode&quot;); //拦截PassportControllerApi里的信息
        registry.addInterceptor(userTokenInterceptor())
                .addPathPatterns(&quot;/user/getAccountInfo&quot;)
                .addPathPatterns(&quot;/user/updateUserId&quot;)
                .addPathPatterns(&quot;/fs/uploadFace&quot;)
                .addPathPatterns(&quot;/fs/uploadSomeFiles&quot;)
                .addPathPatterns(&quot;/fans/follow&quot;)
                .addPathPatterns(&quot;/fans/unfollow&quot;);

        registry.addInterceptor(adminTokenInterceptor())//继续添加拦截器：查询admin列表 创建新admin用户
                .addPathPatterns(&quot;/adminMng/adminIsExist&quot;)
                .addPathPatterns(&quot;/adminMng/addNewAdmin&quot;)
                .addPathPatterns(&quot;/adminMng/getAdminList&quot;)
                .addPathPatterns(&quot;/fs/uploadToGridFS&quot;)
                .addPathPatterns(&quot;/friendLinkMng/saveOrUpdateFriendLink&quot;)
                .addPathPatterns(&quot;/friendLinkMng/getFriendLinkList&quot;)
                .addPathPatterns(&quot;/friendLinkMng/delete&quot;)
                .addPathPatterns(&quot;/categoryMng/saveOrUpdateCategory&quot;)
                .addPathPatterns(&quot;/categoryMng/getCatList&quot;);

        registry.addInterceptor(userActiveInterceptor())
                .addPathPatterns(&quot;/fs/uploadSomeFiles&quot;)
                .addPathPatterns(&quot;/fans/follow&quot;)
                .addPathPatterns(&quot;/fans/unfollow&quot;);
    &#125;
&#125;
</code></pre>
<h3 id="粉丝数与关注数页面显示【粉丝关注】"><a href="#粉丝数与关注数页面显示【粉丝关注】" class="headerlink" title="粉丝数与关注数页面显示【粉丝关注】"></a>粉丝数与关注数页面显示【粉丝关注】</h3><pre><code class="java">service-user  com/imooc/user/controller/UserController.java
@RestController
public class UserController extends BaseController implements UserControllerApi &#123;
 @Override
    public GraceJSONResult getUserInfo(String userId) &#123;
        //接口进行解耦!!
        // 0. 判断参数不为空
        if (StringUtils.isBlank(userId))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.UN_LOGIN);
        &#125;
        // 1. 根据userId查询用户的信息 UserService+impl
        AppUser user = getUser(userId);
        // 2. 返回用户信息
        AppUserVO userVO = new AppUserVO();
        BeanUtils.copyProperties(user, userVO); //拷贝信息
        // 3. 查询redis中用户的关注数和粉丝数，放入userVO放入前端渲染
        userVO.setMyFansCounts(getCountsFromRedis(REDIS_WRITER_FANS_COUNTS + &quot;:&quot; + userId));
        userVO.setMyFollowCounts(getCountsFromRedis(REDIS_MY_FOLLOW_COUNTS + &quot;:&quot; + userId));
        return GraceJSONResult.ok(userVO);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java
public abstract class BaseController &#123;
public Integer getCountsFromRedis(String key)&#123;
        String countsStr = redis.get(key);
        if (StringUtils.isBlank(countsStr)) &#123;
            countsStr = &quot;0&quot;;
        &#125;
        return Integer.valueOf(countsStr);
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/AppUserVO.java
public class AppUserVO &#123;
    private String id;
    private String nickname;
    private String face;
    private Integer activeStatus;

    private Integer myFollowCounts;
    private Integer myFansCounts;
&#125;Getter + Setter
</code></pre>
<h3 id="我的粉丝列表-后端分页查询【粉丝管理】"><a href="#我的粉丝列表-后端分页查询【粉丝管理】" class="headerlink" title="我的粉丝列表_后端分页查询【粉丝管理】"></a>我的粉丝列表_后端分页查询【粉丝管理】</h3><pre><code class="java">service-api  com/imooc/api/controller/user/MyFansControllerApi.java
@Api(value = &quot;粉丝管理&quot;,tags = &#123;&quot;粉丝管理功能的controller&quot;&#125;)
@RequestMapping(&quot;fans&quot;)
public interface MyFansControllerApi &#123;
@ApiOperation(value = &quot;查询我的所有粉丝列表&quot;, notes = &quot;查询我的所有粉丝列表&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/queryAll&quot;)
    public GraceJSONResult queryAll(
            @RequestParam String writerId,
            @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
            @RequestParam Integer page,
            @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页查询每一页显示的条数&quot;, required = false)
            @RequestParam Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/MyFansController.java
@RestController
public class MyFansController extends BaseController implements MyFansControllerApi &#123;
 @Override
    public GraceJSONResult queryAll(String writerId, Integer page, Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        return GraceJSONResult.ok(myFansService.queryMyFansList(writerId, page, pageSize));
    &#125;
&#125;
===================================================================
http://writer.imoocnews.com:9090/imooc-news/writer/myFans.html
数据库中fans表
weiter_id
可以改成登录的cookie里面的 uid：240629F21AK1BHX4
就可以测试用户粉丝数量
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/MyFansService.java
package com.imooc.user.service;

import com.imooc.utils.PagedGridResult;

public interface MyFansService &#123;
    /**
     * 查询当前用户是否关注作家
     */
    public boolean isMeFollowThisWriter(String writerId, String fanId);

    /**
     * 关注成为粉丝
     */
    public void follow(String writerId, String fanId);

    /**
     * 粉丝取消关注
     */
    public void unfollow(String writerId, String fanId);

    /**
     * 查询我的粉丝
     */
    public PagedGridResult queryMyFansList(String writerId, Integer page, Integer pageSize);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/MyFansServiceImpl.java
@Service
public class MyFansServiceImpl extends BaseService implements MyFansService &#123;
@Override
    public PagedGridResult queryMyFansList(String writerId, Integer page, Integer pageSize) &#123;
        Fans fans = new Fans();
        fans.setWriterId(writerId);

        PageHelper.startPage(page,pageSize); //进行分页
        List&lt;Fans&gt; list = fansMapper.select(fans);
        return setterPagedGrid(list,page);
    &#125;
&#125;
</code></pre>
<h3 id="男女比例柱状图-饼状图显示【数据可视化-粉丝画像】Echarts"><a href="#男女比例柱状图-饼状图显示【数据可视化-粉丝画像】Echarts" class="headerlink" title="男女比例柱状图_饼状图显示【数据可视化-粉丝画像】Echarts"></a>男女比例柱状图_饼状图显示【数据可视化-粉丝画像】<del>Echarts</del></h3><p><a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">Apache ECharts</a> + 前端 [myFansCharts-static.html + myFansCharts.html]</p>
<pre><code class="java">service-api  com/imooc/api/controller/user/MyFansControllerApi.java
@Api(value = &quot;粉丝管理&quot;,tags = &#123;&quot;粉丝管理功能的controller&quot;&#125;)
@RequestMapping(&quot;fans&quot;)
public interface MyFansControllerApi &#123;
@ApiOperation(value = &quot;查询男女粉丝数量&quot;, notes = &quot;查询男女粉丝数量&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/queryRatio&quot;)
    public GraceJSONResult queryRatio(@RequestParam String writerId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/MyFansController.java
@RestController
public class MyFansController extends BaseController implements MyFansControllerApi &#123;
 @Override
    public GraceJSONResult queryRatio(String writerId) &#123;
        int manCount = myFansService.queryFansCounts(writerId, Sex.man);
        int womanCount = myFansService.queryFansCounts(writerId, Sex.woman);

        FansCountsVO fansCountsVO = new FansCountsVO();
        fansCountsVO.setManCounts(manCount);
        fansCountsVO.setWomanCounts(womanCount);
        return GraceJSONResult.ok(fansCountsVO);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/MyFansService.java
package com.imooc.user.service;

import com.imooc.utils.PagedGridResult;

public interface MyFansService &#123;
     /**
     * 查询粉丝数
     */
    public Integer queryFansCounts(String writerId, Sex sex);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/MyFansServiceImpl.java
@Service
public class MyFansServiceImpl extends BaseService implements MyFansService &#123;
@Override
    public Integer queryFansCounts(String writerId, Sex sex) &#123;
        Fans fans = new Fans();
        fans.setWriterId(writerId);
        fans.setSex(sex.type);

        int count = fansMapper.selectCount(fans);
        return count;
    &#125;
&#125;
</code></pre>
<h3 id="中国地图粉丝地域分布数量展示【数据可视化-粉丝画像】"><a href="#中国地图粉丝地域分布数量展示【数据可视化-粉丝画像】" class="headerlink" title="中国地图粉丝地域分布数量展示【数据可视化-粉丝画像】"></a>中国地图粉丝地域分布数量展示【数据可视化-粉丝画像】</h3><h3 id="男女比例柱状图-饼状图显示【数据可视化-粉丝画像】Echarts-1"><a href="#男女比例柱状图-饼状图显示【数据可视化-粉丝画像】Echarts-1" class="headerlink" title="男女比例柱状图_饼状图显示【数据可视化-粉丝画像】Echarts"></a>男女比例柱状图_饼状图显示【数据可视化-粉丝画像】<del>Echarts</del></h3><p><a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">Apache ECharts</a> + 前端 [myFansCharts-static.html + myFansCharts.html]</p>
<pre><code class="java">service-api  com/imooc/api/controller/user/MyFansControllerApi.java
@ApiOperation(value = &quot;根据地域查询粉丝数量&quot;, notes = &quot;根据地域查询粉丝数量&quot;, httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/queryRatioByRegion&quot;)
    public GraceJSONResult queryRatioByRegion(@RequestParam String writerId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/MyFansController.java
@RestController
public class MyFansController extends BaseController implements MyFansControllerApi &#123;
  @Override
    public GraceJSONResult queryRatioByRegion(String writerId) &#123;
        return GraceJSONResult.ok(myFansService.queryRegionRatioCounts(writerId));
    &#125;
&#125;
=====================================================================
将fans里的writer_id【自己的cookie里的uid 属于自己的属性 对应着右面的province省份】
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/MyFansService.java
package com.imooc.user.service;

import com.imooc.utils.PagedGridResult;

public interface MyFansService &#123;
     /**
     * 查询粉丝数
     */
    public List&lt;RegionRatioVO&gt; queryRegionRatioCounts(String writerId);
&#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/service/impl/MyFansServiceImpl.java
@Service
public class MyFansServiceImpl extends BaseService implements MyFansService &#123;
@Override
    public List&lt;RegionRatioVO&gt; queryRegionRatioCounts(String writerId) &#123;
        Fans fans = new Fans();
        fans.setWriterId(writerId);

        List&lt;RegionRatioVO&gt; list = new ArrayList&lt;&gt;();
        for (String r : regions) &#123;
            fans.setProvince(r);
            Integer count = fansMapper.selectCount(fans);

            RegionRatioVO regionRatioVO = new RegionRatioVO();
            regionRatioVO.setName(r);
            regionRatioVO.setValue(count);

            list.add(regionRatioVO);
        &#125;
        return list;
    &#125;

    public static final String[] regions = &#123;&quot;北京&quot;, &quot;天津&quot;, &quot;上海&quot;, &quot;重庆&quot;,
            &quot;河北&quot;, &quot;山西&quot;, &quot;辽宁&quot;, &quot;吉林&quot;, &quot;黑龙江&quot;, &quot;江苏&quot;, &quot;浙江&quot;, &quot;安徽&quot;, &quot;福建&quot;, &quot;江西&quot;, &quot;山东&quot;,
            &quot;河南&quot;, &quot;湖北&quot;, &quot;湖南&quot;, &quot;广东&quot;, &quot;海南&quot;, &quot;四川&quot;, &quot;贵州&quot;, &quot;云南&quot;, &quot;陕西&quot;, &quot;甘肃&quot;, &quot;青海&quot;, &quot;台湾&quot;,
            &quot;内蒙古&quot;, &quot;广西&quot;, &quot;西藏&quot;, &quot;宁夏&quot;, &quot;新疆&quot;,
            &quot;香港&quot;, &quot;澳门&quot;&#125;;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/RegionRatioVO.java
package com.imooc.pojo.vo;

public class RegionRatioVO &#123;

    private String name;
    private Integer value;

    public String getName() &#123;
        return name;
    &#125;

    public void setName(String name) &#123;
        this.name = name;
    &#125;

    public Integer getValue() &#123;
        return value;
    &#125;

    public void setValue(Integer value) &#123;
        this.value = value;
    &#125;
&#125;
</code></pre>
<h2 id="开发文章详情接口-【章节概述】detail-html"><a href="#开发文章详情接口-【章节概述】detail-html" class="headerlink" title="开发文章详情接口 【章节概述】detail.html"></a>开发文章详情接口 【章节概述】<del>detail.html</del></h2><ul>
<li><strong>文章详情页</strong></li>
<li><strong>文章评论模块</strong></li>
<li><strong>评论管理</strong></li>
</ul>
<h3 id="文章详情页"><a href="#文章详情页" class="headerlink" title="文章详情页"></a>文章详情页</h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
 @GetMapping(&quot;detail&quot;)
    @ApiOperation(value = &quot;文章详情查询&quot;, notes = &quot;文章详情查询&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult detail(@RequestParam String articleId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
 @Override
    public GraceJSONResult detail(String articleId) &#123;
        ArticleDetailVO detailVO = articlePortalService.queryDetail(articleId);

        Set&lt;String&gt; idSet = new HashSet();
        idSet.add(detailVO.getPublishUserId());
        List&lt;AppUserVO&gt; publisherList = getPublisherList(idSet);

        if (!publisherList.isEmpty()) &#123;
            detailVO.setPublishUserName(publisherList.get(0).getNickname());
        &#125;

        detailVO.setReadCounts(
                getCountsFromRedis(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + articleId));

        return GraceJSONResult.ok(detailVO);
    &#125;
==================================================================
http://www.imoocnews.com:9090/imooc-news/portal/detail.html?articleId=240721DDAHBPWG0H
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticlePortalService.java
    /**
     * 查询文章详情
     */
    public ArticleDetailVO queryDetail(String articleId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticlePortalServiceImpl.java
    @Override
    public ArticleDetailVO queryDetail(String articleId) &#123;
        Article article = new Article();
        article.setId(articleId);
        article.setIsAppoint(YesOrNo.NO.type);
        article.setIsDelete(YesOrNo.NO.type);
        article.setArticleStatus(ArticleReviewStatus.SUCCESS.type);

        Article result = articleMapper.selectOne(article);
        ArticleDetailVO detailVO = new ArticleDetailVO();
        BeanUtils.copyProperties(result, detailVO);
        return detailVO;
    &#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/ArticleDetailVO.java
package com.imooc.pojo.vo;

import com.fasterxml.jackson.annotation.JsonFormat;

import java.util.Date;

public class ArticleDetailVO &#123;

    private String id;
    private String title;
    private String cover;
    private Integer categoryId;
    private String categoryName;
    private String publishUserId;
    @JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
    private Date publishTime;
    private String content;

    private String publishUserName;
    private Integer readCounts;
&#125;Getter + Setter
</code></pre>
<h3 id="阅读文章-阅读量redis累加【详情页】"><a href="#阅读文章-阅读量redis累加【详情页】" class="headerlink" title="阅读文章_阅读量redis累加【详情页】"></a>阅读文章_阅读量redis累加【详情页】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
@PostMapping(&quot;readArticle&quot;)
    @ApiOperation(value = &quot;阅读文章，文章阅读量累加&quot;, notes = &quot;阅读文章，文章阅读量累加&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult readArticle(@RequestParam String articleId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
  @Override
    public GraceJSONResult detail(String articleId) &#123;
        ArticleDetailVO detailVO = articlePortalService.queryDetail(articleId);

        Set&lt;String&gt; idSet = new HashSet();
        idSet.add(detailVO.getPublishUserId());
        List&lt;AppUserVO&gt; publisherList = getPublisherList(idSet);

        if (!publisherList.isEmpty()) &#123;
            detailVO.setPublishUserName(publisherList.get(0).getNickname());
        &#125;

        detailVO.setReadCounts( //去redis获取值 关联到前端阅读量增加 关联！！！
                getCountsFromRedis(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + articleId));

        return GraceJSONResult.ok(detailVO);
    &#125;

    @Override
    public GraceJSONResult readArticle(String articleId) &#123;
        redis.increment(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + articleId, 1);
        return GraceJSONResult.ok();
    &#125;
==================================================================
http://www.imoocnews.com:9090/imooc-news/portal/detail.html?articleId=240721DDAHBPWG0H
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticlePortalService.java
public class ArticleDetailVO &#123;

    private String id;
    private String title;
    private String cover;
    private Integer categoryId;
    private String categoryName;
    private String publishUserId;
    @JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
    private Date publishTime;
    private String content;

    private String publishUserName;
    private Integer readCounts;
&#125;Getter + Setter
</code></pre>
<h3 id="文章阅读数防刷策略【详情页】"><a href="#文章阅读数防刷策略【详情页】" class="headerlink" title="文章阅读数防刷策略【详情页】"></a>文章阅读数防刷策略【详情页】</h3><blockquote>
<p>限定id去做增加 readArticle中增加拦截器<br>在ArticlePortalControllerApi.java中的readArticle接口 增加 HttpServletRequest request</p>
</blockquote>
<pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
@PostMapping(&quot;readArticle&quot;)
    @ApiOperation(value = &quot;阅读文章，文章阅读量累加&quot;, notes = &quot;阅读文章，文章阅读量累加&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult readArticle(@RequestParam String articleId, HttpServletRequest request);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
@Override
    public GraceJSONResult readArticle(String articleId, HttpServletRequest request) &#123;
        String userIp = IPUtil.getRequestIp(request);
        // 设置针对当前用户ip的永久存在的key，存入redis，表示该ip的用户已经阅读过了 防刷策略
        redis.setnx(REDIS_ALREADY_READ + &quot;:&quot; + articleId + &quot;:&quot; + userIp, userIp);

        redis.increment(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + articleId, 1);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/interceptors/ArticleReadInterceptor.java //【增加拦截器】
package com.imooc.api.interceptors;

import com.imooc.utils.IPUtil;
import com.imooc.utils.RedisOperator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class ArticleReadInterceptor extends BaseInterceptor implements HandlerInterceptor &#123;

    @Autowired
    public RedisOperator redis;
    public static final String REDIS_ALREADY_READ = &quot;redis_already_read&quot;;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;

        String articleId = request.getParameter(&quot;articleId&quot;);

        String userIp = IPUtil.getRequestIp(request);
        boolean isExist = redis.keyIsExist(REDIS_ALREADY_READ + &quot;:&quot; +  articleId + &quot;:&quot; + userIp);

        if (isExist) &#123;
            return false;
        &#125;
        return true;
    &#125;

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;

    &#125;

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;

    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/InterceptorConfig.java
package com.imooc.api.config;

import com.imooc.api.interceptors.*;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
...
    @Bean
    public ArticleReadInterceptor articleReadInterceptor()&#123;
        return new ArticleReadInterceptor();
    &#125;

    @Override
    public void addInterceptors(InterceptorRegistry registry)&#123;//注册拦截器
...
        registry.addInterceptor(articleReadInterceptor())
                .addPathPatterns(&quot;/portal/article/readArticle&quot;);
    &#125;
&#125;
</code></pre>
<h3 id="Redis-mget-批量查询组装阅读量并展示【文章列表】"><a href="#Redis-mget-批量查询组装阅读量并展示【文章列表】" class="headerlink" title="Redis mget 批量查询组装阅读量并展示【文章列表】"></a>Redis mget 批量查询组装阅读量并展示【文章列表】</h3><h5 id="Redis-get单个读取-amp-amp-Redis-mget批量读取"><a href="#Redis-get单个读取-amp-amp-Redis-mget批量读取" class="headerlink" title="Redis get单个读取 &amp;&amp; Redis mget批量读取"></a>Redis get单个读取 &amp;&amp; Redis mget批量读取</h5><p><img src="https://raw.githubusercontent.com/P-luminary/images/9d581a6e864d203ffb7157e6edd621ef947c4775/data/Redis_mget%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2.png"></p>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
 private PagedGridResult rebuildArticleGrid(PagedGridResult gridResult) &#123;
        // START
        List&lt;Article&gt; list = (List&lt;Article&gt;)gridResult.getRows();
        // 1. 构建发布者id列表
        Set&lt;String&gt; idSet = new HashSet&lt;&gt;();
        List&lt;String&gt; idList = new ArrayList&lt;&gt;();
        for (Article a : list) &#123;
//            System.out.println(a.getPublishUserId());
            // 1.1 构建发布者的set
            idSet.add(a.getPublishUserId());
            // 1.2 构建文章id的list 包含所有key的值
            idList.add(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + a.getId());
        &#125;
        System.out.println(idSet.toString());
        // 发起redis的mget批量查询api，获得对应的值
        List&lt;String&gt; readCountsRedisList = redis.mget(idList);
        List&lt;AppUserVO&gt; publisherList = getPublisherList(idSet);

        // 3. 拼接两个list，重组文章列表
        List&lt;IndexArticleVO&gt; indexArticleList = new ArrayList&lt;&gt;();
        for (int i = 0 ; i &lt; list.size() ; i ++) &#123;
            IndexArticleVO indexArticleVO = new IndexArticleVO();
            Article a = list.get(i); //属性值拷贝
            BeanUtils.copyProperties(a, indexArticleVO);

            // 3.1 从publisherList中获得发布者的基本信息
            AppUserVO publisher  = getUserIfPublisher(a.getPublishUserId(), publisherList);
            indexArticleVO.setPublisherVO(publisher);

            // 3.2 重新组装设置文章列表中的阅读量
            String redisCountsStr = readCountsRedisList.get(i);
            int readCounts = 0;
            if (StringUtils.isNotBlank(redisCountsStr)) &#123;
                readCounts = Integer.valueOf(redisCountsStr);
            &#125;
            indexArticleVO.setReadCounts(readCounts);

            indexArticleList.add(indexArticleVO);
        &#125;
        gridResult.setRows(indexArticleList);
// END
        return gridResult;
    &#125;
</code></pre>
<h3 id="用户发表评论【文章评论】"><a href="#用户发表评论【文章评论】" class="headerlink" title="用户发表评论【文章评论】"></a>用户发表评论【文章评论】</h3><pre><code class="xml">mybatis-generator-database generatorConfig-article.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE generatorConfiguration
        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;

&lt;generatorConfiguration&gt;
    &lt;context id=&quot;MysqlContext&quot; targetRuntime=&quot;MyBatis3Simple&quot; defaultModelType=&quot;flat&quot;&gt;
        &lt;property name=&quot;beginningDelimiter&quot; value=&quot;`&quot;/&gt;
        &lt;property name=&quot;endingDelimiter&quot; value=&quot;`&quot;/&gt;

        &lt;!-- 通用mapper所在目录 --&gt;
        &lt;plugin type=&quot;tk.mybatis.mapper.generator.MapperPlugin&quot;&gt;
            &lt;property name=&quot;mappers&quot; value=&quot;com.imooc.my.mapper.MyMapper&quot;/&gt;
        &lt;/plugin&gt;

        &lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot;
                        connectionURL=&quot;jdbc:mysql://localhost:3306/imooc-news-dev&quot;
                        userId=&quot;root&quot;
                        password=&quot;root&quot;&gt;
        &lt;/jdbcConnection&gt;

        &lt;!-- 对应生成的pojo所在包 --&gt;
        &lt;javaModelGenerator targetPackage=&quot;com.imooc.pojo&quot; targetProject=&quot;mybatis-generator-database/src/main/java&quot;/&gt;

        &lt;!-- 对应生成的mapper所在目录 --&gt;
        &lt;sqlMapGenerator targetPackage=&quot;mapper.article&quot; targetProject=&quot;mybatis-generator-database/src/main/resources&quot;/&gt;

        &lt;!-- 配置mapper对应的java映射 --&gt;
        &lt;javaClientGenerator targetPackage=&quot;com.imooc.article.mapper&quot; targetProject=&quot;mybatis-generator-database/src/main/java&quot; type=&quot;XMLMAPPER&quot;/&gt;

        &lt;!-- 数据库表 --&gt;
        &lt;table tableName=&quot;comments&quot;&gt;&lt;/table&gt;

    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
</code></pre>
<pre><code class="java">mybatis-generator-database  com/imooc/mybatis/utils/ArticleGenerator.java //【运行】
package com.imooc.mybatis.utils;

import org.mybatis.generator.api.MyBatisGenerator;
import org.mybatis.generator.config.Configuration;
import org.mybatis.generator.config.xml.ConfigurationParser;
import org.mybatis.generator.internal.DefaultShellCallback;

import java.io.File;
import java.util.ArrayList;
import java.util.List;


public class ArticleGenerator &#123;

    public void generator() throws Exception &#123;

        List&lt;String&gt; warnings = new ArrayList&lt;String&gt;();
        boolean overwrite = true;
        //指定 逆向工程配置文件
        File configFile = new File(&quot;mybatis-generator-database&quot;
                                            + File.separator
                                            + &quot;generatorConfig-article.xml&quot;);
        ConfigurationParser cp = new ConfigurationParser(warnings);
        Configuration config = cp.parseConfiguration(configFile);
        DefaultShellCallback callback = new DefaultShellCallback(overwrite);
        MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config,
                callback, warnings);
        myBatisGenerator.generate(null);

    &#125; 
    
    public static void main(String[] args) throws Exception &#123;
        try &#123;
            ArticleGenerator generatorSqlmap = new ArticleGenerator();
            generatorSqlmap.generator();
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/mapper/CommentsMapper.java
package com.imooc.article.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Comments;

public interface CommentsMapper extends MyMapper&lt;Comments&gt; &#123;
&#125;

================================================================

</code></pre>
<pre><code class="java">service-article  resources/mapper/CommentsMapper.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.CommentsMapper&quot;&gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Comments&quot;&gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;id&quot; /&gt;
    &lt;result column=&quot;writer_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;writerId&quot; /&gt;
    &lt;result column=&quot;father_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;fatherId&quot; /&gt;
    &lt;result column=&quot;article_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleId&quot; /&gt;
    &lt;result column=&quot;article_title&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleTitle&quot; /&gt;
    &lt;result column=&quot;article_cover&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleCover&quot; /&gt;
    &lt;result column=&quot;comment_user_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserId&quot; /&gt;
    &lt;result column=&quot;comment_user_nickname&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserNickname&quot; /&gt;
    &lt;result column=&quot;comment_user_face&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserFace&quot; /&gt;
    &lt;result column=&quot;content&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;content&quot; /&gt;
    &lt;result column=&quot;create_time&quot; jdbcType=&quot;TIMESTAMP&quot; property=&quot;createTime&quot; /&gt;
  &lt;/resultMap&gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Comments&quot;&gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;id&quot; /&gt;
    &lt;result column=&quot;writer_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;writerId&quot; /&gt;
    &lt;result column=&quot;father_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;fatherId&quot; /&gt;
    &lt;result column=&quot;article_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleId&quot; /&gt;
    &lt;result column=&quot;article_title&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleTitle&quot; /&gt;
    &lt;result column=&quot;article_cover&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleCover&quot; /&gt;
    &lt;result column=&quot;comment_user_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserId&quot; /&gt;
    &lt;result column=&quot;comment_user_nickname&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserNickname&quot; /&gt;
    &lt;result column=&quot;comment_user_face&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserFace&quot; /&gt;
    &lt;result column=&quot;content&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;content&quot; /&gt;
    &lt;result column=&quot;create_time&quot; jdbcType=&quot;TIMESTAMP&quot; property=&quot;createTime&quot; /&gt;
  &lt;/resultMap&gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Comments&quot;&gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;id&quot; /&gt;
    &lt;result column=&quot;writer_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;writerId&quot; /&gt;
    &lt;result column=&quot;father_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;fatherId&quot; /&gt;
    &lt;result column=&quot;article_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleId&quot; /&gt;
    &lt;result column=&quot;article_title&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleTitle&quot; /&gt;
    &lt;result column=&quot;article_cover&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;articleCover&quot; /&gt;
    &lt;result column=&quot;comment_user_id&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserId&quot; /&gt;
    &lt;result column=&quot;comment_user_nickname&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;commentUserNickname&quot; /&gt;
    &lt;result column=&quot;content&quot; jdbcType=&quot;VARCHAR&quot; property=&quot;content&quot; /&gt;
    &lt;result column=&quot;create_time&quot; jdbcType=&quot;TIMESTAMP&quot; property=&quot;createTime&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/article/CommentControllerApi.java
@Api(value = &quot;评论相关业务的controller&quot;, tags = &#123;&quot;评论相关业务的controller&quot;&#125;)
@RequestMapping(&quot;comment&quot;)
public interface CommentControllerApi &#123;

    @PostMapping(&quot;createComment&quot;)
    @ApiOperation(value = &quot;用户评论&quot;, notes = &quot;用户评论&quot;, httpMethod = &quot;POST&quot;) //@Valid是做验证的
    public GraceJSONResult createArticle(@RequestBody @Valid CommentReplyBO commentReplyBO, BindingResult result);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/CommentController.java
@RestController
public class CommentController extends BaseController implements CommentControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(CommentController.class);

    @Override
    public GraceJSONResult createArticle(@Valid CommentReplyBO commentReplyBO,
                                         BindingResult result) &#123;
        // 0. 判断BindingResult是否保存错误的验证信息，如果有，则直接return
        if (result.hasErrors()) &#123;
            Map&lt;String, String&gt; errorMap = getErrors(result);
            return GraceJSONResult.errorMap(errorMap);
        &#125;

        // 1. 根据留言用户的id查询他的昵称，用于存入到数据表进行字段的冗余处理，从而避免多表关联查询的性能影响
        String userId = commentReplyBO.getCommentUserId();

        // 2. 发起restTemplate调用用户服务，获得用户侧昵称
        Set&lt;String&gt; idSet = new HashSet&lt;&gt;();
        idSet.add(userId);
        String nickname = getBasicUserList(idSet).get(0).getNickname();
...[未完待续]
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java
public List&lt;AppUserVO&gt; getBasicUserList(Set idSet) &#123;
        String userServerUrlExecute
                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
                = restTemplate.getForEntity(userServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; userVOList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            userVOList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        return userVOList;
    &#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/bo/CommentReplyBO.java
/**
 * 文章留言的BO
 */
public class CommentReplyBO &#123;

    @NotBlank(message = &quot;留言信息不完整&quot;)
    private String articleId;

    @NotBlank(message = &quot;留言信息不完整&quot;)
    private String fatherId;

    @NotBlank(message = &quot;当前用户信息不正确，请尝试重新登录&quot;)
    private String commentUserId;

    @NotBlank(message = &quot;留言内容不能为空&quot;)
    @Length(max = 50, message = &quot;文章内容长度不能超过50&quot;)
    private String content;
&#125;Getter + Setter + ToString
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/Comments.java
public class Comments &#123;
    @Id
    private String id;

    /**
     * 评论的文章是哪个作者的关联id
     */
    @Column(name = &quot;writer_id&quot;)
    private String writerId;

    /**
     * 如果是回复留言，则本条为子留言，需要关联查询
     */
    @Column(name = &quot;father_id&quot;)
    private String fatherId;

    /**
     * 回复的那个文章id
     */
    @Column(name = &quot;article_id&quot;)
    private String articleId;

    /**
     * 冗余文章标题，宽表处理，非规范化的sql思维，对于几百万文章和几百万评论的关联查询来讲，性能肯定不行，所以做宽表处理，从业务角度来说，文章发布以后不能随便修改标题和封面的
     */
    @Column(name = &quot;article_title&quot;)
    private String articleTitle;

    /**
     * 文章封面
     */
    @Column(name = &quot;article_cover&quot;)
    private String articleCover;

    /**
     * 发布留言的用户id
     */
    @Column(name = &quot;comment_user_id&quot;)
    private String commentUserId;

    /**
     * 冗余用户昵称，非一致性字段，用户修改昵称后可以不用同步
     */
    @Column(name = &quot;comment_user_nickname&quot;)
    private String commentUserNickname;

    /**
     * 冗余的用户头像
     */
    @Column(name = &quot;comment_user_face&quot;)
    private String commentUserFace;

    /**
     * 留言内容
     */
    private String content;

    /**
     * 留言时间
     */
    @Column(name = &quot;create_time&quot;)
    private Date createTime;
</code></pre>
<h3 id="用户评论入库保存【文章评论】这里暂时把数据库的comment-user-face删除了"><a href="#用户评论入库保存【文章评论】这里暂时把数据库的comment-user-face删除了" class="headerlink" title="用户评论入库保存【文章评论】这里暂时把数据库的comment_user_face删除了"></a>用户评论入库保存【文章评论】<del>这里暂时把数据库的comment_user_face删除了</del></h3><pre><code class="java">service-api  com/imooc/api/controller/article/CommentControllerApi.java
@Api(value = &quot;评论相关业务的controller&quot;, tags = &#123;&quot;评论相关业务的controller&quot;&#125;)
@RequestMapping(&quot;comment&quot;)
public interface CommentControllerApi &#123;

    @PostMapping(&quot;createComment&quot;)
    @ApiOperation(value = &quot;用户评论&quot;, notes = &quot;用户评论&quot;, httpMethod = &quot;POST&quot;) //@Valid是做验证的
    public GraceJSONResult createArticle(@RequestBody @Valid CommentReplyBO commentReplyBO, BindingResult result);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/CommentController.java
@RestController
public class CommentController extends BaseController implements CommentControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(CommentController.class);
    @Autowired
    private CommentPortalService commentPortalService;

    @Override
    public GraceJSONResult createArticle(@Valid CommentReplyBO commentReplyBO,
                                         BindingResult result) &#123;
        // 0. 判断BindingResult是否保存错误的验证信息，如果有，则直接return
        if (result.hasErrors()) &#123;
            Map&lt;String, String&gt; errorMap = getErrors(result);
            return GraceJSONResult.errorMap(errorMap);
        &#125;

        // 1. 根据留言用户的id查询他的昵称，用于存入到数据表进行字段的冗余处理，从而避免多表关联查询的性能影响
        String userId = commentReplyBO.getCommentUserId();

        // 2. 发起restTemplate调用用户服务，获得用户侧昵称
        Set&lt;String&gt; idSet = new HashSet&lt;&gt;();
        idSet.add(userId);
        String nickname = getBasicUserList(idSet).get(0).getNickname();

        // 3. 保存用户评论的信息到数据库
        commentPortalService.createComment(commentReplyBO.getArticleId(), commentReplyBO.getFatherId(), commentReplyBO.getContent(), userId, nickname);

        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/CommentPortalService.java
public interface CommentPortalService &#123;
    /**
     * 发表评论
     */
    public void createComment(String articleId,
                              String fatherCommentId,
                              String content,
                              String userId,
                              String nickname);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/CommentPortalServiceImpl.java
package com.imooc.article.service.impl;

import com.imooc.api.service.BaseService;
import com.imooc.article.mapper.CommentsMapper;
import com.imooc.article.service.ArticlePortalService;
import com.imooc.article.service.CommentPortalService;
import com.imooc.pojo.Comments;
import com.imooc.pojo.vo.ArticleDetailVO;
import com.imooc.utils.PagedGridResult;
import org.n3r.idworker.Sid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;


@Service
public class CommentPortalServiceImpl extends BaseService implements CommentPortalService &#123;
    @Autowired
    private ArticlePortalService articlePortalService;
    @Autowired
    private Sid sid;
    @Autowired
    private CommentsMapper commentsMapper;

    @Transactional
    @Override
    public void createComment(String articleId, String fatherCommentId, String content, String userId, String nickname) &#123;
        String commentId = sid.nextShort();
        ArticleDetailVO article = articlePortalService.queryDetail(articleId);
        Comments comments = new Comments();
        comments.setId(commentId);

        comments.setWriterId(article.getPublishUserId());
        comments.setArticleTitle(article.getTitle());
        comments.setArticleCover(article.getCover());
        comments.setArticleId(articleId);

        comments.setFatherId(fatherCommentId);
        comments.setCommentUserId(userId);
        comments.setCommentUserNickname(nickname);

        comments.setContent(content);
        comments.setCreateTime(new Date());

        commentsMapper.insert(comments);

        // 评论数累加
        redis.increment(REDIS_ARTICLE_COMMENT_COUNTS + &quot;:&quot; + articleId, 1);
    &#125;
&#125;
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/Comments.java
public class Comments &#123;
    @Id
    private String id;

    /**
     * 评论的文章是哪个作者的关联id
     */
    @Column(name = &quot;writer_id&quot;)
    private String writerId;

    /**
     * 如果是回复留言，则本条为子留言，需要关联查询
     */
    @Column(name = &quot;father_id&quot;)
    private String fatherId;

    /**
     * 回复的那个文章id
     */
    @Column(name = &quot;article_id&quot;)
    private String articleId;

    /**
     * 冗余文章标题，宽表处理，非规范化的sql思维，对于几百万文章和几百万评论的关联查询来讲，性能肯定不行，所以做宽表处理，从业务角度来说，文章发布以后不能随便修改标题和封面的
     */
    @Column(name = &quot;article_title&quot;)
    private String articleTitle;

    /**
     * 文章封面
     */
    @Column(name = &quot;article_cover&quot;)
    private String articleCover;

    /**
     * 发布留言的用户id
     */
    @Column(name = &quot;comment_user_id&quot;)
    private String commentUserId;

    /**
     * 冗余用户昵称，非一致性字段，用户修改昵称后可以不用同步
     */
    @Column(name = &quot;comment_user_nickname&quot;)
    private String commentUserNickname;

//    /**
//     * 冗余的用户头像
//     */
//    @Column(name = &quot;comment_user_face&quot;)
//    private String commentUserFace;

    /**
     * 留言内容
     */
    private String content;

    /**
     * 留言时间
     */
    @Column(name = &quot;create_time&quot;)
    private Date createTime;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/BaseController.java
public List&lt;AppUserVO&gt; getBasicUserList(Set idSet) &#123;
        String userServerUrlExecute
                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
                = restTemplate.getForEntity(userServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; userVOList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            userVOList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        return userVOList;
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/mapper/CommentsMapper.java
package com.imooc.article.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Comments;
import org.springframework.stereotype.Repository;

@Repository
public interface CommentsMapper extends MyMapper&lt;Comments&gt; &#123;
&#125;
</code></pre>
<pre><code class="java">service-article  resources/mapper/CommentsMapper.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.CommentsMapper&quot; &gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Comments&quot; &gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;writer_id&quot; property=&quot;writerId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;father_id&quot; property=&quot;fatherId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;article_id&quot; property=&quot;articleId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;article_title&quot; property=&quot;articleTitle&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;article_cover&quot; property=&quot;articleCover&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;comment_user_id&quot; property=&quot;commentUserId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;comment_user_nickname&quot; property=&quot;commentUserNickname&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;content&quot; property=&quot;content&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;create_time&quot; property=&quot;createTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<h3 id="评论数累计与显示【文章评论】"><a href="#评论数累计与显示【文章评论】" class="headerlink" title="评论数累计与显示【文章评论】"></a>评论数累计与显示【文章评论】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/CommentControllerApi.java
@Api(value = &quot;评论相关业务的controller&quot;, tags = &#123;&quot;评论相关业务的controller&quot;&#125;)
@RequestMapping(&quot;comment&quot;)
public interface CommentControllerApi &#123;
@GetMapping(&quot;counts&quot;)
    @ApiOperation(value = &quot;用户评论数查询&quot;, notes = &quot;用户评论数查询&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult commentCounts(@RequestParam String articleId);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/CommentController.java
 @Override
    public GraceJSONResult commentCounts(String articleId) &#123;
        Integer counts = getCountsFromRedis(REDIS_ARTICLE_COMMENT_COUNTS + &quot;:&quot; + articleId);
        return GraceJSONResult.ok(counts);
    &#125;

--------------------------------------------------------------------------
service-api  com/imooc/api/BaseController.java
public Integer getCountsFromRedis(String key)&#123;
        String countsStr = redis.get(key);
        if (StringUtils.isBlank(countsStr)) &#123;
            countsStr = &quot;0&quot;;
        &#125;
        return Integer.valueOf(countsStr);
    &#125;
</code></pre>
<h3 id="文章评论sql关联查询father-id…"><a href="#文章评论sql关联查询father-id…" class="headerlink" title="文章评论sql关联查询father_id…"></a>文章评论sql关联查询<del>father_id…</del></h3><pre><code class="mysql">【多表关联查询】
SELECT
    c.id as commentId,
    c.father_id as fatherId,
    c.comment_user_id as commentUserId,
    c.comment_user_nickname as commentUserNickname,
    c.article_id as articleId,
    c.content as content,
    c.create_time as createTime,
    f.comment_user_nickname as quoteUserNickname,
    f.content as quoteContent
FROM
    comments c
LEFT JOIN
    comments f
ON
    c.father_id = f.id
WHERE
    c.article_id = &#39;2006117B57WRZGHH&#39;
ORDER BY
    c.create_time
DESC
</code></pre>
<h3 id="显示评论列表【文章评论】"><a href="#显示评论列表【文章评论】" class="headerlink" title="显示评论列表【文章评论】"></a>显示评论列表【文章评论】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/CommentControllerApi.java
com/imooc/api/controller/article/CommentControllerApi.java 
@GetMapping(&quot;list&quot;)
    @ApiOperation(value = &quot;查询文章的所有评论列表&quot;, notes = &quot;查询文章的所有评论列表&quot;, httpMethod = &quot;GET&quot;)
    public GraceJSONResult list(@RequestParam String articleId,
                                @RequestParam Integer page,
                                @RequestParam Integer pageSize);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/CommentController.java
@Override
    public GraceJSONResult list(String articleId, Integer page, Integer pageSize) &#123;
        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;

        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;
        PagedGridResult gridResult = commentPortalService.queryArticleComments(articleId, page, pageSize);
        return GraceJSONResult.ok(gridResult);
    &#125;
==============================================================
http://www.imoocnews.com:9090/imooc-news/portal/detail.html?articleId=200816961ZYBXFRP
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/CommentPortalService.java
/**
     * 查询文章评论列表
     */
    public PagedGridResult queryArticleComments(String articleId,
                                                Integer page,
                                                Integer pageSize);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/mapper/CommentsMapperCustom.java
package com.imooc.article.mapper;

import com.imooc.pojo.vo.CommentsVO;
import org.apache.ibatis.annotations.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Map;

@Repository
public interface CommentsMapperCustom &#123;

    /**
     * 查询文章评论
     */
    public List&lt;CommentsVO&gt; queryArticleCommentList(@Param(&quot;paramMap&quot;) Map&lt;String, Object&gt; map);

&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/CommentPortalServiceImpl.java
@Override
    public PagedGridResult queryArticleComments(String articleId, Integer page, Integer pageSize) &#123;
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;articleId&quot;, articleId);

        PageHelper.startPage(page, pageSize);
        List&lt;CommentsVO&gt; list = commentsMapperCustom.queryArticleCommentList(map);
        return setterPagedGrid(list,page);
    &#125;
</code></pre>
<pre><code class="mysql">service-article  resources/mapper/CommentsMapperCustom.xml #【把关于face的字段都删掉】
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.CommentsMapperCustom&quot; &gt;

  &lt;select id=&quot;queryArticleCommentList&quot;
          resultType=&quot;com.imooc.pojo.vo.CommentsVO&quot;
          parameterType=&quot;Map&quot;&gt;

    SELECT
      c.id as commentId,
      c.father_id as fatherId,
      c.comment_user_id as commentUserId,
      c.comment_user_nickname as commentUserNickname,
      c.article_id as articleId,
      c.content as content,
      c.create_time as createTime,
      f.comment_user_nickname as quoteUserNickname,
      f.content as quoteContent
    FROM
      comments c
        LEFT JOIN
      comments f
      ON
        c.father_id = f.id
    WHERE
      c.article_id = #&#123;paramMap.articleId&#125;
    ORDER BY
      c.create_time
            DESC

  &lt;/select&gt;
&lt;/mapper&gt;
</code></pre>
<h3 id="作业-管理评论列表以及删除评论【评论管理】"><a href="#作业-管理评论列表以及删除评论【评论管理】" class="headerlink" title="(作业) 管理评论列表以及删除评论【评论管理】"></a>(作业) 管理评论列表以及删除评论【评论管理】</h3><blockquote>
<p>前端的commentMng.html的VUE有问题<br>需要增加定义userInfo<br>var mainPage &#x3D; new Vue({<br>        el: “#mainPage”,<br>data: {<br>            userInfo: {<br>                activeStatus: 0<br>            },<br>}…</p>
</blockquote>
<pre><code class="java">service-api  com/imooc/api/controller/article/CommentControllerApi.java
    @PostMapping(&quot;mng&quot;)
    @ApiOperation(value = &quot;查询我的评论管理列表&quot;, notes = &quot;查询我的评论管理列表&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult mng(@RequestParam String writerId,
                               @ApiParam(name = &quot;page&quot;, value = &quot;查询下一页的第几页&quot;, required = false)
                               @RequestParam Integer page,
                               @ApiParam(name = &quot;pageSize&quot;, value = &quot;分页的每一页显示的条数&quot;, required = false)
                               @RequestParam Integer pageSize);


    @PostMapping(&quot;/delete&quot;)
    @ApiOperation(value = &quot;作者删除评论&quot;, notes = &quot;作者删除评论&quot;, httpMethod = &quot;POST&quot;)
    public GraceJSONResult delete(@RequestParam String writerId,
                                  @RequestParam String commentId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/CommentController.java
 @Override
    public GraceJSONResult mng(String writerId, Integer page, Integer pageSize) &#123;

        if (page == null) &#123;
            page = COMMON_START_PAGE;
        &#125;
        if (pageSize == null) &#123;
            pageSize = COMMON_PAGE_SIZE;
        &#125;

        PagedGridResult gridResult = commentPortalService.queryWriterCommentsMng(writerId, page, pageSize);
        return GraceJSONResult.ok(gridResult);
    &#125;

    @Override
    public GraceJSONResult delete(String writerId, String commentId) &#123;
        commentPortalService.deleteComment(writerId, commentId);
        return GraceJSONResult.ok();
    &#125;
==============================================================
http://writer.imoocnews.com:9090/imooc-news/writer/commentMng.html
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/CommentPortalService.java
     /**
     * 查询我的评论管理列表
     */
    public PagedGridResult queryWriterCommentsMng(String writerId, Integer page, Integer pageSize);

    /**
     * 删除评论
     */
    public void deleteComment(String writerId, String commentId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/CommentPortalServiceImpl.java
@Override
    public PagedGridResult queryWriterCommentsMng(String writerId, Integer page, Integer pageSize) &#123;
        Comments comment = new Comments();
        comment.setWriterId(writerId);
        PageHelper.startPage(page, pageSize);
        List&lt;Comments&gt; list = commentsMapper.select(comment);
        return setterPagedGrid(list,page);
    &#125;

    @Override
    public void deleteComment(String writerId, String commentId) &#123;
        Comments comment = new Comments();
        comment.setId(commentId);
        comment.setWriterId(writerId);
        commentsMapper.delete(comment);
    &#125;
</code></pre>
<h3 id="增加评论者头像展示功能需求扩展【文章评论】增加需求字段comment-user-face"><a href="#增加评论者头像展示功能需求扩展【文章评论】增加需求字段comment-user-face" class="headerlink" title="增加评论者头像展示功能需求扩展【文章评论】增加需求字段comment_user_face"></a>增加评论者头像展示功能需求扩展【文章评论】<del>增加需求字段comment_user_face</del></h3><blockquote>
<p>[数据库添加一个新的字段comment_user_face 重新在mybatis-generator-database进行逆向生成覆盖]<br>涉及范围广</p>
<p>在数据库里也要加个字段  在前端需求也要改一下头像</p>
</blockquote>
<pre><code class="html">detail.html
&lt;div class=&quot;all-comments-list&quot; v-for=&quot;(comment,index) in commentList&quot; :key=&quot;index&quot;&gt;
        &lt;div class=&quot;single-comment-wrapper&quot;&gt;
        &lt;!--&lt;img src=&quot;./img/face1.png&quot; class=&quot;user-face&quot;/&gt;--&gt;
        &lt;img :src=&quot;comment.commentUserFace&quot; class=&quot;user-face&quot;/&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="mysql">service-article  resources/mapper/CommentsMapper.xml #【增加字段】
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.CommentsMapper&quot; &gt;
  &lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.imooc.pojo.Comments&quot; &gt;
    &lt;!--
      WARNING - @mbg.generated
    --&gt;
    &lt;id column=&quot;id&quot; property=&quot;id&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;writer_id&quot; property=&quot;writerId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;father_id&quot; property=&quot;fatherId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;article_id&quot; property=&quot;articleId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;article_title&quot; property=&quot;articleTitle&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;article_cover&quot; property=&quot;articleCover&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;comment_user_id&quot; property=&quot;commentUserId&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;comment_user_nickname&quot; property=&quot;commentUserNickname&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;comment_user_face&quot; property=&quot;commentUserFace&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;content&quot; property=&quot;content&quot; jdbcType=&quot;VARCHAR&quot; /&gt;
    &lt;result column=&quot;create_time&quot; property=&quot;createTime&quot; jdbcType=&quot;TIMESTAMP&quot; /&gt;
  &lt;/resultMap&gt;
&lt;/mapper&gt;
</code></pre>
<pre><code class="mysql">service-article  resources/mapper/CommentsMapperCustom.xml #【增加字段】
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;
&lt;mapper namespace=&quot;com.imooc.article.mapper.CommentsMapperCustom&quot; &gt;

  &lt;select id=&quot;queryArticleCommentList&quot;
          resultType=&quot;com.imooc.pojo.vo.CommentsVO&quot;
          parameterType=&quot;Map&quot;&gt;

    SELECT
      c.id as commentId,
      c.father_id as fatherId,
      c.comment_user_id as commentUserId,
      c.comment_user_nickname as commentUserNickname,
      c.comment_user_face as commentUserFace,
      c.article_id as articleId,
      c.content as content,
      c.create_time as createTime,
      f.comment_user_nickname as quoteUserNickname,
      f.content as quoteContent
    FROM
      comments c
        LEFT JOIN
      comments f
      ON
        c.father_id = f.id
    WHERE
      c.article_id = #&#123;paramMap.articleId&#125;
    ORDER BY
      c.create_time
            DESC

  &lt;/select&gt;

&lt;/mapper&gt;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/CommentPortalService.java //【增加字段】
 /**
     * 发表评论
     */
    public void createComment(String articleId,
                              String fatherCommentId,
                              String content,
                              String userId,
                              String nickname,
                              String face);
</code></pre>
<pre><code class="java">------------------------------------------------------------
dev-model  com/imooc/pojo/vo/CommentsVO.java //【增加字段属性】
private String commentUserFace;
    【Getter + Setter】

------------------------------------------------------------
dev-model  com/imooc/pojo/Comments.java
/**
     * 冗余的用户头像
     */
@Column(name = &quot;comment_user_face&quot;)
private String commentUserFace;
    【Getter + Setter】
------------------------------------------------------------
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/CommentController.java 
    //【增加 String face = getBasicUserList(idSet).get(0).getFace();】
@Override
    public GraceJSONResult createArticle(@Valid CommentReplyBO commentReplyBO,
                                         BindingResult result) &#123;
        // 0. 判断BindingResult是否保存错误的验证信息，如果有，则直接return
        if (result.hasErrors()) &#123;
            Map&lt;String, String&gt; errorMap = getErrors(result);
            return GraceJSONResult.errorMap(errorMap);
        &#125;

        // 1. 根据留言用户的id查询他的昵称，用于存入到数据表进行字段的冗余处理，从而避免多表关联查询的性能影响
        String userId = commentReplyBO.getCommentUserId();

        // 2. 发起restTemplate调用用户服务，获得用户侧昵称
        Set&lt;String&gt; idSet = new HashSet&lt;&gt;();
        idSet.add(userId);
        String nickname = getBasicUserList(idSet).get(0).getNickname();
        String face = getBasicUserList(idSet).get(0).getFace();

        // 3. 保存用户评论的信息到数据库
        commentPortalService.createComment(commentReplyBO.getArticleId(), commentReplyBO.getFatherId(), commentReplyBO.getContent(), userId, nickname,face);

        return GraceJSONResult.ok();
    &#125;
====================================================
http://www.imoocnews.com:9090/imooc-news/portal/detail.html?articleId=2006116Z3MAP8SW0
//下面有个评论：牛逼  带着自己上传的头像
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/CommentPortalServiceImpl.java
    //【增加 comments.setCommentUserFace(face);】
@Transactional
    @Override
    public void createComment(String articleId, String fatherCommentId, String content, String userId, String nickname,String face) &#123;
        String commentId = sid.nextShort();
        ArticleDetailVO article = articlePortalService.queryDetail(articleId);
        Comments comments = new Comments();
        comments.setId(commentId);

        comments.setWriterId(article.getPublishUserId());
        comments.setArticleTitle(article.getTitle());
        comments.setArticleCover(article.getCover());
        comments.setArticleId(articleId);

        comments.setFatherId(fatherCommentId);
        comments.setCommentUserId(userId);
        comments.setCommentUserNickname(nickname);
        comments.setCommentUserFace(face);

        comments.setContent(content);
        comments.setCreateTime(new Date());

        commentsMapper.insert(comments);

        // 评论数累加
        redis.increment(REDIS_ARTICLE_COMMENT_COUNTS + &quot;:&quot; + articleId, 1);
    &#125;
</code></pre>
<h3 id="文章静态化技术与Freemarker【文章概述】"><a href="#文章静态化技术与Freemarker【文章概述】" class="headerlink" title="文章静态化技术与Freemarker【文章概述】"></a>文章静态化技术与Freemarker【文章概述】</h3><ul>
<li><strong>页面静态化</strong></li>
<li><strong>Freemarker静态化技术</strong></li>
<li><strong>渲染模板数据</strong></li>
<li><strong>生成并展示静态页面</strong></li>
</ul>
<h5 id="静态化趋势"><a href="#静态化趋势" class="headerlink" title="静态化趋势"></a>静态化趋势</h5><ul>
<li><strong>便于SEO</strong></li>
<li><strong>加速用户访问</strong></li>
<li><strong>降低数据库压力</strong></li>
</ul>
<h5 id="模板引擎技术"><a href="#模板引擎技术" class="headerlink" title="模板引擎技术"></a>模板引擎技术</h5><ul>
<li><strong>JSP</strong></li>
<li><strong>Freemarker</strong></li>
<li><strong>Thymeleaf</strong></li>
<li><strong>Velocity</strong></li>
</ul>
<h5 id="页面静态化"><a href="#页面静态化" class="headerlink" title="页面静态化"></a>页面静态化</h5><p><img src="https://raw.githubusercontent.com/P-luminary/images/1f57d8e494be53fe2ee4745f819db41fe1e7173a/data/%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96.png"></p>
<h3 id="创建并且显示模板ftl"><a href="#创建并且显示模板ftl" class="headerlink" title="创建并且显示模板ftl"></a>创建并且显示模板ftl</h3><pre><code class="xml">service-article  pom.xml
 &lt;!-- freemarker 依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-freemarker&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/FreemarkerController.java
package com.imooc.article.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@Controller
@RequestMapping(&quot;free&quot;)
public class FreemarkerController&#123;
    @GetMapping(&quot;/hello&quot;)
    public String hello(Model model)&#123;
        // 定义输出到模板的内容
        // 输入字符串
        String stranger = &quot;慕课网 imooc.com&quot;;
        model.addAttribute(&quot;there&quot;, stranger);

        // 返回的stu是freemarker模板所在的目录 classpath:/templates/
        // 匹配 *.ftl
        return &quot;stu&quot;;
    &#125;
&#125;
==================================================================
http://localhost:8001/free/hello
</code></pre>
<pre><code class="yaml">service-article  resources/application.yml 【suffix是模板后缀】
  freemarker:
    charset: UTF-8
    content-type: text/html
    suffix: .ftl
    template-loader-path: classpath:/templates/
</code></pre>
<pre><code class="html">service-article  resources/templates/stu.ftl
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Hello Freemarker&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
    &lt;#-- 
        写完以后去模板页面配置 application.yml
        Freemarker 页面的语法构成：
        1. 注释
        2. 表达式 $&#123;...&#125;
        3. 普通文本，基本的html标签
        4. 指令
    --&gt;
        &lt;div&gt;
            hello $&#123;there&#125;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="输出对象【Freemarker语法】"><a href="#输出对象【Freemarker语法】" class="headerlink" title="输出对象【Freemarker语法】"></a>输出对象【Freemarker语法】</h3><pre><code class="java">dev-model  com/imooc/pojo/Stu.java
public class Stu &#123;
    private String uid;
    private String username;
    private Integer age;
    private Date birthday;
    private Float amount;
    private boolean haveChild;
    private Spouse spouse;
&#125; Getter + Setter
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/Spouse.java
public class Spouse &#123;
    private String username;
    private Integer age;
&#125; Getter + Setter
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/FreemarkerController.java
package com.imooc.article.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@Controller
@RequestMapping(&quot;free&quot;)
public class FreemarkerController&#123;
    @GetMapping(&quot;/hello&quot;)
    public String hello(Model model)&#123;
        // 定义输出到模板的内容
        // 输入字符串
        String stranger = &quot;慕课网 imooc.com&quot;;
        model.addAttribute(&quot;there&quot;, stranger);

        makeModel(model);
        // 返回的stu是freemarker模板所在的目录 classpath:/templates/
        // 匹配 *.ftl
        return &quot;stu&quot;;
    &#125;

    private Model makeModel(Model model) &#123;
        Stu stu = new Stu();
        stu.setUid(&quot;10010&quot;);
        stu.setUsername(&quot;imooc&quot;);
        stu.setAmount(88.86f);
        stu.setAge(18);
        stu.setHaveChild(true);
        stu.setBirthday(new Date());

        Spouse spouse = new Spouse();
        spouse.setUsername(&quot;Lucy&quot;);
        spouse.setAge(25);
        stu.setSpouse(spouse);
        model.addAttribute(&quot;stu&quot;,stu);
        return model;
    &#125;
&#125;
==================================================================
http://localhost:8001/free/hello

Hello 慕课网 imooc.com

用户名uid: 10010
用户姓名: imooc
年龄：18
生日：2024-07-29 15:13:05
用户余额：88.86
已育：yes
伴侣：Lucy,25岁
</code></pre>
<pre><code class="html">service-article  resources/templates/stu.ftl
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Hello Freemarker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;#-- 写完以后去模板页面配置 application.yml
    Freemarker 页面的语法构成：
    1. 注释
    2. 表达式 $&#123;...&#125;
    3. 普通文本，基本的html标签
    4. 指令
--&gt;
    &lt;div&gt;
        hello $&#123;there&#125;
    &lt;/div&gt;
&lt;br&gt;

    &lt;div&gt;
        用户名uid: $&#123;stu.uid&#125;&lt;br&gt;
        用户姓名: $&#123;stu.username&#125;&lt;br&gt;
        年龄：$&#123;stu.age&#125;&lt;br&gt;
        生日：$&#123;stu.birthday?string(&#39;yyyy-MM-dd HH:mm:ss&#39;)&#125;&lt;br&gt; &lt;#-- 日期转换 --&gt;
        用户余额：$&#123;stu.amount&#125;&lt;br&gt;
        已育：$&#123;stu.haveChild?string(&#39;yes&#39;, &#39;no&#39;)&#125;&lt;br&gt;
        伴侣：$&#123;stu.spouse.username&#125;,$&#123;stu.spouse.age&#125;岁

    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="输出list与map【Freemarker语法】"><a href="#输出list与map【Freemarker语法】" class="headerlink" title="输出list与map【Freemarker语法】"></a>输出list与map【Freemarker语法】</h3><pre><code class="java">dev-model  com/imooc/pojo/Stu.java
public class Stu &#123;
    private String uid;
    private String username;
    private Integer age;
    private Date birthday;
    private Float amount;
    private boolean haveChild;

    private Spouse spouse;

    private List&lt;Article&gt; articleList;
    private Map&lt;String, String&gt; parents;
&#125; Getter + Setter
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/Spouse.java
public class Spouse &#123;
    private String username;
    private Integer age;
&#125; Getter + Setter
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/FreemarkerController.java
package com.imooc.article.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.Article;
import com.imooc.pojo.Spouse;
import com.imooc.pojo.Stu;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.*;

@Controller
@RequestMapping(&quot;free&quot;)
public class FreemarkerController&#123;
    @GetMapping(&quot;/hello&quot;)
    public String hello(Model model)&#123;
        // 定义输出到模板的内容
        // 输入字符串
        String stranger = &quot;慕课网 imooc.com&quot;;
        model.addAttribute(&quot;there&quot;, stranger);

        makeModel(model);
        // 返回的stu是freemarker模板所在的目录 classpath:/templates/
        // 匹配 *.ftl
        return &quot;stu&quot;;
    &#125;

    private Model makeModel(Model model) &#123;
        Stu stu = new Stu();
        stu.setUid(&quot;10010&quot;);
        stu.setUsername(&quot;imooc&quot;);
        stu.setAmount(88.86f);
        stu.setAge(18);
        stu.setHaveChild(true);
        stu.setBirthday(new Date());

        Spouse spouse = new Spouse();
        spouse.setUsername(&quot;Lucy&quot;);
        spouse.setAge(25);

        stu.setSpouse(spouse);
        stu.setArticleList(getArticles());
        stu.setParents(getParents());

        model.addAttribute(&quot;stu&quot;,stu);
        return model;
    &#125;

    private List&lt;Article&gt; getArticles()&#123;
        Article article1 = new Article();
        article1.setId(&quot;1001&quot;);
        article1.setTitle(&quot;今天天气不错&quot;);

        Article article2 = new Article();
        article2.setId(&quot;1002&quot;);
        article2.setTitle(&quot;今天下雨了&quot;);

        Article article3 = new Article();
        article3.setId(&quot;1003&quot;);
        article3.setTitle(&quot;昨天下雨了&quot;);

        List&lt;Article&gt; list = new ArrayList&lt;&gt;();
        list.add(article1);
        list.add(article2);
        list.add(article3);
        return list;
    &#125;

    private Map&lt;String, String&gt; getParents()&#123;
        Map&lt;String, String&gt; parents = new HashMap&lt;&gt;();
        parents.put(&quot;father&quot;, &quot;XiaoMing&quot;);
        parents.put(&quot;mother&quot;, &quot;LiLi&quot;);
        return parents;
    &#125;
&#125;
==================================================================
http://localhost:8001/free/hello

hello 慕课网 imooc.com

用户名uid: 10010
用户姓名: imooc
年龄：18
生日：2024-07-29 15:39:07
用户余额：88.86
已育：yes
伴侣：Lucy,25岁

1001 今天天气不错
1002 今天下雨了
1003 昨天下雨了

LiLi
XiaoMing
</code></pre>
<pre><code class="html">service-article  resources/templates/stu.ftl
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Hello Freemarker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;#-- 写完以后去模板页面配置 application.yml
    Freemarker 页面的语法构成：
    1. 注释
    2. 表达式 $&#123;...&#125;
    3. 普通文本，基本的html标签
    4. 指令
--&gt;
    &lt;div&gt;
        hello $&#123;there&#125;
    &lt;/div&gt;
&lt;br&gt;

    &lt;div&gt;
        用户名uid: $&#123;stu.uid&#125;&lt;br&gt;
        用户姓名: $&#123;stu.username&#125;&lt;br&gt;
        年龄：$&#123;stu.age&#125;&lt;br&gt;
        生日：$&#123;stu.birthday?string(&#39;yyyy-MM-dd HH:mm:ss&#39;)&#125;&lt;br&gt; &lt;#-- 日期转换 --&gt;
        用户余额：$&#123;stu.amount&#125;&lt;br&gt;
        已育：$&#123;stu.haveChild?string(&#39;yes&#39;, &#39;no&#39;)&#125;&lt;br&gt;
        伴侣：$&#123;stu.spouse.username&#125;,$&#123;stu.spouse.age&#125;岁
    &lt;/div&gt;

&lt;br&gt;

    &lt;div&gt;
        &lt;#list stu.articleList as article&gt;
            &lt;div&gt;
                &lt;span&gt;$&#123;article.id&#125;&lt;/span&gt;
                &lt;span&gt;$&#123;article.title&#125;&lt;/span&gt;
            &lt;/div&gt;
        &lt;/#list&gt;
    &lt;/div&gt;

&lt;br&gt;

    &lt;div&gt;
        &lt;#list stu.parents?keys as key&gt;
            &lt;div&gt;
                $&#123;stu.parents[key]&#125;
            &lt;/div&gt;
        &lt;/#list&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="指令if【Freemarker语法】"><a href="#指令if【Freemarker语法】" class="headerlink" title="指令if【Freemarker语法】"></a>指令if【Freemarker语法】</h3><pre><code class="html">service-article  resources/templates/stu.ftl
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Hello Freemarker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;#-- 
    写完以后去模板页面配置 application.yml
    Freemarker 页面的语法构成：
    1. 注释
    2. 表达式 $&#123;...&#125;
    3. 普通文本，基本的html标签
    4. 指令
--&gt;
    &lt;div&gt;
        hello $&#123;there&#125;
    &lt;/div&gt;
&lt;br&gt;

    &lt;div&gt;
        用户名uid: $&#123;stu.uid&#125;&lt;br&gt;
        用户姓名: $&#123;stu.username&#125;&lt;br&gt;
        年龄：$&#123;stu.age&#125;&lt;br&gt;
        生日：$&#123;stu.birthday?string(&#39;yyyy-MM-dd HH:mm:ss&#39;)&#125;&lt;br&gt; &lt;#-- 日期转换 --&gt;
        用户余额：$&#123;stu.amount&#125;&lt;br&gt;
        已育：$&#123;stu.haveChild?string(&#39;yes&#39;, &#39;no&#39;)&#125;&lt;br&gt;
        &lt;#if stu.spouse??&gt;
            伴侣：$&#123;stu.spouse.username&#125;, $&#123;stu.spouse.age&#125;岁
        &lt;/#if&gt;
        &lt;#if !stu.spouse??&gt;
            单身狗
        &lt;/#if&gt;
    &lt;/div&gt;

&lt;br&gt;

    &lt;div&gt;
        &lt;#list stu.articleList as article&gt;
            &lt;div&gt;
                &lt;span&gt;$&#123;article.id&#125;&lt;/span&gt;
                &lt;span&gt;$&#123;article.title&#125;&lt;/span&gt;
            &lt;/div&gt;
        &lt;/#list&gt;
    &lt;/div&gt;

&lt;br&gt;

    &lt;div&gt;
        &lt;#list stu.parents?keys as key&gt;
            &lt;div&gt;
                $&#123;stu.parents[key]&#125;
            &lt;/div&gt;
        &lt;/#list&gt;
    &lt;/div&gt;

&lt;br&gt;

    &lt;div&gt;
        &lt;#if stu.uid == &#39;10010&#39;&gt;
            用户id是10010
            &lt;br&gt;
        &lt;/#if&gt;
        &lt;#if stu.username != &#39;imooc&#39;&gt;
            用户名不是imooc
            &lt;br&gt;
        &lt;/#if&gt;
        &lt;#if (stu.age &gt;= 18) &gt;
            用户已成年
        &lt;/#if&gt;
        &lt;br&gt;
        &lt;#if (stu.age &gt; 18 || stu.age = 18) &gt;
            成年人
            &lt;br&gt;
        &lt;/#if&gt;
        &lt;#if (stu.age &lt; 18) &gt;
            未成年
            &lt;br&gt;
        &lt;/#if&gt;
        &lt;#if stu.haveChild &gt;
            已育
        &lt;/#if&gt;
        &lt;br&gt;
        &lt;#if !stu.haveChild &gt;
             未育
        &lt;/#if&gt;
     &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><span style = "color:red">在这里特别注意一下 已经开始第二阶段的代码 进阶篇 所以前端的代码也是需要更新换代的 包括..&#x2F;js&#x2F;app.js里面多了 app.getPageName();</span><br><a target="_blank" rel="noopener" href="https://coding.imooc.com/learn/questiondetail/4daeRX4JGBRPnWEp.html">没有getPageName这个函数-慕课网 (imooc.com)</a><br><a target="_blank" rel="noopener" href="https://coding.imooc.com/learn/questiondetail/224939.html">生成的html调用app.js中getPageName()函数出错的问题-慕课网 (imooc.com)</a></p>
<h3 id="结合动态数据生成静态化HTML【Freemarker】"><a href="#结合动态数据生成静态化HTML【Freemarker】" class="headerlink" title="结合动态数据生成静态化HTML【Freemarker】"></a>结合动态数据生成静态化HTML【Freemarker】</h3><pre><code class="java">service-article  com/imooc/article/controller/FreemarkerController.java
【stu.ftl如上图不变增加java的整合代码】 俗称Java+ftl=HTML
package com.imooc.article.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.Article;
import com.imooc.pojo.Spouse;
import com.imooc.pojo.Stu;
import freemarker.template.Configuration;
import freemarker.template.Template;
import freemarker.template.TemplateException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Writer;
import java.util.*;

@Controller
@RequestMapping(&quot;free&quot;)
public class FreemarkerController&#123;

    @Value(&quot;$&#123;freemarker.html.target&#125;&quot;)
    private String htmlTarget;

    @GetMapping(&quot;/createHTML&quot;)
    @ResponseBody
    public String createHTML(Model model) throws IOException, TemplateException &#123;
        // 0. 配置freemarker基本环境
        Configuration cfg = new Configuration(Configuration.getVersion());
        // 声明freemarker模板所需要加载的目录的位置
            //resources/templates/stu.ftl
        String classpath = this.getClass().getResource(&quot;/&quot;).getPath();
        cfg.setDirectoryForTemplateLoading(new File((classpath + &quot;templates&quot;)));

            // 测试打印
        System.out.println(htmlTarget);
        System.out.println(classpath + &quot;templates&quot;);
        /**
         * /workspace/freemarker_html
         * /C:/Users/Pluminary/Desktop/backup/imooc-news-dev/imooc-news-dev-service-article/target/classes/templates
         */
        // 1. 获得现有的模板ftl文件
        Template template = cfg.getTemplate(&quot;stu.ftl&quot;, &quot;utf-8&quot;);

        // 2. 获得动态数据
            // 定义输出到模板的内容
            // 输入字符串
        String stranger = &quot;慕课网 imooc.com&quot;;
        model.addAttribute(&quot;there&quot;, stranger);
        model = makeModel(model);

        // 3. 融合动态数据和ftl，生成html
        File tempDic = new File(htmlTarget);
        if (!tempDic.exists()) &#123;
            tempDic.mkdirs();
        &#125;
        Writer out = new FileWriter(htmlTarget + File.separator + &quot;10010&quot; + &quot;.html&quot;);
        template.process(model, out);
        out.close();
        return &quot;ok&quot;;
        // C:\workspace\freemarker_html\10010.html 里面的数据都是静态数据
    &#125;

    @GetMapping(&quot;/hello&quot;)
    public String hello(Model model)&#123;
        makeModel(model);
        // 返回的stu是freemarker模板所在的目录 classpath:/templates/
        // 匹配 *.ftl
        return &quot;stu&quot;;
    &#125;

    private Model makeModel(Model model) &#123;
        Stu stu = new Stu();
        stu.setUid(&quot;10010&quot;);
        stu.setUsername(&quot;imooc&quot;);
        stu.setAmount(88.86f);
        stu.setAge(18);
        stu.setHaveChild(true);
        stu.setBirthday(new Date());

        Spouse spouse = new Spouse();
        spouse.setUsername(&quot;Lucy&quot;);
        spouse.setAge(25);

        stu.setSpouse(spouse);
        stu.setArticleList(getArticles());
        stu.setParents(getParents());

        model.addAttribute(&quot;stu&quot;,stu);
        return model;
    &#125;

    private List&lt;Article&gt; getArticles()&#123;
        Article article1 = new Article();
        article1.setId(&quot;1001&quot;);
        article1.setTitle(&quot;今天天气不错&quot;);

        Article article2 = new Article();
        article2.setId(&quot;1002&quot;);
        article2.setTitle(&quot;今天下雨了&quot;);

        Article article3 = new Article();
        article3.setId(&quot;1003&quot;);
        article3.setTitle(&quot;昨天下雨了&quot;);

        List&lt;Article&gt; list = new ArrayList&lt;&gt;();
        list.add(article1);
        list.add(article2);
        list.add(article3);
        return list;
    &#125;

    private Map&lt;String, String&gt; getParents()&#123;
        Map&lt;String, String&gt; parents = new HashMap&lt;&gt;();
        parents.put(&quot;father&quot;, &quot;XiaoMing&quot;);
        parents.put(&quot;mother&quot;, &quot;LiLi&quot;);
        return parents;
    &#125;
&#125;
</code></pre>
<h3 id="改写详情页为模板页ftl【页面静态化】"><a href="#改写详情页为模板页ftl【页面静态化】" class="headerlink" title="改写详情页为模板页ftl【页面静态化】"></a>改写详情页为模板页ftl【页面静态化】</h3><blockquote>
<p>地址页不是拼接   将detail.html 的路径都变成绝对路径</p>
<!--<link rel="shortcut icon" href="img/mu-toutiao.ico" />-->
<pre><code>&lt;link rel=&quot;shortcut icon&quot; href=&quot;../img/mu-toutiao.ico&quot; /&gt;
</code></pre>
<p>把其拷贝到 resources&#x2F;templates&#x2F;detail.ftl</p>
</blockquote>
<pre><code class="html">【放在d盘 tomcat/webapps中的】detail.ftl
&lt;div class=&quot;big-title&quot;&gt;
     $&#123;articleDetail.title&#125;
&lt;/div&gt;
    &lt;div class=&quot;read-counts&quot; v-show=&quot;articleDetail.readCounts != &#39;&#39; &amp;&amp; articleDetail.readCounts != null&quot;&gt;
     阅读量：$&#123;articleDetail.readCounts&#125;
    &lt;/div&gt;
......
&lt;div class=&quot;date-title&quot;&gt;
       &lt;span class=&quot;year&quot;&gt;$&#123;articleDetail.publishTime?string(&#39;yyyy&#39;)&#125;&lt;/span&gt;
 &lt;/div&gt;
      &lt;div class=&quot;back-year-line&quot;&gt;&lt;/div&gt;

      &lt;div class=&quot;date-md&quot;&gt;$&#123;articleDetail.publishTime?string(&#39;MM/dd&#39;)&#125;&lt;/div&gt;

      &lt;div class=&quot;date-times&quot;&gt;$&#123;articleDetail.publishTime?string(&#39;HH:mm:ss&#39;)&#125;&lt;/div&gt;

      &lt;div class=&quot;writer-name&quot; @click=&quot;showWriter(&#39;$&#123;articleDetail.publishUserId&#125;&#39;)&quot;&gt;
                        $&#123;articleDetail.publishUserName&#125;
                    &lt;/div&gt;
.....
&lt;div class=&quot;article-wrapper&quot;&gt;
   &lt;div class=&quot;content&quot;&gt;
        $&#123;articleDetail.content&#125;
   &lt;/div&gt;
&lt;div class=&quot;declare&quot;&gt;
      免责声明：本平台所有内容仅供测试，且文章来自互联网，不代表慕课网的观点和立场，如有不妥，请联系后删除。
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="文章详情ftl生成静态化页面【页面静态化】"><a href="#文章详情ftl生成静态化页面【页面静态化】" class="headerlink" title="文章详情ftl生成静态化页面【页面静态化】"></a>文章详情ftl生成静态化页面【页面静态化】</h3><pre><code class="yaml">freemarker:
  html:
    target: D:/apache-tomcat-8.5.93/webapps/imooc-news/portal/a
    article: D:/apache-tomcat-8.5.93/webapps/imooc-news/portal/a
</code></pre>
<pre><code class="java">dev-model  com/imooc/pojo/vo/ArticleDetailVO.java
public class ArticleDetailVO &#123;

    private String id;
    private String title;
    private String cover;
    private Integer categoryId;
    private String categoryName;
    private String publishUserId;
    @JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
    private Date publishTime;
    private String content;

    private String publishUserName;
    private Integer readCounts;
&#125;Getter + Setter
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
 @Override
    public GraceJSONResult doReview(String articleId, Integer passOrNot) &#123;
        Integer pendingStatus;
        if (passOrNot == YesOrNo.YES.type) &#123;
            // 审核成功
            pendingStatus = ArticleReviewStatus.SUCCESS.type;
        &#125; else if (passOrNot == YesOrNo.NO.type) &#123;
            // 审核失败
            pendingStatus = ArticleReviewStatus.FAILED.type;
        &#125; else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
        // 保存到数据库，更改文章状态为审核成功或者失败
        articleService.updateArticleStatus(articleId, pendingStatus);
        if (pendingStatus == ArticleReviewStatus.SUCCESS.type)&#123;
            //审核成功，生成文章详情页静态html
            try&#123;
                 createArticleHTML(articleId);
//                String articleMongoId = createArticleHTMLToGridF(articleId);
            &#125;catch (Exception e)&#123;
                e.printStackTrace();
            &#125;
        &#125;
        return GraceJSONResult.ok();
    &#125;

    @Value(&quot;$&#123;freemarker.html.target&#125;&quot;)
    private String articlePath;
    @Autowired
    private RestTemplate restTemplate;
    // 文章生成HTML
    public void createArticleHTML(String articleId) throws IOException, TemplateException &#123;
        Configuration cfg = new Configuration(Configuration.getVersion());
        String classpath = this.getClass().getResource(&quot;/&quot;).getPath();
        cfg.setDirectoryForTemplateLoading(new File(classpath + &quot;templates&quot;));

        Template template = cfg.getTemplate(&quot;detail.ftl&quot;, &quot;utf-8&quot;);

        // 获得文章的详情数据
        ArticleDetailVO detailVO = getArticleDetail(articleId);
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;articleDetail&quot;, detailVO);

        File tempDic = new File(articlePath);
        if (!tempDic.exists()) &#123;
            tempDic.mkdirs();
        &#125;

        String path = articlePath + File.separator + detailVO.getId() + &quot;.html&quot;;

        Writer out = new FileWriter(path);
        template.process(map, out);
        out.close();
    &#125;
    // 发起远程调用rest，获得文章详情数据
    public ArticleDetailVO getArticleDetail(String articleId) &#123;
        String url
                = &quot;http://www.imoocnews.com:8001/portal/article/detail?articleId=&quot; + articleId;
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
                = restTemplate.getForEntity(url, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        ArticleDetailVO detailVO = null;
        if (bodyResult.getStatus() == 200) &#123;
            String detailJson = JsonUtils.objectToJson(bodyResult.getData());
            detailVO = JsonUtils.jsonToPojo(detailJson, ArticleDetailVO.class);
        &#125;
        return detailVO;
    &#125;
</code></pre>
<pre><code class="java">先去发表头条http://writer.imoocnews.com:9090/imooc-news/writer/createArticle.html
再去审核通过http://www.imoocnews.com:9090/imooc-news/admin/contentReview.html
此时运行后 就会有java+ftl=html静态页面在指定位置生成了
指定位置：D:\apache-tomcat-8.5.93\webapps\imooc-news\portal\a
生成了一个文件：240729D9S8683XP0.html  这里面就是刚刚发表头条的内容
此时下面的两个网站都可以打开同样的头条内容
http://www.imoocnews.com:9090/imooc-news/portal/a/240729D9S8683XP0.html
http://www.imoocnews.com:9090/imooc-news/portal/detail.html?articleId=240729D9S8683XP0

240729D9S8683XP0.html
&lt;div class=&quot;writer-name&quot; @click=&quot;showWriter(&#39;240629F21AK1BHX4&#39;)&quot;&gt;
      P_luminary
&lt;/div&gt;

// 跳转作家页面
showWriter(writerId) &#123;
    window.open(&quot;../writer.html?writerId=&quot; + writerId);
&#125;,
</code></pre>
<p><a target="_blank" rel="noopener" href="https://coding.imooc.com/learn/questiondetail/4daeRX4JGBRPnWEp.html">没有getPageName这个函数-慕课网 (imooc.com)</a></p>
<h3 id="文章阅读量detail单独获取并展示-【页面静态化】"><a href="#文章阅读量detail单独获取并展示-【页面静态化】" class="headerlink" title="文章阅读量detail单独获取并展示 【页面静态化】"></a>文章阅读量<del>detail</del>单独获取并展示 【页面静态化】</h3><p><a target="_blank" rel="noopener" href="http://www.imoocnews.com:9090/imooc-news/portal/a/240730FGXGSCRZ54.html">a5 (imoocnews.com)</a></p>
<pre><code class="java">【去前面代入阅读量】
 &lt;div class=&quot;read-counts&quot;&gt;
            阅读量：&#123;&#123;readCounts&#125;&#125;
        &lt;/div&gt;
【先定义readCounts初始量为0】
var articleList = new Vue(&#123;
        el: &quot;#detailContainer&quot;,
        data: &#123;
            nowReplyingFatherCommentId: 0,  // 根据当前用户正在回复的父commentId进行页面的留言看展示或隐藏
            userInfo: null,
            
            articleId: &quot;&quot;,
            articleDetail: &#123;&#125;,
            readCounts: 0,
        &#125;

// 获得文章阅读数
         this.getArticleReadCounts(articleId);

 // 获得文章阅读数
        getArticleReadCounts(articleId) &#123;
               var me = this;

               var articleServerUrl = app.articleServerUrl;
               axios.defaults.withCredentials = true;
               axios.get(articleServerUrl + &quot;/portal/article/readCounts?articleId=&quot; + articleId)
                .then(res =&gt; &#123;
                  // console.log(JSON.stringify(res.data));
                  this.readCounts = res.data;
                &#125;);
            &#125;,
//★★★★★★★★★★★★★★★★★★★★     ★★★★★★★★★★★★★★★★★★★★★★★\\
然后把这个临时页面修改的地方 移动到后端service-article  resources/templates/detail.ftl中
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
@Override
    public Integer readCounts(String articleId) &#123;
       return getCountsFromRedis(REDIS_ARTICLE_READ_COUNTS + &quot;:&quot; + articleId);
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/article/ArticlePortalControllerApi.java
@GetMapping(&quot;readCounts&quot;)
    @ApiOperation(value = &quot;获得文章阅读数&quot;, notes = &quot;获得文章阅读数&quot;, httpMethod = &quot;GET&quot;)
    public Integer readCounts(@RequestParam String articleId);
</code></pre>
<p><a target="_blank" rel="noopener" href="http://www.imoocnews.com:9090/imooc-news/portal/a/240730FP00HHCF14.html">在这里折腾一天终于好了 文章:a6 (imoocnews.com)</a></p>
<p>9-10</p>
<h3 id="梳理生产端消费端与中间gridfs关系"><a href="#梳理生产端消费端与中间gridfs关系" class="headerlink" title="梳理生产端消费端与中间gridfs关系"></a>梳理生产端消费端与中间gridfs关系</h3><h5 id="静态化高度耦合"><a href="#静态化高度耦合" class="headerlink" title="静态化高度耦合"></a>静态化高度耦合</h5><blockquote>
<p>在本地电脑&#x2F;同一台服务器     &#x3D;&gt;     生成静态页面HTML →<del>(发布)</del> 前端</p>
</blockquote>
<h5 id="解耦静态化"><a href="#解耦静态化" class="headerlink" title="解耦静态化"></a>解耦静态化</h5><blockquote>
<p>后端服务器(生成静态页面HTML)  &#x3D;&gt;  GridFS  &lt;&#x3D;  前端服务器(前端HTML)<br>同时  后端服务器(生成静态页面HTML)  →  前端服务器(前端HTML)</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/e63aeac9b0694f2fced26f0349e630e42e51ae54/data/%E9%9D%99%E6%80%81%E5%8C%96%E9%AB%98%E5%BA%A6%E8%80%A6%E5%90%88%E4%B8%8E%E8%A7%A3%E8%80%A6.png"></p>
<pre><code class="java">创建一个新的module =&gt; imooc-news-dev-service-article-html
把service-article中resources的application.yml /dev+prod.yml logback-spring.xml拷贝到article-html模块的resources中

############################################################
http://localhost:8002/hello
&#123;
    &quot;status&quot;: 200,
    &quot;msg&quot;: &quot;操作成功！&quot;,
    &quot;success&quot;: true,
    &quot;data&quot;: null
&#125;
</code></pre>
<pre><code class="yaml">application.yml
############################################################
#
# article文章静态化服务
# web访问端口号  约定：8002
#
############################################################
server:
# port: 8003
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  profiles:
    active: dev # yml中配置文件的环境配置, dev:开发环境, test:测试环境, prod:生产环境
  application:
    name: service-article-html
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8

  data:
    mongodb:
      uri: mongodb://root:root@192.168.170.135:27017
      database: imooc-news
  freemarker:
    charset: UTF-8
    content-type: text/html
    suffix: .ftl
    template-loader-path: classpath:/templates/

# 定义freemarker生成的HTML
freemarker:
  html:
    target: D:/apache-tomcat-8.5.93/webapps/imooc-news/portal/a
    article: D:/apache-tomcat-8.5.93/webapps/imooc-news/portal/a
</code></pre>
<pre><code class="yaml">application-dev.yml
server:
  port: 8002

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379

## setup CN from java, This is resource
website:
  domain-name: imoocnews.com




application-prod.yml
server:
  port: 8002

spring:
  redis:
    database: 0
    host: 47.98.225.105
    port: 6379
</code></pre>
<pre><code class="java">service-article-html  com/imooc/article/html/Application.java
package com.imooc.article.html;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article-html  com/imooc/article/html/controller/HelloController.java
package com.imooc.article.html.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);

    public Object hello() &#123;
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<h3 id="生产端存储html道gridfs并关联文章表【静态化解耦】"><a href="#生产端存储html道gridfs并关联文章表【静态化解耦】" class="headerlink" title="生产端存储html道gridfs并关联文章表【静态化解耦】"></a>生产端存储html道gridfs并关联文章表【静态化解耦】</h3><h5 id="静态化解耦步骤"><a href="#静态化解耦步骤" class="headerlink" title="静态化解耦步骤"></a>静态化解耦步骤</h5><ul>
<li><strong>生成html，并上传到gridfs中</strong></li>
<li><strong>获得mongoFileId，关联保存到文章表中</strong></li>
<li><strong>调用消费端，下载gridfs的html进行发布</strong></li>
</ul>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
 /**
     * 关联文章和gridfs的html文件id
     */
    public void updateArticleToGridFS(String articleId, String articleMongoId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
 @Transactional
    @Override
    public void updateArticleToGridFS(String articleId, String articleMongoId) &#123;
        Article pendingArticle = new Article();
        pendingArticle.setId(articleId);
        pendingArticle.setMongoFileId(articleMongoId);
        articleMapper.updateByPrimaryKeySelective(pendingArticle);
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
@Override
    public GraceJSONResult doReview(String articleId, Integer passOrNot) &#123;
        Integer pendingStatus;
        if (passOrNot == YesOrNo.YES.type) &#123;
            // 审核成功
            pendingStatus = ArticleReviewStatus.SUCCESS.type;
        &#125; else if (passOrNot == YesOrNo.NO.type) &#123;
            // 审核失败
            pendingStatus = ArticleReviewStatus.FAILED.type;
        &#125; else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
        // 保存到数据库，更改文章状态为审核成功或者失败
        articleService.updateArticleStatus(articleId, pendingStatus);

        if (pendingStatus == ArticleReviewStatus.SUCCESS.type)&#123;
            //审核成功，生成文章详情页静态html
            try&#123;
//                 createArticleHTML(articleId);
                String articleMongoId = createArticleHTMLToGridFS(articleId);
                // 存储到对应的文章 进行关联保存
                articleService.updateArticleToGridFS(articleId, articleMongoId);
            &#125;catch (Exception e)&#123;
                e.printStackTrace();
            &#125;
        &#125;
        return GraceJSONResult.ok();
    &#125;
......
...
    @Value(&quot;$&#123;freemarker.html.target&#125;&quot;)
    private String articlePath;
    @Autowired
    private RestTemplate restTemplate;
    // 文章生成HTML
    public void createArticleHTML(String articleId) throws IOException, TemplateException &#123;
        Configuration cfg = new Configuration(Configuration.getVersion());
        String classpath = this.getClass().getResource(&quot;/&quot;).getPath();
        cfg.setDirectoryForTemplateLoading(new File(classpath + &quot;templates&quot;));

        Template template = cfg.getTemplate(&quot;detail.ftl&quot;, &quot;utf-8&quot;);

        // 获得文章的详情数据
        ArticleDetailVO detailVO = getArticleDetail(articleId);
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;articleDetail&quot;, detailVO);

        File tempDic = new File(articlePath);
        if (!tempDic.exists()) &#123;
            tempDic.mkdirs();
        &#125;

        String path = articlePath + File.separator + detailVO.getId() + &quot;.html&quot;;

        Writer out = new FileWriter(path);
        template.process(map, out);
        out.close();
    &#125;

    @Autowired
    private GridFSBucket gridFSBucket;
    public String createArticleHTMLToGridFS(String articleId) throws IOException, TemplateException &#123;
        Configuration cfg = new Configuration(Configuration.getVersion());
        String classpath = this.getClass().getResource(&quot;/&quot;).getPath();
        cfg.setDirectoryForTemplateLoading(new File(classpath + &quot;templates&quot;));

        Template template = cfg.getTemplate(&quot;detail.ftl&quot;, &quot;utf-8&quot;);

        // 获得文章的详情数据
        ArticleDetailVO detailVO = getArticleDetail(articleId);
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;articleDetail&quot;, detailVO);

        String htmlContent = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);
//        System.out.println(htmlContent);

        InputStream inputStream = IOUtils.toInputStream(htmlContent);
        ObjectId fileId = gridFSBucket.uploadFromStream(detailVO.getId() + &quot;.html&quot;,inputStream);
        return fileId.toString();
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/GridFSConfig.java
package com.imooc.article;

import com.mongodb.MongoClient;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.gridfs.GridFSBucket;
import com.mongodb.client.gridfs.GridFSBuckets;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.stereotype.Component;

@Component //可以被容器访问到
public class GridFSConfig &#123;
    @Value(&quot;$&#123;spring.data.mongodb.database&#125;&quot;)
    private String mongodb;

    @Bean
    public GridFSBucket gridFSBucket(MongoClient mongoClient)&#123;
        MongoDatabase mongoDatabase = mongoClient.getDatabase(mongodb);
        GridFSBucket bucket = GridFSBuckets.create(mongoDatabase);//存入mongodatabase
        return bucket;
    &#125;
&#125;
</code></pre>
<h3 id="消费端从gridfs下载HTML到tomcat【静态化解耦】"><a href="#消费端从gridfs下载HTML到tomcat【静态化解耦】" class="headerlink" title="消费端从gridfs下载HTML到tomcat【静态化解耦】"></a>消费端从gridfs下载HTML到tomcat【静态化解耦】</h3><pre><code class="java">service-api  com/imooc/api/controller/article/ArticleHTMLControllerApi.java
package com.imooc.api.controller.article;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.NewArticleBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.Date;

@Api(value = &quot;静态化文章业务的controller&quot;, tags = &#123;&quot;静态化文章业务的controller&quot;&#125;)
@RequestMapping(&quot;article/html&quot;)
public interface ArticleHTMLControllerApi &#123;

    @GetMapping(&quot;download&quot;)
    @ApiOperation(value = &quot;下载html&quot;, notes = &quot;下载html&quot;, httpMethod = &quot;GET&quot;)
    public Integer download(String articleId, String articleMongoId) throws Exception;
&#125;
</code></pre>
<pre><code class="java">article-html  com/imooc/article/html/controller/ArticleHTMLController.java
package com.imooc.article.html.controller;

import com.imooc.api.controller.article.ArticleHTMLControllerApi;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.mongodb.client.gridfs.GridFSBucket;
import com.mongodb.gridfs.GridFS;
import org.bson.types.ObjectId;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.RestController;

import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;

@RestController
public class ArticleHTMLController implements ArticleHTMLControllerApi &#123;

    final static Logger logger = LoggerFactory.getLogger(ArticleHTMLController.class);

    @Autowired //相应的下载
    private GridFSBucket gridFSBucket;

    @Value(&quot;$&#123;freemarker.html.article&#125;&quot;)
    private String articlePath;

    @Override
    public Integer download(String articleId, String articleMongoId)
            throws Exception &#123;

        // 拼接最终文件的保存的地址
        String path = articlePath + File.separator + articleId + &quot;.html&quot;;

        // 获取文件流，定义存放的位置和名称
        File file = new File(path);
        // 创建输出流
        OutputStream outputStream = new FileOutputStream(file);
        // 执行下载
        gridFSBucket.downloadToStream(new ObjectId(articleMongoId), outputStream);

        return HttpStatus.OK.value();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
@Override
    public GraceJSONResult doReview(String articleId, Integer passOrNot) &#123;
        Integer pendingStatus;
        if (passOrNot == YesOrNo.YES.type) &#123;
            // 审核成功
            pendingStatus = ArticleReviewStatus.SUCCESS.type;
        &#125; else if (passOrNot == YesOrNo.NO.type) &#123;
            // 审核失败
            pendingStatus = ArticleReviewStatus.FAILED.type;
        &#125; else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
        // 保存到数据库，更改文章状态为审核成功或者失败
        articleService.updateArticleStatus(articleId, pendingStatus);

        if (pendingStatus == ArticleReviewStatus.SUCCESS.type)&#123;
            //审核成功，生成文章详情页静态html
            try&#123;
//                 createArticleHTML(articleId);
                String articleMongoId = createArticleHTMLToGridFS(articleId);
                // 存储到对应的文章 进行关联保存
                articleService.updateArticleToGridFS(articleId, articleMongoId);
                // 调用消费端，执行下载html
                doDownloadArticleHTML(articleId,articleMongoId);
            &#125;catch (Exception e)&#123;
                e.printStackTrace();
            &#125;
        &#125;
        return GraceJSONResult.ok();
    &#125;
    private void doDownloadArticleHTML(String articleId, String articleMongoId) &#123;
        String url = //去SwitchHost弄个新的端口映射
                &quot;http://html.imoocnews.com:8002/article/html/download?articleId=&quot;
                        + articleId +
                        &quot;&amp;articleMongoId=&quot;
                        + articleMongoId;
        ResponseEntity&lt;Integer&gt; responseEntity = restTemplate.getForEntity(url, Integer.class);
        int status = responseEntity.getBody();
        if (status != HttpStatus.OK.value()) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
      /**
     * 关联文章和gridfs的html文件id
     */
    public void updateArticleToGridFS(String articleId, String articleMongoId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
    @Transactional
    @Override
    public void updateArticleToGridFS(String articleId, String articleMongoId) &#123;
        Article pendingArticle = new Article();
        pendingArticle.setId(articleId);
        pendingArticle.setMongoFileId(articleMongoId);
        articleMapper.updateByPrimaryKeySelective(pendingArticle);
    &#125;
</code></pre>
<pre><code class="mysql">【SwitchHosts】
# imooc-news 192.168.1.3
127.0.0.1 www.imoocnews.com
127.0.0.1 writer.imoocnews.com
127.0.0.1 admin.imoocnews.com
```
127.0.0.1 article.imoocnews.com
127.0.0.1 user.imoocnews.com
127.0.0.1 files.imoocnews.com
127.0.0.1 html.imoocnews.com

发布文章后审核文章
此时会发现数据库MongoDB里面的GridFS存储桶有新建的html 包括在 前端也存在此文件
D:\apache-tomcat-8.5.93\webapps\imooc-news\portal\a\240731CN3X1M56Y8.html
</code></pre>
<h3 id="撤回删除文章，删除gridfs文件以及html【静态化解耦】"><a href="#撤回删除文章，删除gridfs文件以及html【静态化解耦】" class="headerlink" title="撤回删除文章，删除gridfs文件以及html【静态化解耦】"></a>撤回删除文章，删除gridfs文件以及html【静态化解耦】</h3><blockquote>
<p>拿到mongodb_id  去删除 在service-html 写个删除接口 拼接删除方法</p>
</blockquote>
<pre><code class="java">service-api  com/imooc/api/controller/article/ArticleHTMLControllerApi.java
@Api(value = &quot;静态化文章业务的controller&quot;, tags = &#123;&quot;静态化文章业务的controller&quot;&#125;)
@RequestMapping(&quot;article/html&quot;)
public interface ArticleHTMLControllerApi &#123;
@GetMapping(&quot;delete&quot;)
    @ApiOperation(value = &quot;删除html&quot;, notes = &quot;删除html&quot;, httpMethod = &quot;GET&quot;)
    public Integer delete(String articleId) throws Exception;
&#125;
</code></pre>
<pre><code class="java">article-html  com/imooc/article/html/controller/ArticleHTMLController.java
@Override
    public Integer delete(String articleId) throws Exception &#123;
        // 拼接最终文件的保存的地址
        String path = articlePath + File.separator + articleId + &quot;.html&quot;;
        // 获取文件流，定义存放的位置和名称
        File file = new File(path);
        // 删除文件
        file.delete();
        return HttpStatus.OK.value();
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
 @Override
    public GraceJSONResult delete(String userId, String articleId) &#123;
        articleService.deleteArticle(userId,articleId);
        return GraceJSONResult.ok();
    &#125;

    @Override
    public GraceJSONResult withdraw(String userId, String articleId) &#123;
        articleService.withdrawArticle(userId, articleId);
        return GraceJSONResult.ok();
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
@Transactional
    @Override
    public void deleteArticle(String userId, String articleId) &#123;
        Example articleExample = makeExampleCriteria(userId, articleId);

        Article pending = new Article();
        pending.setIsDelete(YesOrNo.YES.type);

        int result = articleMapper.updateByExampleSelective(pending, articleExample);
        if (result != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_DELETE_ERROR);
        &#125;
        deleteHTML(articleId);
    &#125;

    @Transactional
    @Override
    public void withdrawArticle(String userId, String articleId) &#123;
        Example articleExample = makeExampleCriteria(userId, articleId);

        Article pending = new Article();
        pending.setArticleStatus(ArticleReviewStatus.WITHDRAW.type);

        int result = articleMapper.updateByExampleSelective(pending, articleExample);
        if (result != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_WITHDRAW_ERROR);
        &#125;
        deleteHTML(articleId);
    &#125;
...
...

    @Autowired
    private GridFSBucket gridFSBucket;
    /**
     * 文章撤回删除后，删除静态化的html
     */

    public void deleteHTML(String articleId) &#123;
        // 1. 查询文章的mongoFileId
        Article pending = articleMapper.selectByPrimaryKey(articleId);
        String articleMongoId = pending.getMongoFileId();

        // 2. 删除GridFS上的文件
        gridFSBucket.delete(new ObjectId(articleMongoId));

        // 3. 删除消费端的HTML文件
        doDeleteArticleHTML(articleId);
//        doDeleteArticleHTMLByMQ(articleId);
    &#125;

    @Autowired
    public RestTemplate restTemplate;
    private void doDeleteArticleHTML(String articleId) &#123;
        String url = &quot;http://html.imoocnews.com:8002/article/html/delete?articleId=&quot; + articleId;
        ResponseEntity&lt;Integer&gt; responseEntity = restTemplate.getForEntity(url, Integer.class);
        int status = responseEntity.getBody();
        if (status != HttpStatus.OK.value()) &#123;
            GraceException.display(ResponseStatusEnum.SYSTEM_OPERATION_ERROR);
        &#125;
    &#125;
</code></pre>
<h3 id="接口解耦需求【章节概述】"><a href="#接口解耦需求【章节概述】" class="headerlink" title="接口解耦需求【章节概述】"></a>接口解耦需求【章节概述】</h3><ul>
<li><strong>介绍RabbitMQ</strong></li>
<li><strong>RabbitMQ术语</strong></li>
<li><strong>安装与配置消息队列</strong></li>
<li><strong>实现接口调用解耦</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/d5205be20fc0bac1de7cadbc9b34f6ff949df3d1/data/Rabbitmq.png"></p>
<h3 id="RabbitMQ概述-MQ模型"><a href="#RabbitMQ概述-MQ模型" class="headerlink" title="RabbitMQ概述_MQ模型"></a>RabbitMQ概述_MQ模型</h3><h5 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h5><ul>
<li><strong>RabbitMQ</strong></li>
<li><strong>ActiveMQ</strong></li>
<li><strong>RocketMQ</strong></li>
<li><strong>Kafka</strong></li>
</ul>
<h5 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h5><ul>
<li><strong>erlang语言开发</strong></li>
<li><strong>AMQP</strong></li>
<li><strong>应用之间通信</strong></li>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a></li>
</ul>
<h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li><strong>异步任务</strong></li>
<li><strong>提速</strong></li>
<li><strong>接口解耦</strong></li>
<li><strong>削峰</strong></li>
</ul>
<h5 id="RabbitMQ模型"><a href="#RabbitMQ模型" class="headerlink" title="RabbitMQ模型"></a>RabbitMQ模型</h5><p><img src="https://raw.githubusercontent.com/P-luminary/images/d83d056479d71444c598865698d340e2ba01da96/data/RabbitMQ%E6%A8%A1%E5%9E%8B.png"></p>
<h3 id="RabbitMQ-3-8-5-安装与配置详细在”多线程与分布式-md“中有"><a href="#RabbitMQ-3-8-5-安装与配置详细在”多线程与分布式-md“中有" class="headerlink" title="RabbitMQ-3.8.5 安装与配置详细在”多线程与分布式.md“中有"></a>RabbitMQ-3.8.5 安装与配置<del>详细在”多线程与分布式.md“中有</del></h3><blockquote>
<p>E:\Java实例项目1-20套\第04套【项目实战】Spring Cloud分布式微服务实战，打造大型自媒体3大业务平台 分布式前后端分离项目分层聚合 养成应对复杂业务的综合技术能力\imooc-news\rabbitmq-server-3.8.5</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://packagecloud.io/rabbitmq/erlang/install#bash-rpm">rabbitmq&#x2F;erlang - Installation · packagecloud- Bash Scripts</a></p>
<pre><code class="mysql">[imooc@imooc ~]$ curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash
[imooc@imooc ~]$ sudo yum install erlang
[imooc@imooc ~]$ erl
Erlang/OTP 23 [erts-11.2.2.10] [source] [64-bit] [smp:2:2] [ds:2:2:10] [async-threads:1] [hipe]

Eshell V11.2.2.10  (abort with ^G)
1&gt; 
[imooc@imooc ~]$ yum list | grep erlang
erlang.x86_64                               23.3.4.11-1.el7            @rabbitmq_erlang
erlang-debuginfo.x86_64                     23.3.4.11-1.el7            rabbitmq_erlang
[imooc@imooc ~]$ sudo rpm --import https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey
[imooc@imooc ~]$ sudo rpm --import https://packagecloud.io/gpg.key

将资源包里的文件拷贝过来 rabbitmq.conf 和 rabbitmq-server.rpm
#[先把两个依赖搞好 =&gt; 一个是key 一个是依赖]
[imooc@imooc ~]$ sudo rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc
[imooc@imooc ~]$ sudo yum install socat
[imooc@imooc ~]$ sudo rpm -ivh rabbitmq-server-3.8.5-1.el7.noarch.rpm
[imooc@imooc ~]$ sudo vim rabbitmq.conf
#&#123;loopback_users, []&#125; 加上注释#
[imooc@imooc ~]$ cd /etc/rabbitmq/
#把conf移动到etc中
[imooc@imooc rabbitmq]$ sudo cp /home/imooc/rabbitmq.conf .
#重新启动rabbitmq
[imooc@imooc rabbitmq]$ sudo systemctl restart rabbitmq-server
#查看状态
[imooc@imooc rabbitmq]$ sudo systemctl status rabbitmq-server

● rabbitmq-server.service - RabbitMQ broker
   Loaded: loaded (/usr/lib/systemd/system/rabbitmq-server.service; disabled; vendor preset: disabled)
   Active: active (running) since 四 2024-08-01 15:45:54 CST; 13s ago
 Main PID: 5843 (beam.smp)
   Status: &quot;Initialized&quot;
    Tasks: 86
   CGroup: /system.slice/rabbitmq-server.service
           ├─5843 /usr/lib64/erlang/erts-11.2.2.10/bin/beam.smp -W w -K true -A 64 -M...
           ├─5952 erl_child_setup 32768
           ├─6008 inet_gethost 4
           └─6009 inet_gethost 4
           
[imooc@imooc rabbitmq]$ sudo rabbitmq-plugins enable rabbitmq_management
[imooc@imooc rabbitmq]$ ll
总用量 40
-rw-r--r--. 1 root rabbitmq    23 8月   1 15:46 enabled_plugins
-rw-r--r--. 1 root rabbitmq 33325 8月   1 15:35 rabbitmq.conf

http://192.168.170.135:15672/
username: guest
password: guest
[imooc@imooc ~]$ sudo vim rabbitmq.conf #把这个取消注释
loopback_users.guest = false

http://192.168.170.135:15672/#/  #创建虚拟host节点
→ admin → Add a user
</code></pre>
<h3 id="引入依赖和配置【集成Rabbitmq】"><a href="#引入依赖和配置【集成Rabbitmq】" class="headerlink" title="引入依赖和配置【集成Rabbitmq】"></a>引入依赖和配置【集成Rabbitmq】</h3><pre><code class="xml">service-api  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<blockquote>
<p>模块 Module<br>imooc-news-dev-service-article 是生产者[发送消息]<br>→<br>imooc-news-dev-service-article-html 是消费者[处理消息]</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://192.168.170.135:15672/#/vhosts">RabbitMQ Management</a> 在Virtual Hosts → Add a new virtual host → Name: imooc-news-dev<br>退出再重新登陆一下rabbitmq → 账号密码：admin</p>
<pre><code class="yaml">service-article  application.yml
  rabbitmq:
    host: 192.168.170.135
    port: 5672
    username: admin
    password: admin
    virtual-host: imooc-news-dev
</code></pre>
<pre><code class="yaml">service-article-html  application.yml
  rabbitmq:
    host: 192.168.170.135
    port: 5672
    username: admin
    password: admin
    virtual-host: imooc-news-dev
</code></pre>
<h3 id="创建交换机和队列【集成Rabbitmq】"><a href="#创建交换机和队列【集成Rabbitmq】" class="headerlink" title="创建交换机和队列【集成Rabbitmq】"></a>创建交换机和队列【集成Rabbitmq】</h3><pre><code class="java">service-api  com/imooc/api/config/RabbitMQConfig.java
package com.imooc.api.config;

import org.springframework.amqp.core.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * RabbitMQ 的配置类
 */
@Configuration
public class RabbitMQConfig &#123;

    // 定义交换机的名字
    public static final String EXCHANGE_ARTICLE = &quot;exchange_article&quot;;

    // 定义队列的名字
    public static final String QUEUE_DOWNLOAD_HTML = &quot;queue_download_html&quot;;

    // 创建交换机
    @Bean(EXCHANGE_ARTICLE)
    public Exchange exchange()&#123;
        return ExchangeBuilder
                .topicExchange(EXCHANGE_ARTICLE)
                .durable(true)
                .build();
    &#125;

    // 创建队列
    @Bean(QUEUE_DOWNLOAD_HTML)
    public Queue queue()&#123;
        return new Queue(QUEUE_DOWNLOAD_HTML);
    &#125;

    // 队列绑定交换机
    @Bean
    public Binding binding(
            @Qualifier(QUEUE_DOWNLOAD_HTML) Queue queue,
            @Qualifier(EXCHANGE_ARTICLE) Exchange exchange)&#123;
        return BindingBuilder
                .bind(queue)
                .to(exchange)
                //.with(&quot;article.*&quot;) &quot;article.hello&quot;,  //类似于API的规则
                .with(&quot;article.#.do&quot;)
                .noargs();      // 执行绑定
    &#125;
&#125;
</code></pre>
<h3 id="创建生产者-配置路由规则【集成RabbitMQ】"><a href="#创建生产者-配置路由规则【集成RabbitMQ】" class="headerlink" title="创建生产者_配置路由规则【集成RabbitMQ】"></a>创建生产者_配置路由规则【集成RabbitMQ】</h3><p><a target="_blank" rel="noopener" href="http://localhost:8001/producer/hello">localhost:8001&#x2F;producer&#x2F;hello</a></p>
<blockquote>
<p>{<br>“status”: 200,<br>“msg”: “操作成功！”,<br>“success”: true,<br>“data”: null<br>}</p>
</blockquote>
<pre><code class="java">//如果队列规则改变 就需要把Exchanges里的RoutingKey解绑[Unbind] 否则还是会有以前的规则收到消息
//http://192.168.170.135:15672/#/exchanges/imooc-news-dev/exchange_article 
package com.imooc.article.controller;

import com.imooc.api.config.RabbitMQConfig;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(&quot;producer&quot;)
public class HelloController&#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);
    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping(&quot;/hello&quot;)
    public Object hello() &#123;
    /**
     * RabbitMQ的路由规则 routing key
     * display.*.*  →  * 代表一个占位符
     * .with(&quot;article.#.do&quot;)  //类似于API的规则
     * 例：
     *      display.do.download      匹配
     *      display.do.upload.done 不匹配
     *
     * display.# → # 代表任意多个占位符
     * 例：
     *      display.do.download      匹配
     *      display.do.upload.done.over 匹配
     */

        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.publish.download.do&quot;, //要绑定规则
                &quot;1001~&quot;);
        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.success.do&quot;, //要绑定规则
                &quot;1002~&quot;);
        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.play&quot;, //要绑定规则
                &quot;1003~&quot;);
        return GraceJSONResult.ok();
    &#125;
&#125;
http://localhost:8001/producer/hello
</code></pre>
<h3 id="消费者接受消息处理业务【集成RabbitMQ】"><a href="#消费者接受消息处理业务【集成RabbitMQ】" class="headerlink" title="消费者接受消息处理业务【集成RabbitMQ】"></a>消费者接受消息处理业务【集成RabbitMQ】</h3><p><a target="_blank" rel="noopener" href="http://192.168.170.135:15672/#/queues/imooc-news-dev/queue_download_html">RabbitMQ Management</a></p>
<blockquote>
<p>如果消息被消费掉后那么就 需要重新请求消息队列生成</p>
</blockquote>
<pre><code class="java">service-article-html  com/imooc/article/html/RabbitMQConsumer.java
package com.imooc.article.html;

import com.imooc.api.config.RabbitMQConfig;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;
//打断点后 只要队列有消息 消费者监听到就会被消费
@Component
public class RabbitMQConsumer &#123;
    @RabbitListener(queues = &#123;RabbitMQConfig.QUEUE_DOWNLOAD_HTML&#125;)//监听哪个队列
    public void watchQueue(String payload, Message message)&#123;
        System.out.println(payload);

        String routingKey = message.getMessageProperties().getReceivedRoutingKey();
        if (routingKey.equalsIgnoreCase(&quot;article.publish.download.do&quot;)) &#123;
            System.out.println(&quot;article.publish.download.do&quot;);
        &#125; else if (routingKey.equalsIgnoreCase(&quot;article.success.do&quot;)) &#123;
            System.out.println(&quot;article.success.do&quot;);
        &#125; else &#123;
            System.out.println(&quot;不符合的规则：&quot; + routingKey);
        &#125;
    &#125;
&#125;
==================================================================
// 如果消息被消费掉后那么就 需要重新请求消息队列生成
// 此时需要刷新 http://localhost:8001/producer/hello 重新提交一下消息就可以了
Console：
1001~
article.publish.download.do
1002~
article.success.do
1003~
不符合的规则：article.play
</code></pre>
<h3 id="文章静态化HTML与删除【异步解耦】"><a href="#文章静态化HTML与删除【异步解耦】" class="headerlink" title="文章静态化HTML与删除【异步解耦】"></a>文章静态化HTML与删除【异步解耦】</h3><pre><code class="java">service-article  com/imooc/article/controller/ArticleController.java
 @Override
    public GraceJSONResult doReview(String articleId, Integer passOrNot) &#123;
        Integer pendingStatus;
        if (passOrNot == YesOrNo.YES.type) &#123;
            // 审核成功
            pendingStatus = ArticleReviewStatus.SUCCESS.type;
        &#125; else if (passOrNot == YesOrNo.NO.type) &#123;
            // 审核失败
            pendingStatus = ArticleReviewStatus.FAILED.type;
        &#125; else &#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.ARTICLE_REVIEW_ERROR);
        &#125;
        // 保存到数据库，更改文章状态为审核成功或者失败
        articleService.updateArticleStatus(articleId, pendingStatus);

        if (pendingStatus == ArticleReviewStatus.SUCCESS.type)&#123;
            //审核成功，生成文章详情页静态html
            try&#123;
//                 createArticleHTML(articleId);
                String articleMongoId = createArticleHTMLToGridFS(articleId);
                // 存储到对应的文章 进行关联保存
                articleService.updateArticleToGridFS(articleId, articleMongoId);
                // 调用消费端，执行下载html
//                doDownloadArticleHTML(articleId,articleMongoId);
            ★★  // 发送消息到mq队列，让消费者监听并且下载html  ★★
                doDownloadArticleHTMLByMQ(articleId,articleMongoId);
            &#125;catch (Exception e)&#123;
                e.printStackTrace();
            &#125;
        &#125;
        return GraceJSONResult.ok();
    &#125;
@Autowired
    private RabbitTemplate rabbitTemplate;
    private void doDownloadArticleHTMLByMQ(String articleId, String articleMongoId) &#123;

        rabbitTemplate.convertAndSend(
                RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.download.do&quot;,
                articleId + &quot;,&quot; + articleMongoId);
    &#125;
</code></pre>
<pre><code class="java">service-article-html  com/imooc/article/html/controller/ArticleHTMLComponent.java
package com.imooc.article.html.controller;

import com.mongodb.client.gridfs.GridFSBucket;
import org.bson.types.ObjectId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;

import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;

@Component
public class ArticleHTMLComponent &#123;

    @Autowired
    private GridFSBucket gridFSBucket;

    @Value(&quot;$&#123;freemarker.html.article&#125;&quot;)
    private String articlePath;

    public Integer download(String articleId, String articleMongoId)
            throws Exception &#123;

        // 拼接最终文件的保存的地址
        String path = articlePath + File.separator + articleId + &quot;.html&quot;;

        // 获取文件流，定义存放的位置和名称
        File file = new File(path);
        // 创建输出流
        OutputStream outputStream = new FileOutputStream(file);
        // 执行下载
        gridFSBucket.downloadToStream(new ObjectId(articleMongoId), outputStream);

        return HttpStatus.OK.value();
    &#125;

    public Integer delete(String articleId) throws Exception &#123;

        // 拼接最终文件的保存的地址
        String path = articlePath + File.separator + articleId + &quot;.html&quot;;

        // 获取文件流，定义存放的位置和名称
        File file = new File(path);

        // 删除文件
        file.delete();

        return HttpStatus.OK.value();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article-html  com/imooc/article/html/RabbitMQConsumer.java
package com.imooc.article.html;

import com.imooc.api.config.RabbitMQConfig;
import com.imooc.article.html.controller.ArticleHTMLComponent;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
//打断点后 只要队列有消息 消费者监听到就会被消费
@Component
public class RabbitMQConsumer &#123;
    @Autowired
    private ArticleHTMLComponent articleHTMLComponent;

    @RabbitListener(queues = &#123;RabbitMQConfig.QUEUE_DOWNLOAD_HTML&#125;)//监听哪个队列
    public void watchQueue(String payload, Message message)&#123;
        System.out.println(payload);

        String routingKey = message.getMessageProperties().getReceivedRoutingKey();
        if (routingKey.equalsIgnoreCase(&quot;article.publish.download.do&quot;)) &#123;
            System.out.println(&quot;article.publish.download.do&quot;);
        &#125; else if (routingKey.equalsIgnoreCase(&quot;article.success.do&quot;)) &#123;
            System.out.println(&quot;article.success.do&quot;);
        &#125;else if (routingKey.equalsIgnoreCase(&quot;article.download.do&quot;)) &#123;
            String articleId = payload.split(&quot;,&quot;)[0];
            String articleMongoId = payload.split(&quot;,&quot;)[1];
            try &#123;
                articleHTMLComponent.download(articleId, articleMongoId);
            &#125; catch (Exception e) &#123;
                e.printStackTrace();
            &#125;

        &#125; else if (routingKey.equalsIgnoreCase(&quot;article.html.download.do&quot;)) &#123;
            String articleId = payload;
            try &#123;
                articleHTMLComponent.delete(articleId);
            &#125; catch (Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125; else &#123;
            System.out.println(&quot;不符合的规则：&quot; + routingKey);
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="java">前端的index.html页面也需要修改成静态页面跳转
&lt;a :href=&quot;&#39;./a/&#39;+article.id+&#39;.html&#39;&quot; target=&quot;_blank&quot; class=&quot;link-article-title&quot;&gt;&#123;&#123;article.title&#125;&#125;&lt;/a&gt;
这样再次刷新 就可以让页面不是articleId=?...
http://www.imoocnews.com:9090/imooc-news/portal/a/240801D7S7PM63R4.html
</code></pre>
<h3 id="延迟队列的需求与安装配置【延迟队列】"><a href="#延迟队列的需求与安装配置【延迟队列】" class="headerlink" title="延迟队列的需求与安装配置【延迟队列】"></a>延迟队列的需求与安装配置【延迟队列】</h3><p>把这个<del>rabbitmq_delayed_message_exchange-3.8.0.ez</del>上传到Linux虚拟机</p>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/be9aa25974ee850399731a79b57f5cd8c4375356/data/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97.jpg"></p>
<pre><code class="mysql">[imooc@imooc rabbitmq]$ cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.5/plugins
[imooc@imooc ~]$ sudo mv /home/imooc/rabbitmq_delayed_message_exchange-3.8.0.ez /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.5/plugins
[imooc@imooc plugins]$ sudo systemctl restart rabbitmq-server
[imooc@imooc plugins]$ sudo rabbitmq-plugins list
Listing plugins with pattern &quot;.*&quot; ...
 Configured: E = explicitly enabled; e = implicitly enabled
 | Status: * = running on rabbit@imooc
 |/
[  ] rabbitmq_amqp1_0                  3.8.5
[  ] rabbitmq_auth_backend_cache       3.8.5
[  ] rabbitmq_auth_backend_http        3.8.5
[  ] rabbitmq_auth_backend_ldap        3.8.5
[  ] rabbitmq_auth_backend_oauth2      3.8.5
[  ] rabbitmq_auth_mechanism_ssl       3.8.5
[  ] rabbitmq_consistent_hash_exchange 3.8.5
[  ] rabbitmq_delayed_message_exchange 3.8.0
[  ] rabbitmq_event_exchange           3.8.5
[  ] rabbitmq_federation               3.8.5
[  ] rabbitmq_federation_management    3.8.5
[  ] rabbitmq_jms_topic_exchange       3.8.5
[E*] rabbitmq_management               3.8.5
[e*] rabbitmq_management_agent         3.8.5
[  ] rabbitmq_mqtt                     3.8.5
[  ] rabbitmq_peer_discovery_aws       3.8.5
[  ] rabbitmq_peer_discovery_common    3.8.5
[  ] rabbitmq_peer_discovery_consul    3.8.5
[  ] rabbitmq_peer_discovery_etcd      3.8.5
[  ] rabbitmq_peer_discovery_k8s       3.8.5
[  ] rabbitmq_prometheus               3.8.5
[  ] rabbitmq_random_exchange          3.8.5
[  ] rabbitmq_recent_history_exchange  3.8.5
[  ] rabbitmq_sharding                 3.8.5
[  ] rabbitmq_shovel                   3.8.5
[  ] rabbitmq_shovel_management        3.8.5
[  ] rabbitmq_stomp                    3.8.5
[  ] rabbitmq_top                      3.8.5
[  ] rabbitmq_tracing                  3.8.5
[  ] rabbitmq_trust_store              3.8.5
[e*] rabbitmq_web_dispatch             3.8.5
[  ] rabbitmq_web_mqtt                 3.8.5
[  ] rabbitmq_web_mqtt_examples        3.8.5
[  ] rabbitmq_web_stomp                3.8.5
[  ] rabbitmq_web_stomp_examples       3.8.5
[imooc@imooc plugins]$ service rabbitmq-server restart #[重启服务]
Redirecting to /bin/systemctl restart rabbitmq-server.service
</code></pre>
<h3 id="实现延迟队列【延迟队列】"><a href="#实现延迟队列【延迟队列】" class="headerlink" title="实现延迟队列【延迟队列】"></a>实现延迟队列【延迟队列】</h3><pre><code class="java">service-api  com/imooc/api/config/RabbitMQDelayConfig.java
package com.imooc.api.config;

import org.springframework.amqp.core.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;
import java.util.Map;

/**
 * RabbitMQ 的配置类
 */
@Configuration
public class RabbitMQDelayConfig &#123;

    // 定义交换机的名字
    public static final String EXCHANGE_DELAY = &quot;exchange_delay&quot;;

    // 定义队列的名字
    public static final String QUEUE_DELAY = &quot;queue_delay&quot;;

    // 创建延迟交换机
    @Bean(EXCHANGE_DELAY)
    public CustomExchange delayExchange() &#123;
        Map&lt;String, Object&gt; args = new HashMap&lt;&gt;();
        args.put(&quot;x-delayed-type&quot;, &quot;topic&quot;);
        return new CustomExchange(EXCHANGE_DELAY, &quot;x-delayed-message&quot;, true, false, args);
    &#125;

    // 创建队列
    @Bean(QUEUE_DELAY)
    public Queue queue()&#123;
        return new Queue(QUEUE_DELAY);
    &#125;

    // 队列绑定交换机 ↓ binding必须要唯一
    @Bean
    public Binding delayBinding(
            @Qualifier(QUEUE_DELAY) Queue queue,
            @Qualifier(EXCHANGE_DELAY) Exchange exchange)&#123;
        return BindingBuilder
                .bind(queue)
                .to(exchange)
                .with(&quot;delay.#&quot;)
                .noargs();      // 执行绑定
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/RabbitMQDelayConsumer.java
package com.imooc.article;

import com.imooc.api.config.RabbitMQDelayConfig;
import com.imooc.article.service.ArticleService;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Date;

@Component
public class RabbitMQDelayConsumer &#123;

    @Autowired
    private ArticleService articleService;

    @RabbitListener(queues = &#123;RabbitMQDelayConfig.QUEUE_DELAY&#125;)
    public void watchQueue(String payload, Message message) &#123;
        System.out.println(payload);

        String routingKey = message.getMessageProperties().getReceivedRoutingKey();
        System.out.println(routingKey);

        System.out.println(&quot;消费者接受的延迟消息：&quot; + new Date());

//        // 消费者接收到定时发布的延迟消息，修改当前的文章状态为`即时发布`
//        String articleId = payload;
//        articleService.updateArticleToPublish(articleId);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/HelloController.java
package com.imooc.article.controller;

import com.imooc.api.config.RabbitMQConfig;
import com.imooc.api.config.RabbitMQDelayConfig;
import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.AmqpException;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.core.MessageDeliveryMode;
import org.springframework.amqp.core.MessagePostProcessor;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Date;

@RestController
@RequestMapping(&quot;producer&quot;)
public class HelloController&#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);
    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping(&quot;/hello&quot;)
    public Object hello() &#123;
    /**
     * RabbitMQ的路由规则 routing key
     * display.*.*  →  * 代表一个占位符
     * .with(&quot;article.#.do&quot;)  //类似于API的规则
     * 例：
     *      display.do.download      匹配
     *      display.do.upload.done 不匹配
     *
     * display.# → # 代表任意多个占位符
     * 例：
     *      display.do.download      匹配
     *      display.do.upload.done.over 匹配
     */

        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.publish.download.do&quot;, //要绑定规则
                &quot;1001~&quot;);
        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.success.do&quot;, //要绑定规则
                &quot;1002~&quot;);
        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_ARTICLE,
                &quot;article.play&quot;, //要绑定规则
                &quot;1003~&quot;);
        return GraceJSONResult.ok();
    &#125;

    @GetMapping(&quot;/delay&quot;)
    public Object delay() &#123;
        //重写延迟方法  【生产者】
        MessagePostProcessor messagePostProcessor = new MessagePostProcessor() &#123;
            @Override
            public Message postProcessMessage(Message message) throws AmqpException &#123;
                // 设置消息的持久
                message.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                // 设置消息延迟的时间 单位ms毫秒
                message.getMessageProperties().setDelay(5000);
                return message;
            &#125;
        &#125;;
        rabbitTemplate.convertAndSend(RabbitMQDelayConfig.EXCHANGE_DELAY,
                &quot;delay.demo&quot;, //要绑定规则
                &quot;这是一条延时消息~&quot;,
                messagePostProcessor);
        System.out.println(&quot;生产者发送的延迟消息：&quot; + new Date());
        return &quot;OK&quot;;
    &#125;
&#125;
</code></pre>
<pre><code class="mysql">确保 rabbitmq_delayed_message_exchange 插件正确启用：

复制代码
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
sudo systemctl restart rabbitmq-server

======================================================================
http://localhost:8001/producer/delay

生产者发送的延迟消息：Thu Aug 01 20:17:30 CST 2024

这是一条延时消息~
delay.demo
消费者接受的延迟消息：Thu Aug 01 20:17:35 CST 2024
</code></pre>
<h3 id="实现文章的定时延时发布【延迟队列】"><a href="#实现文章的定时延时发布【延迟队列】" class="headerlink" title="实现文章的定时延时发布【延迟队列】"></a>实现文章的定时延时发布【延迟队列】</h3><pre><code class="java">service-article  com/imooc/article/service/ArticleService.java
/**
     * 更新定时发布为即使发布
     
    public void updateAppointToPublish(); **/

    /**
     * 更新单条文章为记时发布
     */
    public void updateArticleToPublish(String articleId);
</code></pre>
<pre><code class="java">service-article  com/imooc/article/service/impl/ArticleServiceImpl.java
【32-64行  89-101行】
 @Transactional
    @Override
    public void createArticle(NewArticleBO newArticleBO, Category category) &#123;
        String articleId = sid.nextShort();

        Article article = new Article();
        BeanUtils.copyProperties(newArticleBO, article);

        article.setId(articleId);
        article.setCategoryId(category.getId());
        article.setArticleStatus(ArticleReviewStatus.REVIEWING.type);
        article.setCommentCounts(0);
        article.setReadCounts(0);

        article.setIsDelete(YesOrNo.NO.type);
        article.setCreateTime(new Date());
        article.setUpdateTime(new Date());

        if (article.getIsAppoint() == ArticleAppointType.TIMING.type) &#123;
            article.setPublishTime(newArticleBO.getPublishTime()); //用户可以在前端选择定时发布
        &#125; else if (article.getIsAppoint() == ArticleAppointType.IMMEDIATELY.type) &#123;
            article.setPublishTime(new Date());
        &#125;

        int res = articleMapper.insert(article);
        if (res != 1) &#123;
            GraceException.display(ResponseStatusEnum.ARTICLE_CREATE_ERROR);
        &#125;

        // 发送延迟消息到mq，计算定时发布时间和当前时间的时间差，则为往后延迟的时间
        if (article.getIsAppoint() == ArticleAppointType.TIMING.type) &#123;

            Date endDate = newArticleBO.getPublishTime();
            Date startDate = new Date();

          int delayTimes = (int)(endDate.getTime() - startDate.getTime());

            System.out.println(DateUtil.timeBetween(startDate, endDate));

            // FIXME: 为了测试方便，写死10s
//            int delayTimes = 10 * 1000;

            MessagePostProcessor messagePostProcessor = new MessagePostProcessor() &#123;
                @Override
                public Message postProcessMessage(Message message) throws AmqpException &#123;
                    // 设置消息的持久
                    message.getMessageProperties()
                            .setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                    // 设置消息延迟的时间，单位ms毫秒
                    message.getMessageProperties()
                            .setDelay(delayTimes);
                    return message;
                &#125;
            &#125;;
            rabbitTemplate.convertAndSend(
                    RabbitMQDelayConfig.EXCHANGE_DELAY,
                    &quot;publish.delay.display&quot;,
                    articleId,
                    messagePostProcessor);

            System.out.println(&quot;延迟消息-定时发布文章：&quot; + new Date());
        &#125;


        /**
         * FIXME: 我们只检测正常的词汇，非正常词汇大家课后去检测
         */
        // 通过阿里智能AI实现对文章文本的自动检测（自动审核）
//        String reviewTextResult = aliTextReviewUtils.reviewTextContent(newArticleBO.getContent());
        String reviewTextResult = ArticleReviewLevel.REVIEW.type;

        if (reviewTextResult
                .equalsIgnoreCase(ArticleReviewLevel.PASS.type)) &#123;
            // 修改当前的文章，状态标记为审核通过
            this.updateArticleStatus(articleId, ArticleReviewStatus.SUCCESS.type);
        &#125; else if (reviewTextResult
                .equalsIgnoreCase(ArticleReviewLevel.REVIEW.type)) &#123;
            // 修改当前的文章，状态标记为需要人工审核
            this.updateArticleStatus(articleId, ArticleReviewStatus.WAITING_MANUAL.type);
        &#125; else if (reviewTextResult
                .equalsIgnoreCase(ArticleReviewLevel.BLOCK.type)) &#123;
            // 修改当前的文章，状态标记为审核未通过
            this.updateArticleStatus(articleId, ArticleReviewStatus.FAILED.type);
        &#125;
    &#125;

@Transactional //添加事务[更新操作]
/** @Override
    public void updateAppointToPublish() &#123;
        articleMapperCustom.updateAppointToPublish();
    &#125; **/

    @Override
    public void updateArticleToPublish(String articleId) &#123;
        Article article = new Article();
        article.setId(articleId);
        article.setIsAppoint(ArticleAppointType.IMMEDIATELY.type);
        articleMapper.updateByPrimaryKeySelective(article);
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/RabbitMQDelayConsumer.java
package com.imooc.article;

import com.imooc.api.config.RabbitMQDelayConfig;
import com.imooc.article.service.ArticleService;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Date;

@Component
public class RabbitMQDelayConsumer &#123;

    @Autowired
    private ArticleService articleService;

    @RabbitListener(queues = &#123;RabbitMQDelayConfig.QUEUE_DELAY&#125;)
    public void watchQueue(String payload, Message message) &#123;
        System.out.println(payload);

        String routingKey = message.getMessageProperties().getReceivedRoutingKey();
        System.out.println(routingKey);

        System.out.println(&quot;消费者接受的延迟消息：&quot; + new Date());

        // 消费者接收到定时发布的延迟消息，修改当前的文章状态为`即时发布`
        String articleId = payload;
        articleService.updateArticleToPublish(articleId);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/RabbitMQDelayConfig.java //【换一下绑定类型.with(...)】
package com.imooc.api.config;

import org.springframework.amqp.core.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;
import java.util.Map;

/**
 * RabbitMQ 的配置类
 */
@Configuration
public class RabbitMQDelayConfig &#123;

    // 定义交换机的名字
    public static final String EXCHANGE_DELAY = &quot;exchange_delay&quot;;

    // 定义队列的名字
    public static final String QUEUE_DELAY = &quot;queue_delay&quot;;

    // 创建延迟交换机
    @Bean(EXCHANGE_DELAY)
    public CustomExchange delayExchange() &#123;
        Map&lt;String, Object&gt; args = new HashMap&lt;&gt;();
        args.put(&quot;x-delayed-type&quot;, &quot;topic&quot;);
        return new CustomExchange(EXCHANGE_DELAY, &quot;x-delayed-message&quot;, true, false, args);
    &#125;

    // 创建队列
    @Bean(QUEUE_DELAY)
    public Queue queue()&#123;
        return new Queue(QUEUE_DELAY);
    &#125;

    // 队列绑定交换机 ↓ binding必须要唯一
    @Bean
    public Binding delayBinding(
            @Qualifier(QUEUE_DELAY) Queue queue,
            @Qualifier(EXCHANGE_DELAY) Exchange exchange)&#123;
        return BindingBuilder
                .bind(queue)
                .to(exchange)
                .with(&quot;publish.delay.#&quot;)
                .noargs();      // 执行绑定
    &#125;
&#125;
</code></pre>
<pre><code class="java">http://writer.imoocnews.com:9090/imooc-news/writer/createArticle.html 发布一篇定时文章
// 在数据库里面是article → is_appoint 是1 然后延迟3天后会变成0
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@15650472]
JDBC Connection [HikariProxyConnection@441638108 wrapping org.mariadb.jdbc.MariaDbConnection@159b2e33] will be managed by Spring
==&gt;  Preparing: INSERT INTO article ( id,title,category_id,article_type,article_cover,is_appoint,article_status,publish_user_id,publish_time,read_counts,comment_counts,mongo_file_id,is_delete,create_time,update_time,content ) VALUES( ?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,? ) 
==&gt; Parameters: 240801FNS7M8G354(String), b10(String), 14(Integer), 2(Integer), (String), 1(Integer), 1(Integer), 240629F21AK1BHX4(String), 2024-08-04 00:00:00.0(Timestamp), 0(Integer), 0(Integer), null, 0(Integer), 2024-08-01 20:36:24.971(Timestamp), 2024-08-01 20:36:24.971(Timestamp), &lt;p&gt;b10&lt;/p&gt;(String)
//★ &lt;==    Updates: 1 ★
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@15650472]
//★ 2天3小时23分钟 ★
//★ 延迟消息-定时发布文章：Thu Aug 01 20:36:24 CST 2024 ★
Fetched SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@15650472] from current transaction
==&gt;  Preparing: UPDATE article SET article_status = ? WHERE ( ( id = ? ) ) 
==&gt; Parameters: 2(Integer), 240801FNS7M8G354(String)
&lt;==    Updates: 1
</code></pre>
<h3 id="互联网框架演变【微服务块】"><a href="#互联网框架演变【微服务块】" class="headerlink" title="互联网框架演变【微服务块】"></a>互联网框架演变【微服务块】</h3><ul>
<li><strong>架构演变</strong></li>
<li><strong>微服务入门</strong></li>
<li><strong>SpringCloud各个组件学习</strong></li>
<li><strong>改造项目服务化</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/6d9d64a0daa29b87ebdd0c5ca1240264d5b802ed/data/r%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98.png"></p>
<h3 id="注冊中心模型"><a href="#注冊中心模型" class="headerlink" title="注冊中心模型"></a>注冊中心模型</h3><ul>
<li>Eureka</li>
<li>可以把每個服務注入到eureka，更利於管理和維護，使得服務閒通信更方便</li>
</ul>
<blockquote>
<p>Lilei [上户口] → <strong>派出所</strong>  ← [上户口] HanMeimei</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/317410ba901fb06e893bcdd7e2eb05980a9d19d0/data/Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83.png"></p>
<h3 id="构建Eureka注册服务【eureka】"><a href="#构建Eureka注册服务【eureka】" class="headerlink" title="构建Eureka注册服务【eureka】"></a>构建Eureka注册服务【eureka】</h3><pre><code class="java">springcloud-eureka  com/imooc/eureka/Application.java
package com.imooc.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;


@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class, MongoAutoConfiguration.class&#125;)
@EnableEurekaServer // 开启注册中心
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;

&#125;
http://localhost:7000/hello  #运行接口
http://localhost:7000         #运行eureka
</code></pre>
<pre><code class="java">springcloud-eureka  com/imooc/eureka/controller/HelloController.java
package com.imooc.eureka.controller;

import com.imooc.api.controller.user.HelloControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.RedisOperator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController implements HelloControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(HelloController.class);
    public Object hello()&#123;
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<pre><code class="xml">springcloud-eureka  pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;springcloud-eureka&lt;/artifactId&gt;

    &lt;dependencies&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;

            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
            &lt;/dependency&gt;
            &lt;!-- 其他必要的依赖 --&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;Hoxton.SR12&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

&lt;/project&gt;
</code></pre>
<pre><code class="xml">springcloud-eureka  logback-spring.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;configuration&gt;
    &lt;!-- 指定日志文件的存储地址，使用绝对路径 --&gt;
&lt;!--    &lt;property name=&quot;LOG_HOME&quot; value=&quot;/workspaces/logs/imooc-news-dev/service-admin&quot;/&gt;--&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;C:/Users/Pluminary/Desktop/imooc-news-dev/springcloud-eureka&quot;/&gt;

    &lt;!-- Console 输出设置 --&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;
            &lt;pattern&gt;%white(%d&#123;mm:ss.SSS&#125;) %green([%thread]) %cyan(%-5level) %yellow(%logger&#123;36&#125;) %magenta(-) %black(%msg%n)&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 按照每天生成日志文件 --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- 日志文件输出的文件名 --&gt;
            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/eureka.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!--&lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;--&gt;
        &lt;!--&lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;--&gt;
    &lt;!--&lt;/logger&gt;--&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<pre><code class="yaml">springcloud-eureka  application.yml
############################################################
#
# eureka 注册中心
# web访问端口号  约定：7000
#
############################################################
server:
  port: 7000
  tomcat:
    uri-encoding: UTF-8
    max-swallow-size: -1  # tomcat默认大小2M，超过2M的文件不会被捕获，需要调整此处大小为100MB或者-1即可

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-eureka

############################################################
#
# eureka 配置信息
#
############################################################
eureka:
  instance:  # eureka 实例的hostname，也可以是自定义配置hostname
    hostname: eureka
  client:  # 是否要把当前的eureka server注册到自己
    register-with-eureka: false
    # 从注册中心获得检索服务实例，server没有必要，直接false即可
    fetch-registry: false
    # 单实例配置自己的服务地址，高可用集群则配置多个地址
    service-url:
      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/
</code></pre>
<pre><code class="java">http://localhost:7000/
进入了Spring Eureka
Instances currently registered with Eureka
</code></pre>
<h3 id="实现用户与文章的服务注册【eureka】"><a href="#实现用户与文章的服务注册【eureka】" class="headerlink" title="实现用户与文章的服务注册【eureka】"></a>实现用户与文章的服务注册【eureka】</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/longd123/article/details/124440454">关于eureka客户端启动报错UnknownHostException详细解决方法_eureka unknownhostexception-CSDN博客</a> </p>
<pre><code class="mysql"># 问题：
http://eureka:7000/eureka   找不到 eureka 的服务器 IP 地址

在cmd里面
C:\Users\Pluminary&gt;ping eureka
Ping 请求找不到主机 eureka。请检查该名称，然后重试。

# 解答：
从你的描述来看，主机eureka无法解析，这是导致服务无法注册到Eureka Server的原因。你可以通过以下方法解决这个问题：

1. 更新 hosts 文件
在你的开发机器上更新 hosts 文件以手动解析 eureka 主机名。

Windows
打开记事本以管理员身份运行。

打开文件 C:\Windows\System32\drivers\etc\hosts。

添加以下行，将 &lt;eureka服务器的IP地址&gt; 替换为实际的IP地址：

plaintext
复制代码
&lt;eureka服务器的IP地址&gt; eureka
保存并关闭文件。

=================================================================
# imooc-news 192.168.1.3
127.0.0.1 www.imoocnews.com
127.0.0.1 writer.imoocnews.com
127.0.0.1 admin.imoocnews.com
```
127.0.0.1 article.imoocnews.com
127.0.0.1 user.imoocnews.com
127.0.0.1 files.imoocnews.com
127.0.0.1 html.imoocnews.com
</code></pre>
<pre><code class="yaml">springcloud-eureka  resources/application.yml
############################################################
#
# eureka 配置信息
#
############################################################
eureka:
  instance:
    # eureka 实例的hostname，可以是hostname，也可以自定义配置hostname
    hostname: eureka
  client:
    # 是否要把当前的eureka server注册到自己
    register-with-eureka: false
    # 从注册中心获得检索服务实例，server没有必要，直接false即可
    fetch-registry: false
    # 单实例配置自己的服务地址，高可用集群则配置多个地址
    service-url:
      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/
</code></pre>
<pre><code class="yaml">service-user  resources/application.yml
上面的其余不变 底下添加eureka
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
      defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
</code></pre>
<pre><code class="java">service-user  com/imooc/user/Application.java
package com.imooc.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.user.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient // 开启eureka client 注册到server中
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="xml">springcloud-eureka  pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;springcloud-eureka&lt;/artifactId&gt;

    &lt;dependencies&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<pre><code class="java">springcloud-eureka  com/imooc/user/Application.java
package com.imooc.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;


@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class, MongoAutoConfiguration.class&#125;)
@EnableEurekaServer // 开启注册中心
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
====================================================================
// 先启动这个服务 再启动user的服务
随后就能看见http://localhost:7000/
里面有一个注册的服务
/*  
   Instances currently registered with Eureka
   Application    AMIs    Availability Zones    Status
★ SERVICE-USER    n/a (1)    (1)    UP (1) - localhost:service-user:8003 
*/
</code></pre>
<pre><code class="yaml">service-article  resources/application.yml
# 定义freemarker生成的HTML
freemarker:
  html:
    target: D:/apache-tomcat-8.5.93/webapps/imooc-news/portal/a
    article: D:/apache-tomcat-8.5.93/webapps/imooc-news/portal/a

############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
      defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
</code></pre>
<pre><code class="java">service-article  com/imooc/article/Application.java 
//【此时再去启动这个article服务 会发现SERVICE-ARTICLE也成功的注册到Eureka中】
package com.imooc.article;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.context.annotation.ComponentScan;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

@EnableSwagger2
@SpringBootApplication
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
/*
   Application    AMIs    Availability Zones    Status
★ SERVICE-ARTICLE    n/a (1)    (1)    UP (1) - localhost:service-article:8001
★ SERVICE-USER    n/a (1)    (1)    UP (1) - localhost:service-user:8003
*/
</code></pre>
<h3 id="使用AppName优化服务间的通信【eureka】"><a href="#使用AppName优化服务间的通信【eureka】" class="headerlink" title="使用AppName优化服务间的通信【eureka】"></a>使用AppName优化服务间的通信【eureka】</h3><h6 id="实行动态化调用-地址拼接"><a href="#实行动态化调用-地址拼接" class="headerlink" title="实行动态化调用 地址拼接"></a>实行动态化调用 地址拼接</h6><p>AppName是eureka的ApplicationId &#x3D; <strong>SERVICE-USER</strong></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·[文章article]自媒体接口api</a> 如果页面没有信息那就是在<strong>Swagger2.java</strong>中代码的问题<br><a target="_blank" rel="noopener" href="http://localhost:7000/">Eureka</a></p>
<blockquote>
<p>门户端文章业务的controller →  &#x2F;portal&#x2F;article&#x2F;detail  →  articleId&#x3D;2006117B57WRZGHH</p>
</blockquote>
<pre><code class="java">package com.imooc.api.config;

import com.google.common.base.Predicate;
import com.google.common.base.Predicates;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.RequestHandler;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

@Configuration //Springboot啓動的時候會被掃描到并且加載
@EnableSwagger2
public class Swagger2 &#123;

    //    http://localhost:8088/swagger-ui.html     原路径
    //    http://localhost:8088/doc.html            新路径

    // 配置swagger2核心配置 docket
    @Bean
    public Docket createRestApi() &#123;
        Predicate&lt;RequestHandler&gt; adminPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.admin.controller&quot;);
        Predicate&lt;RequestHandler&gt; articlePredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.article.controller&quot;);
        Predicate&lt;RequestHandler&gt; userPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.user.controller&quot;);
        Predicate&lt;RequestHandler&gt; filesPredicate = RequestHandlerSelectors.basePackage(&quot;com.imooc.files.controller&quot;);

        return new Docket(DocumentationType.SWAGGER_2)  // 指定api类型为swagger2
                .apiInfo(apiInfo())                 // 用于定义api文档汇总信息
                .select()
//                .apis(Predicates.or(userPredicate, adminPredicate, filesPredicate))
                .apis(Predicates.or(adminPredicate, articlePredicate, userPredicate, filesPredicate))
                .paths(PathSelectors.any())         // 所有controller
                .build();
    &#125;

    private ApiInfo apiInfo() &#123;
        return new ApiInfoBuilder()
                .title(&quot;慕课新闻·自媒体接口api&quot;)                       // 文档页标题
                .contact(new Contact(&quot;imooc&quot;,
                        &quot;https://www.imooc.com&quot;,
                        &quot;abc@imooc.com&quot;))                   // 联系人信息
                .description(&quot;专为慕课新闻·自媒体平台提供的api文档&quot;)      // 详细信息
                .version(&quot;1.0.1&quot;)                               // 文档版本号
                .termsOfServiceUrl(&quot;https://www.imooc.com&quot;)     // 网站地址
                .build();
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
// 注入服务发现，可以获得已经注册的服务相关信息
    @Autowired
    private DiscoveryClient discoveryClient;
    // 发起远程调用，获得用户的基本信息
    private List&lt;AppUserVO&gt; getPublisherList(Set idSet) &#123;
        String serviceId = &quot;SERVICE-USER&quot;;
        List&lt;ServiceInstance&gt; instanceList = discoveryClient.getInstances(serviceId);
        ServiceInstance userService = instanceList.get(0);
    // 实行动态化调用 地址拼接
        String userServerUrlExecute
                = &quot;http://&quot;+ userService.getHost() + &quot;:&quot; + userService.getPort() + &quot;/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
//        String userServerUrlExecute
//                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
                = restTemplate.getForEntity(userServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        return publisherList;
    &#125;
</code></pre>
<h3 id="动态构建eureka集群【eureka】保证高可用"><a href="#动态构建eureka集群【eureka】保证高可用" class="headerlink" title="动态构建eureka集群【eureka】保证高可用"></a>动态构建eureka集群【eureka】<del>保证高可用</del></h3><blockquote>
<p>创建一个新的<strong>module</strong> 其内容和 <strong>springcloud-eureka</strong> 里面的一样</p>
</blockquote>
<pre><code class="mysql">SwitchHosts配置信息
# imooc-news 192.168.1.3
127.0.0.1 www.imoocnews.com
127.0.0.1 writer.imoocnews.com
127.0.0.1 admin.imoocnews.com
```
127.0.0.1 article.imoocnews.com
127.0.0.1 user.imoocnews.com
127.0.0.1 files.imoocnews.com
127.0.0.1 html.imoocnews.com

# SpringCloud
127.0.0.1 eureka
127.0.0.1 eureka-cluster-7001
127.0.0.1 eureka-cluster-7002
127.0.0.1 eureka-cluster-7003
</code></pre>
<pre><code class="yaml">springcloud-eureka-cluster  application.yml
############################################################
#
# eureka 集群的注册中心
# web访问端口号  约定：7001~7003
#
############################################################
server:
  port: 7001
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-eureka-cluster

############################################################
#
# eureka 配置信息
#
############################################################
eureka:
  instance:
    # 集群中每个eureka的名字都是唯一的
    hostname: eureka-cluster-7001
  client:
    # 是否要把当前的eureka server注册到自己
    register-with-eureka: false
    # 从注册中心获得检索服务实例，server没有必要，直接false即可
    fetch-registry: false
    # 单实例配置自己的服务地址，高可用集群则配置多个地址
    service-url:
      defaultZone: http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/

####################################################################################
http://localhost:7001/

DS Replicas
eureka-cluster-7003
eureka-cluster-7002
####################################################################################
如果后面服务很多 100个 那是不是也要创建100个module呢？
并不是 因为每个都是一样的只是改一下application.yml的port端口号而已
所以我们要去把它设置为动态的端口
</code></pre>
<h3 id="↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓"><a href="#↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓" class="headerlink" title="↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓"></a><span style = "color:red">↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span></h3><pre><code class="yaml">springcloud-eureka-cluster  application.yml【改后】
############################################################
#
# eureka 集群的注册中心
# web访问端口号  约定：7001~7003
#
############################################################
server:
  port: $&#123;7001&#125;
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-eureka-cluster

############################################################
#
# eureka 配置信息
#
############################################################
eureka:
  instance:
    # 集群中每个eureka的名字都是唯一的
    hostname: eureka-cluster-$&#123;server.port&#125;
    # 自定义端口号
  other-node-port2: $&#123;p2:7002&#125;
  other-node-port3: $&#123;p3:7003&#125;
  client:
    # 是否要把当前的eureka server注册到自己
    register-with-eureka: false
    # 从注册中心获得检索服务实例，server没有必要，直接false即可
    fetch-registry: false
    # 单实例配置自己的服务地址，高可用集群则配置多个地址
    service-url:
      defaultZone: http://eureka-cluster-$&#123;eureka.other-node-port2&#125;:$&#123;eureka.other-node-port2&#125;/eureka/,http://eureka-cluster-$&#123;eureka.other-node-port3&#125;:$&#123;eureka.other-node-port3&#125;/eureka/

####################################################################################
http://eureka-cluster-7001:7001/  #【可运行】
</code></pre>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyl-0110/p/14368753.html">1一站式管理所有SpringBoot启动类，Services服务窗口 - 喵酱张-Eric - 博客园 (cnblogs.com)</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44603382/article/details/121593216">IDEA 2021没有VM options_idea2021怎么找到“vm options”-CSDN博客</a></p>
<blockquote>
<p>复制eureka-cluster-7001服务 变成eureka-cluster-7002 并且在Edit configuration的地方点击Modify options中的Add VM 输入代码：**-DPORT&#x3D;7002 -DP2&#x3D;7001 -DP3&#x3D;7003**<br>同理弄一个eureka-cluster-7003 输入VM代码：**-DPORT&#x3D;7003 -DP2&#x3D;7001 -DP3&#x3D;7002**<br>全部启动后都可以在浏览器正常运行 【集群】<br><a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/">http://eureka-cluster-7001:7001/</a>  DS Replicas：<a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/eureka/">eureka-cluster-7003</a> + <a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/eureka/">eureka-cluster-7002</a><br><a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/">http://eureka-cluster-7002:7002/</a>  DS Replicas：<a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/eureka/">eureka-cluster-7003</a> + <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/eureka/">eureka-cluster-7001</a><br><a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/">http://eureka-cluster-7003:7003/</a>  DS Replicas：<a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/eureka/">eureka-cluster-7002</a> + <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/eureka/">eureka-cluster-7001</a><br>如果把里面的application.yml配置注释掉 就可以把自己注册到eureka中<br>client:<br>  <em>#</em> *是否要把当前的<strong>eureka server</strong>注册到自己<br>    *  register-with-eureka: false<br>  <em>#</em> *从注册中心获得检索服务实例，<strong>server</strong>没有必要，直接<strong>false</strong>即可<br>    *  fetch-registry: false<br>之后再重新启动eureka-cluster-7001~7003</p>
<p><a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/">eureka-cluster-7001:7001</a></p>
<h5 id="DS-Replicas"><a href="#DS-Replicas" class="headerlink" title="DS Replicas"></a>DS Replicas</h5><ul>
<li><a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/eureka/">eureka-cluster-7003</a></li>
<li><a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/eureka/">eureka-cluster-7002</a></li>
</ul>
<h5 id="Instances-currently-registered-with-Eureka"><a href="#Instances-currently-registered-with-Eureka" class="headerlink" title="Instances currently registered with Eureka"></a>Instances currently registered with Eureka</h5><table>
<thead>
<tr>
<th align="left">Application</th>
<th align="left">AMIs</th>
<th align="left">Availability Zones</th>
<th align="left">Status</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>SPRINGCLOUD-EUREKA-CLUSTER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (3)</td>
<td align="left">(3)</td>
<td align="left"><strong>UP</strong> (3) - <a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/actuator/info">localhost:springcloud-eureka-cluster:7003</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/actuator/info">localhost:springcloud-eureka-cluster:7001</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/actuator/info">localhost:springcloud-eureka-cluster:7002</a></td>
</tr>
</tbody></table>
</blockquote>
<h3 id="微服务注册到eureka集群【eureka】-port-8003"><a href="#微服务注册到eureka集群【eureka】-port-8003" class="headerlink" title="微服务注册到eureka集群【eureka】${port:8003}"></a>微服务注册到eureka集群【eureka】<del>${port:8003}</del></h3><pre><code class="yaml">service-user  application.yml
    # 注册中心的服务地址
    service-url:
  # defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/ 三个节点的注册
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
</code></pre>
<pre><code class="yaml">service-article  application.yml
    # 注册中心的服务地址
    service-url:
  # defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口:8001_api</a><br>门户端文章业务的controller → get：&#x2F;portal&#x2F;article&#x2F;detail → articleId：2006117B57WRZGHH</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/">Eureka:7001</a></p>
<h6 id="DS-Replicas-1"><a href="#DS-Replicas-1" class="headerlink" title="DS Replicas"></a>DS Replicas</h6><ul>
<li><a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/eureka/">eureka-cluster-7003</a></li>
<li><a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/eureka/">eureka-cluster-7002</a></li>
</ul>
<h6 id="Instances-currently-registered-with-Eureka-1"><a href="#Instances-currently-registered-with-Eureka-1" class="headerlink" title="Instances currently registered with Eureka"></a>Instances currently registered with Eureka</h6><table>
<thead>
<tr>
<th align="left">Application</th>
<th align="left">AMIs</th>
<th align="left">Availability Zones</th>
<th align="left">Status</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>SERVICE-ARTICLE</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (1)</td>
<td align="left">(1)</td>
<td align="left"><strong>UP</strong> (1) - <a target="_blank" rel="noopener" href="http://localhost:8001/actuator/info">localhost:service-article:8001</a></td>
</tr>
<tr>
<td align="left"><strong>SERVICE-USER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (1)</td>
<td align="left">(1)</td>
<td align="left"><strong>UP</strong> (1) - <a target="_blank" rel="noopener" href="http://localhost:8003/actuator/info">localhost:service-user:8003</a></td>
</tr>
<tr>
<td align="left"><strong>SPRINGCLOUD-EUREKA-CLUSTER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (3)</td>
<td align="left">(3)</td>
<td align="left"><strong>UP</strong> (3) - <a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/actuator/info">localhost:springcloud-eureka-cluster:7003</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/actuator/info">localhost:springcloud-eureka-cluster:7001</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/actuator/info">localhost:springcloud-eureka-cluster:7002</a></td>
</tr>
</tbody></table>
<h3 id="构建微服务集集群【eureka】"><a href="#构建微服务集集群【eureka】" class="headerlink" title="构建微服务集集群【eureka】"></a>构建微服务集集群【eureka】</h3><blockquote>
<p>复制<strong>service-user:8003</strong>服务 变成service-user:8013 并且在Edit configuration的地方点击Modify options中的Add VM 输入代码：**–DPORT&#x3D;8013** </p>
</blockquote>
<pre><code class="yaml">service-user  application-dev.yml
server:
  port: $&#123;port:8003&#125;

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
# open mybatis log in dev
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
# setup CN from java, This is resource
website:
  domain-name: imoocnews.com
</code></pre>
<p><a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/">Eureka:7001</a></p>
<h6 id="DS-Replicas-2"><a href="#DS-Replicas-2" class="headerlink" title="DS Replicas"></a>DS Replicas</h6><ul>
<li><a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/eureka/">eureka-cluster-7003</a></li>
<li><a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/eureka/">eureka-cluster-7002</a></li>
</ul>
<h6 id="Instances-currently-registered-with-Eureka-2"><a href="#Instances-currently-registered-with-Eureka-2" class="headerlink" title="Instances currently registered with Eureka"></a>Instances currently registered with Eureka</h6><table>
<thead>
<tr>
<th align="left">Application</th>
<th align="left">AMIs</th>
<th align="left">Availability Zones</th>
<th align="left">Status</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>SERVICE-ARTICLE</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (1)</td>
<td align="left">(1)</td>
<td align="left"><strong>UP</strong> (1) - <a target="_blank" rel="noopener" href="http://localhost:8001/actuator/info">localhost:service-article:8001</a></td>
</tr>
<tr>
<td align="left"><strong>SERVICE-USER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (2)</td>
<td align="left">(2)</td>
<td align="left"><strong>UP</strong> (2) - <a target="_blank" rel="noopener" href="http://localhost:8003/actuator/info">localhost:service-user:8003</a> , <a target="_blank" rel="noopener" href="http://localhost:8013/actuator/info">localhost:service-user:8013</a></td>
</tr>
<tr>
<td align="left"><strong>SPRINGCLOUD-EUREKA-CLUSTER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (3)</td>
<td align="left">(3)</td>
<td align="left"><strong>UP</strong> (3) - <a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/actuator/info">localhost:springcloud-eureka-cluster:7003</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/actuator/info">localhost:springcloud-eureka-cluster:7001</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/actuator/info">localhost:springcloud-eureka-cluster:7002</a></td>
</tr>
</tbody></table>
<h3 id="实现轮训负载均衡【eureka】"><a href="#实现轮训负载均衡【eureka】" class="headerlink" title="实现轮训负载均衡【eureka】"></a>实现轮训负载均衡【eureka】</h3><pre><code class="yaml">imooc-news-dev-service-user  application-dev.yml
server:
  port: $&#123;port:8003&#125;

spring:
  redis:
    database: 0
    host: 127.0.0.1
    port: 6379
# open mybatis log in dev
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
# setup CN from java, This is resource
website:
  domain-name: imoocnews.com
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
//每次调用的时候 都会输出其Port
 @Value(&quot;$&#123;server.port&#125;&quot;)
    private String myPort;

    @Override
    public GraceJSONResult queryByIds(String userIds) &#123;
        System.out.println(&quot;myPort=&quot; + myPort);
        if (StringUtils.isBlank(userIds))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_NOT_EXIST_ERROR);
        &#125;
        List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
        List&lt;String&gt; userIdList = JsonUtils.jsonToList(userIds, String.class);//传过来两个用户的id
        for (String userId : userIdList)&#123;
            //获得用户基本信息
            AppUserVO userVO = getBasicUserInfo(userId);
            // 3.添加到publisherList
            publisherList.add(userVO);
        &#125;
        return GraceJSONResult.ok(publisherList);
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
    // 注入服务发现，可以获得已经注册的服务相关信息
    @Autowired
    private DiscoveryClient discoveryClient;
    // 发起远程调用，获得用户的基本信息
    private List&lt;AppUserVO&gt; getPublisherList(Set idSet) &#123;
        String serviceId = &quot;SERVICE-USER&quot;;
//        List&lt;ServiceInstance&gt; instanceList = discoveryClient.getInstances(serviceId);
//        ServiceInstance userService = instanceList.get(0);
    // 实行动态化调用 地址拼接
        String userServerUrlExecute
                //因为seviceId里面的SERVICE—USER就存在着userService.getHost()和.getPort()
                = &quot;http://&quot;+ serviceId + &quot;/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
//        String userServerUrlExecute
//                = &quot;http://&quot;+ userService.getHost() + &quot;:&quot; + userService.getPort() + &quot;/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
//        String userServerUrlExecute
//                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        // 为restTemplate增加一个负载均衡 @CloudConfig 
                // public RestTemplate restTemplate()
        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
                = restTemplate.getForEntity(userServerUrlExecute, GraceJSONResult.class);
        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        return publisherList;
    &#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/CloudConfig.java
package com.imooc.api.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.OkHttp3ClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class CloudConfig &#123;

    public CloudConfig() &#123;
    &#125;
    /**
     * 会基于OKHttp3的配置来实例RestTemplate
     * @return
     */
    @Bean
    @LoadBalanced //添加负载均衡
    public RestTemplate restTemplate() &#123;
        return new RestTemplate(new OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口:8001-api</a><br>门户端文章业务的controller → articleId：2006117B57WRZGHH</p>
</blockquote>
<h3 id="自我保护功能【eureka】"><a href="#自我保护功能【eureka】" class="headerlink" title="自我保护功能【eureka】"></a>自我保护功能【eureka】</h3><p><img src="https://raw.githubusercontent.com/P-luminary/images/6475d580b535921c2886327b5964ef9fdcad0663/data/Eureka%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4.png"></p>
<pre><code class="yaml">springcloud-eureka-cluster  application.yml
############################################################
#
# eureka 配置信息
#
############################################################
eureka:
  instance:
    # 集群中每个eureka的名字都是唯一的
    hostname: eureka-cluster-$&#123;server.port&#125;
    # 自定义端口号
  other-node-port2: $&#123;p2:7002&#125;
  other-node-port3: $&#123;p3:7003&#125;
  client:
    # 是否要把当前的eureka server注册到自己
      # register-with-eureka: false
    # 从注册中心获得检索服务实例，server没有必要，直接false即可
      # fetch-registry: false
    # 单实例配置自己的服务地址，高可用集群则配置多个地址
    service-url:
      defaultZone: http://eureka-cluster-$&#123;eureka.other-node-port2&#125;:$&#123;eureka.other-node-port2&#125;/eureka/,http://eureka-cluster-$&#123;eureka.other-node-port3&#125;:$&#123;eureka.other-node-port3&#125;/eureka/
  server:
    enable-self-preservation: false # 关闭eureka的自我保护功能
    eviction-interval-timer-in-ms: 5000 # 清理无效节点的时间，可以缩短为5s 默认60s
</code></pre>
<pre><code class="yaml">springcloud-eureka application.yml
############################################################
#
# eureka 配置信息
#
############################################################
eureka:
  instance:
    # eureka 实例的hostname，可以是hostname，也可以自定义配置hostname
    hostname: eureka
  client:
    # 是否要把当前的eureka server注册到自己
    register-with-eureka: false
    # 从注册中心获得检索服务实例，server没有必要，直接false即可
    fetch-registry: false
    # 单实例配置自己的服务地址，高可用集群则配置多个地址
    service-url:
      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/
  server:
    enable-self-preservation: false # 关闭eureka的自我保护功能
    eviction-interval-timer-in-ms: 5000 # 清理无效节点的时间，可以缩短为5s 默认60s
</code></pre>
<pre><code class="yaml">service-user  application.yml
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
#     defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/ 三个节点的注册
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
</code></pre>
<pre><code class="yaml">service-article  application.yml
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
#     defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
  instance:
    # 调整微服务(eureka client)和注册中心(eureka server)的心跳时间
    lease-renewal-interval-in-seconds: 3
    # eureka 距离最近的一次心跳等待提出的时间 默认90s
    lease-expiration-duration-in-seconds: 5
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/">Eureka:7001</a><br>先把所有服务全启动<br>eureka:7000<br>eureka-cluster-7001<br>eureka-cluster-7002<br>eureka-cluster-7003<br>service-article:8001<br>service-user:8003<br>service-user:8013<br>然后去刷新</p>
<h6 id="Instances-currently-registered-with-Eureka-3"><a href="#Instances-currently-registered-with-Eureka-3" class="headerlink" title="Instances currently registered with Eureka"></a>Instances currently registered with Eureka</h6><table>
<thead>
<tr>
<th align="left">Application</th>
<th align="left">AMIs</th>
<th align="left">Availability Zones</th>
<th align="left">Status</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>SERVICE-ARTICLE</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (1)</td>
<td align="left">(1)</td>
<td align="left"><strong>UP</strong> (1) - <a target="_blank" rel="noopener" href="http://localhost:8001/actuator/info">localhost:service-article:8001</a></td>
</tr>
<tr>
<td align="left"><strong>SERVICE-USER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (2)</td>
<td align="left">(2)</td>
<td align="left"><strong>UP</strong> (2) - <a target="_blank" rel="noopener" href="http://localhost:8003/actuator/info">localhost:service-user:8003</a> , <a target="_blank" rel="noopener" href="http://localhost:8013/actuator/info">localhost:service-user:8013</a></td>
</tr>
<tr>
<td align="left"><strong>SPRINGCLOUD-EUREKA-CLUSTER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (3)</td>
<td align="left">(3)</td>
<td align="left"><strong>UP</strong> (3) - <a target="_blank" rel="noopener" href="http://eureka-cluster-7003:7003/actuator/info">localhost:springcloud-eureka-cluster:7003</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/actuator/info">localhost:springcloud-eureka-cluster:7001</a> , <a target="_blank" rel="noopener" href="http://eureka-cluster-7002:7002/actuator/info">localhost:springcloud-eureka-cluster:7002</a></td>
</tr>
</tbody></table>
<p>随后只留下eureka-cluster-7001其他全部Stop<br>再次刷新</p>
<h6 id="Instances-currently-registered-with-Eureka-4"><a href="#Instances-currently-registered-with-Eureka-4" class="headerlink" title="Instances currently registered with Eureka"></a>Instances currently registered with Eureka</h6><table>
<thead>
<tr>
<th align="left">Application</th>
<th align="left">AMIs</th>
<th align="left">Availability Zones</th>
<th align="left">Status</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>SPRINGCLOUD-EUREKA-CLUSTER</strong></td>
<td align="left"><strong>n&#x2F;a</strong> (1)</td>
<td align="left">(1)</td>
<td align="left"><strong>UP</strong> (1) - <a target="_blank" rel="noopener" href="http://eureka-cluster-7001:7001/actuator/info">localhost:springcloud-eureka-cluster:7001</a></td>
</tr>
</tbody></table>
</blockquote>
<h3 id="负载均衡工具"><a href="#负载均衡工具" class="headerlink" title="负载均衡工具"></a>负载均衡工具</h3><ul>
<li><strong>Ribbon</strong>[本地] &#x3D; <strong>RestTemplate</strong> + <strong>@LoadBalanced</strong></li>
<li><strong>服务间通信的负载均衡工具，提供完善的超时重试机制</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/a0b97158e7b360bc72b677aad99c5cb41b32d995/data/ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png"></p>
<pre><code class="java">service-api  com/imooc/api/config/CloudConfig.java
package com.imooc.api.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.OkHttp3ClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class CloudConfig &#123;

    public CloudConfig() &#123;
    &#125;

    /**
     * 会基于OKHttp3的配置来实例RestTemplate
     * @return
     */
    @Bean
    @LoadBalanced //添加负载均衡 默认的负载均衡算法：枚举
    public RestTemplate restTemplate() &#123;

        return new RestTemplate(new OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;
</code></pre>
<h3 id="实现多种负载均衡算法【ribbon】"><a href="#实现多种负载均衡算法【ribbon】" class="headerlink" title="实现多种负载均衡算法【ribbon】"></a>实现多种负载均衡算法【ribbon】</h3><h6 id="自定义规则"><a href="#自定义规则" class="headerlink" title="自定义规则"></a>自定义规则</h6><p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口api</a></p>
<pre><code class="java">service-api  com/imooc/api/config/CloudConfig.java
package com.imooc.api.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.OkHttp3ClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class CloudConfig &#123;

    public CloudConfig() &#123;
    &#125;

    /**
     * 会基于OKHttp3的配置来实例RestTemplate
     * @return
     */
    @Bean
    @LoadBalanced //添加负载均衡 默认的负载均衡算法：枚举
    public RestTemplate restTemplate() &#123;

        return new RestTemplate(new OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/rule/MyRule.java
package com.rule;

import com.netflix.loadbalancer.IRule;
import com.netflix.loadbalancer.RandomRule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

// 官方定义了规则不要被 @ComponentScan( 扫描到
@Configuration
public class MyRule &#123;
    @Bean
    public IRule iRule()&#123;// 随机的负载均衡策略
        return new RandomRule();
        // 在调用方article的启动类开启注解 @RibbonClient
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/Application.java
package com.imooc.article;

import com.rule.MyRule;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.ribbon.RibbonClient;
import org.springframework.context.annotation.ComponentScan;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

@EnableSwagger2
@SpringBootApplication
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
@RibbonClient(name = &quot;service-user&quot;, configuration = MyRule.class) //微服务名称
public class Application &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<h6 id="运用配置文件进行配置"><a href="#运用配置文件进行配置" class="headerlink" title="运用配置文件进行配置"></a>运用配置文件进行配置</h6><blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口api</a> 发送11次请求 <strong>门户端文章业务</strong>→articleId：2006117B57WRZGHH<br>service-user:8003请求到myPort&#x3D;8003 8次<br>service-user:8013请求到myPort&#x3D;8013 3次</p>
</blockquote>
<pre><code class="yaml">service-article  resources/application.yml
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
#     defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
  instance:
    # 调整微服务(eureka client)和注册中心(eureka server)的心跳时间
    lease-renewal-interval-in-seconds: 3
    # eureka 距离最近的一次心跳等待提出的时间 默认90s
    lease-expiration-duration-in-seconds: 5

# 配置指定自定义的ribbon规则
SERVICE-USER:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
</code></pre>
<pre><code class="java">service-article  com/imooc/article/Application.java
package com.imooc.article;

import com.rule.MyRule;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.ribbon.RibbonClient;
import org.springframework.context.annotation.ComponentScan;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

@EnableSwagger2
@SpringBootApplication
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
//@RibbonClient(name = &quot;service-user&quot;, configuration = MyRule.class) //微服务名称
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<h3 id="重试机制【ribbon】"><a href="#重试机制【ribbon】" class="headerlink" title="重试机制【ribbon】"></a>重试机制【ribbon】</h3><h6 id="节点有可能因为网络问题访问不到-而为了不让其返回错误-需要重试机制"><a href="#节点有可能因为网络问题访问不到-而为了不让其返回错误-需要重试机制" class="headerlink" title="节点有可能因为网络问题访问不到 而为了不让其返回错误 需要重试机制"></a>节点有可能因为网络问题访问不到 而为了不让其返回错误 需要重试机制</h6><pre><code class="xml">sevice-api  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.retry&lt;/groupId&gt;
            &lt;artifactId&gt;spring-retry&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="yaml">service-article  application.yml
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
#     defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
  instance:
    # 调整微服务(eureka client)和注册中心(eureka server)的心跳时间
    lease-renewal-interval-in-seconds: 3
    # eureka 距离最近的一次心跳等待提出的时间 默认90s
    lease-expiration-duration-in-seconds: 5

# 配置指定自定义的ribbon规则
SERVICE-USER:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule


ribbon:
  ConnectTimeout: 5000          # 创建连接的超时时间，单位：ms
  ReadTimeout: 5000             # 在连接创建好以后，调用接口的超时时间，单位：ms
  MaxAutoRetries: 1             # 最大重试次数
  MaxAutoRetriesNextServer: 2   # 切换到下个微服务实例的重试次数
  # 当请求到某个微服务5s，超时后会进行重试，先重试连接自己当前的这个实例
  # 如果当前重试失败1次，则会切换到访问集群中的下一个微服务实例，切换最大为2次

logging:
  level:
#    com.imooc.api.controller.user.UserControllerApi: debug
    root: debug
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口-8001api</a>     articleId：2006117B57WRZGHH<br>先把所有服务全部启动 然后把service-user:8013 的服务Stop<br>再去api接口发送请求 查看servcice-article:8001的Console输出日志<br>14:10.288 [http-nio-8001-exec-1] DEBUG o.s.retry.support.RetryTemplate - Retry: count&#x3D;0<br>14:10.774 [http-nio-8001-exec-1] DEBUG o.s.web.client.RestTemplate - Response 200 OK<br>14:10.288 [http-nio-8001-exec-1] DEBUG o.s.retry.support.RetryTemplate - Retry: count&#x3D;1<br>14:10.288 [http-nio-8001-exec-1] DEBUG o.s.retry.support.RetryTemplate - Retry: count&#x3D;2<br>14:10.774 [http-nio-8001-exec-1] DEBUG o.s.web.client.RestTemplate - Response 200 OK</p>
</blockquote>
<h3 id="简化服务调用【feign】以Api作为接口-面向接口的编程风格"><a href="#简化服务调用【feign】以Api作为接口-面向接口的编程风格" class="headerlink" title="简化服务调用【feign】以Api作为接口,面向接口的编程风格"></a>简化服务调用【feign】<del>以Api作为接口,面向接口的编程风格</del></h3><h5 id="声明式HTTP工具"><a href="#声明式HTTP工具" class="headerlink" title="声明式HTTP工具"></a>声明式HTTP工具</h5><ul>
<li><strong>Feign</strong></li>
<li><strong>声明式的http工具，用于简化服务调用</strong></li>
</ul>
<pre><code class="xml">service-api  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/ArticlePortalController.java
    // 注入服务发现，可以获得已经注册的服务相关信息
    @Autowired
    private DiscoveryClient discoveryClient;

    @Autowired
    private UserControllerApi userControllerApi;
    //面向接口 UserControllerApi
    // 发起远程调用，获得用户的基本信息
    private List&lt;AppUserVO&gt; getPublisherList(Set idSet) &#123;
//        String serviceId = &quot;SERVICE-USER&quot;;
//        List&lt;ServiceInstance&gt; instanceList = discoveryClient.getInstances(serviceId);
//        ServiceInstance userService = instanceList.get(0);
    // 实行动态化调用 地址拼接
//        String userServerUrlExecute
                //因为seviceId里面的SERVICE—USER就存在着userService.getHost()和.getPort()
//                = &quot;http://&quot;+ serviceId + &quot;/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        GraceJSONResult bodyResult = userControllerApi.queryByIds(JsonUtils.objectToJson(idSet));
//        String userServerUrlExecute
//                = &quot;http://&quot;+ userService.getHost() + &quot;:&quot; + userService.getPort() + &quot;/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
//        String userServerUrlExecute
//                = &quot;http://user.imoocnews.com:8003/user/queryByIds?userIds=&quot; + JsonUtils.objectToJson(idSet);
        // 为restTemplate增加一个负载均衡@CloudConfig public RestTemplate restTemplate()
//        ResponseEntity&lt;GraceJSONResult&gt; responseEntity
//                = restTemplate.getForEntity(userServerUrlExecute, GraceJSONResult.class);
//        GraceJSONResult bodyResult = responseEntity.getBody();
        List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;
        return publisherList;
    &#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/Application.java //【EnableFeignClients】
package com.imooc.article;

import com.rule.MyRule;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.ribbon.RibbonClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

@EnableSwagger2
@SpringBootApplication
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
//@RibbonClient(name = &quot;service-user&quot;, configuration = MyRule.class) //微服务名称
@EnableFeignClients(&#123;&quot;com.imooc&quot;&#125;)
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/config/MyServiceList.java
package com.imooc.api.config;

public class MyServiceList &#123;
    public static final String SERVICE_USER = &quot;service-user&quot;;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/api/controller/user/UserControllerApi.java【@FeignClient】
package com.imooc.api.controller.user;

import com.imooc.api.config.MyServiceList;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

@Api(value = &quot;用户信息相关Controller&quot;,tags = &#123;&quot;用户信息相关Controller&quot;&#125;)
@RequestMapping(&quot;user&quot;)
@FeignClient(value = MyServiceList.SERVICE_USER) //作为客户端直接调用
public interface UserControllerApi &#123;

    @ApiOperation(value = &quot;获得用户基本信息&quot;,notes = &quot;获得用户基本信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getUserInfo&quot;)
    public GraceJSONResult getUserInfo(@RequestParam String userId);
    @ApiOperation(value = &quot;获得用户账户信息&quot;,notes = &quot;获得用户账户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAccountInfo&quot;)
    public GraceJSONResult getAccountInfo(@RequestParam String userId);

    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/updateUserInfo&quot;)
    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO,
                                          @RequestParam BindingResult result); //RequestParam  BindingResult result 加了肯定在前端不可用 对Feign而言不能存在两个对象不然会认为有两个model

    @ApiOperation(value = &quot;根据用户的ids查询用户列表&quot;,notes = &quot;根据用户的ids查询用户列表&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/queryByIds&quot;)
    public GraceJSONResult queryByIds(@RequestParam String userIds);
&#125;
</code></pre>
<h3 id="统一检验处理【feign】"><a href="#统一检验处理【feign】" class="headerlink" title="统一检验处理【feign】"></a>统一检验处理【feign】</h3><blockquote>
<p>把所有的BindingResult都可以采用全局调用的方法去调用<br><a target="_blank" rel="noopener" href="http://localhost:8003/doc.html">慕课新闻·自媒体接口8003api</a> → 用户信息相关 → 修改&#x2F;完善用户信息  Post &#x2F;user&#x2F;updateUserInfo</p>
</blockquote>
<pre><code class="java">dev-common  com/imooc/exception/GraceExceptionHandler.java
package com.imooc.exception;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MaxUploadSizeExceededException;

import javax.naming.Binding;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * 统一异常拦截处理
 * 可以针对异常的类型进行捕获 然后返回json信息到前端
 */
@ControllerAdvice
public class GraceExceptionHandler &#123;
 /* @ExceptionHandler(MyCustomException.class)
    //只要是这个类的异常都会进入下面的方法
    @ResponseBody
    public GraceJSONResult returnMyException(MyCustomException e)&#123;
        e.printStackTrace(); //打印信息
        return GraceJSONResult.exception(e.getResponseStatusEnum());
    &#125;

    @ExceptionHandler(MaxUploadSizeExceededException.class)
    @ResponseBody
    public GraceJSONResult returnMaxUploadSizeExceededException(MaxUploadSizeExceededException e) &#123;
        return GraceJSONResult.errorCustom(ResponseStatusEnum.FILE_MAX_SIZE_ERROR);
    &#125;*/

    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseBody //该异常是基于所有的vo验证
    public GraceJSONResult returnException(MethodArgumentNotValidException e) &#123;
        BindingResult result = e.getBindingResult();
        Map&lt;String, String&gt; map = getErrors(result);
        return GraceJSONResult.errorMap(map);
    &#125;

    public Map&lt;String, String&gt; getErrors(BindingResult result) &#123;
        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
        List&lt;FieldError&gt; errorList = result.getFieldErrors();
        for (FieldError error : errorList) &#123;
            // 发送验证错误的时候所对应的某个属性
            String field = error.getField();
            // 验证的错误消息
            String msg = error.getDefaultMessage();
            map.put(field, msg);
        &#125;
        return map;
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/user/UserControllerApi.java
//    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
//    @PostMapping(&quot;/updateUserInfo&quot;)
//    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO,
//                                          @RequestParam BindingResult result);
    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/updateUserInfo&quot;)
    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO);
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
    @Override
  public GraceJSONResult updateUserInfo(@Valid UpdateUserInfoBO updateUserInfoBO)&#123;
    //, BindingResult result) &#123;
//        // 0.校验BO
//        if (result.hasErrors())&#123;
//            Map&lt;String, String&gt; map = getErrors(result);
//            return GraceJSONResult.errorMap(map);
//        &#125;
        // 1.执行更新操作
        userService.updateUserInfo(updateUserInfoBO);
        return GraceJSONResult.ok();
        //调用UserService把独有信息传入
    &#125;
</code></pre>
<h3 id="开启日志调式【feign】基于http的调用"><a href="#开启日志调式【feign】基于http的调用" class="headerlink" title="开启日志调式【feign】基于http的调用"></a>开启日志调式【feign】<del>基于http的调用</del></h3><pre><code class="yaml">service-article  application.yml
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  # 自定义eureka server的信息
  server:
    hostname: eureka
    port: 7000
  client:
    # 所有的微服务都必须注册到eureka中
    register-with-eureka: true
    # 从注册中心获得检索服务实例
    fetch-registry: true

    # 注册中心的服务地址
    service-url:
#     defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
  instance:
    # 调整微服务(eureka client)和注册中心(eureka server)的心跳时间
    lease-renewal-interval-in-seconds: 3
    # eureka 距离最近的一次心跳等待提出的时间 默认90s
    lease-expiration-duration-in-seconds: 5

# 配置指定自定义的ribbon规则
SERVICE-USER:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule


ribbon:
  ConnectTimeout: 5000          # 创建连接的超时时间，单位：ms
  ReadTimeout: 5000             # 在连接创建好以后，调用接口的超时时间，单位：ms
  MaxAutoRetries: 1             # 最大重试次数
  MaxAutoRetriesNextServer: 2   # 切换到下个微服务实例的重试次数
  # 当请求到某个微服务5s，超时后会进行重试，先重试连接自己当前的这个实例
  # 如果当前重试失败1次，则会切换到访问集群中的下一个微服务实例，切换最大为2次

logging:
  level:
    com.imooc.api.controller.user.UserControllerApi: debug
#    root: debug 日志打印级别

# 配置feign
feign:
  client:
    config:
      # 配置服务提供方的名称
      service-user:
        logger-level: full
</code></pre>
<blockquote>
<p>重启所有服务 调用<a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口8001api</a>门户端→文章详情 articleId：2006117B57WRZGHH<br>09:19.009 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] &lt;— HTTP&#x2F;1.1 200 (590ms)<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] connection: keep-alive<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] content-type: application&#x2F;json<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] date: Mon, 05 Aug 2024 09:09:19 GMT<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] keep-alive: timeout&#x3D;60<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] transfer-encoding: chunked<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] vary: Access-Control-Request-Headers<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] vary: Access-Control-Request-Method<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] vary: Origin<br>09:19.011 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds]<br>09:19.013 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] {“status”:200,”msg”:”操作成功！”,”success”:true,”data”:[{“id”:”200628AFYM7AGWPH”,”nickname”:”我是慕课网”,”face”:”<a target="_blank" rel="noopener" href="https://imooc-news-dev.oss-cn-shanghai.aliyuncs.com/images/abc/200628AFYM7AGWPH/2007088XH2WT7GXP.png&quot;,&quot;activeStatus&quot;:1,&quot;myFollowCounts&quot;:null,&quot;myFansCounts&quot;:null%7D]%7D">https://imooc-news-dev.oss-cn-shanghai.aliyuncs.com/images/abc/200628AFYM7AGWPH/2007088XH2WT7GXP.png&quot;,&quot;activeStatus&quot;:1,&quot;myFollowCounts&quot;:null,&quot;myFansCounts&quot;:null}]}</a><br>09:19.013 [http-nio-8001-exec-7] DEBUG c.i.a.c.user.UserControllerApi - [UserControllerApi#queryByIds] &lt;— END HTTP (286-byte body)<br>09:19.518 [PollingServerListUpdater-0] INFO  c.n.config.ChainedDynamicProperty - Flipping property: service-user.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit &#x3D; 2147483647<br>09:21.013 [scheduling-1] INFO  c.imooc.api.aspect.ServiceLogAspect - 开始执行 class com.imooc.article.service.impl.ArticleServiceImpl.updateAppointToPublish </p>
</blockquote>
<h3 id="阐述断路器及概念【hystrix】"><a href="#阐述断路器及概念【hystrix】" class="headerlink" title="阐述断路器及概念【hystrix】"></a>阐述断路器及概念【hystrix】</h3><h6 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h6><ul>
<li><strong>Hystrix</strong></li>
<li><strong>提供容错机制，避免微服务系统雪崩</strong></li>
</ul>
<h6 id="服务熔断与降级"><a href="#服务熔断与降级" class="headerlink" title="服务熔断与降级"></a>服务熔断与降级</h6><p><img src="https://raw.githubusercontent.com/P-luminary/images/397bfbaea5edddda83d11dce86c9e70cbac33f5c/data/hystrix%E6%96%AD%E8%B7%AF%E5%99%A8_%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%8D%E7%BA%A7.png"></p>
<h3 id="模拟服务故障【hystrix】"><a href="#模拟服务故障【hystrix】" class="headerlink" title="模拟服务故障【hystrix】"></a>模拟服务故障【hystrix】</h3><blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8001/doc.html">慕课新闻·自媒体接口8001api</a>  同上<br>会报Timeout超时的异常</p>
</blockquote>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
   @Value(&quot;$&#123;server.port&#125;&quot;)
    private String myPort;

    @Override
    public GraceJSONResult queryByIds(String userIds) &#123;
        // 1.手动触发异常
        int a = 1/0;
        // 2.模拟超时异常
        try &#123;
            Thread.sleep(6000);
        &#125; catch (InterruptedException e) &#123;
            throw new RuntimeException(e);
        &#125;


        System.out.println(&quot;myPort=&quot; + myPort);
        if (StringUtils.isBlank(userIds))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_NOT_EXIST_ERROR);
        &#125;
        List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
        List&lt;String&gt; userIdList = JsonUtils.jsonToList(userIds, String.class);//传过来两个用户的id
        for (String userId : userIdList)&#123;
            //获得用户基本信息
            AppUserVO userVO = getBasicUserInfo(userId);
            // 3.添加到publisherList
            publisherList.add(userVO);
        &#125;
        return GraceJSONResult.ok(publisherList);
    &#125;
</code></pre>
<pre><code class="xml">service-api  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<h3 id="服务提供者熔断【hystrix】"><a href="#服务提供者熔断【hystrix】" class="headerlink" title="服务提供者熔断【hystrix】"></a>服务提供者熔断【hystrix】</h3><pre><code class="java">service-user  com/imooc/user/controller/UserController.java
@Value(&quot;$&#123;server.port&#125;&quot;)
    private String myPort;
    // 添加熔断机制 一旦熔断会有替补方法[降级的方法]
    @HystrixCommand(fallbackMethod = &quot;queryByIdsFallback&quot;)
    @Override
    public GraceJSONResult queryByIds(String userIds) &#123;
        // 1.手动触发异常
        int a = 1/0;
        // 2.模拟超时异常
        try &#123;
            Thread.sleep(6000);
        &#125; catch (InterruptedException e) &#123;
            throw new RuntimeException(e);
        &#125;
        System.out.println(&quot;myPort=&quot; + myPort);
        if (StringUtils.isBlank(userIds))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_NOT_EXIST_ERROR);
        &#125;
        List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
        List&lt;String&gt; userIdList = JsonUtils.jsonToList(userIds, String.class);//传过来两个用户的id
        for (String userId : userIdList)&#123;
            //获得用户基本信息
            AppUserVO userVO = getBasicUserInfo(userId);
            // 3.添加到publisherList
            publisherList.add(userVO);
        &#125;
        return GraceJSONResult.ok(publisherList);
    &#125;


    public GraceJSONResult queryByIdsFallback(String userIds) &#123;
        System.out.println(&quot;进入降级方法：queryByIdsFallback&quot;);

        List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
        List&lt;String&gt; userIdList = JsonUtils.jsonToList(userIds, String.class);//传过来两个用户的id
        for (String userId : userIdList)&#123;
            // 手动构建空对象，详情页所展示的用户信息可有可无 返回空对象
            AppUserVO userVO = new AppUserVO();
            publisherList.add(userVO);
        &#125;
        return GraceJSONResult.ok(publisherList);
    &#125;
</code></pre>
<pre><code class="java">service-user  com/imooc/user/Application.java
package com.imooc.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.context.annotation.ComponentScan;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication(exclude = MongoAutoConfiguration.class)
@MapperScan(basePackages = &quot;com.imooc.user.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient   // 开启eureka client 注册到server中
@EnableCircuitBreaker // 开启hystrix的熔断机制
public class Application &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
===============================================================
进入降级方法
</code></pre>
<pre><code class="yaml">service-user  application.yml
#  配置hystrix
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 2000   # 设置hystrix超时时间，超过2秒触发降级
</code></pre>
<h3 id="全局降级【hystrix】"><a href="#全局降级【hystrix】" class="headerlink" title="全局降级【hystrix】"></a>全局降级【hystrix】</h3><blockquote>
<p>只需要return一个错误就行了没必要100个方法写100个降级<br>{</p>
<p>​    status: 555,<br>​    msg: “”全局降级：系统繁忙，请稍后再试！””<br>​    success: false,<br>​    data: null</p>
<p>}</p>
</blockquote>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java
@RestController
@DefaultProperties(defaultFallback = &quot;defaultFallback&quot;)
public class UserController extends BaseController implements UserControllerApi &#123;
    final static Logger logger = LoggerFactory.getLogger(UserController.class);

    @Autowired
    private UserService userService;

    // 其他方法一旦发现异常就会进入这个方法里面 全局唯一 其他的降级方法要注释
    public GraceJSONResult defaultFallback()&#123;
        return GraceJSONResult.errorCustom(ResponseStatusEnum.SYSTEM_ERROR_GLOBAL);
    &#125;
......
&#125;
</code></pre>
<pre><code class="java">// 改动是为了不报错空指针异常 因为已经变成了全局降级  降级的错误信息要调整
    @Autowired
    private UserControllerApi userControllerApi;
    //面向接口 UserControllerApi
    // 发起远程调用，获得用户的基本信息
   /* private List&lt;AppUserVO&gt; getPublisherList(Set idSet) &#123;
GraceJSONResult bodyResult = userControllerApi.queryByIds(JsonUtils.objectToJson(idSet)); 
List&lt;AppUserVO&gt; publisherList = null;
        if (bodyResult.getStatus() == 200) &#123;
            String userJson = JsonUtils.objectToJson(bodyResult.getData());
            publisherList = JsonUtils.jsonToList(userJson, AppUserVO.class);
        &#125;*/ else &#123;
            publisherList = new ArrayList&lt;&gt;();
        &#125;
        return publisherList;
    &#125;
</code></pre>
<pre><code class="java">dev-common  com/imooc/grace/result/ResponseStatusEnum.java
 // 系统错误，未预期的错误 555
    SYSTEM_ERROR(555, false, &quot;系统繁忙，请稍后再试！&quot;),
    SYSTEM_OPERATION_ERROR(556, false, &quot;操作失败，请重试或联系管理员&quot;),
    SYSTEM_RESPONSE_NO_INFO(557, false, &quot;&quot;),
    SYSTEM_ERROR_GLOBAL(558, false, &quot;全局降级：系统繁忙，请稍后再试！&quot;),
    SYSTEM_ERROR_FEIGN(559, false, &quot;客户端Feign降级：系统繁忙，请稍后再试！&quot;),
    SYSTEM_ERROR_ZUUL(560, false, &quot;请求系统过于繁忙，请稍后再试！&quot;);
</code></pre>
<h3 id="服务调用者降级【hystrix】"><a href="#服务调用者降级【hystrix】" class="headerlink" title="服务调用者降级【hystrix】"></a>服务调用者降级【hystrix】</h3><pre><code class="yaml">service-article  application.yml
# 配置feign
feign:
  client:
    config:
      # 配置服务提供方的名称
      service-user:
        logger-level: full

  hystrix:  #打开feign客户端的内置hystrix
    enabled: true
</code></pre>
<pre><code class="java">service-article  com/imooc/article/Application.java //【增加一个@EnableHystrix】
package com.imooc.article;

import com.rule.MyRule;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.hystrix.EnableHystrix;
import org.springframework.cloud.netflix.ribbon.RibbonClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

@EnableSwagger2
@SpringBootApplication
@MapperScan(basePackages = &quot;com.imooc.article.mapper&quot;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;,&quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
//@RibbonClient(name = &quot;service-user&quot;, configuration = MyRule.class) //微服务名称
@EnableFeignClients(&#123;&quot;com.imooc&quot;&#125;)
@EnableHystrix
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
====================================================================================
service-article:8001  进入客户端(服务调用者)的降级方法
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/user/UserControllerApi.java//【@FeignClient增加fallbackFactory】
package com.imooc.api.controller.user;

import com.imooc.api.config.MyServiceList;
import com.imooc.api.controller.user.fallbacks.UserControllerFactoryFallback;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.pojo.bo.RegistLoginBO;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

@Api(value = &quot;用户信息相关Controller&quot;,tags = &#123;&quot;用户信息相关Controller&quot;&#125;)
@RequestMapping(&quot;user&quot;) //fallbackFactory所有方法的降级
@FeignClient(value = MyServiceList.SERVICE_USER, fallbackFactory = UserControllerFactoryFallback.class ) //作为客户端直接调用
public interface UserControllerApi &#123;

    @ApiOperation(value = &quot;获得用户基本信息&quot;,notes = &quot;获得用户基本信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getUserInfo&quot;)
    public GraceJSONResult getUserInfo(@RequestParam String userId);
    @ApiOperation(value = &quot;获得用户账户信息&quot;,notes = &quot;获得用户账户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/getAccountInfo&quot;)
    public GraceJSONResult getAccountInfo(@RequestParam String userId);

//    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
//    @PostMapping(&quot;/updateUserInfo&quot;)
//    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO,
//                                          @RequestParam BindingResult result);
    @ApiOperation(value = &quot;修改/完善用户信息&quot;,notes = &quot;修改/完善用户信息&quot;,httpMethod = &quot;POST&quot;)
    @PostMapping(&quot;/updateUserInfo&quot;)
    public GraceJSONResult updateUserInfo(@RequestBody @Valid UpdateUserInfoBO updateUserInfoBO);


    @ApiOperation(value = &quot;根据用户的ids查询用户列表&quot;,notes = &quot;根据用户的ids查询用户列表&quot;,httpMethod = &quot;GET&quot;)
    @GetMapping(&quot;/queryByIds&quot;)
    public GraceJSONResult queryByIds(@RequestParam String userIds);
&#125;
</code></pre>
<pre><code class="java">service-api  com/imooc/api/controller/user/fallbacks/UserControllerFactoryFallback.java
package com.imooc.api.controller.user.fallbacks;

import com.imooc.api.controller.user.UserControllerApi;
import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.pojo.bo.UpdateUserInfoBO;
import com.imooc.pojo.vo.AppUserVO;
import feign.hystrix.FallbackFactory;
import org.springframework.stereotype.Component;

import javax.validation.Valid;
import java.util.ArrayList;
import java.util.List;

@Component //这个类让容器加载
public class UserControllerFactoryFallback implements FallbackFactory&lt;UserControllerApi&gt; &#123;
    @Override
    public UserControllerApi create(Throwable throwable) &#123;
 // 重写的过程就是降级的过程
        return new UserControllerApi() &#123;
            //SYSTEM_ERROR_FEIGN(559, false, &quot;客户端Feign降级：系统繁忙，请稍后再试！&quot;)
            @Override
            public GraceJSONResult getUserInfo(String userId) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.SYSTEM_ERROR_FEIGN);
            &#125;

            @Override
            public GraceJSONResult getAccountInfo(String userId) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.SYSTEM_ERROR_FEIGN);
            &#125;

            @Override
            public GraceJSONResult updateUserInfo(@Valid UpdateUserInfoBO updateUserInfoBO) &#123;
                return GraceJSONResult.errorCustom(ResponseStatusEnum.SYSTEM_ERROR_FEIGN);
            &#125;

            @Override
            public GraceJSONResult queryByIds(String userIds) &#123;
                System.out.println(&quot;进入客户端(服务调用者)的降级方法&quot;);
                List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
                return GraceJSONResult.ok(publisherList);
            &#125;
        &#125;;
    &#125;
&#125;
</code></pre>
<h3 id="自动触发熔断隔离与恢复【hystrix】"><a href="#自动触发熔断隔离与恢复【hystrix】" class="headerlink" title="自动触发熔断隔离与恢复【hystrix】"></a>自动触发熔断隔离与恢复【hystrix】</h3><p><img src="https://raw.githubusercontent.com/P-luminary/images/c67b7337984e7ad3913d8d161ec90de36aba38a8/data/%E7%86%94%E6%96%AD%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png"></p>
<pre><code class="yaml">service-user  application.yml #【配置熔断器】
#  配置hystrix
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 2000   # 设置hystrix超时时间，超过2秒触发降级
      circuitBreaker:   # 配置断路器
        enabled: true
        requestVolumeThreshold: 10    # 触发熔断最小请求次数，默认：20
        sleepWindowInMilliseconds: 15000    # 熔断后过几秒后尝试半开状态（请求重试），默认：5s
        errorThresholdPercentage: 50  # 触发熔断的失败率（异常率/阈值），默认：50
</code></pre>
<pre><code class="java">service-user  com/imooc/user/controller/UserController.java //[FIXME:]
    @Value(&quot;$&#123;server.port&#125;&quot;)
    private String myPort;
    // 添加熔断机制 一旦熔断会有替补方法[降级的方法]
    @HystrixCommand//(fallbackMethod = &quot;queryByIdsFallback&quot;)
    @Override
    public GraceJSONResult queryByIds(String userIds) &#123;
        // 1.手动触发异常
        int a = 1/0;
        // 2.模拟超时异常
        try &#123;
            Thread.sleep(6000);
        &#125; catch (InterruptedException e) &#123;
            throw new RuntimeException(e);
        &#125;


        System.out.println(&quot;myPort=&quot; + myPort);
        if (StringUtils.isBlank(userIds))&#123;
            return GraceJSONResult.errorCustom(ResponseStatusEnum.USER_NOT_EXIST_ERROR);
        &#125;
        List&lt;AppUserVO&gt; publisherList = new ArrayList&lt;&gt;();
        List&lt;String&gt; userIdList = JsonUtils.jsonToList(userIds, String.class);//传过来两个用户的id
        // FIXME: 仅用于dev测试，硬编码动态判断来抛出异常
        if (userIdList.size() &gt; 1)&#123;
            System.out.println(&quot;出现异常~~&quot;);
            throw new RuntimeException(&quot;出现异常~~&quot;);
        &#125;

        for (String userId : userIdList)&#123;
            //获得用户基本信息
            AppUserVO userVO = getBasicUserInfo(userId);
            // 3.添加到publisherList
            publisherList.add(userVO);
        &#125;
        return GraceJSONResult.ok(publisherList);
    &#125;
</code></pre>
<h3 id="微服务网关【zuul】维护微服务的ip地址"><a href="#微服务网关【zuul】维护微服务的ip地址" class="headerlink" title="微服务网关【zuul】维护微服务的ip地址"></a>微服务网关【zuul】<del>维护微服务的ip地址</del></h3><p><img src="https://raw.githubusercontent.com/P-luminary/images/56aa521f01816d47174142d710bde78e0f31fd7e/data/%E5%BE%AE1%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3.png"></p>
<h5 id="服务网关"><a href="#服务网关" class="headerlink" title="服务网关"></a>服务网关</h5><ul>
<li>Zuul (祖尔)</li>
<li>微服务的网关，可以实现动态路由、过滤器等功能</li>
</ul>
<h3 id="构建网关微服务【zuul】"><a href="#构建网关微服务【zuul】" class="headerlink" title="构建网关微服务【zuul】"></a>构建网关微服务【zuul】</h3><pre><code class="java">springcloud-zuul-server  com/imooc/zuul/Application.java
@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,
                                    MongoAutoConfiguration.class&#125;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;, &quot;org.n3r.idworker&quot;&#125;)
//@EnableZuulServer
@EnableZuulProxy      // @EnableZuulProxy是@EnableZuulServer的一个增强升级版，当zuul和eureka、ribbon等组件共同使用，则使用增强版即可
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;

&#125;
</code></pre>
<pre><code class="xml">springcloud-zuul-server  logback-spring.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;configuration&gt;
    &lt;!-- 指定日志文件的存储地址，使用绝对路径 --&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;/workspaces/logs/imooc-news-dev/springcloud-zuul&quot;/&gt;

    &lt;!-- Console 输出设置 --&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;
            &lt;pattern&gt;%white(%d&#123;mm:ss.SSS&#125;) %green([%thread]) %cyan(%-5level) %yellow(%logger&#123;36&#125;) %magenta(-) %black(%msg%n)&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 按照每天生成日志文件 --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- 日志文件输出的文件名 --&gt;
            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/zuul.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/logger&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<pre><code class="xml">service-api  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="xml">springcloud-zuul-server  pom.xml 【exclusions是重点】
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;springcloud-zuul-server&lt;/artifactId&gt;

    &lt;dependencies&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;!--排除包--&gt;
                &lt;exclusions&gt;
                    &lt;exclusion&gt;
                    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
                    &lt;/exclusion&gt;
                &lt;/exclusions&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--&lt;dependency&gt;--&gt;
        &lt;!--&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;--&gt;
        &lt;!--&lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;--&gt;
        &lt;!--&lt;/dependency&gt;--&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<pre><code class="yml">springcloud-zuul-server  application.yml 
############################################################
#
# 网关zuul
# web访问端口号  约定：7070
#
############################################################
server:
  port: 7070
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-zuul-server

  redis:
    database: 0
    host: 192.168.1.201
    port: 6379
    password: 123456
  zipkin:
    # 配置zipkin采集的服务地址，数据会发送到这里
    base-url: http://192.168.1.2:9411/
    sender:
      # 数据采集的传输通信方式，web http的形式
      type: web
  sleuth:
    sampler:
      # 数据采样比例（百分数），0~1
      probability: 1
</code></pre>
<pre><code class="java">zuul-server  com/imooc/zuul/controller/HelloController.java
package com.imooc.zuul.controller;

import com.imooc.grace.result.GraceJSONResult;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController &#123;

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping(&quot;/hello&quot;)
    public Object hello() &#123;
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<h3 id="配置路由【zuul】"><a href="#配置路由【zuul】" class="headerlink" title="配置路由【zuul】"></a>配置路由【zuul】</h3><pre><code class="yaml">zuul-server  application.yml
# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/** # 请求路径(前缀)
      path: /service-article/**       # 请求路径(前缀)
      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
</code></pre>
<pre><code class="yaml">localhost:8001/portal/article/detail?articleId=2006117B57WRZGHH
直接可以访问到详情数据
微服务网关→ 7070
// service-article: /service-article/** # 请求路径(前缀**)
# localhost:7070/service-article/portal/detail?articleId=2006117B57WRZGHH

# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/** # 请求路径(前缀)
      path: /service-article/**       # 请求路径(前缀)
      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀
# localhost:7070/api/service-article/portal/detail?articleId=2006117B57WRZGHH
</code></pre>
<h3 id="配置微服务实例的路由【zuul】"><a href="#配置微服务实例的路由【zuul】" class="headerlink" title="配置微服务实例的路由【zuul】"></a>配置微服务实例的路由【zuul】</h3><pre><code class="yaml">在路由规则里面的  url: http://192.168.1.2:8001  很容易发生变化
所以直接去请求eureka的SERVICE-USER/ARTICLE
</code></pre>
<pre><code class="xml">springcloud-zuul-server  pom.xml 【取消exclusions注释 包含eureka client】
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;!--排除包--&gt;
          &lt;/dependency&gt;
</code></pre>
<pre><code class="yaml">zuul-server  application.yml
############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  server:
    hostname: eureka
    port: 7000
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
</code></pre>
<pre><code class="java">springcloud-zuul-server  com/imooc/zuul/Application.java 【打开@EnableEurekaClient】
@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,
                                    MongoAutoConfiguration.class&#125;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;, &quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
//@EnableZuulServer
@EnableZuulProxy      // @EnableZuulProxy是@EnableZuulServer的一个增强升级版，当zuul和eureka、ribbon等组件共同使用，则使用增强版即可
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<pre><code class="yaml">zuul-server  application.yml 【实现service-id进行请求转发 ip发生变化没有关系】
# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
      service-article:                  # 配置微服务的路由id，微服务的实例id
      path: /service-article/**       # 请求路径(前缀)
      service-id: service-article     # 请求转发的微服务实例id
#     url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀

↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ 简化版本 ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓

# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/** # 请求路径(前缀)
  #    service-article:                  # 配置微服务的路由id，微服务的实例id
#      path: /service-article/**       # 请求路径(前缀)
#      service-id: service-article     # 请求转发的微服务实例id
#      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀
</code></pre>
<h3 id="过滤器【zuul】网端ip黑名单拦截"><a href="#过滤器【zuul】网端ip黑名单拦截" class="headerlink" title="过滤器【zuul】网端ip黑名单拦截"></a>过滤器【zuul】<del>网端ip黑名单拦截</del></h3><p><img src="https://raw.githubusercontent.com/P-luminary/images/3cb9704aa86555cd937cb6b045ace81a44ec3dbd/data/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84.png"></p>
<pre><code class="java">zuul-server  com/imooc/zuul/filters/MyFilter.java
package com.imooc.zuul.filters;

import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.exception.ZuulException;
import org.springframework.stereotype.Component;

/**
 * 构建zuul的自定义过滤器
 */
@Component
public class MyFilter extends ZuulFilter &#123;

    /**
     * 定义过滤器的类型
     *      pre：    在请求被路由之前执行
     *      route：  在路由请求的时候执行
     *      post：   请求路由以后执行
     *      error：  处理请求时发生错误的时候执行
     * @return
     */
    @Override
    public String filterType() &#123;
        return &quot;pre&quot;;
    &#125;

    /**
     * 过滤器执行的顺序，配置多个有顺序的过滤
     * 执行顺序从小到大
     * @return
     */
    @Override
    public int filterOrder() &#123;
        return 1;
    &#125;

    /**
     * 是否开启过滤器
     *      true：开启
     *      false：禁用
     * @return
     */
    @Override
    public boolean shouldFilter() &#123;
        return true;
    &#125;

    /**
     * 过滤器的业务实现
     * @return
     * @throws ZuulException
     */
    @Override
    public Object run() throws ZuulException &#123;

        System.out.println(&quot;display pre zuul filter...&quot;);

        return null;    // 没有意义可以不用管。
    &#125;
&#125;
</code></pre>
<blockquote>
<p> localhost:7070&#x2F;api&#x2F;service-article&#x2F;portal&#x2F;detail?articleId&#x3D;2006117B57WRZGHH<br>刷新成功后 在zuul-7070服务console会有一行<br>display pre zuul filter… [启动成功]</p>
</blockquote>
<h3 id="限制ip黑名单的频繁请求【zuul】"><a href="#限制ip黑名单的频繁请求【zuul】" class="headerlink" title="限制ip黑名单的频繁请求【zuul】"></a>限制ip黑名单的频繁请求【zuul】</h3><pre><code class="yaml">zuul-server  application.yml 【增加ip请求限制的参数配置】
# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
      service-article:                  # 配置微服务的路由id，微服务的实例id
      path: /service-article/**       # 请求路径(前缀)
      service-id: service-article     # 请求转发的微服务实例id
#     url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀

↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ 简化版本 ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓

# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/** # 请求路径(前缀)
  #    service-article:                  # 配置微服务的路由id，微服务的实例id
#      path: /service-article/**       # 请求路径(前缀)
#      service-id: service-article     # 请求转发的微服务实例id
#      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀

# ip请求限制的参数配置
blackIp:
  continueCounts: $&#123;counts:10&#125;    # ip连续请求的次数
  timeInterval: $&#123;interval:10&#125;    # ip判断的事件间隔，单位：秒
  limitTimes: $&#123;times:15&#125;         # 限制的事件，单位：秒
</code></pre>
<pre><code class="java">zuul-server  com/imooc/zuul/filters/BlackIPFilter.java
package com.imooc.zuul.filters;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.IPUtil;
import com.imooc.utils.JsonUtils;
import com.imooc.utils.RedisOperator;
import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import com.netflix.zuul.exception.ZuulException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
/* application.yml
*  blackIp:
   continueCounts: $&#123;counts:10&#125;    # ip连续请求的次数
   timeInterval: $&#123;interval:10&#125;    # ip判断的事件间隔，单位：秒
   limitTimes: $&#123;times:15&#125;         # 限制的事件，单位：秒
* */
@Component
@RefreshScope
public class BlackIPFilter extends ZuulFilter &#123;

    @Value(&quot;$&#123;blackIp.continueCounts&#125;&quot;)
    public Integer continueCounts;
    @Value(&quot;$&#123;blackIp.timeInterval&#125;&quot;)
    public Integer timeInterval;
    @Value(&quot;$&#123;blackIp.limitTimes&#125;&quot;)
    public Integer limitTimes;

    @Autowired
    private RedisOperator redis;

    @Override
    public String filterType() &#123;
        return &quot;pre&quot;;
    &#125;

    @Override
    public int filterOrder() &#123;
        return 2;
    &#125;

    @Override
    public boolean shouldFilter() &#123;
        return true;
    &#125;

    @Override
    public Object run() throws ZuulException &#123;

        System.out.println(&quot;执行【ip黑名单】过滤器...&quot;);

        System.out.println(&quot;continueCounts: &quot; + continueCounts);
        System.out.println(&quot;timeInterval: &quot; + timeInterval);
        System.out.println(&quot;limitTimes: &quot; + limitTimes);


        // 获得上下文对象
        RequestContext context = RequestContext.getCurrentContext();
        HttpServletRequest request = context.getRequest();

        // 获得ip
        String ip = IPUtil.getRequestIp(request);

        /**
         * 需求：
         *  判断ip在10秒内的请求次数是否超过10次
         *  如果超过，则限制这个ip访问15秒，15秒以后再放行
         */

        final String ipRedisKey = &quot;zuul-ip:&quot; + ip;
        final String ipRedisLimitKey = &quot;zuul-ip-limit:&quot; + ip;

        // 获得当前ip这个key的剩余时间
        long limitLeftTime = redis.ttl(ipRedisLimitKey);
        // 如果当前限制ip的key还存在剩余时间，说明这个ip不能访问，继续等待
        if (limitLeftTime &gt; 0) &#123;
            stopRequest(context);
            return null;
        &#125;

        // 在redis中累加ip的请求访问次数
        long requestCounts = redis.increment(ipRedisKey, 1);
        // 从0开始计算请求次数，初期访问为1，则设置过期时间，也就是连续请求的间隔时间
        if (requestCounts == 1) &#123;
            redis.expire(ipRedisKey, timeInterval);
        &#125;

        // 如果还能取得请求次数，说明用户连续请求的次数落在10秒内
        // 一旦请求次数超过了连续访问的次数，则需要限制这个ip的访问
        if (requestCounts &gt; continueCounts) &#123;
            // 限制ip的访问时间
            redis.set(ipRedisLimitKey, ipRedisLimitKey, limitTimes);
            stopRequest(context);
        &#125;

        return null;
    &#125;

    private void stopRequest(RequestContext context) &#123;
        // 停止zuul继续向下路由，禁止请求通信
        context.setSendZuulResponse(false);
        context.setResponseStatusCode(200);
        String result = JsonUtils.objectToJson(
                GraceJSONResult.errorCustom(
                        ResponseStatusEnum.SYSTEM_ERROR_ZUUL));
        context.setResponseBody(result);
        context.getResponse().setCharacterEncoding(&quot;utf-8&quot;);
        context.getResponse().setContentType(MediaType.APPLICATION_JSON_VALUE);
    &#125;
&#125;

=============================================================================
dev-common  com/imooc/grace/result/ResponseStatusEnum.java
SYSTEM_ERROR_ZUUL(560, false, &quot;请求系统过于繁忙，请稍后再试！&quot;);
</code></pre>
<pre><code class="yaml">zuul-server  application.yml 【把redis增加进来】
############################################################
#
# 网关zuul
# web访问端口号  约定：7070
#
############################################################
server:
  port: 7070
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-zuul-server

  redis:
    database: 0
    host: 192.168.1.201
    port: 6379
    password: 123456
  zipkin:
    # 配置zipkin采集的服务地址，数据会发送到这里
    base-url: http://192.168.1.2:9411/
    sender:
      # 数据采集的传输通信方式，web http的形式
      type: web
  sleuth:
    sampler:
      # 数据采样比例（百分数），0~1
      probability: 1

############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  server:
    hostname: eureka
    port: 7000
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/

# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/** # 请求路径(前缀)
  #    service-article:                  # 配置微服务的路由id，微服务的实例id
#      path: /service-article/**       # 请求路径(前缀)
#      service-id: service-article     # 请求转发的微服务实例id
#      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀



# ip请求限制的参数配置
blackIp:
  continueCounts: $&#123;counts:10&#125;    # ip连续请求的次数
  timeInterval: $&#123;interval:10&#125;    # ip判断的事件间隔，单位：秒
  limitTimes: $&#123;times:15&#125;         # 限制的事件，单位：秒
</code></pre>
<blockquote>
<p>此时redis中会出现<br>zuul-ip(1) → zuul-ip  → Value:1<br>zuul-ip-limit(1) → zuul-ip-limit: 本机地址<br>在zuul-7070服务里的Console 显示：<br>display pre zuul filter …<br>执行【ip黑名单】过滤器…</p>
</blockquote>
<h3 id="分布式配置中心【config】"><a href="#分布式配置中心【config】" class="headerlink" title="分布式配置中心【config】"></a>分布式配置中心【config】</h3><ul>
<li><strong>SpringCloud Config</strong></li>
<li><strong>为所有服务提供统一的配置管理服务</strong><del>微服务配置一下子全部生效</del></li>
<li><strong>包含配置服务端与配置客户端</strong></li>
</ul>
<h5 id="配置中心的功能"><a href="#配置中心的功能" class="headerlink" title="配置中心的功能"></a>配置中心的功能</h5><ul>
<li><strong>统一管理配置</strong></li>
<li><strong>管理不同环境下的配置</strong></li>
<li><strong>动态调整配置</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/b1fb9d3f444bf78ad6621441538f809d208f8c1a/data/%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.png"></p>
<h3 id="搭配配置中心【config】"><a href="#搭配配置中心【config】" class="headerlink" title="搭配配置中心【config】"></a>搭配配置中心【config】</h3><p><a target="_blank" rel="noopener" href="https://github.com/leechenxiang/imooc-news-config/tree/master">leechenxiang&#x2F;imooc-news-config (github.com)</a></p>
<pre><code class="yaml">zuul-dev.yml
blackIp:
  continueCounts: 10
  timeInterval: 10
  limitTimes: 15

zuul-prod.yml
blackIp:
  continueCounts: 40
  timeInterval: 70
  limitTimes: 315
</code></pre>
<pre><code class="xml">springcloud-config  pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;springcloud-config&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<pre><code class="java">springcloud-config  com/imooc/config/Application.java
package com.imooc.config;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.cloud.config.server.EnableConfigServer;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
import org.springframework.context.annotation.ComponentScan;

@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,
                                    MongoAutoConfiguration.class&#125;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;, &quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
==========================================================================
config-7080
</code></pre>
<pre><code class="yaml">springcloud-config  application.yml
############################################################
#
# 配置服务Config
# web访问端口号  约定：7080
#
############################################################
server:
  port: 7080
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-config
  
  rabbitmq:
    host: 192.168.1.204
    port: 5672
    username: admin
    password: admin
    virtual-host: imooc-news-dev

############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  server:
    hostname: eureka
    port: 7000
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/


# 配置动态刷新git配置的路径终端请求地址
management:
  endpoints:
    web:
      exposure:
        include: &quot;*&quot;
</code></pre>
<pre><code class="xml">springcloud-config  logback-spring.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;configuration&gt;
    &lt;!-- 指定日志文件的存储地址，使用绝对路径 --&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;/workspaces/logs/imooc-news-dev/springcloud-config&quot;/&gt;

    &lt;!-- Console 输出设置 --&gt;
    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;
            &lt;pattern&gt;%white(%d&#123;mm:ss.SSS&#125;) %green([%thread]) %cyan(%-5level) %yellow(%logger&#123;36&#125;) %magenta(-) %black(%msg%n)&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 按照每天生成日志文件 --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- 日志文件输出的文件名 --&gt;
            &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config.%d&#123;yyyy-MM-dd&#125;.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!--&lt;logger name=&quot;org.apache.ibatis.cache.decorators.LoggingCache&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;--&gt;
        &lt;!--&lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;--&gt;
    &lt;!--&lt;/logger&gt;--&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<pre><code class="java">springcloud-config  com/imooc/config/controller/HelloController.java
package com.imooc.config.controller;

import com.imooc.grace.result.GraceJSONResult;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController &#123;

    @GetMapping(&quot;/hello&quot;)
    public Object hello() &#123;
        return GraceJSONResult.ok();
    &#125;
&#125;
</code></pre>
<h3 id="配置中心实现git配置读取【config】"><a href="#配置中心实现git配置读取【config】" class="headerlink" title="配置中心实现git配置读取【config】"></a>配置中心实现git配置读取【config】</h3><pre><code class="xml">springcloud-config  pom.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;imooc-news-dev&lt;/artifactId&gt;
        &lt;groupId&gt;com.imooc&lt;/groupId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;springcloud-config&lt;/artifactId&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.imooc&lt;/groupId&gt;
            &lt;artifactId&gt;imooc-news-dev-service-api&lt;/artifactId&gt;
            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<pre><code class="yaml">springcloud-config  application.yml
#增加  cloud:config:server:git: uri
############################################################
#
# 配置服务Config
# web访问端口号  约定：7080
#
############################################################
server:
  port: 7080
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-config
  cloud:
    config:
      server:
        git:
          uri: https://github.com/leechenxiang/imooc-news-config.git
  rabbitmq:
    host: 192.168.1.204
    port: 5672
    username: admin
    password: admin
    virtual-host: imooc-news-dev

############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  server:
    hostname: eureka
    port: 7000
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/
</code></pre>
<pre><code class="java">springcloud-config  com/imooc/config/Application.java
package com.imooc.config;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration;
import org.springframework.cloud.config.server.EnableConfigServer;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
import org.springframework.context.annotation.ComponentScan;

@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,
                                    MongoAutoConfiguration.class&#125;)
@ComponentScan(basePackages = &#123;&quot;com.imooc&quot;, &quot;org.n3r.idworker&quot;&#125;)
@EnableEurekaClient
@EnableConfigServer //开启这个配置中心
public class Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(Application.class, args);
    &#125;
&#125;
</code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/leechenxiang/imooc-news-config/tree/master">leechenxiang&#x2F;imooc-news-config (github.com)</a></p>
<blockquote>
<p>localhost:7080&#x2F;zuul-prod.yml    这里直接引用了github上面的yml<br>localhost:7080&#x2F;master&#x2F;zuul-prod.yml   </p>
</blockquote>
<pre><code class="yaml">zuul-dev.yml
blackIp:
  continueCounts: 10
  timeInterval: 10
  limitTimes: 15

zuul-prod.yml
blackIp:
  continueCounts: 40
  timeInterval: 70
  limitTimes: 315
</code></pre>
<h3 id="配置客户端拉取配置"><a href="#配置客户端拉取配置" class="headerlink" title="配置客户端拉取配置"></a>配置客户端拉取配置</h3><pre><code class="xml">zuul-server  pom.xml
         &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="yaml">zuul-server  resources/bootstrap.yml
############################################################
# 系统全局加载文件 先加载这个文件
# 网关zuul
# web访问端口号  约定：7070
#
############################################################
server:
  port: 7070
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-zuul-server
  redis:
    database: 0
    host: 192.168.1.201
    port: 6379
    password: 123456
  cloud:
    config:
      label: master # github上的分支
      name: zuul # 定义的服务
      profile: prod  # 所加载的环境变量
#      uri: http://192.168.1.2:7080
      discovery:
        enabled: true
        service-id: springcloud-config


############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  server:
    hostname: eureka
    port: 7000
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/

# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/**
  #    service-article:                  # 配置微服务的路由id，微服务的实例id
#      path: /service-article/**       # 请求路径(前缀)
#      service-id: service-article     # 请求转发的微服务实例id
#      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址
  prefix: /api                        # 请求前缀
</code></pre>
<pre><code class="java">启动zuul-7070  //客户端连接config(server)并且动态获得了github的数据
打印控制台Console
display pre zuul filter...
执行【ip黑名单】过滤器...
// zuul-prod.yml
  continueCounts: 40
  timeInterval: 70
  limitTimes: 315
</code></pre>
<h3 id="动态刷新git配置"><a href="#动态刷新git配置" class="headerlink" title="动态刷新git配置"></a>动态刷新git配置</h3><pre><code class="java">// zuul-prod.yml 动态修改数值
  continueCounts: 35
  timeInterval: 305
  limitTimes: 65
在浏览器会显示更新后的数值 但是在console打印台不会显示改后的 只会显示之前的
需要重启服务才可以达到修改后的效果 显示修改的数值
</code></pre>
<pre><code class="xml">zuul-server  pom.xml
添加健康检测的配置
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="java">zuul-server  com/imooc/zuul/filters/BlackIPFilter.java
//【开启刷新 @RefreshScope 不能全自动 需要触碰某些请求 在yaml配置动态刷新的地址】
package com.imooc.zuul.filters;

import com.imooc.grace.result.GraceJSONResult;
import com.imooc.grace.result.ResponseStatusEnum;
import com.imooc.utils.IPUtil;
import com.imooc.utils.JsonUtils;
import com.imooc.utils.RedisOperator;
import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import com.netflix.zuul.exception.ZuulException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
/* application.yml
*  blackIp:
   continueCounts: $&#123;counts:10&#125;    # ip连续请求的次数
   timeInterval: $&#123;interval:10&#125;    # ip判断的事件间隔，单位：秒
   limitTimes: $&#123;times:15&#125;         # 限制的事件，单位：秒
* */
@Component
@RefreshScope
public class BlackIPFilter extends ZuulFilter &#123;

    @Value(&quot;$&#123;blackIp.continueCounts&#125;&quot;)
    public Integer continueCounts;
    @Value(&quot;$&#123;blackIp.timeInterval&#125;&quot;)
    public Integer timeInterval;
    @Value(&quot;$&#123;blackIp.limitTimes&#125;&quot;)
    public Integer limitTimes;

    @Autowired
    private RedisOperator redis;

    @Override
    public String filterType() &#123;
        return &quot;pre&quot;;
    &#125;

    @Override
    public int filterOrder() &#123;
        return 2;
    &#125;

    @Override
    public boolean shouldFilter() &#123;
        return true;
    &#125;
&#125;
</code></pre>
<pre><code class="yaml">zuul-server  bootstrap.yml  +  springcloud-config  application.yaml
# 配置动态刷新git配置的路径终端请求地址 只需要通过URL请求不用重启就可以自动刷新 后期要通过脚本运行才可【通过请求处理 postman → POST → https://localhost:7070/actuator/refresh】
management:
  endpoints:
    web:
      exposure:
        include: refresh
# 此时回到console就可以有更新后的数据显示了
</code></pre>
<h3 id="消息总线概述【bus】-RabbitMQ"><a href="#消息总线概述【bus】-RabbitMQ" class="headerlink" title="消息总线概述【bus】[RabbitMQ]"></a>消息总线概述【bus】<del>[RabbitMQ]</del></h3><h5 id="Config遗留问题"><a href="#Config遗留问题" class="headerlink" title="Config遗留问题"></a>Config遗留问题</h5><ul>
<li><strong>手动刷新与业务耦合</strong> [也可能在文章&#x2F;user模块发生]</li>
<li>Config配置中心的刷新去解决动态刷新</li>
<li><strong>N个微服务端需要N次手动书信</strong></li>
</ul>
<h5 id="消息总线-要和config与微服务端进行配置"><a href="#消息总线-要和config与微服务端进行配置" class="headerlink" title="消息总线(要和config与微服务端进行配置)"></a>消息总线<del>(要和config与微服务端进行配置)</del></h5><ul>
<li><strong>SpringCloud Bus</strong></li>
<li>为SpringCloud Config提供增益buff</li>
<li><strong>可以实现配置自动刷新</strong>[1k个 1w个]</li>
</ul>
<p><img src="https://raw.githubusercontent.com/P-luminary/images/5fc0f342c2ab14a5e7e3aa9869b97348c7ed39ed/data/%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E6%A6%82%E8%BF%B0.jpg"></p>
<h3 id="配置实现消息统一发送【bus】"><a href="#配置实现消息统一发送【bus】" class="headerlink" title="配置实现消息统一发送【bus】"></a>配置实现消息统一发送【bus】</h3><blockquote>
<p>config把消息推給zull-server</p>
</blockquote>
<pre><code class="xml">springcloud-config  pom.xml    ＋    zuul-server  pom.xml
    &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="yaml">zuul-server  resources/bootstrap.yaml  +  springcloud-config  application.yaml
  rabbitmq:
    host: 192.168.1.204
    port: 5672
    username: admin
    password: admin
    virtual-host: imooc-news-dev
</code></pre>
<blockquote>
<p>实现刷新server端达到所有的刷新配置<br>【通过请求处理 postman → POST → <a target="_blank" rel="noopener" href="https://localhost:7080/actuator/bus-refresh%E3%80%91">https://localhost:7080/actuator/bus-refresh】</a><br>若想精确刷新某个服务 需要拼接<br> postman → POST → <a target="_blank" rel="noopener" href="https://localhost:7080/actuator/bus-refresh/%7B%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AE%9E%E4%BE%8Bid%7D:%7Bport%7D">https://localhost:7080/actuator/bus-refresh/{微服务的实例id}:{port}</a><br>微服务实例id是yaml配置项目信息 → spring.application.name：springcloud-zuul-server<br><a target="_blank" rel="noopener" href="https://localhost:7080/actuator/bus-refresh/springcloud-zuul-server:7070">https://localhost:7080/actuator/bus-refresh/springcloud-zuul-server:7070</a> 【目标微服务地址实现精确打击】</p>
</blockquote>
<h3 id="消息驱动概述【stream】"><a href="#消息驱动概述【stream】" class="headerlink" title="消息驱动概述【stream】"></a>消息驱动概述【stream】</h3><h5 id="消息驱动"><a href="#消息驱动" class="headerlink" title="消息驱动"></a>消息驱动</h5><ul>
<li><strong>SpringCloud Stream</strong></li>
<li><strong><span style = "color:red">统一封装消息的服务框架</span></strong></li>
<li>RabbitMQ，RocketMQ，Kafka，ActiveMQ，ZeroMQ，…</li>
</ul>
<h5 id="Stream消息模型"><a href="#Stream消息模型" class="headerlink" title="Stream消息模型"></a>Stream消息模型</h5><img src="https://raw.githubusercontent.com/P-luminary/images/995964c627f628ee94ebb76bbbe6fe7872884f32/data/Stream%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B.png" style="zoom:80%;" />



<h3 id="实现消费者与生产者【stream】"><a href="#实现消费者与生产者【stream】" class="headerlink" title="实现消费者与生产者【stream】"></a>实现消费者与生产者【stream】</h3><blockquote>
<p>将zuul-server的resources&#x2F;application.yml 恢复到原来配置</p>
</blockquote>
<pre><code class="yaml">############################################################
#
# 网关zuul
# web访问端口号  约定：7070
#
############################################################
server:
  port: 7070
  tomcat:
    uri-encoding: UTF-8

############################################################
#
# 配置项目信息
#
############################################################
spring:
  application:
    name: springcloud-zuul-server

  redis:
    database: 0
    host: 192.168.1.201
    port: 6379
    password: 123456
  zipkin:
    # 配置zipkin采集的服务地址，数据会发送到这里
    base-url: http://192.168.1.2:9411/
    sender:
      # 数据采集的传输通信方式，web http的形式
      type: web
  sleuth:
    sampler:
      # 数据采样比例（百分数），0~1
      probability: 1

############################################################
#
# eureka client 配置信息
#
############################################################
eureka:
  server:
    hostname: eureka
    port: 7000
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      #defaultZone: http://$&#123;eureka.server.hostname&#125;:$&#123;eureka.server.port&#125;/eureka/
      defaultZone: http://eureka-cluster-7001:7001/eureka/,http://eureka-cluster-7002:7002/eureka/,http://eureka-cluster-7003:7003/eureka/

# 路由规则: http://[网关地址]:[端口号]/[prefix]/[微服务实例id]/[请求地址路径]
zuul:
  routes:
    # 由于路由id和微服务实例id相同，我们可以简化转发的配置
    service-article: /service-article/** # 请求路径(前缀)
  #    service-article:                  # 配置微服务的路由id，微服务的实例id
#      path: /service-article/**       # 请求路径(前缀)
#      service-id: service-article     # 请求转发的微服务实例id
#      url: http://192.168.1.2:8001    # 请求转发到指定的微服务所在的ip地址(8001文章服务)
  prefix: /api                        # 请求前缀



# ip请求限制的参数配置
blackIp:
  continueCounts: $&#123;counts:10&#125;    # ip连续请求的次数
  timeInterval: $&#123;interval:10&#125;    # ip判断的事件间隔，单位：秒
  limitTimes: $&#123;times:15&#125;         # 限制的事件，单位：秒
</code></pre>
<pre><code class="xml">service-article  pom.xml  +  service-user  pom.xml
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-stream-rabbit&lt;/artifactId&gt;
            &lt;version&gt;4.1.1&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="yaml">service-article  application.yaml      +      service-user  application.yaml
    cloud:
    stream:
      bindings:                    # 绑定通道和交换机
        myOutput:                   # 定义生产者的通道
          # 自定义交换机的名字，也就是代码里构建的信息，交给底层mq的交换机
          destination:
        myInput:                    # 定义消费者通道
          # 自定义交换机的名字，也就是消息从底层mq输入到消费端进行消费
          destination:
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/MyStreamChannel.java
package com.imooc.article.stream;

import org.springframework.cloud.stream.annotation.Input;
import org.springframework.cloud.stream.annotation.Output;
import org.springframework.cloud.stream.messaging.Sink;
import org.springframework.cloud.stream.messaging.Source;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.SubscribableChannel;
import org.springframework.stereotype.Component;

/**
 * 声明构建通道channel
 */
@Component
public interface MyStreamChannel &#123;

    String OUTPUT = &quot;myOutput&quot;;
    String INPUT = &quot;myInput&quot;;

    @Output(MyStreamChannel.OUTPUT)
    MessageChannel output();

    @Input(MyStreamChannel.INPUT)
    SubscribableChannel input();  //订阅能力的通道
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/MyStreamChannel.java
package com.imooc.article.stream;


import org.springframework.cloud.stream.annotation.Input;
import org.springframework.cloud.stream.annotation.Output;
import org.springframework.cloud.stream.messaging.Sink;
import org.springframework.cloud.stream.messaging.Source;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.SubscribableChannel;
import org.springframework.stereotype.Component;

/**
 * 声明构建通道channel
 */
@Component
public interface MyStreamChannel &#123;
    String OUTPUT = &quot;myOutput&quot;;
    String INPUT = &quot;myInput&quot;;

    @Output(MyStreamChannel.OUTPUT)
    MessageChannel output();

    @Input(MyStreamChannel.INPUT)
    SubscribableChannel input();
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/StreamService.java
package com.imooc.article.stream;

public interface StreamService &#123;
    public void sendMsg();
    public void eat(String dumpling);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/StreamServiceImpl.java
package com.imooc.article.stream;

import com.imooc.pojo.AppUser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.messaging.support.MessageBuilder;
import org.springframework.stereotype.Component;

/**
 * 开启绑定器
 * 绑定通道channel
 */
@Component
@EnableBinding(MyStreamChannel.class)
public class StreamServiceImpl implements StreamService &#123;

    @Autowired
    private MyStreamChannel myStreamChannel;

    @Override
    public void sendMsg() &#123;
        AppUser user = new AppUser();
        user.setId(&quot;10101&quot;);
        user.setNickname(&quot;imooc&quot;);

        // 消息通过绑定器发送给mq
        myStreamChannel.output()
                .send(MessageBuilder.withPayload(user).build());
    &#125;

    @Override
    public void eat(String dumpling) &#123;
        myStreamChannel.output()
                .send(MessageBuilder.withPayload(dumpling).build());
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/MyStreamConsumer.java
package com.imooc.article.stream;

import com.imooc.pojo.AppUser;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.cloud.stream.annotation.StreamListener;
import org.springframework.stereotype.Component;

/**
 * 构建消费端
 */
@Component
@EnableBinding(MyStreamChannel.class) //开启通道绑定
public class MyStreamConsumer &#123;

    /**
     * 监听并且实现消息的消费和相关业务处理
     */
    @StreamListener(MyStreamChannel.INPUT)
    public void receiveMsg(AppUser user) &#123;
        System.out.println(user.toString());
    &#125;

    @StreamListener(MyStreamChannel.INPUT)
    public void receiveMsg(String dumpling) &#123;
        System.out.println(dumpling);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/HelloController.java

@RestController
@RequestMapping(&quot;producer&quot;)
public class HelloController &#123;

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Autowired
    private StreamService streamService;

    @GetMapping(&quot;/stream&quot;)
    public Object stream() &#123;
        streamService.sendMsg();

        for (int i = 0 ; i &lt; 10 ; i ++ ) &#123;
            streamService.eat(&quot;我吃了第&quot; + (i+1) + &quot;只饺子~&quot;);
        &#125;

        return &quot;ok~~!!!&quot;;
    &#125;
</code></pre>
<h3 id="消息分组与持久化【stream】"><a href="#消息分组与持久化【stream】" class="headerlink" title="消息分组与持久化【stream】"></a>消息分组与持久化【stream】</h3><blockquote>
<p>避免重复消费  分组group 组内消费者不会重复消费</p>
</blockquote>
<h5 id="Stream消息分组"><a href="#Stream消息分组" class="headerlink" title="Stream消息分组"></a>Stream消息分组</h5><pre><code class="yaml">service-article  application.yml  
  cloud:
    stream:
      bindings:                    # 绑定通道和交换机
        myOutput:                   # 定义生产者的通道
          # 自定义交换机的名字，也就是代码里构建的信息，交给底层mq的交换机
          destination:
        myInput:                    # 定义消费者通道
          # 自定义交换机的名字，也就是消息从底层mq输入到消费端进行消费
          destination:
          group: boys

------------------------------------------------------------------------------

service-user  application.yml
  cloud:
    stream:
      bindings: # 绑定通道和交换机
        myOutput: # 定义生产者的通道
          # 自定义交换机的名字，也就是代码里构建的信息，交给底层mq的交换机
          destination:
        myInput: # 定义消费者通道
          # 自定义交换机的名字，也就是消息从底层mq输入到消费端进行消费
          destination:
          group: girls
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/StreamService.java
package com.imooc.article.stream;

public interface StreamService &#123;
  //public void sendMsg();
    public void eat(String dumpling);
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/StreamServiceImpl.java
package com.imooc.article.stream;

import com.imooc.pojo.AppUser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.messaging.support.MessageBuilder;
import org.springframework.stereotype.Component;

/**
 * 开启绑定器
 * 绑定通道channel
 */
@Component
@EnableBinding(MyStreamChannel.class)
public class StreamServiceImpl implements StreamService &#123;

    @Autowired
    private MyStreamChannel myStreamChannel;

    @Override
 /* public void sendMsg() &#123;
        AppUser user = new AppUser();
        user.setId(&quot;10101&quot;);
        user.setNickname(&quot;imooc&quot;);

        // 消息通过绑定器发送给mq
        myStreamChannel.output()
                .send(MessageBuilder.withPayload(user).build());
    &#125; */

    @Override
    public void eat(String dumpling) &#123;
        myStreamChannel.output()
                .send(MessageBuilder.withPayload(dumpling).build());
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/stream/MyStreamConsumer.java
package com.imooc.article.stream;

import com.imooc.pojo.AppUser;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.cloud.stream.annotation.StreamListener;
import org.springframework.stereotype.Component;

/**
 * 构建消费端
 */
@Component
@EnableBinding(MyStreamChannel.class) //开启通道绑定
public class MyStreamConsumer &#123;

    /**
     * 监听并且实现消息的消费和相关业务处理
     */
 /* @StreamListener(MyStreamChannel.INPUT)
    public void receiveMsg(AppUser user) &#123;
        System.out.println(user.toString());
    &#125; */

    @StreamListener(MyStreamChannel.INPUT)
    public void receiveMsg(String dumpling) &#123;
        System.out.println(dumpling);
    &#125;
&#125;
</code></pre>
<pre><code class="java">service-article  com/imooc/article/controller/HelloController.java

@RestController
@RequestMapping(&quot;producer&quot;)
public class HelloController &#123;

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Autowired
    private StreamService streamService;

    @GetMapping(&quot;/stream&quot;)
    public Object stream() &#123;
     // streamService.sendMsg();

        for (int i = 0 ; i &lt; 10 ; i ++ ) &#123;
            streamService.eat(&quot;我吃了第&quot; + (i+1) + &quot;只饺子~&quot;);
        &#125;

        return &quot;ok~~!!!&quot;;
    &#125;
</code></pre>
<blockquote>
<p>消息不会被重复消费<br>service-article:8001   我吃了1-10只饺子~  【消费的饺子总数一共10次】<br>service-user:8003(女生) 我吃了1 3 5 7 9只饺子~    【饺子随机】<br>service-user:8013(男生) 我吃了2 4 6 8 10只饺子~  【饺子随机】</p>
<p>如果把service-user:8003(女生)  service-user:8013(男生) 服务stop 用户微服务无法接收任何消息<br>但是我们定义了group → 消息是可以持久化的 当重启用户微服务之后  就会打印出刚刚已经吃的饺子了<br>服务器宕机  &#x3D;  吃饺子中途去上厕所 回来后仍然还能吃到饺子</p>
</blockquote>
<h3 id="链路追踪概述与zipkin【sleuth】组件"><a href="#链路追踪概述与zipkin【sleuth】组件" class="headerlink" title="链路追踪概述与zipkin【sleuth】组件"></a>链路追踪概述与zipkin【sleuth】<del>组件</del></h3><h5 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h5><ul>
<li><strong>Sleuth</strong></li>
<li><strong>贯穿整个微服务系统中，追踪一个请求的过程</strong></li>
<li><strong>zipkin 可视化控制面板</strong></li>
</ul>
<blockquote>
<p>下载zipkin-server-2.12.6-exec.jar<br>CMD → C:\Users\Pluminary&gt;java -jar &#x2F;Users&#x2F;Pluminary&#x2F;Desktop&#x2F;zipkin-server-2.12.6-exec.jar<br><a target="_blank" rel="noopener" href="https://localhost:9411/zipkin/">https://localhost:9411/zipkin/</a></p>
</blockquote>
<h3 id="整合zipkin【sleuth】项目入口是网关"><a href="#整合zipkin【sleuth】项目入口是网关" class="headerlink" title="整合zipkin【sleuth】项目入口是网关"></a>整合zipkin【sleuth】<del>项目入口是网关</del></h3><pre><code class="xml">zuul-server  pom.xml  +  service-article  pom.xml  +  service-user  pom.xml
         &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="yaml">zuul-server与service-article与service-user  application.yml
  zipkin:
    # 配置zipkin采集的服务地址，数据会发送到这里
    base-url: http://192.168.1.2:9411/
    sender:
      # 数据采集的传输通信方式，web http的形式
      type: web
  sleuth:
    sampler:
      # 数据采样比例（百分数），0~1
      probability: 1
</code></pre>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://localhost:9411/zipkin/">https://localhost:9411/zipkin/</a></p>
</blockquote>
<h3 id="SpringCloud章节总结"><a href="#SpringCloud章节总结" class="headerlink" title="SpringCloud章节总结"></a>SpringCloud章节总结</h3><ul>
<li><strong>eureka 注册中心</strong></li>
<li><strong>ribbon 负载均衡</strong></li>
<li><strong>feign 声明式客户端</strong></li>
<li><strong>hystrix 熔断降级组件</strong></li>
<li><strong>zuul 网关</strong></li>
<li><strong>config 配置中心</strong></li>
<li><strong>bus 消息总线</strong></li>
<li><strong>stream 消息驱动</strong></li>
<li><strong>zipkin + sleuth 链路追踪</strong></li>
</ul>

    </div>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <div id="comment">
        <div id="gitalk-container">
        </div>
    </div>
    
</div>
                     
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 2018 - 2026 P-luminary
            <span class="footer-icon">
                <a-icon type="flag" theme="filled" /></span>
            @Asuna
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a>
<!--         & <a target="_blank" rel="noopener" href="https://github.com/korilin/hexo-theme-particle">Particle Theme</a></div> -->
        
    </div>

</footer>

<script src="/js/highlight.min.js"></script>
<script src="/js/particle.js"></script>
                </div>
            </div>
        </transition>
    </div>

    <script>
    new Vue({
        el: "#layout",
        data: {
            show_page: false,
            onload_menu: false,
            menu_show: false,
            card_top: 100
        },
        created: function () {
            var that = this
            window.onload = function () {
                that.show_page = true
                document.getElementById("loadcontent").style.opacity = 0
                setTimeout(function () {
                    document.getElementById("loadleft").style.width = 0
                    document.getElementById("loadright").style.width = 0
                }, 300)
                setTimeout(function () {
                    document.getElementById("loading").style = "display:none"
                }, 600)
            }
        },
        mounted: function () {
            var that = this
            window.addEventListener('scroll', function (e) {
                that.menu_show = false
            })
        },
        methods: {
            home_click: function () {
                window.scrollTo({
                    top: window.innerHeight - 80,
                    behavior: "smooth",
                });
            }
        }
    })
</script>

<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'hexo-theme-particle',      // The repository of store comments,
        owner: 'P-luminary',
        admin: ['P-luminary'],
        language: 'en',
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: true  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>

</body>

</html>